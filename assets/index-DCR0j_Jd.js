var Fo=Object.defineProperty;var Lo=(t,e,n)=>e in t?Fo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var H=(t,e,n)=>Lo(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const c of i)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const c={};return i.integrity&&(c.integrity=i.integrity),i.referrerPolicy&&(c.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?c.credentials="include":i.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(i){if(i.ep)return;i.ep=!0;const c=n(i);fetch(i.href,c)}})();async function Vo(t){if(!navigator.gpu)throw new Error("WebGPU is not supported by this browser.");const e=t.getContext("webgpu");if(!e)throw new Error("Failed to acquire WebGPU context.");const n=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(!n)throw new Error("No suitable GPU adapter found.");const o=await n.requestDevice(),i=navigator.gpu.getPreferredCanvasFormat();return{adapter:n,device:o,context:e,format:i}}var Se=1e-6,Ft=typeof Float32Array<"u"?Float32Array:Array,jo="zyx";function Oo(){var t=new Ft(9);return Ft!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function te(){var t=new Ft(16);return Ft!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Mn(t){var e=new Ft(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Uo(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function _o(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Go(t,e,n){var o=e[0],i=e[1],c=e[2],a=e[3],r=e[4],l=e[5],d=e[6],f=e[7],p=e[8],h=e[9],x=e[10],I=e[11],P=e[12],b=e[13],M=e[14],B=e[15],z=n[0],C=n[1],v=n[2],S=n[3];return t[0]=z*o+C*r+v*p+S*P,t[1]=z*i+C*l+v*h+S*b,t[2]=z*c+C*d+v*x+S*M,t[3]=z*a+C*f+v*I+S*B,z=n[4],C=n[5],v=n[6],S=n[7],t[4]=z*o+C*r+v*p+S*P,t[5]=z*i+C*l+v*h+S*b,t[6]=z*c+C*d+v*x+S*M,t[7]=z*a+C*f+v*I+S*B,z=n[8],C=n[9],v=n[10],S=n[11],t[8]=z*o+C*r+v*p+S*P,t[9]=z*i+C*l+v*h+S*b,t[10]=z*c+C*d+v*x+S*M,t[11]=z*a+C*f+v*I+S*B,z=n[12],C=n[13],v=n[14],S=n[15],t[12]=z*o+C*r+v*p+S*P,t[13]=z*i+C*l+v*h+S*b,t[14]=z*c+C*d+v*x+S*M,t[15]=z*a+C*f+v*I+S*B,t}function Qe(t,e,n,o){var i=e[0],c=e[1],a=e[2],r=e[3],l=i+i,d=c+c,f=a+a,p=i*l,h=i*d,x=i*f,I=c*d,P=c*f,b=a*f,M=r*l,B=r*d,z=r*f,C=o[0],v=o[1],S=o[2];return t[0]=(1-(I+b))*C,t[1]=(h+z)*C,t[2]=(x-B)*C,t[3]=0,t[4]=(h-z)*v,t[5]=(1-(p+b))*v,t[6]=(P+M)*v,t[7]=0,t[8]=(x+B)*S,t[9]=(P-M)*S,t[10]=(1-(p+I))*S,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Yo(t,e,n,o,i){var c=1/Math.tan(e/2);if(t[0]=c/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,i!=null&&i!==1/0){var a=1/(o-i);t[10]=i*a,t[14]=i*o*a}else t[10]=-1,t[14]=-o;return t}function Ro(t,e,n,o,i,c,a){var r=1/(e-n),l=1/(o-i),d=1/(c-a);return t[0]=-2*r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=d,t[11]=0,t[12]=(e+n)*r,t[13]=(i+o)*l,t[14]=c*d,t[15]=1,t}function Do(t,e,n,o){var i,c,a,r,l,d,f,p,h,x,I=e[0],P=e[1],b=e[2],M=o[0],B=o[1],z=o[2],C=n[0],v=n[1],S=n[2];return Math.abs(I-C)<Se&&Math.abs(P-v)<Se&&Math.abs(b-S)<Se?_o(t):(f=I-C,p=P-v,h=b-S,x=1/Math.sqrt(f*f+p*p+h*h),f*=x,p*=x,h*=x,i=B*h-z*p,c=z*f-M*h,a=M*p-B*f,x=Math.sqrt(i*i+c*c+a*a),x?(x=1/x,i*=x,c*=x,a*=x):(i=0,c=0,a=0),r=p*a-h*c,l=h*i-f*a,d=f*c-p*i,x=Math.sqrt(r*r+l*l+d*d),x?(x=1/x,r*=x,l*=x,d*=x):(r=0,l=0,d=0),t[0]=i,t[1]=r,t[2]=f,t[3]=0,t[4]=c,t[5]=l,t[6]=p,t[7]=0,t[8]=a,t[9]=d,t[10]=h,t[11]=0,t[12]=-(i*I+c*P+a*b),t[13]=-(r*I+l*P+d*b),t[14]=-(f*I+p*P+h*b),t[15]=1,t)}function St(){var t=new Ft(3);return Ft!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function jn(t){var e=t[0],n=t[1],o=t[2];return Math.sqrt(e*e+n*n+o*o)}function Tt(t,e,n){var o=new Ft(3);return o[0]=t,o[1]=e,o[2]=n,o}function qo(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ce(t,e,n,o){return t[0]=e,t[1]=n,t[2]=o,t}function Wo(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Je(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function $o(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function pe(t,e,n,o){return t[0]=e[0]+n[0]*o,t[1]=e[1]+n[1]*o,t[2]=e[2]+n[2]*o,t}function Ho(t,e){var n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}function Ot(t,e){var n=e[0],o=e[1],i=e[2],c=n*n+o*o+i*i;return c>0&&(c=1/Math.sqrt(c)),t[0]=e[0]*c,t[1]=e[1]*c,t[2]=e[2]*c,t}function Ht(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Kt(t,e,n){var o=e[0],i=e[1],c=e[2],a=n[0],r=n[1],l=n[2];return t[0]=i*l-c*r,t[1]=c*a-o*l,t[2]=o*r-i*a,t}var Xo=jn;(function(){var t=St();return function(e,n,o,i,c,a){var r,l;for(n||(n=3),o||(o=0),i?l=Math.min(i*n+o,e.length):l=e.length,r=o;r<l;r+=n)t[0]=e[r],t[1]=e[r+1],t[2]=e[r+2],c(t,t,a),e[r]=t[0],e[r+1]=t[1],e[r+2]=t[2];return e}})();function Ko(){var t=new Ft(4);return Ft!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Qo(t,e){var n=e[0],o=e[1],i=e[2],c=e[3],a=n*n+o*o+i*i+c*c;return a>0&&(a=1/Math.sqrt(a)),t[0]=n*a,t[1]=o*a,t[2]=i*a,t[3]=c*a,t}(function(){var t=Ko();return function(e,n,o,i,c,a){var r,l;for(n||(n=4),o||(o=0),i?l=Math.min(i*n+o,e.length):l=e.length,r=o;r<l;r+=n)t[0]=e[r],t[1]=e[r+1],t[2]=e[r+2],t[3]=e[r+3],c(t,t,a),e[r]=t[0],e[r+1]=t[1],e[r+2]=t[2],e[r+3]=t[3];return e}})();function Te(){var t=new Ft(4);return Ft!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Jo(t,e,n){n=n*.5;var o=Math.sin(n);return t[0]=o*e[0],t[1]=o*e[1],t[2]=o*e[2],t[3]=Math.cos(n),t}function Ge(t,e,n,o){var i=e[0],c=e[1],a=e[2],r=e[3],l=n[0],d=n[1],f=n[2],p=n[3],h,x,I,P,b;return x=i*l+c*d+a*f+r*p,x<0&&(x=-x,l=-l,d=-d,f=-f,p=-p),1-x>Se?(h=Math.acos(x),I=Math.sin(h),P=Math.sin((1-o)*h)/I,b=Math.sin(o*h)/I):(P=1-o,b=o),t[0]=P*i+b*l,t[1]=P*c+b*d,t[2]=P*a+b*f,t[3]=P*r+b*p,t}function Zo(t,e){var n=e[0]+e[4]+e[8],o;if(n>0)o=Math.sqrt(n+1),t[3]=.5*o,o=.5/o,t[0]=(e[5]-e[7])*o,t[1]=(e[6]-e[2])*o,t[2]=(e[1]-e[3])*o;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var c=(i+1)%3,a=(i+2)%3;o=Math.sqrt(e[i*3+i]-e[c*3+c]-e[a*3+a]+1),t[i]=.5*o,o=.5/o,t[3]=(e[c*3+a]-e[a*3+c])*o,t[c]=(e[c*3+i]+e[i*3+c])*o,t[a]=(e[a*3+i]+e[i*3+a])*o}return t}function ts(t,e,n,o){var i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:jo,c=Math.PI/360;e*=c,o*=c,n*=c;var a=Math.sin(e),r=Math.cos(e),l=Math.sin(n),d=Math.cos(n),f=Math.sin(o),p=Math.cos(o);switch(i){case"xyz":t[0]=a*d*p+r*l*f,t[1]=r*l*p-a*d*f,t[2]=r*d*f+a*l*p,t[3]=r*d*p-a*l*f;break;case"xzy":t[0]=a*d*p-r*l*f,t[1]=r*l*p-a*d*f,t[2]=r*d*f+a*l*p,t[3]=r*d*p+a*l*f;break;case"yxz":t[0]=a*d*p+r*l*f,t[1]=r*l*p-a*d*f,t[2]=r*d*f-a*l*p,t[3]=r*d*p+a*l*f;break;case"yzx":t[0]=a*d*p+r*l*f,t[1]=r*l*p+a*d*f,t[2]=r*d*f-a*l*p,t[3]=r*d*p-a*l*f;break;case"zxy":t[0]=a*d*p-r*l*f,t[1]=r*l*p+a*d*f,t[2]=r*d*f+a*l*p,t[3]=r*d*p-a*l*f;break;case"zyx":t[0]=a*d*p-r*l*f,t[1]=r*l*p+a*d*f,t[2]=r*d*f-a*l*p,t[3]=r*d*p+a*l*f;break;default:throw new Error("Unknown angle order "+i)}return t}var On=Qo;(function(){var t=St(),e=Tt(1,0,0),n=Tt(0,1,0);return function(o,i,c){var a=Ht(i,c);return a<-.999999?(Kt(t,e,i),Xo(t)<1e-6&&Kt(t,n,i),Ot(t,t),Jo(o,t,Math.PI),o):a>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(Kt(t,i,c),o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=1+a,On(o,o))}})();(function(){var t=Te(),e=Te();return function(n,o,i,c,a,r){return Ge(t,o,a,r),Ge(e,i,c,r),Ge(n,t,e,2*r*(1-r)),n}})();(function(){var t=Oo();return function(e,n,o,i){return t[0]=o[0],t[3]=o[1],t[6]=o[2],t[1]=i[0],t[4]=i[1],t[7]=i[2],t[2]=-n[0],t[5]=-n[1],t[8]=-n[2],On(e,Zo(e,t))}})();const vn=-Math.PI/2+.001,bn=Math.PI/2-.001;class es{constructor(){H(this,"target",Tt(0,0,0));H(this,"position",St());H(this,"yaw",Math.PI*.25);H(this,"pitch",Math.PI*.2);H(this,"distance",6);H(this,"aspect",1);H(this,"fov",45*Math.PI/180);H(this,"near",.1);H(this,"far",1e3);H(this,"orthoScale",4);H(this,"mode","perspective");H(this,"view",te());H(this,"proj",te());H(this,"viewProj",te());H(this,"worldUp",Tt(0,1,0));H(this,"tmpForward",St());H(this,"tmpRight",St());H(this,"tmpUp",St())}setAspect(e){this.aspect=Math.max(1e-4,e)}toggleProjection(){this.mode==="perspective"?(this.orthoScale=this.distance*Math.tan(this.fov*.5),this.mode="axonometric"):(this.distance=this.orthoScale/Math.tan(this.fov*.5),this.mode="perspective")}setAngles(e,n){this.yaw=e,this.pitch=Math.max(vn,Math.min(bn,n))}orbit(e,n,o=.005){this.yaw-=e*o,this.pitch-=n*o,this.pitch=Math.max(vn,Math.min(bn,this.pitch))}zoom(e,n=.001){const o=Math.exp(e*n);this.mode==="perspective"?this.distance=Math.min(200,Math.max(.2,this.distance*o)):this.orthoScale=Math.min(200,Math.max(.2,this.orthoScale*o))}pan(e,n,o){const i=Math.max(1,o),c=this.getPanScale(i);this.updatePosition(),Je(this.tmpForward,this.target,this.position),Ot(this.tmpForward,this.tmpForward),Kt(this.tmpRight,this.tmpForward,this.worldUp),Ot(this.tmpRight,this.tmpRight),Kt(this.tmpUp,this.tmpRight,this.tmpForward),Ot(this.tmpUp,this.tmpUp),pe(this.target,this.target,this.tmpRight,-e*c),pe(this.target,this.target,this.tmpUp,n*c)}getViewMatrix(){return this.updatePosition(),Do(this.view,this.position,this.target,this.worldUp),this.view}getProjectionMatrix(){if(this.mode==="perspective")Yo(this.proj,this.fov,this.aspect,this.near,this.far);else{const e=this.orthoScale,n=e*this.aspect;Ro(this.proj,-n,n,-e,e,this.near,this.far)}return this.proj}getViewProjMatrix(){return Go(this.viewProj,this.getProjectionMatrix(),this.getViewMatrix()),this.viewProj}getPosition(){return this.updatePosition(),this.position}fitToBounds(e,n,o=1.2){const i=Tt(e[0],e[1],e[2]),c=Tt(n[0],n[1],n[2]),a=St();Wo(a,i,c),$o(a,a,.5),qo(this.target,a);const r=.5*Ho(i,c)*o;if(this.mode==="perspective"){const l=this.fov*.5,d=r/Math.sin(l),f=r/Math.sin(Math.atan(Math.tan(l)*this.aspect));this.distance=Math.max(d,f)}else this.orthoScale=Math.max(.1,r)}updatePosition(){const e=Math.cos(this.pitch),n=Math.sin(this.pitch),o=Math.cos(this.yaw),i=Math.sin(this.yaw);this.position[0]=this.target[0]+this.distance*e*o,this.position[1]=this.target[1]+this.distance*n,this.position[2]=this.target[2]+this.distance*e*i}getPanScale(e){return this.mode==="perspective"?2*this.distance*Math.tan(this.fov*.5)/e:this.orthoScale*2/e}}class ns{constructor(e,n){H(this,"pointerId",null);H(this,"dragMode",null);H(this,"lastX",0);H(this,"lastY",0);H(this,"pointers",new Map);H(this,"lastMidpoint",null);H(this,"lastDistance",null);H(this,"onPointerDown",e=>{if(this.canvas.setPointerCapture(e.pointerId),e.pointerType==="touch"){this.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),this.updateTouchGestureState();return}this.pointerId=e.pointerId,this.lastX=e.clientX,this.lastY=e.clientY,this.dragMode=this.getDragMode(e)});H(this,"onPointerMove",e=>{if(e.pointerType==="touch"){const i=this.pointers.get(e.pointerId);if(!i)return;const c={x:e.clientX,y:e.clientY};if(this.pointers.set(e.pointerId,c),this.pointers.size===1){const d=c.x-i.x,f=c.y-i.y;this.camera.orbit(-d,-f);return}const a=this.getTwoTouchPoints();if(!a)return;const r=this.getMidpoint(a[0],a[1]),l=this.getDistance(a[0],a[1]);if(this.lastMidpoint&&this.lastDistance!==null){const d=r.x-this.lastMidpoint.x,f=r.y-this.lastMidpoint.y;this.camera.pan(d,f,this.canvas.clientHeight);const p=l-this.lastDistance;Math.abs(p)>0&&this.camera.zoom(-p)}this.lastMidpoint=r,this.lastDistance=l;return}if(this.pointerId!==e.pointerId||!this.dragMode)return;const n=e.clientX-this.lastX,o=e.clientY-this.lastY;this.dragMode==="orbit"?this.camera.orbit(-n,-o):this.camera.pan(n,o,this.canvas.clientHeight),this.lastX=e.clientX,this.lastY=e.clientY});H(this,"onPointerUp",e=>{if(e.pointerType==="touch"){this.pointers.delete(e.pointerId),this.updateTouchGestureState(),this.canvas.releasePointerCapture(e.pointerId);return}this.pointerId===e.pointerId&&(this.canvas.releasePointerCapture(e.pointerId),this.pointerId=null,this.dragMode=null)});H(this,"onWheel",e=>{e.preventDefault();const n=e.deltaY*3.3;this.camera.zoom(n)});H(this,"onKeyDown",e=>{e.code==="KeyP"&&this.camera.toggleProjection()});this.canvas=e,this.camera=n,this.attach()}attach(){this.canvas.addEventListener("pointerdown",this.onPointerDown),this.canvas.addEventListener("pointermove",this.onPointerMove),this.canvas.addEventListener("pointerup",this.onPointerUp),this.canvas.addEventListener("pointercancel",this.onPointerUp),this.canvas.addEventListener("wheel",this.onWheel,{passive:!1}),this.canvas.addEventListener("contextmenu",e=>{e.preventDefault()}),window.addEventListener("keydown",this.onKeyDown)}updateTouchGestureState(){const e=this.getTwoTouchPoints();if(!e){this.lastMidpoint=null,this.lastDistance=null;return}this.lastMidpoint=this.getMidpoint(e[0],e[1]),this.lastDistance=this.getDistance(e[0],e[1])}getTwoTouchPoints(){if(this.pointers.size<2)return null;const e=this.pointers.values(),n=e.next().value,o=e.next().value;return!n||!o?null:[n,o]}getMidpoint(e,n){return{x:(e.x+n.x)*.5,y:(e.y+n.y)*.5}}getDistance(e,n){return Math.hypot(n.x-e.x,n.y-e.y)}getDragMode(e){return e.shiftKey||e.button===1?"pan":e.button===0?"orbit":null}}const wn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
  @location(1) normal: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
  @location(0) normal: vec3<f32>,
  @location(1) worldPos: vec3<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  out.normal = normalize((object.model * vec4<f32>(input.normal, 0.0)).xyz);
  out.worldPos = worldPos.xyz;
  return out;
}

// Fade to the average coverage when the pattern is sub-pixel to avoid moire.
fn resolvePattern(value: f32, duty: f32, fw: f32) -> f32 {
  let safeFw = max(fw, 1e-5);
  let fade = clamp(0.5 / safeFw, 0.0, 1.0);
  let clampedDuty = clamp(duty, 0.0, 1.0);
  return mix(clampedDuty, value, fade);
}

// Derivative-based antialiasing for periodic line patterns in screen space.
fn aaLine(u: f32, spacing: f32, thickness: f32) -> f32 {
  let safeSpacing = max(spacing, 1e-5);
  let coord = u / safeSpacing;
  let dist = abs(fract(coord) - 0.5);
  let fw = fwidth(coord);
  let width = clamp(thickness / safeSpacing, 0.0, 1.0);
  let halfWidth = 0.5 * width;
  let line = 1.0 - smoothstep(halfWidth - fw, halfWidth + fw, dist);
  return resolvePattern(line, width, fw);
}

// Antialiased on/off pulse along a period (used for dash segments).
fn aaPulse(u: f32, period: f32, length: f32) -> f32 {
  let safePeriod = max(period, 1e-5);
  let coord = u / safePeriod;
  let phase = fract(coord);
  let fw = fwidth(coord);
  let duty = clamp(length / safePeriod, 0.0, 1.0);
  let head = smoothstep(0.0, fw, phase);
  let tail = 1.0 - smoothstep(duty - fw, duty + fw, phase);
  let pulse = head * tail;
  return resolvePattern(pulse, duty, fw);
}

fn lineMask(
  screenPx: vec2<f32>,
  normal: vec2<f32>,
  spacing: f32,
  thickness: f32
) -> f32 {
  let u = dot(screenPx, normal);
  return aaLine(u, spacing, thickness);
}

fn dashMask(screenPx: vec2<f32>) -> f32 {
  let rowSpacing = 9.0;
  let dashLength = 12.5;
  let dashPeriod = 36.0;
  let thickness = 0.25;
  let rowIndex = floor(screenPx.y / rowSpacing);
  let phase = f32(i32(rowIndex) % 3) * (dashPeriod / 3.0);
  let row = aaLine(screenPx.y, rowSpacing, thickness);
  let dash = aaPulse(screenPx.x + phase, dashPeriod, dashLength);
  return row * dash;
}

fn dashedLineMask(
  screenPx: vec2<f32>,
  normal: vec2<f32>,
  spacing: f32,
  thickness: f32,
  dashLength: f32,
  dashPeriod: f32,
  phase: f32
) -> f32 {
  let line = lineMask(screenPx, normal, spacing, thickness);
  let tangent = vec2<f32>(-normal.y, normal.x);
  let v = dot(screenPx, tangent) + phase;
  let dash = aaPulse(v, dashPeriod, dashLength);
  return line * dash;
}

fn gridMask(worldPos: vec3<f32>, spacing: f32) -> f32 {
  if (spacing <= 0.0) {
    return 0.0;
  }
  let s = max(1e-4, spacing);
  let thickness = 0.0075;
  let lineX = gridLineMask(worldPos.x, s, thickness);
  let lineZ = gridLineMask(worldPos.z, s, thickness);
  return max(lineX, lineZ);
}

fn gridLineMask(u: f32, spacing: f32, thickness: f32) -> f32 {
  let coord = u / spacing;
  let dist = abs(fract(coord) - 0.5);
  let fw = max(fwidth(coord), 1e-4);
  let halfWidth = 0.5 * (thickness / spacing);
  return 1.0 - smoothstep(halfWidth - fw, halfWidth + fw, dist);
}

@fragment
fn fsMain(input: VertexOut, @builtin(front_facing) isFront: bool) -> @location(0) vec4<f32> {
  let light = normalize(-frame.cameraDir);
  let n = normalize(input.normal);
  let shadeNormal = select(-n, n, isFront);
  var ndotl = 0.0;
  let fill = 0.4;
  let materialType = i32(round(object.material.y));
  let patternId = i32(round(object.material.x));
  let gridOnly = object.material.w;

  if (materialType == 1) {
    ndotl = abs(dot(n, light));
  } else {
    ndotl = max(dot(shadeNormal, light), 0.0);
  }

  let lightFactor = min(1.0, ndotl + fill);
  let base = object.color.rgb * lightFactor;

  if (materialType == 1) {
    let grid = gridMask(input.worldPos, object.material.z);
    let gridColor = vec3<f32>(0.55, 0.55, 0.55);
    if (gridOnly > 0.5) {
      if (grid <= 0.0) {
        discard;
      }
      let color = mix(base, gridColor, grid);
      return vec4<f32>(color, 1.0);
    }
    let color = mix(base, gridColor, grid);
    return vec4<f32>(color, object.color.a);
  }

  if (materialType == 3) {
    let viewDir = normalize(frame.cameraPos - input.worldPos);
    let fresnel = pow(1.0 - max(dot(shadeNormal, viewDir), 0.0), 3.0);
    let glassLight = mix(0.65, 1.0, ndotl);
    let glassBase = object.color.rgb * glassLight;
    let rim = mix(glassBase, vec3<f32>(1.0, 1.0, 1.0), 0.6);
    let keyLight = normalize(vec3<f32>(0.35, 0.85, 0.25));
    let halfVec = normalize(keyLight + viewDir);
    let spec = pow(max(dot(shadeNormal, halfVec), 0.0), 64.0);
    let color = mix(glassBase, rim, fresnel) + spec * 0.25;
    let alpha = clamp(object.color.a * (0.7 + 0.7 * fresnel), 0.0, 1.0);
    return vec4<f32>(color, alpha);
  }

  if (patternId == 0) {
    return vec4<f32>(base, object.color.a);
  }

  var u = 0.0;
  var v = 0.0;
  let an = abs(n);
  if (an.y >= an.x && an.y >= an.z) {
    u = input.worldPos.x;
    v = input.worldPos.z;
  } else if (an.x >= an.z) {
    u = input.worldPos.z;
    v = input.worldPos.y;
  } else {
    u = input.worldPos.x;
    v = input.worldPos.y;
  }
  let surfaceScale = max(object.material.w, 1e-4);
  let surfacePx = vec2(u, v) * surfaceScale;
  let normalA = vec2<f32>(-0.70710678, 0.70710678);
  let normalB = vec2<f32>(0.70710678, 0.70710678);

  var hatch = 0.0;
  if (patternId == 1) {
    let a = lineMask(surfacePx, normalA, 12.0, 0.25);
    let b = lineMask(surfacePx, normalB, 12.0, 0.25);
    hatch = max(a, b);
  } else if (patternId == 2) {
    hatch = dashedLineMask(surfacePx, normalA, 9.0, 0.25, 8.0, 10.0, 0.0);
  } else if (patternId == 3) {
    hatch = dashMask(surfacePx);
  }

  let ink = vec3<f32>(0.0, 0.0, 0.0);
  let color = mix(base, ink, hatch);
  return vec4<f32>(color, object.color.a);
}
`,In=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
  @location(1) normal: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  return out;
}

fn encodeId(id: u32) -> vec4<f32> {
  let r = f32((id >> 0u) & 0xFFu) / 255.0;
  let g = f32((id >> 8u) & 0xFFu) / 255.0;
  let b = f32((id >> 16u) & 0xFFu) / 255.0;
  let a = f32((id >> 24u) & 0xFFu) / 255.0;
  return vec4<f32>(r, g, b, a);
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  let id = u32(object.pick.x);
  return encodeId(id);
}
`,Pn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) start: vec3<f32>,
  @location(1) end: vec3<f32>,
  @location(2) side: f32,
  @location(3) along: f32,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

fn ndcToScreen(ndc: vec2<f32>, viewport: vec2<f32>) -> vec2<f32> {
  let x = (ndc.x * 0.5 + 0.5) * viewport.x;
  let y = (1.0 - (ndc.y * 0.5 + 0.5)) * viewport.y;
  return vec2<f32>(x, y);
}

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  let startClip = frame.viewProj * vec4<f32>(input.start, 1.0);
  let endClip = frame.viewProj * vec4<f32>(input.end, 1.0);
  let startNdc = startClip.xy / startClip.w;
  let endNdc = endClip.xy / endClip.w;

  let viewport = frame.viewport.xy;
  let startScreen = ndcToScreen(startNdc, viewport);
  let endScreen = ndcToScreen(endNdc, viewport);
  var dirScreen = endScreen - startScreen;
  let len = length(dirScreen);
  if (len < 1e-4) {
    dirScreen = vec2<f32>(1.0, 0.0);
  } else {
    dirScreen = dirScreen / len;
  }
  let perp = vec2<f32>(-dirScreen.y, dirScreen.x);
  let halfWidth = 3.0;
  let offsetScreen = perp * (halfWidth * input.side);
  let offsetNdc = vec2<f32>(
    offsetScreen.x * frame.viewport.z * 2.0,
    -offsetScreen.y * frame.viewport.w * 2.0
  );

  let baseClip = mix(startClip, endClip, input.along);
  let baseNdc = baseClip.xy / baseClip.w;
  let finalNdc = baseNdc + offsetNdc;

  var out: VertexOut;
  out.position = vec4<f32>(finalNdc * baseClip.w, baseClip.z, baseClip.w);
  return out;
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  return object.color;
}
`,Sn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  return out;
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  return object.color;
}

`,Tn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) aPos: vec3<f32>,
  @location(1) bPos: vec3<f32>,
  @location(2) n0: vec3<f32>,
  @location(3) n1: vec3<f32>,
  @location(4) side: f32,
  @location(5) along: f32,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
  @location(0) @interpolate(flat) lineA: vec2<f32>,
  @location(1) @interpolate(flat) lineB: vec2<f32>,
  @location(2) @interpolate(flat) visibility: f32,
};

fn ndcToScreen(ndc: vec2<f32>) -> vec2<f32> {
  let uv = ndc * 0.5 + vec2<f32>(0.5, 0.5);
  return vec2<f32>(uv.x * frame.viewport.x, (1.0 - uv.y) * frame.viewport.y);
}

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;

  let worldA = object.model * vec4<f32>(input.aPos, 1.0);
  let worldB = object.model * vec4<f32>(input.bPos, 1.0);
  let clipA = frame.viewProj * worldA;
  let clipB = frame.viewProj * worldB;

  let ndcA = clipA.xy / clipA.w;
  let ndcB = clipB.xy / clipB.w;
  let screenA = ndcToScreen(ndcA);
  let screenB = ndcToScreen(ndcB);
  out.lineA = screenA;
  out.lineB = screenB;

  let dir = screenB - screenA;
  let len = max(1e-4, length(dir));
  let tangent = dir / len;
  let normal = vec2<f32>(-tangent.y, tangent.x);

  let halfWidth = 1.0;
  let offsetPx = normal * (input.side * halfWidth);
  let offsetNdc = vec2<f32>(
    offsetPx.x * frame.viewport.z * 2.0,
    -offsetPx.y * frame.viewport.w * 2.0
  );

  let base = mix(clipA, clipB, input.along);
  let biasedZ = max(0.0, base.z);
  let shifted = vec4<f32>(
    base.xy + offsetNdc * base.w,
    biasedZ,
    base.w
  );
  out.position = shifted;

  out.visibility = 1.0;
  return out;
}

@fragment
fn fsMain(input: VertexOut) -> @location(0) vec4<f32> {
  if (input.visibility <= 0.0) {
    discard;
  }
  let a = input.lineA;
  let b = input.lineB;
  let ab = b - a;
  let len2 = max(1e-4, dot(ab, ab));

  let p = input.position.xy / frame.devicePixelRatio;
  let t = clamp(dot(p - a, ab) / len2, 0.0, 1.0);
  let proj = a + ab * t;
  let dist = length(p - proj);

  let halfWidth = 1.0;
  let aa = max(0.5, fwidth(dist));
  let mask = 1.0 - smoothstep(halfWidth - aa, halfWidth + aa, dist);
  return vec4<f32>(object.color.rgb, object.color.a * mask);
}
`,os={r:21/255,g:21/255,b:21/255,a:1},ss=3;class is{constructor(e,n,o,i){H(this,"pipeline");H(this,"terrainPipeline");H(this,"glassPipeline");H(this,"curvePipeline");H(this,"wireframePipeline");H(this,"edgePipeline");H(this,"edgeOccludedPipeline");H(this,"pickPipeline");H(this,"frameBindGroupLayout");H(this,"objectBindGroupLayout");H(this,"pipelineLayout");H(this,"frameUniformBuffer");H(this,"frameUniformData");H(this,"frameBindGroup");H(this,"depthTexture",null);H(this,"depthView",null);H(this,"pickTexture",null);H(this,"pickView",null);H(this,"pickDepthTexture",null);H(this,"pickDepthView",null);H(this,"pickBuffer",null);H(this,"objects",[]);H(this,"size",{width:0,height:0,dpr:1});H(this,"cameraDir",St());H(this,"clearColor",{...os});this.canvas=e,this.device=n,this.context=o,this.format=i,this.frameUniformData=new Float32Array(28),this.frameUniformBuffer=n.createBuffer({size:this.frameUniformData.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.frameBindGroupLayout=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.objectBindGroupLayout=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.pipelineLayout=n.createPipelineLayout({bindGroupLayouts:[this.frameBindGroupLayout,this.objectBindGroupLayout]}),this.pipeline=this.createPipeline("back"),this.terrainPipeline=this.createPipeline("none",!0),this.glassPipeline=this.createPipeline("none",!0,!1,"less-equal"),this.curvePipeline=this.createCurvePipeline(),this.wireframePipeline=this.createWireframePipeline(),this.edgePipeline=this.createEdgeHighlightPipeline("always"),this.edgeOccludedPipeline=this.createEdgeHighlightPipeline("less-equal"),this.pickPipeline=this.createPickPipeline(),this.frameBindGroup=n.createBindGroup({layout:this.frameBindGroupLayout,entries:[{binding:0,resource:{buffer:this.frameUniformBuffer}}]})}setObjects(e){this.objects=e}setClearColor(e){this.clearColor={...e}}createRenderObject(e,n,o,i,c,a){const r=Mn(o),l=Mn(r),d=[...i],f=[...c],p=[...c],h=new Float32Array(28);h.set(r,0),h.set(i,16),h.set(f,20),h.set([0,0,0,0],24);const x=this.device.createBuffer({size:h.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),I=this.device.createBindGroup({layout:this.objectBindGroupLayout,entries:[{binding:0,resource:{buffer:x}}]});return this.device.queue.writeBuffer(x,0,h),{id:e,mesh:n,modelMatrix:r,baseMatrix:l,color:i,baseColor:d,material:f,baseMaterial:p,objectType:a.objectType,layerIndex:a.layerIndex??0,visible:!0,soilId:a.soilId,sectionId:a.sectionId,profileId:a.profileId,pickId:0,edgeXray:!1,uniformBuffer:x,uniformData:h,bindGroup:I}}resize(){var i,c,a;const e=window.devicePixelRatio||1,n=Math.max(1,Math.floor(this.canvas.clientWidth*e)),o=Math.max(1,Math.floor(this.canvas.clientHeight*e));n===this.size.width&&o===this.size.height&&e===this.size.dpr||(this.size={width:n,height:o,dpr:e},this.canvas.width=n,this.canvas.height=o,this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"}),(i=this.depthTexture)==null||i.destroy(),this.depthTexture=this.device.createTexture({size:{width:n,height:o},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.depthView=this.depthTexture.createView(),(c=this.pickTexture)==null||c.destroy(),this.pickTexture=this.device.createTexture({size:{width:n,height:o},format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.pickView=this.pickTexture.createView(),(a=this.pickDepthTexture)==null||a.destroy(),this.pickDepthTexture=this.device.createTexture({size:{width:n,height:o},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.pickDepthView=this.pickDepthTexture.createView(),this.pickBuffer||(this.pickBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})))}getSize(){return this.size}render(e){if(this.objects.length===0)return;this.resize();const n=e.getViewProjMatrix(),o=e.getPosition();Je(this.cameraDir,e.target,o),Ot(this.cameraDir,this.cameraDir);const i=this.size.width/this.size.dpr,c=this.size.height/this.size.dpr;this.frameUniformData.set(n,0),this.frameUniformData.set([o[0],o[1],o[2],this.size.dpr],16),this.frameUniformData.set([this.cameraDir[0],this.cameraDir[1],this.cameraDir[2],0],20),this.frameUniformData.set([i,c,i>0?1/i:0,c>0?1/c:0],24),this.device.queue.writeBuffer(this.frameUniformBuffer,0,this.frameUniformData.buffer,this.frameUniformData.byteOffset,this.frameUniformData.byteLength);const a=e.mode==="perspective",r=a?c/(2*Math.tan(e.fov*.5)):c/(2*e.orthoScale),l=this.context.getCurrentTexture().createView(),d=this.device.createCommandEncoder(),f=d.beginRenderPass({colorAttachments:[{view:l,loadOp:"clear",storeOp:"store",clearValue:this.clearColor}],depthStencilAttachment:{view:this.depthView,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});f.setBindGroup(0,this.frameBindGroup);let p=null;for(const h of this.objects){if(!h.visible)continue;if(h.material[1]===0&&h.material[0]>0){const P=a?r/Math.max(e.distance,.01):r;h.material[3]=P}else h.material[1]!==1&&(h.material[3]=1);h.uniformData.set(h.modelMatrix,0),h.uniformData.set(h.color,16),h.uniformData.set(h.material,20),h.uniformData.set([h.pickId??0,0,0,0],24),this.device.queue.writeBuffer(h.uniformBuffer,0,h.uniformData.buffer,h.uniformData.byteOffset,h.uniformData.byteLength);const x=h.objectType==="solid"&&Math.round(h.material[1])===ss,I=h.objectType==="curve"?this.curvePipeline:h.objectType==="solidWireframe"?this.wireframePipeline:h.objectType==="solidEdge"?h.edgeXray?this.edgePipeline:this.edgeOccludedPipeline:x?this.glassPipeline:h.objectType==="terrain"||h.objectType==="solid"?this.terrainPipeline:this.pipeline;p!==I&&(f.setPipeline(I),p=I),f.setBindGroup(1,h.bindGroup),f.setVertexBuffer(0,h.mesh.vertexBuffer),f.draw(h.mesh.vertexCount,1,0,0)}f.end(),this.device.queue.submit([d.finish()])}async pick(e,n){if(!this.pickTexture||!this.pickView||!this.pickDepthView||!this.pickBuffer)return null;const o=Math.floor(e*this.size.dpr),i=Math.floor(n*this.size.dpr);if(o<0||i<0||o>=this.size.width||i>=this.size.height)return null;const c=this.device.createCommandEncoder(),a=c.beginRenderPass({colorAttachments:[{view:this.pickView,loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:0}}],depthStencilAttachment:{view:this.pickDepthView,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});a.setPipeline(this.pickPipeline),a.setBindGroup(0,this.frameBindGroup);for(const d of this.objects)!d.visible||!d.pickId||(a.setBindGroup(1,d.bindGroup),a.setVertexBuffer(0,d.mesh.vertexBuffer),a.draw(d.mesh.vertexCount,1,0,0));a.end(),c.copyTextureToBuffer({texture:this.pickTexture,origin:{x:o,y:i}},{buffer:this.pickBuffer,bytesPerRow:256},{width:1,height:1,depthOrArrayLayers:1}),this.device.queue.submit([c.finish()]),await this.pickBuffer.mapAsync(GPUMapMode.READ);const r=new Uint8Array(this.pickBuffer.getMappedRange()),l=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;return this.pickBuffer.unmap(),l===0?null:l}createPipeline(e,n=!1,o=!0,i="less"){const c=[{format:this.format}];return n&&(c[0].blend={color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}),this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:wn}),entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{module:this.device.createShaderModule({code:wn}),entryPoint:"fsMain",targets:c},primitive:{topology:"triangle-list",cullMode:e},depthStencil:{format:"depth24plus",depthWriteEnabled:o,depthCompare:i}})}createCurvePipeline(){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:Pn}),entryPoint:"vsMain",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32"},{shaderLocation:3,offset:28,format:"float32"}]}]},fragment:{module:this.device.createShaderModule({code:Pn}),entryPoint:"fsMain",targets:[{format:this.format,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less-equal",format:"depth24plus"}})}createWireframePipeline(e="less-equal"){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:Sn}),entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]}]},fragment:{module:this.device.createShaderModule({code:Sn}),entryPoint:"fsMain",targets:[{format:this.format}]},primitive:{topology:"line-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:e}})}createEdgeHighlightPipeline(e){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:Tn}),entryPoint:"vsMain",buffers:[{arrayStride:14*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:6*4,format:"float32x3"},{shaderLocation:3,offset:9*4,format:"float32x3"},{shaderLocation:4,offset:12*4,format:"float32"},{shaderLocation:5,offset:13*4,format:"float32"}]}]},fragment:{module:this.device.createShaderModule({code:Tn}),entryPoint:"fsMain",targets:[{format:this.format,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:e}})}createPickPipeline(){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:In}),entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{module:this.device.createShaderModule({code:In}),entryPoint:"fsMain",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}})}}async function rs(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load scene: ${e.status}`);return await e.json()}function cs(t){const e=new Float32Array([.5,-.5,-.5,1,0,0,.5,.5,-.5,1,0,0,.5,.5,.5,1,0,0,.5,-.5,-.5,1,0,0,.5,.5,.5,1,0,0,.5,-.5,.5,1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0,-.5,-.5,-.5,-1,0,0,-.5,.5,-.5,0,1,0,-.5,.5,.5,0,1,0,.5,.5,.5,0,1,0,-.5,.5,-.5,0,1,0,.5,.5,.5,0,1,0,.5,.5,-.5,0,1,0,-.5,-.5,.5,0,-1,0,-.5,-.5,-.5,0,-1,0,.5,-.5,-.5,0,-1,0,-.5,-.5,.5,0,-1,0,.5,-.5,-.5,0,-1,0,.5,-.5,.5,0,-1,0,-.5,-.5,.5,0,0,1,.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,.5,.5,0,0,1,.5,-.5,-.5,0,0,-1,-.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,.5,-.5,0,0,-1]),n=t.createBuffer({size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(n,0,e),{vertexBuffer:n,vertexCount:e.length/6}}const as=1e-6;function ls(t,e){if(e.length<2)return zn(t);const n=[],o=(a,r,l,d)=>{n.push(a[0],a[1],a[2],r[0],r[1],r[2],l,d)};for(let a=0;a<e.length-1;a+=1){const r=e[a],l=e[a+1],d=l[0]-r[0],f=l[1]-r[1],p=l[2]-r[2];d*d+f*f+p*p<=as||(o(r,l,-1,0),o(r,l,1,0),o(r,l,1,1),o(r,l,-1,0),o(r,l,1,1),o(r,l,-1,1))}const i=new Float32Array(n);if(i.length===0)return zn(t);const c=t.createBuffer({size:i.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(c,0,i),{vertexBuffer:c,vertexCount:i.length/8}}function zn(t){return{vertexBuffer:t.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}function Nn(t,e,n,o,i=.02){const c=[],a=(d,f,p,h,x,I)=>{c.push(d,f,p,h,x,I)};for(let d=0;d<e.length-1;d+=1){const[f,p]=e[d],[h,x]=e[d+1],I=h-f,P=x-p,b=Math.hypot(I,P);if(b<1e-4)continue;const M=P/b,B=-I/b,z=M*i,C=B*i,v=f+z,S=p+C,T=h+z,F=x+C,Y=n,L=n,G=o,V=o;a(v,Y,S,M,0,B),a(T,G,F,M,0,B),a(T,L,F,M,0,B),a(v,Y,S,M,0,B),a(v,V,S,M,0,B),a(T,G,F,M,0,B),a(v,Y,S,-M,0,-B),a(T,L,F,-M,0,-B),a(T,G,F,-M,0,-B),a(v,Y,S,-M,0,-B),a(T,G,F,-M,0,-B),a(v,V,S,-M,0,-B)}const r=new Float32Array(c),l=t.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(l,0,r),{vertexBuffer:l,vertexCount:r.length/6}}const fs=1e-6;function ds(t,e,n,o){const i=Math.floor(e.length/2),c=Math.floor(o.length/3);if(i<3||n.length!==i||c<1||o.length!==c*3)return Cn(t);const a=new Float32Array(i),r=new Float32Array(i),l=new Float32Array(i),d=M=>e[M*2],f=M=>e[M*2+1],p=M=>n[M];for(let M=0;M<o.length;M+=3){let B=o[M]|0,z=o[M+1]|0,C=o[M+2]|0;if(B<0||z<0||C<0||B>=i||z>=i||C>=i)continue;const v=d(B),S=f(B),T=d(z),F=f(z),Y=d(C),L=f(C);if((T-v)*(L-S)-(F-S)*(Y-v)<0){const J=z;z=C,C=J}const V=p(B),A=p(z),k=p(C),U=T-v,g=A-V,y=F-S,m=Y-v,w=k-V,N=L-S,R=g*N-y*w,D=y*m-U*N,X=U*w-g*m;a[B]+=R,r[B]+=D,l[B]+=X,a[z]+=R,r[z]+=D,l[z]+=X,a[C]+=R,r[C]+=D,l[C]+=X}const h=new Float32Array(i*3);for(let M=0;M<i;M+=1){const B=a[M],z=r[M],C=l[M],v=Math.hypot(B,z,C);if(v<=fs){h[M*3]=0,h[M*3+1]=1,h[M*3+2]=0;continue}h[M*3]=B/v,h[M*3+1]=z/v,h[M*3+2]=C/v}const x=[],I=M=>{x.push(d(M),p(M),f(M),h[M*3],h[M*3+1],h[M*3+2])};for(let M=0;M<o.length;M+=3){let B=o[M]|0,z=o[M+1]|0,C=o[M+2]|0;if(B<0||z<0||C<0||B>=i||z>=i||C>=i)continue;const v=d(B),S=f(B),T=d(z),F=f(z),Y=d(C),L=f(C);if((T-v)*(L-S)-(F-S)*(Y-v)<0){const V=z;z=C,C=V}I(B),I(z),I(C)}const P=new Float32Array(x);if(P.length===0)return Cn(t);const b=t.createBuffer({size:P.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(b,0,P),{vertexBuffer:b,vertexCount:P.length/6}}function Cn(t){return{vertexBuffer:t.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}const hs=1e-6,Jt=6,us=(t,e,n)=>Math.min(Math.max(t,e),n),ps=(t,e,n)=>{const o=Math.hypot(t,e,n);return o<=hs?null:[t/o,e/o,n/o]},Ye=1e-5,En=(t,e,n)=>{const o=Math.round(t/Ye),i=Math.round(e/Ye),c=Math.round(n/Ye);return`${o},${i},${c}`};function ms(t,e){if(t.length===0)return t;const n=new Map,o=[],i=(r,l,d,f,p,h)=>{o.push(r[0],r[1],r[2],l[0],l[1],l[2],d[0],d[1],d[2],f[0],f[1],f[2],p,h)},c=(r,l,d,f)=>{i(r,l,d,f,-1,0),i(r,l,d,f,1,0),i(r,l,d,f,1,1),i(r,l,d,f,-1,0),i(r,l,d,f,1,1),i(r,l,d,f,-1,1)},a=(r,l,d)=>{const f=En(r[0],r[1],r[2]),p=En(l[0],l[1],l[2]),h=f<p?`${f}|${p}`:`${p}|${f}`,x=n.get(h);if(!x){n.set(h,{a:r,b:l,normals:[d]});return}x.normals.push(d)};for(let r=0;r+Jt*3-1<t.length;r+=Jt*3){const l=t[r],d=t[r+1],f=t[r+2],p=t[r+Jt],h=t[r+Jt+1],x=t[r+Jt+2],I=t[r+Jt*2],P=t[r+Jt*2+1],b=t[r+Jt*2+2],M=p-l,B=h-d,z=x-f,C=I-l,v=P-d,S=b-f,T=B*S-z*v,F=z*C-M*S,Y=M*v-B*C,L=ps(T,F,Y);if(!L)continue;const G=[l,d,f],V=[p,h,x],A=[I,P,b];a(G,V,L),a(V,A,L),a(A,G,L)}for(const r of n.values()){const l=r.normals;if(l.length===1){c(r.a,r.b,l[0],l[0]);continue}let d=1,f=null,p=null;for(let h=0;h<l.length;h+=1){const x=l[h];for(let I=h+1;I<l.length;I+=1){const P=l[I],b=us(x[0]*P[0]+x[1]*P[1]+x[2]*P[2],-1,1);b<d&&(d=b,f=x,p=P)}}f&&p&&d<e&&c(r.a,r.b,f,p)}return o.length>0?new Float32Array(o):new Float32Array}const Gt=1e-6,xs=Math.cos(40*Math.PI/180);function Re(t,e,n=6){if(e.length===0)return _n(t);const o=t.createBuffer({size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(o,0,e),{vertexBuffer:o,vertexCount:e.length/n}}function gs(t){if(t.length===0)return t;const e=new Float32Array(t.length*2);let n=0;for(let o=0;o+17<t.length;o+=18){const i=o,c=o+6,a=o+12;for(let r=0;r<6;r+=1)e[n++]=t[i+r];for(let r=0;r<6;r+=1)e[n++]=t[c+r];for(let r=0;r<6;r+=1)e[n++]=t[c+r];for(let r=0;r<6;r+=1)e[n++]=t[a+r];for(let r=0;r<6;r+=1)e[n++]=t[a+r];for(let r=0;r<6;r+=1)e[n++]=t[i+r]}return e}function ys(t,e){const n=Math.floor(e.length/3),o=new Int32Array(n*3);for(let i=0;i<n;i+=1){const c=i*3,a=e[c]|0;let r=e[c+1]|0,l=e[c+2]|0;const d=t[a*2],f=t[a*2+1],p=t[r*2],h=t[r*2+1],x=t[l*2],I=t[l*2+1];if((p-d)*(I-f)-(h-f)*(x-d)<0){const b=r;r=l,l=b}o[c]=a,o[c+1]=r,o[c+2]=l}return o}function kn(t,e,n,o){const i=Math.floor(t.length/2),c=new Float32Array(i*3);for(let a=0;a<n.length;a+=3){const r=n[a],l=n[a+1],d=n[a+2];if(r<0||l<0||d<0||r>=i||l>=i||d>=i)continue;const f=t[r*2],p=t[r*2+1],h=e[r],x=t[l*2],I=t[l*2+1],P=e[l],b=t[d*2],M=t[d*2+1],B=e[d],z=x-f,C=P-h,v=I-p,S=b-f,T=B-h,F=M-p;let Y,L,G;o==="up"?(Y=C*F-v*T,L=v*S-z*F,G=z*T-C*S):(Y=T*v-F*C,L=F*z-S*v,G=S*C-T*z),c[r*3]+=Y,c[r*3+1]+=L,c[r*3+2]+=G,c[l*3]+=Y,c[l*3+1]+=L,c[l*3+2]+=G,c[d*3]+=Y,c[d*3+1]+=L,c[d*3+2]+=G}for(let a=0;a<i;a+=1){const r=c[a*3],l=c[a*3+1],d=c[a*3+2],f=Math.hypot(r,l,d);if(f<=Gt){c[a*3]=0,c[a*3+1]=o==="up"?1:-1,c[a*3+2]=0;continue}c[a*3]=r/f,c[a*3+1]=l/f,c[a*3+2]=d/f}return c}function Ms(t,e,n,o,i,c,a){const r=Math.floor(t.length/2),l=Math.floor(e.length/3);if(r<3||n.length!==r||o.length!==r||l<1||e.length!==l*3)return new Float32Array(0);const d=ys(t,e),f=i&&i.length===r*3?i:kn(t,n,d,"up"),p=c&&c.length===r*3?c:kn(t,o,d,"down"),h=[],x=(g,y)=>{h.push(g[0],g[1],g[2],y[0],y[1],y[2])},I=(g,y,m)=>{const w=g[0]+(y[0]-g[0])*m,N=g[1]+(y[1]-g[1])*m,R=g[2]+(y[2]-g[2])*m,D=Math.hypot(w,N,R);return D<=Gt?[0,1,0]:[w/D,N/D,R/D]},P=Gt,b=g=>{const y=[];for(let m=0;m<g.length;m+=1){const w=g[m],N=g[(m+1)%g.length],R=w.thickness>P,D=N.thickness>P;if(R&&D){y.push(N);continue}if(R===D)continue;const X=N.thickness-w.thickness;if(Math.abs(X)<=Gt){D&&y.push(N);continue}const J=(P-w.thickness)/X,nt=w.x+(N.x-w.x)*J,Z=w.z+(N.z-w.z)*J,ct=w.yTop+(N.yTop-w.yTop)*J,at=w.yBottom+(N.yBottom-w.yBottom)*J,st=.5*(ct+at);y.push({x:nt,z:Z,yTop:st,yBottom:st,thickness:0,nTop:I(w.nTop,N.nTop,J),nBottom:I(w.nBottom,N.nBottom,J)}),D&&y.push(N)}return y},M=g=>{if(!(g.length<3)){for(let y=1;y+1<g.length;y+=1){const m=g[0],w=g[y],N=g[y+1];x([m.x,m.yTop,m.z],m.nTop),x([w.x,w.yTop,w.z],w.nTop),x([N.x,N.yTop,N.z],N.nTop)}for(let y=1;y+1<g.length;y+=1){const m=g[0],w=g[y],N=g[y+1];x([m.x,m.yBottom,m.z],m.nBottom),x([N.x,N.yBottom,N.z],N.nBottom),x([w.x,w.yBottom,w.z],w.nBottom)}}},B=(g,y,m)=>{g.thickness<=P&&y.thickness<=P&&m.thickness<=P||M(b([g,y,m]))},z=1e-5,C=new Int32Array(r),v=[],S=new Map;for(let g=0;g<r;g+=1){const y=t[g*2],m=t[g*2+1],w=Math.round(y/z),N=Math.round(m/z),R=`${w},${N}`;let D=S.get(R);D===void 0&&(D=v.length,S.set(R,D),v.push(g)),C[g]=D}const T=a&&a.length>=3?a:e,F=new Map,Y=(g,y)=>{const m=g<y?g:y,w=g<y?y:g;return BigInt(m)<<32n|BigInt(w)},L=(g,y,m)=>{const w=Y(g,y),N=F.get(w);if(!N){F.set(w,{a:g,b:y,c:m,count:1});return}N.count+=1};for(let g=0;g+2<T.length;g+=3){const y=T[g]|0,m=T[g+1]|0,w=T[g+2]|0;if(y<0||m<0||w<0||y>=r||m>=r||w>=r)continue;const N=C[y],R=C[m],D=C[w],X=[],J=(nt,Z,ct)=>{if(nt===Z)return;const at=Y(nt,Z);for(const st of X)if(st===at)return;X.push(at),L(nt,Z,ct)};J(N,R,D),J(R,D,N),J(D,N,R)}for(let g=0;g<d.length;g+=3){const y=d[g],m=d[g+1],w=d[g+2];if(y<0||m<0||w<0||y>=r||m>=r||w>=r)continue;const N=t[y*2],R=t[y*2+1],D=t[m*2],X=t[m*2+1],J=t[w*2],nt=t[w*2+1],Z={x:N,z:R,yTop:n[y],yBottom:o[y],thickness:n[y]-o[y],nTop:[f[y*3],f[y*3+1],f[y*3+2]],nBottom:[p[y*3],p[y*3+1],p[y*3+2]]},ct={x:D,z:X,yTop:n[m],yBottom:o[m],thickness:n[m]-o[m],nTop:[f[m*3],f[m*3+1],f[m*3+2]],nBottom:[p[m*3],p[m*3+1],p[m*3+2]]},at={x:J,z:nt,yTop:n[w],yBottom:o[w],thickness:n[w]-o[w],nTop:[f[w*3],f[w*3+1],f[w*3+2]],nBottom:[p[w*3],p[w*3+1],p[w*3+2]]};B(Z,ct,at)}const G=(g,y)=>{const m=g.thickness>P,w=y.thickness>P;if(m&&w)return[g,y];if(!m&&!w)return[];const N=y.thickness-g.thickness;if(Math.abs(N)<=Gt)return m?[g]:[];const R=(P-g.thickness)/N,D=g.x+(y.x-g.x)*R,X=g.z+(y.z-g.z)*R,J=g.yTop+(y.yTop-g.yTop)*R,nt=g.yBottom+(y.yBottom-g.yBottom)*R,Z={x:D,z:X,yTop:J,yBottom:nt,thickness:P};return m?[g,Z]:[Z,y]},V=(g,y,m)=>{const w=[g.x,g.yTop,g.z],N=[y.x,y.yTop,y.z],R=[g.x,g.yBottom,g.z],D=[y.x,y.yBottom,y.z],X=N[0]-w[0],J=N[1]-w[1],nt=N[2]-w[2],Z=D[0]-w[0],ct=D[1]-w[1],at=D[2]-w[2],st=J*at-nt*ct,ht=nt*Z-X*at,dt=X*ct-J*Z;if(st*m[0]+ht*m[1]+dt*m[2]>=0){x(w,m),x(N,m),x(D,m),x(w,m),x(D,m),x(R,m);return}x(w,m),x(D,m),x(N,m),x(w,m),x(R,m),x(D,m)},A=.001,k=1e-4,U=(g,y)=>{for(let m=0;m<d.length;m+=3){const w=d[m],N=d[m+1],R=d[m+2];if(w<0||N<0||R<0||w>=r||N>=r||R>=r)continue;const D=t[w*2],X=t[w*2+1],J=t[N*2],nt=t[N*2+1],Z=t[R*2],ct=t[R*2+1],at=J-D,st=nt-X,ht=Z-D,dt=ct-X,bt=g-D,zt=y-X,wt=at*dt-st*ht;if(Math.abs(wt)<=Gt)continue;const mt=(bt*dt-zt*ht)/wt,Nt=(at*zt-st*bt)/wt,yt=1-mt-Nt;if(yt>=-Gt&&mt>=-Gt&&Nt>=-Gt){const Bt=n[w]*yt+n[N]*mt+n[R]*Nt,Mt=o[w]*yt+o[N]*mt+o[R]*Nt;return Bt-Mt}}return null};for(const g of F.values()){if(g.count!==1)continue;const y=v[g.a],m=v[g.b],w=v[g.c];if(y===void 0||m===void 0||w===void 0)continue;const N=t[y*2],R=t[y*2+1],D=t[m*2],X=t[m*2+1],J=.5*(N+D),nt=.5*(R+X),Z=D-N;let at=X-R,st=-Z;const ht=Math.hypot(at,st);if(ht<=Gt)continue;const dt=[at/ht,0,st/ht],bt=U(J+dt[0]*A,nt+dt[2]*A),zt=U(J-dt[0]*A,nt-dt[2]*A),wt=bt!==null&&bt>k,mt=zt!==null&&zt>k;if(wt&&mt)continue;const Nt=wt?[-dt[0],0,-dt[2]]:dt,yt={x:N,z:R,yTop:n[y],yBottom:o[y],thickness:n[y]-o[y]},Bt={x:D,z:X,yTop:n[m],yBottom:o[m],thickness:n[m]-o[m]},Mt=G(yt,Bt);Mt.length===2&&V(Mt[0],Mt[1],Nt)}return new Float32Array(h)}function Un(t,e,n,o,i,c,a,r){const l=Math.floor(e.length/2),d=Math.floor(n.length/3);if(l<3||d<1||e.length!==l*2||n.length!==d*3||o.length!==l||i.length!==l){const I=_n(t);return{solid:I,wireframe:I,edges:I}}const f=Ms(e,n,o,i,c,a,r),p=Re(t,f),h=Re(t,gs(f)),x=Re(t,ms(f,xs),14);return{solid:p,wireframe:h,edges:x}}function _n(t){return{vertexBuffer:t.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}const Yt=1e-6;function vs(t){const e=t.worldPath,n=e[0],o=e[e.length-1],i=o[0]-n[0],c=o[1]-n[1],a=Math.hypot(i,c),r=a>Yt?i/a:1,l=a>Yt?c/a:0,d=Number.isFinite(t.sScale)&&t.sScale>0?t.sScale:t.LWorld&&t.sMaxCad?t.LWorld/t.sMaxCad:1,f=-l,p=r,h=Math.hypot(f,p),x=h>Yt?[f/h,0,p/h]:[0,0,1];return{origin:[n[0],n[1]],direction:[r,l],normal:x,sScale:d}}function Gn(t,e){const n=t[0]*e.sScale,o=e.origin[0]+e.direction[0]*n,i=e.origin[1]+e.direction[1]*n;return[o,t[1],i]}function bs(t,e,n){const o=[],i=(d,f)=>{o.push(d[0],d[1],d[2],f[0],f[1],f[2])},c=e.normal,a=[-c[0],-c[1],-c[2]];for(const d of n){const f=ws(d);if(f.length<3)continue;const p=Ps(f);if(p.length===0)continue;const h=f.map(x=>Gn(x,e));for(let x=0;x<p.length;x+=3){const I=p[x],P=p[x+1],b=p[x+2],M=h[I],B=h[P],z=h[b];i(M,c),i(B,c),i(z,c),i(M,a),i(z,a),i(B,a)}}const r=new Float32Array(o),l=t.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(l,0,r),{vertexBuffer:l,vertexCount:r.length/6}}function ws(t){if(t.length<3)return[];const e=[];for(const c of t){const a=e[e.length-1];(!a||Math.hypot(c[0]-a[0],c[1]-a[1])>Yt)&&e.push([c[0],c[1]])}if(e.length<3)return[];const n=e[0],o=e[e.length-1];if(Math.hypot(n[0]-o[0],n[1]-o[1])<=Yt&&e.pop(),e.length<3)return[];const i=Is(e);return i.length<3?[]:(Ss(i)<0&&i.reverse(),i)}function Is(t){const e=[],n=t.length;for(let o=0;o<n;o+=1){const i=t[(o-1+n)%n],c=t[o],a=t[(o+1)%n],r=me(i,c,a),l=c[0]-i[0],d=c[1]-i[1],f=a[0]-c[0],p=a[1]-c[1],h=l*f+d*p;Math.abs(r)<Yt&&h>0||e.push(c)}return e}function Ps(t){const e=[],n=t.length;if(n<3)return e;const o=Array.from({length:n},(a,r)=>r);let i=0;const c=n*n;for(;o.length>=3&&i<c;){i+=1;let a=!1;for(let r=0;r<o.length;r+=1){const l=o[(r-1+o.length)%o.length],d=o[r],f=o[(r+1)%o.length],p=t[l],h=t[d],x=t[f];if(!Ts(p,h,x))continue;let I=!1;for(let P=0;P<o.length;P+=1){const b=o[P];if(!(b===l||b===d||b===f)&&zs(t[b],p,h,x)){I=!0;break}}if(!I){e.push(l,d,f),o.splice(r,1),a=!0;break}}if(!a){for(let r=1;r<o.length-1;r+=1)e.push(o[0],o[r],o[r+1]);break}}return e}function me(t,e,n){return(e[0]-t[0])*(n[1]-t[1])-(e[1]-t[1])*(n[0]-t[0])}function Ss(t){let e=0;for(let n=0;n<t.length;n+=1){const o=t[n],i=t[(n+1)%t.length];e+=o[0]*i[1]-i[0]*o[1]}return e*.5}function Ts(t,e,n){return me(t,e,n)>Yt}function zs(t,e,n,o){const i=me(e,n,t),c=me(n,o,t),a=me(o,e,t);return i>=-Yt&&c>=-Yt&&a>=-Yt}function Ns(t){const e=new Float32Array([-.5,0,-.5,0,1,0,.5,0,.5,0,1,0,.5,0,-.5,0,1,0,-.5,0,-.5,0,1,0,-.5,0,.5,0,1,0,.5,0,.5,0,1,0]),n=t.createBuffer({size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(n,0,e),{vertexBuffer:n,vertexCount:e.length/6}}const De=[.7,.7,.7],Cs=[.12,.5,.18],qe=[.18,.9,.2],We={landfill:1,silt:2,clay:3},Es=.25,$e=(t,e,n)=>{let o=n;return o<0?o+=1:o>1&&(o-=1),o<1/6?t+(e-t)*6*o:o<1/2?e:o<2/3?t+(e-t)*(2/3-o)*6:t},ks=(t,e)=>{const n=t[0],o=t[1],i=t[2],c=Math.max(n,o,i),a=Math.min(n,o,i);let r=0,l=0,d=(c+a)*.5;if(c!==a){const h=c-a;l=d>.5?h/(2-c-a):h/(c+a),c===n?r=(o-i)/h+(o<i?6:0):c===o?r=(i-n)/h+2:r=(n-o)/h+4,r/=6}if(d=Math.min(1,Math.max(0,d+e)),l===0)return[d,d,d];const f=d<.5?d*(1+l):d+l-d*l,p=2*d-f;return[$e(p,f,r+1/3),$e(p,f,r),$e(p,f,r-1/3)]};function As(t,e,n){var p;const o=new Map,i=[],c=te(),a=Te(),r={min:[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],max:[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]},l=new Map(n.soils.map(h=>[h.id,h])),d=n.objects.find(h=>h.type==="terrain")??null;let f=!1;if(n.solidsModel){const h=n.solidsModel,x=h.surfaces.terrain;if(x&&Array.isArray(x)){const I=h.mesh,P=Math.floor(I.verticesXZ.length/2);if(P>2&&x.length===P){const b=ds(t,I.verticesXZ,x,I.triangles);if(b.vertexCount>0){const M=(d==null?void 0:d.color)??Cs,z=[0,1,(d==null?void 0:d.gridScale)??1,0],C=e.createRenderObject((d==null?void 0:d.id)??"terrain",b,c,[M[0],M[1],M[2],1],z,{objectType:"terrain"});i.push(C),f=!0}}}}if((p=n.solidsModel)!=null&&p.sectionCurves)for(const h of n.solidsModel.sectionCurves){if(!h.points||h.points.length<2)continue;const x=ls(t,h.points);if(x.vertexCount===0)continue;const I=[0,0,0,0],P=e.createRenderObject(`curve_${h.id}`,x,c,[qe[0],qe[1],qe[2],1],I,{objectType:"curve"});i.push(P)}for(const h of n.objects){if(h.type!=="terrain"&&h.type!=="marker"||h.type==="terrain"&&f)continue;const x=Bs(t,h,o),I=Fs(h),P=h.soilId?l.get(h.soilId):void 0,b=h.color??(P==null?void 0:P.color)??De,M=h.type==="terrain"?1:h.type==="marker"?2:0,B=h.patternId??(P==null?void 0:P.patternId)??(h.soilId?We[h.soilId]:0)??0,z=M===0?B:0,C=h.gridScale??1,v=[z,M,C,0],S=e.createRenderObject(h.id,x,I,[b[0],b[1],b[2],1],v,{objectType:h.type,soilId:h.soilId});i.push(S),Ls(r,h)}if(n.solidsModel){const h=n.solidsModel,{extent:x,surfaces:I,solids:P}=h,{verticesXZ:b,triangles:M}=h.mesh,B=Math.floor(b.length/2);let z=0;if(B>2)for(const S of P){const T=I[S.top],F=I[S.bottom];if(!T||!F||T.length!==B||F.length!==B){z+=1;continue}const{solid:Y,wireframe:L,edges:G}=Un(t,b,M,T,F);if(Y.vertexCount===0){z+=1;continue}const V=l.get(S.soilId),A=(V==null?void 0:V.color)??De,U=[(V==null?void 0:V.patternId)??We[S.soilId]??0,0,0,0],g=e.createRenderObject(`solid_${S.id}`,Y,c,[A[0],A[1],A[2],1],U,{objectType:"solid",soilId:S.soilId,layerIndex:z});if(i.push(g),L.vertexCount>0){const y=[0,2,0,0],m=e.createRenderObject(`solid_${S.id}_wireframe`,L,c,[A[0],A[1],A[2],1],y,{objectType:"solidWireframe",soilId:S.soilId,layerIndex:z});i.push(m)}if(G.vertexCount>0){const y=ks(A,Es),m=[0,2,0,0],w=e.createRenderObject(`solid_${S.id}_edge`,G,c,[y[0],y[1],y[2],1],m,{objectType:"solidEdge",soilId:S.soilId,layerIndex:z});i.push(w)}z+=1}const C=I.terrain,v=C&&Array.isArray(C)&&C.length>0?Os(C,x.yBase):x.yBase;r.min[0]=Math.min(r.min[0],x.xMin),r.max[0]=Math.max(r.max[0],x.xMax),r.min[2]=Math.min(r.min[2],x.zMin),r.max[2]=Math.max(r.max[2],x.zMax),r.min[1]=Math.min(r.min[1],x.yBase),r.max[1]=Math.max(r.max[1],v)}if(n.sections&&n.sections.length>0){const h=r.min[1],x=r.max[1];for(const I of n.sections)if(I.vector){const P=vs(I.vector);let b=!1;for(const[M,B]of Object.entries(I.vector.patches)){if(!B.rings||B.rings.length===0)continue;const z=bs(t,P,B.rings);if(z.vertexCount===0)continue;const C=l.get(M),v=(C==null?void 0:C.color)??De,T=[(C==null?void 0:C.patternId)??We[M]??0,0,0,0],F=e.createRenderObject(`section_${I.id}_${M}`,z,c,[v[0],v[1],v[2],1],T,{objectType:"section",sectionId:I.id,soilId:M});i.push(F),b=!0}if(b)Vs(r,P,I.vector);else{const M=Nn(t,I.path,h,x),B=[.788,.392,.788],z=[0,2,0,0],C=e.createRenderObject(`section_${I.id}`,M,c,[B[0],B[1],B[2],1],z,{objectType:"section",sectionId:I.id});i.push(C),An(r,I,h,x)}}else{const P=Nn(t,I.path,h,x),b=[.788,.392,.788],M=[0,2,0,0],B=e.createRenderObject(`section_${I.id}`,P,c,[b[0],b[1],b[2],1],M,{objectType:"section",sectionId:I.id});i.push(B),An(r,I,h,x)}}if(n.profiles&&n.profiles.length>0){const h=Yn(t,o,"box"),x=.35,I=.08,P=[.43,.91,1];for(const b of n.profiles){const M=b.position.x,B=b.position.y,z=b.position.zGround,C=Math.max(b.depth,.01),v=te();Qe(v,a,Tt(M,z,B),Tt(x,x,x));const S=te();Qe(S,a,Tt(M,z-C*.5,B),Tt(I*2,C,I*2));const T=[0,2,0,0],F=e.createRenderObject(`profile_${b.id}_marker`,h,v,[P[0],P[1],P[2],1],T,{objectType:"profile",profileId:b.id}),Y=e.createRenderObject(`profile_${b.id}_shaft`,h,S,[P[0],P[1],P[2],1],T,{objectType:"profile",profileId:b.id});i.push(F,Y),js(r,b,x,I)}}return{objects:i,bounds:r,data:n}}function Bs(t,e,n){const o=e.mesh.primitive;return Yn(t,n,o)}function Yn(t,e,n){const o=e.get(n);if(o)return o;let i;return n==="plane"?i=Ns(t):i=cs(t),e.set(n,i),i}function Fs(t){const e=t.position??[0,0,0],n=t.rotation??[0,0,0],o=t.scale??[1,1,1],i=t.mesh.size??[1,1,1],c=[o[0]*i[0],o[1]*i[1],o[2]*i[2]],a=Te();ts(a,n[0],n[1],n[2]);const r=te();return Qe(r,a,Tt(e[0],e[1],e[2]),Tt(c[0],c[1],c[2])),r}function Ls(t,e){const n=e.position??[0,0,0],o=e.mesh.size??[1,1,1],i=e.scale??[1,1,1],c=[o[0]*i[0]*.5,o[1]*i[1]*.5,o[2]*i[2]*.5],a=[n[0]-c[0],n[1]-c[1],n[2]-c[2]],r=[n[0]+c[0],n[1]+c[1],n[2]+c[2]];t.min[0]=Math.min(t.min[0],a[0]),t.min[1]=Math.min(t.min[1],a[1]),t.min[2]=Math.min(t.min[2],a[2]),t.max[0]=Math.max(t.max[0],r[0]),t.max[1]=Math.max(t.max[1],r[1]),t.max[2]=Math.max(t.max[2],r[2])}function An(t,e,n,o){for(const[i,c]of e.path)t.min[0]=Math.min(t.min[0],i),t.min[2]=Math.min(t.min[2],c),t.max[0]=Math.max(t.max[0],i),t.max[2]=Math.max(t.max[2],c);t.min[1]=Math.min(t.min[1],n),t.max[1]=Math.max(t.max[1],o)}function Vs(t,e,n){for(const o of Object.values(n.patches))for(const i of o.rings)for(const c of i){const a=Gn([c[0],c[1]],e);t.min[0]=Math.min(t.min[0],a[0]),t.min[1]=Math.min(t.min[1],a[1]),t.min[2]=Math.min(t.min[2],a[2]),t.max[0]=Math.max(t.max[0],a[0]),t.max[1]=Math.max(t.max[1],a[1]),t.max[2]=Math.max(t.max[2],a[2])}}function js(t,e,n,o){const i=e.position.x,c=e.position.y,a=e.position.zGround,r=Math.max(e.depth,.01),l=n*.5,f=Math.max(l,o);t.min[0]=Math.min(t.min[0],i-f),t.max[0]=Math.max(t.max[0],i+f),t.min[2]=Math.min(t.min[2],c-f),t.max[2]=Math.max(t.max[2],c+f),t.max[1]=Math.max(t.max[1],a+l),t.min[1]=Math.min(t.min[1],a-r)}function Os(t,e){let n=Number.NEGATIVE_INFINITY;for(const o of t)Number.isFinite(o)&&(n=Math.max(n,o));return Number.isFinite(n)?n:e}const Ct=1e-6,xe=.001,He=.001;function Rn(t,e,n){return Math.min(Math.max(t,e),n)}function ge(t,e,n,o,i,c){return(n-t)*(c-e)-(o-e)*(i-t)}function Us(t,e){const n=Math.floor(e.length/3),o=new Int32Array(n*3);for(let i=0;i<n;i+=1){const c=i*3,a=e[c]|0;let r=e[c+1]|0,l=e[c+2]|0;const d=t[a*2],f=t[a*2+1],p=t[r*2],h=t[r*2+1],x=t[l*2],I=t[l*2+1];if(ge(d,f,p,h,x,I)<0){const b=r;r=l,l=b}o[c]=a,o[c+1]=r,o[c+2]=l}return o}function Bn(t,e,n,o){const i=Math.floor(t.length/2),c=new Float32Array(i*3);for(let a=0;a<n.length;a+=3){const r=n[a],l=n[a+1],d=n[a+2];if(r<0||l<0||d<0||r>=i||l>=i||d>=i)continue;const f=t[r*2],p=t[r*2+1],h=e[r],x=t[l*2],I=t[l*2+1],P=e[l],b=t[d*2],M=t[d*2+1],B=e[d],z=x-f,C=P-h,v=I-p,S=b-f,T=B-h,F=M-p;let Y,L,G;o==="up"?(Y=C*F-v*T,L=v*S-z*F,G=z*T-C*S):(Y=T*v-F*C,L=F*z-S*v,G=S*C-T*z),c[r*3]+=Y,c[r*3+1]+=L,c[r*3+2]+=G,c[l*3]+=Y,c[l*3+1]+=L,c[l*3+2]+=G,c[d*3]+=Y,c[d*3+1]+=L,c[d*3+2]+=G}for(let a=0;a<i;a+=1){const r=c[a*3],l=c[a*3+1],d=c[a*3+2],f=Math.hypot(r,l,d);if(f<=Ct){c[a*3]=0,c[a*3+1]=o==="up"?1:-1,c[a*3+2]=0;continue}c[a*3]=r/f,c[a*3+1]=l/f,c[a*3+2]=d/f}return c}const _s=t=>{const e=Math.hypot(t[0],t[1],t[2]);return e<=Ct?[0,1,0]:[t[0]/e,t[1]/e,t[2]/e]},Fn=(t,e,n)=>_s([t[0]+(e[0]-t[0])*n,t[1]+(e[1]-t[1])*n,t[2]+(e[2]-t[2])*n]);function Gs(t,e,n,o,i,c){const a=n.length;if(a===0)return{verticesXZ:[],triangles:[],top:[],bottom:[]};const r=new Int32Array(a),l=[],d=[],f=[],p=[],h=[],x=new Map,I=(v,S)=>i==="x"?Math.abs(v-c)<=xe:Math.abs(S-c)<=xe,P=(v,S)=>`${v},${S}`,b=v=>Math.floor(v/He);for(let v=0;v<a;v+=1){const S=t[v*2],T=t[v*2+1];if(!I(S,T)){const V=f.length;l.push(S),d.push(T),f.push(n[v]),p.push(o[v]),h.push(1),r[v]=V;continue}const F=b(S),Y=b(T);let L=-1;const G=He*He;for(let V=-1;V<=1&&L===-1;V+=1)for(let A=-1;A<=1&&L===-1;A+=1){const k=x.get(P(F+V,Y+A));if(k)for(const U of k){const g=l[U]/h[U],y=d[U]/h[U];if((S-g)*(S-g)+(T-y)*(T-y)<=G){L=U;break}}}if(L===-1){L=f.length,l.push(S),d.push(T),f.push(n[v]),p.push(o[v]),h.push(1);const V=P(F,Y),A=x.get(V);A?A.push(L):x.set(V,[L])}else l[L]+=S,d[L]+=T,f[L]+=n[v],p[L]+=o[v],h[L]+=1;r[v]=L}const M=new Array(l.length*2),B=new Array(f.length),z=new Array(p.length);for(let v=0;v<f.length;v+=1){const S=1/h[v];M[v*2]=l[v]*S,M[v*2+1]=d[v]*S,B[v]=f[v]*S,z[v]=p[v]*S}const C=[];for(let v=0;v+2<e.length;v+=3){const S=r[e[v]],T=r[e[v+1]],F=r[e[v+2]];if(S===T||T===F||F===S)continue;const Y=M[S*2],L=M[S*2+1],G=M[T*2],V=M[T*2+1],A=M[F*2],k=M[F*2+1],U=ge(Y,L,G,V,A,k);Math.abs(U)<=Ct||C.push(S,T,F)}return{verticesXZ:M,triangles:C,top:B,bottom:z}}function ze(t,e,n,o,i,c,a){const r=Math.floor(t.length/2),l=Math.floor(e.length/3);if(r<3||l<1||t.length!==r*2||e.length!==l*3||n.length!==r||o.length!==r)return{verticesXZ:[],triangles:[],top:[],bottom:[]};const d=[],f=[],p=[],h=[],x=new Int32Array(r);x.fill(-1);const I=new Map,P=T=>Math.abs(T-c)<=xe?c:T,b=T=>P(i==="x"?t[T*2]:t[T*2+1]),M=T=>{const F=b(T);return a==="max"?F<=c+Ct:F>=c-Ct},B=(T,F)=>{const Y=T<F?T:F,L=T<F?F:T;return BigInt(Y)<<32n|BigInt(L)},z=T=>{const F=x[T];if(F!==-1)return F;const Y=f.length;x[T]=Y;let L=t[T*2],G=t[T*2+1];return i==="x"?L=P(L):G=P(G),d.push(L,G),f.push(n[T]),p.push(o[T]),Y},C=(T,F)=>{const Y=b(T),L=b(F);if(Math.abs(Y-c)<=Ct)return z(T);if(Math.abs(L-c)<=Ct)return z(F);const G=B(T,F),V=I.get(G);if(V!==void 0)return V;const A=t[T*2],k=t[T*2+1],U=t[F*2],g=t[F*2+1],y=n[T],m=o[T],w=n[F],N=o[F],R=L-Y,D=Math.abs(R)<=Ct?0:Rn((c-Y)/R,0,1);let X=A+(U-A)*D,J=k+(g-k)*D;i==="x"?X=c:J=c;const nt=y+(w-y)*D,Z=m+(N-m)*D,ct=f.length;return I.set(G,ct),d.push(X,J),f.push(nt),p.push(Z),ct},v=(T,F,Y)=>{if(T===F||F===Y||Y===T)return;const L=d[T*2],G=d[T*2+1],V=d[F*2],A=d[F*2+1],k=d[Y*2],U=d[Y*2+1],g=ge(L,G,V,A,k,U);Math.abs(g)<=Ct||h.push(T,F,Y)},S=(T,F,Y)=>{const L=[M(T),M(F),M(Y)];if(!L[0]&&!L[1]&&!L[2])return;if(L[0]&&L[1]&&L[2]){v(z(T),z(F),z(Y));return}const G=[],V=[T,F,Y];for(let k=0;k<3;k+=1){const U=V[k],g=V[(k+1)%3],y=L[k],m=L[(k+1)%3];y&&m?G.push(z(g)):y&&!m?G.push(C(U,g)):!y&&m&&(G.push(C(U,g)),G.push(z(g)))}if(G.length<3)return;const A=G[0];for(let k=1;k+1<G.length;k+=1)v(A,G[k],G[k+1])};for(let T=0;T<l;T+=1){const F=T*3,Y=e[F]|0,L=e[F+1]|0,G=e[F+2]|0;Y<0||L<0||G<0||Y>=r||L>=r||G>=r||S(Y,L,G)}return Gs(d,h,f,p,i,c)}function Ys(t,e,n,o,i,c){const a=Math.floor(t.length/2),r=Math.floor(e.length/3);if(a<3||r<1||t.length!==a*2||e.length!==r*3||n.length!==a||o.length!==a)return{verticesXZ:[],triangles:[],top:[],bottom:[]};let l={verticesXZ:t,triangles:e,top:n,bottom:o};return i<Number.POSITIVE_INFINITY&&(l=ze(l.verticesXZ,l.triangles,l.top,l.bottom,"x",i,"max")),c<Number.POSITIVE_INFINITY&&(l=ze(l.verticesXZ,l.triangles,l.top,l.bottom,"z",c,"max")),l}function Rs(t,e,n,o,i,c=Number.NEGATIVE_INFINITY){const a=Math.floor(t.length/2),r=Math.floor(e.length/3);if(a<3||r<1||t.length!==a*2||e.length!==r*3||n.length!==a||o.length!==a)return{verticesXZ:[],triangles:[],top:[],bottom:[]};let l={verticesXZ:t,triangles:e,top:n,bottom:o};return i>Number.NEGATIVE_INFINITY&&(l=ze(l.verticesXZ,l.triangles,l.top,l.bottom,"x",i,"min")),c>Number.NEGATIVE_INFINITY&&(l=ze(l.verticesXZ,l.triangles,l.top,l.bottom,"z",c,"min")),l}function Ds(t,e,n,o,i){const c=Math.floor(t.length/2),a=Math.floor(e.length/3);if(c<3||a<1||t.length!==c*2||e.length!==a*3||n.length!==c||o.length!==c)return{verticesXZ:[],triangles:[],boundaryTriangles:[],top:[],bottom:[],topNormals:[],bottomNormals:[]};const r=Us(t,e),l=Bn(t,n,r,"up"),d=Bn(t,o,r,"down"),f=[],p=[],h=[],x=[],I=[],P=[],b=[],M=new Int32Array(c),B=new Int32Array(c);M.fill(-1),B.fill(-1);const z=[0,-1,0],C=new Map,v=(V,A)=>{const k=V<A?V:A,U=V<A?A:V;return BigInt(k)<<32n|BigInt(U)},S=(V,A,k,U,g,y)=>{const m=p.length;return f.push(V,A),p.push(k),h.push(U),x.push(g[0],g[1],g[2]),I.push(y[0],y[1],y[2]),m},T=(V,A)=>{const k=M[V];if(k!==-1)return k;const U=S(A.x,A.z,A.top,A.bottom,A.nTop,A.nBottom);return M[V]=U,U},F=(V,A)=>{const k=B[V];if(k!==-1)return k;const U=S(A.x,A.z,i,A.bottom,z,A.nBottom);return B[V]=U,U},Y=(V,A,k,U)=>{const g=v(V,A),y=C.get(g);if(y)return y.data;let m=k,w=U;V>A&&(m=U,w=k);const N=w.top-m.top,R=Math.abs(N)<=Ct?0:Rn((i-m.top)/N,0,1),D={x:m.x+(w.x-m.x)*R,z:m.z+(w.z-m.z)*R,top:i,bottom:m.bottom+(w.bottom-m.bottom)*R,nTop:Fn(m.nTop,w.nTop,R),nBottom:Fn(m.nBottom,w.nBottom,R)};return C.set(g,{data:D}),D},L=(V,A,k,U,g)=>{if(Math.abs(k.top-i)<=xe)return g?F(V,k):T(V,k);if(Math.abs(U.top-i)<=xe)return g?F(A,U):T(A,U);const y=v(V,A);let m=C.get(y);if(m||(Y(V,A,k,U),m=C.get(y)),g){if(m.capIndex!==void 0)return m.capIndex;const N=S(m.data.x,m.data.z,i,m.data.bottom,z,m.data.nBottom);return m.capIndex=N,N}if(m.nonCapIndex!==void 0)return m.nonCapIndex;const w=S(m.data.x,m.data.z,m.data.top,m.data.bottom,m.data.nTop,m.data.nBottom);return m.nonCapIndex=w,w},G=(V,A,k,U,g)=>{if(V===A||A===k||k===V)return;let y=f[V*2],m=f[V*2+1],w=f[A*2],N=f[A*2+1],R=f[k*2],D=f[k*2+1],X=ge(y,m,w,N,R,D);if(U){if(X<0){const J=A;A=k,k=J,y=f[V*2],m=f[V*2+1],w=f[A*2],N=f[A*2+1],R=f[k*2],D=f[k*2+1],X=-X}if(Math.abs(X)<=Ct)return;b.push(V,A,k),P.push(V,A,k);return}if(g!==0&&X*g<0){const J=A;A=k,k=J,y=f[V*2],m=f[V*2+1],w=f[A*2],N=f[A*2+1],R=f[k*2],D=f[k*2+1],X=-X}b.push(V,A,k),!(Math.abs(X)<=Ct)&&P.push(V,A,k)};for(let V=0;V<a;V+=1){const A=V*3,k=e[A]|0,U=e[A+1]|0,g=e[A+2]|0;if(k<0||U<0||g<0||k>=c||U>=c||g>=c)continue;const y={x:t[k*2],z:t[k*2+1],top:n[k],bottom:o[k],nTop:[l[k*3],l[k*3+1],l[k*3+2]],nBottom:[d[k*3],d[k*3+1],d[k*3+2]]},m={x:t[U*2],z:t[U*2+1],top:n[U],bottom:o[U],nTop:[l[U*3],l[U*3+1],l[U*3+2]],nBottom:[d[U*3],d[U*3+1],d[U*3+2]]},w={x:t[g*2],z:t[g*2+1],top:n[g],bottom:o[g],nTop:[l[g*3],l[g*3+1],l[g*3+2]],nBottom:[d[g*3],d[g*3+1],d[g*3+2]]},N=ge(y.x,y.z,m.x,m.z,w.x,w.z),R=N===0?0:Math.sign(N),D=y.top>i+Ct,X=m.top>i+Ct,J=w.top>i+Ct,nt=(D?1:0)+(X?1:0)+(J?1:0);if(nt===0){G(T(k,y),T(U,m),T(g,w),!1,R);continue}if(nt===3){G(F(k,y),F(U,m),F(g,w),!0,R);continue}if(nt===1){let Mt=y,Lt=k,Et=m,Rt=U,Dt=w,Vt=g;X?(Mt=m,Lt=U,Et=w,Rt=g,Dt=y,Vt=k):J&&(Mt=w,Lt=g,Et=y,Rt=k,Dt=m,Vt=U);const tt=L(Lt,Rt,Mt,Et,!1),Zt=L(Lt,Vt,Mt,Dt,!1),ae=L(Lt,Rt,Mt,Et,!0),le=L(Lt,Vt,Mt,Dt,!0),vt=T(Rt,Et),kt=T(Vt,Dt),_=F(Lt,Mt);G(vt,kt,tt,!1,R),G(kt,Zt,tt,!1,R),G(_,ae,le,!0,R);continue}let Z=y,ct=k,at=m,st=U,ht=w,dt=g;X?J||(Z=w,ct=g,at=y,st=k,ht=m,dt=U):(Z=m,ct=U,at=w,st=g,ht=y,dt=k);const bt=L(st,ct,at,Z,!1),zt=L(dt,ct,ht,Z,!1),wt=L(st,ct,at,Z,!0),mt=L(dt,ct,ht,Z,!0),Nt=T(ct,Z),yt=F(st,at),Bt=F(dt,ht);G(Nt,bt,zt,!1,R),G(yt,Bt,mt,!0,R),G(yt,mt,wt,!0,R)}return{verticesXZ:f,triangles:P,boundaryTriangles:b,top:p,bottom:h,topNormals:x,bottomNormals:I}}const Xt=t=>-t;function qs(t){return t.map(e=>({...e,worldPath:e.worldPath.map(([n,o])=>[n,Xt(o)])}))}function Ws(t){if(t.objects)for(const e of t.objects)e.position&&(e.position=[e.position[0],e.position[1],Xt(e.position[2])]);if(t.sections&&(t.sections=t.sections.map(e=>({...e,path:e.path.map(([n,o])=>[n,Xt(o)])}))),t.profiles)for(const e of t.profiles)e.position.y=Xt(e.position.y)}function $s(t){const e=t.extent.zMin,n=t.extent.zMax;if(t.extent.zMin=Xt(n),t.extent.zMax=Xt(e),t.sectionCurves)for(const c of t.sectionCurves)for(const a of c.points)a[2]=Xt(a[2]);if(t.solidOutlines)for(const c of Object.values(t.solidOutlines.bySolid))for(const a of c)for(let r=2;r<a.length;r+=3)a[r]=Xt(a[r]);const{verticesXZ:o,triangles:i}=t.mesh;for(let c=1;c<o.length;c+=2)o[c]=Xt(o[c]);for(let c=0;c+2<i.length;c+=3){const a=i[c+1];i[c+1]=i[c+2],i[c+2]=a}}const Hs=[{id:"s1",name:"Geological Section No. 1",sourceDxf:"sections/section_1.dxf",worldPath:[[.01,4.25],[19.99,2.13]],LWorld:20.09215767407771,sMaxCad:20.09,sScale:1.0001074004020762,zRef:5,zBase:-5.55,interfaces:{terrain:[[0,0],[.98,.47],[2.07,.99],[2.97,1.41],[4.32,2],[4.5,2.07],[5.74,2.55],[7.03,3],[8.1,3.26],[9.18,3.49],[10.32,3.73],[11.32,3.91],[12.18,4.06],[13.06,4.19],[13.55,4.25],[13.93,4.3],[15.06,4.44],[16.02,4.54],[18.34,4.79],[19.22,4.89],[20.09,5]],base:[[0,-5.55],[20.09,-5.55]],landfillBase:[[0,-1.19],[1.01,-.91],[2.01,-.54],[3.01,-.16],[4.02,.22],[5.04,.57],[6.07,.9],[7.1,1.2],[8.09,1.48],[9.12,1.78],[10.06,2.04],[11.06,2.26],[12.09,2.42],[13.13,2.53],[14.17,2.6],[15.22,2.67],[16.26,2.74],[17.54,2.83],[18.81,2.9],[20.09,2.95]],siltClay:[[0,-2.23],[1.01,-1.87],[2.01,-1.44],[3.05,-1.09],[5.18,-.49],[6.13,-.15],[7.03,.28],[8.04,.98],[9.03,1.72],[9.12,1.78]]},patches:{landfill:{rings:[[[1.01,-.91],[2.01,-.54],[3.01,-.16],[4.02,.22],[5.04,.57],[6.07,.9],[7.1,1.2],[8.09,1.48],[9.12,1.78],[10.06,2.04],[11.06,2.26],[12.09,2.42],[13.13,2.53],[14.17,2.6],[15.22,2.67],[16.26,2.74],[17.54,2.83],[18.81,2.9],[20.09,2.95],[20.09,5],[19.22,4.89],[18.34,4.79],[16.02,4.54],[15.06,4.44],[13.93,4.3],[13.55,4.25],[13.06,4.19],[12.18,4.06],[11.32,3.91],[10.32,3.73],[9.18,3.49],[8.1,3.26],[7.03,3],[5.74,2.55],[4.5,2.07],[4.32,2],[2.97,1.41],[2.07,.99],[.98,.47],[0,0],[0,-1.19]]]},clay:{rings:[[[20.09,-5.55],[20.09,2.95],[18.81,2.9],[17.54,2.83],[16.26,2.74],[15.22,2.67],[14.17,2.6],[13.13,2.53],[12.09,2.42],[11.06,2.26],[10.06,2.04],[9.12,1.78],[9.03,1.72],[8.04,.98],[7.03,.28],[6.13,-.15],[5.18,-.49],[3.05,-1.09],[2.01,-1.44],[1.01,-1.87],[0,-2.23],[0,-5.55]]]},silt:{rings:[[[1.01,-1.87],[2.01,-1.44],[3.05,-1.09],[5.18,-.49],[6.13,-.15],[7.03,.28],[8.04,.98],[9.03,1.72],[9.12,1.78],[8.09,1.48],[7.1,1.2],[6.07,.9],[5.04,.57],[4.02,.22],[3.01,-.16],[2.01,-.54],[1.01,-.91],[0,-1.19],[0,-2.23]]]}}},{id:"s2",name:"Section 2",sourceDxf:"sections/section_2.dxf",worldPath:[[2.11,9.68],[1.91,.43]],LWorld:9.25216190952147,sMaxCad:9.25,sScale:1.0002337199482672,zRef:.97,zBase:-5.55,interfaces:{terrain:[[0,.97],[.59,.95],[1.27,.94],[1.5,.94],[2.41,.94],[2.64,.94],[3.3,.95],[4.56,.95],[5.59,.95],[6.63,.94],[7.65,.92],[8.64,.9],[9.25,.88]],base:[[0,-5.55],[9.25,-5.55]],landfillBase:[[0,-.3],[.03,-.25],[.12,-.29],[.17,-.32],[1.26,-.36],[1.65,-.37],[2.35,-.4],[2.76,-.43],[3.45,-.46],[4.04,-.47],[4.55,-.52],[5.59,-.55],[5.68,-.54],[6.56,-.54],[7.68,-.55],[8.06,-.56],[8.68,-.58],[9.25,-.61]],siltClay:[[0,-1.7],[.03,-1.64],[.12,-1.68],[.17,-1.7],[.33,-1.7],[1.26,-1.67],[1.65,-1.64],[2.36,-1.6],[2.76,-1.59],[3.45,-1.55],[4.03,-1.5],[4.55,-1.5],[5.59,-1.45],[5.64,-1.45],[5.68,-1.45],[5.71,-1.45],[6.41,-1.47],[6.81,-1.49],[7.17,-1.52],[7.77,-1.56],[9.25,-1.67]]},patches:{landfill:{rings:[[[.03,-.25],[.12,-.29],[.17,-.32],[1.26,-.36],[1.65,-.37],[2.35,-.4],[2.76,-.43],[3.45,-.46],[4.04,-.47],[4.55,-.52],[5.59,-.55],[5.68,-.54],[6.56,-.54],[7.68,-.55],[8.06,-.56],[8.68,-.58],[9.25,-.61],[9.25,.88],[8.64,.9],[7.65,.92],[6.63,.94],[5.59,.95],[4.56,.95],[3.3,.95],[2.64,.94],[2.41,.94],[1.5,.94],[1.27,.94],[.59,.95],[0,.97],[0,-.3]]]},clay:{rings:[[[9.25,-5.55],[9.25,-1.67],[7.77,-1.56],[7.17,-1.52],[6.81,-1.49],[6.41,-1.47],[5.71,-1.45],[5.68,-1.45],[5.64,-1.45],[5.59,-1.45],[4.55,-1.5],[4.03,-1.5],[3.45,-1.55],[2.76,-1.59],[2.36,-1.6],[1.65,-1.64],[1.26,-1.67],[.33,-1.7],[.17,-1.7],[.12,-1.68],[.03,-1.64],[0,-1.7],[0,-5.55]]]},silt:{rings:[[[.03,-1.64],[.12,-1.68],[.17,-1.7],[.33,-1.7],[1.26,-1.67],[1.65,-1.64],[2.36,-1.6],[2.76,-1.59],[3.45,-1.55],[4.03,-1.5],[4.55,-1.5],[5.59,-1.45],[5.64,-1.45],[5.68,-1.45],[5.71,-1.45],[6.41,-1.47],[6.81,-1.49],[7.17,-1.52],[7.77,-1.56],[9.25,-1.67],[9.25,-.61],[8.68,-.58],[8.06,-.56],[7.68,-.55],[6.56,-.54],[5.68,-.54],[5.59,-.55],[4.55,-.52],[4.04,-.47],[3.45,-.46],[2.76,-.43],[2.35,-.4],[1.65,-.37],[1.26,-.36],[.17,-.32],[.12,-.29],[.03,-.25],[0,-.3],[0,-1.7]]]}}},{id:"s3",name:"Section 3",sourceDxf:"sections/section_3.dxf",worldPath:[[15.29,.45],[15.63,9.53]],LWorld:9.086363408977213,sMaxCad:9.09,sScale:.9995999349809915,zRef:4.48,zBase:-5.55,interfaces:{terrain:[[0,4.43],[.69,4.45],[1.83,4.48],[2.64,4.48],[2.95,4.48],[3.82,4.48],[4.98,4.47],[6.25,4.44],[6.46,4.43],[7.32,4.42],[7.96,4.42],[8.44,4.42],[9.09,4.44]],base:[[0,-5.55],[9.09,-5.55]],landfillClay:[[0,2.58],[.39,2.6],[1.86,2.65],[2.17,2.68],[3.71,2.75],[3.78,2.75],[4.96,2.76],[6.13,2.73],[7.3,2.58],[7.63,2.54],[8.38,2.43],[8.58,2.4],[9.09,2.31]]},patches:{landfill:{rings:[[[.39,2.6],[1.86,2.65],[2.17,2.68],[3.71,2.75],[3.78,2.75],[4.96,2.76],[6.13,2.73],[7.3,2.58],[7.63,2.54],[8.38,2.43],[8.58,2.4],[9.09,2.31],[9.09,4.44],[8.44,4.42],[7.96,4.42],[7.32,4.42],[6.46,4.43],[6.25,4.44],[4.98,4.47],[3.82,4.48],[2.95,4.48],[2.64,4.48],[1.83,4.48],[.69,4.45],[0,4.43],[0,2.58]]]},clay:{rings:[[[9.09,-5.55],[9.09,2.31],[8.58,2.4],[8.38,2.43],[7.63,2.54],[7.3,2.58],[6.13,2.73],[4.96,2.76],[3.78,2.75],[3.71,2.75],[2.17,2.68],[1.86,2.65],[.39,2.6],[0,2.58],[0,-5.55]]]}}},{id:"s4",name:"Section 4",sourceDxf:"sections/section_4.dxf",worldPath:[[.2,9.81],[19.72,9.72]],LWorld:19.52020747840555,sMaxCad:19.52,sScale:1.0000106290166777,zRef:4.96,zBase:-5.55,interfaces:{terrain:[[0,.09],[.72,.41],[.94,.51],[1.95,.99],[2.72,1.35],[3.72,1.82],[3.97,1.93],[4.73,2.26],[4.98,2.36],[5.76,2.66],[6.54,2.91],[6.8,3],[7.64,3.22],[7.87,3.28],[8.71,3.47],[8.94,3.52],[9.79,3.68],[10.03,3.73],[10.88,3.87],[11.13,3.9],[11.98,4.03],[12.23,4.06],[13.34,4.2],[14.46,4.33],[15.3,4.43],[15.57,4.46],[16.41,4.56],[16.69,4.59],[17.52,4.69],[17.71,4.71],[18.16,4.77],[18.8,4.86],[19.52,4.96]],base:[[0,-5.55],[19.52,-5.55]],landfillBase:[[0,-1.27],[.83,-.86],[.9,-.81],[1.45,-.6],[1.93,-.49],[2.4,-.37],[3.09,-.22],[3.55,-.03],[4.05,.08],[4.71,.19],[4.9,.23],[5.12,.24],[5.78,.2],[6.8,.25],[6.93,.28],[7.76,.44],[8.03,.49],[9.12,.73],[9.94,.92],[10.21,.99],[10.39,1.03],[11.03,1.19],[11.3,1.26],[12.11,1.47],[12.39,1.54],[13.2,1.74],[13.49,1.81],[14.28,2.01],[14.58,2.07],[15.37,2.26],[15.67,2.32],[16.46,2.49],[16.67,2.52],[17.51,2.68],[17.69,2.7],[18.13,2.76],[18.78,2.86],[19.44,2.93],[19.52,2.94]],siltClay:[[0,-2.65],[.82,-2.24],[.88,-2.2],[1.45,-2],[1.94,-1.92],[2.42,-1.83],[3.12,-1.72],[3.58,-1.54],[4.1,-1.44],[4.74,-1.37],[5.02,-1.3],[5.45,-1.28],[5.82,-1.31],[5.87,-1.3],[6.72,-1.17],[6.79,-1.15],[6.86,-1.11],[7.62,-.75],[7.85,-.62],[8.58,-.21],[8.81,-.06],[9.51,.4],[9.74,.56],[10.39,1.03]]},patches:{landfill:{rings:[[[.83,-.86],[.9,-.81],[1.45,-.6],[1.93,-.49],[2.4,-.37],[3.09,-.22],[3.55,-.03],[4.05,.08],[4.71,.19],[4.9,.23],[5.12,.24],[5.78,.2],[6.8,.25],[6.93,.28],[7.76,.44],[8.03,.49],[9.12,.73],[9.94,.92],[10.21,.99],[10.39,1.03],[11.03,1.19],[11.3,1.26],[12.11,1.47],[12.39,1.54],[13.2,1.74],[13.49,1.81],[14.28,2.01],[14.58,2.07],[15.37,2.26],[15.67,2.32],[16.46,2.49],[16.67,2.52],[17.51,2.68],[17.69,2.7],[18.13,2.76],[18.78,2.86],[19.44,2.93],[19.52,2.94],[19.52,4.96],[18.8,4.86],[18.16,4.77],[17.71,4.71],[17.52,4.69],[16.69,4.59],[16.41,4.56],[15.57,4.46],[15.3,4.43],[14.46,4.33],[13.34,4.2],[12.23,4.06],[11.98,4.03],[11.13,3.9],[10.88,3.87],[10.03,3.73],[9.79,3.68],[8.94,3.52],[8.71,3.47],[7.87,3.28],[7.64,3.22],[6.8,3],[6.54,2.91],[5.76,2.66],[4.98,2.36],[4.73,2.26],[3.97,1.93],[3.72,1.82],[2.72,1.35],[1.95,.99],[.94,.51],[.72,.41],[0,.09],[0,-1.27]]]},clay:{rings:[[[19.52,-5.55],[19.52,2.94],[19.44,2.93],[18.78,2.86],[18.13,2.76],[17.69,2.7],[17.51,2.68],[16.67,2.52],[16.46,2.49],[15.67,2.32],[15.37,2.26],[14.58,2.07],[14.28,2.01],[13.49,1.81],[13.2,1.74],[12.39,1.54],[12.11,1.47],[11.3,1.26],[11.03,1.19],[10.39,1.03],[9.74,.56],[9.51,.4],[8.81,-.06],[8.58,-.21],[7.85,-.62],[7.62,-.75],[6.86,-1.11],[6.79,-1.15],[6.72,-1.17],[5.87,-1.3],[5.82,-1.31],[5.45,-1.28],[5.02,-1.3],[4.74,-1.37],[4.1,-1.44],[3.58,-1.54],[3.12,-1.72],[2.42,-1.83],[1.94,-1.92],[1.45,-2],[.88,-2.2],[.82,-2.24],[0,-2.65],[0,-5.55]]]},silt:{rings:[[[.82,-2.24],[.88,-2.2],[1.45,-2],[1.94,-1.92],[2.42,-1.83],[3.12,-1.72],[3.58,-1.54],[4.1,-1.44],[4.74,-1.37],[5.02,-1.3],[5.45,-1.28],[5.82,-1.31],[5.87,-1.3],[6.72,-1.17],[6.79,-1.15],[6.86,-1.11],[7.62,-.75],[7.85,-.62],[8.58,-.21],[8.81,-.06],[9.51,.4],[9.74,.56],[10.39,1.03],[10.21,.99],[9.94,.92],[9.12,.73],[8.03,.49],[7.76,.44],[6.93,.28],[6.8,.25],[5.78,.2],[5.12,.24],[4.9,.23],[4.71,.19],[4.05,.08],[3.55,-.03],[3.09,-.22],[2.4,-.37],[1.93,-.49],[1.45,-.6],[.9,-.81],[.83,-.86],[0,-1.27],[0,-2.65]]]}}}],Xs={sections:Hs},Ne=1e-6,Ln=new WeakMap;function Ks(t,e,n){const o=t.path;if(o.length<2)return null;const[i,c]=o[0],[a,r]=o[o.length-1],l=a-i,d=r-c,f=Math.hypot(l,d);if(!Number.isFinite(f)||f<=Ne)return null;const p=l/f,h=d/f,x=e.surfaces,I=Js(e),P=I.avgEdgeLength,b=Math.max(.01,P),M=Math.max(2,Math.floor(f/b)+1),B=new Map,z=(A,k,U)=>{const g=B.get(A)??x[A];return g?(B.set(A,g),ti(I,g,k,U)):0},C=[],v=[],S=Object.create(null),T=new Set;for(const A of e.solids)T.add(A.top),T.add(A.bottom);const F=Array.from(T);for(const A of F)S[A]=[];for(let A=0;A<M;A+=1){const k=A/(M-1)*f,U=i+p*k,g=c+h*k;C.push(k);const y=z("terrain",U,g);v.push(y);for(const m of F)S[m].push(z(m,U,g))}const Y=Math.max(...v),L=[];let G=Number.POSITIVE_INFINITY,V=Number.NEGATIVE_INFINITY;for(const A of e.solids){const k=S[A.top],U=S[A.bottom];if(!k||!U)continue;let g=0;for(let m=0;m<k.length;m+=1)g=Math.max(g,k[m]-U[m]);if(g<=Ne)continue;const y=[];for(let m=0;m<M;m+=1){const w=Y-k[m];G=Math.min(G,w),V=Math.max(V,w),y.push({s:C[m],d:w})}for(let m=M-1;m>=0;m-=1){const w=Y-U[m];G=Math.min(G,w),V=Math.max(V,w),y.push({s:C[m],d:w})}L.push({soilId:A.soilId,rings:[y]})}return!Number.isFinite(G)||L.length===0?null:{minS:0,maxS:f,minD:G,maxD:V,zRef:Y,patches:L}}function Qs(t,e){const n=Math.floor(t.length/2),o=Math.floor(e.length/3);if(n<3||o<1)return .25;const i=Math.min(o,200),c=Math.max(1,Math.floor(o/i));let a=0,r=0;for(let d=0;d<o;d+=c){const f=d*3,p=e[f]|0,h=e[f+1]|0,x=e[f+2]|0;p<0||h<0||x<0||p>=n||h>=n||x>=n||(a+=Xe(t,p,h),a+=Xe(t,h,x),a+=Xe(t,x,p),r+=3)}const l=r>0?a/r:.25;return Number.isFinite(l)&&l>0?l:.25}function Xe(t,e,n){const o=t[e*2],i=t[e*2+1],c=t[n*2],a=t[n*2+1];return Math.hypot(c-o,a-i)}function Vn(t,e,n){return Math.max(e,Math.min(n,t))}function Ce(t,e,n){return Math.max(e,Math.min(n,t))}function Js(t){const e=Ln.get(t);if(e)return e;const n=Zs(t);return Ln.set(t,n),n}function Zs(t){const{extent:e,mesh:n}=t,{verticesXZ:o,triangles:i}=n,c=Math.floor(o.length/2),a=Math.floor(i.length/3);if(c<3||a<1||o.length!==c*2||i.length!==a*3){const N=new Int32Array(2);return{xMin:e.xMin,xMax:e.xMax,zMin:e.zMin,zMax:e.zMax,cellSize:Math.max(.01,e.xMax-e.xMin,e.zMax-e.zMin),nx:1,nz:1,offsets:N,indices:new Int32Array(0),ia:new Int32Array(0),ib:new Int32Array(0),ic:new Int32Array(0),ax:new Float32Array(0),az:new Float32Array(0),v0x:new Float32Array(0),v0z:new Float32Array(0),v1x:new Float32Array(0),v1z:new Float32Array(0),invDenom:new Float32Array(0),avgEdgeLength:.25}}const r=e.xMin,l=e.xMax,d=e.zMin,f=e.zMax,p=Math.max(Ne,l-r),h=Math.max(Ne,f-d),x=Qs(o,i),I=Math.max(p,h)/128,P=Math.max(.05,I,x),b=Math.max(1,Math.ceil(p/P)),M=Math.max(1,Math.ceil(h/P)),B=b*M,z=new Int32Array(a),C=new Int32Array(a),v=new Int32Array(a),S=new Float32Array(a),T=new Float32Array(a),F=new Float32Array(a),Y=new Float32Array(a),L=new Float32Array(a),G=new Float32Array(a),V=new Float32Array(a),A=new Int32Array(B),k=N=>Ce(Math.floor((N-r)/P),0,b-1),U=N=>Ce(Math.floor((N-d)/P),0,M-1);for(let N=0;N<a;N+=1){const R=N*3,D=i[R]|0,X=i[R+1]|0,J=i[R+2]|0;if(D<0||X<0||J<0||D>=c||X>=c||J>=c){z[N]=-1,C[N]=-1,v[N]=-1,V[N]=0;continue}z[N]=D,C[N]=X,v[N]=J;const nt=o[D*2],Z=o[D*2+1],ct=o[X*2],at=o[X*2+1],st=o[J*2],ht=o[J*2+1];S[N]=nt,T[N]=Z;const dt=ct-nt,bt=at-Z,zt=st-nt,wt=ht-Z;F[N]=dt,Y[N]=bt,L[N]=zt,G[N]=wt;const mt=dt*wt-bt*zt;V[N]=Math.abs(mt)<=1e-12?0:1/mt;const Nt=Math.min(nt,ct,st),yt=Math.max(nt,ct,st),Bt=Math.min(Z,at,ht),Mt=Math.max(Z,at,ht),Lt=k(Nt),Et=k(yt),Rt=U(Bt),Dt=U(Mt);for(let Vt=Rt;Vt<=Dt;Vt+=1){const tt=Vt*b;for(let Zt=Lt;Zt<=Et;Zt+=1)A[tt+Zt]+=1}}const g=new Int32Array(B+1);for(let N=0;N<B;N+=1)g[N+1]=g[N]+A[N];const y=g[B],m=new Int32Array(y),w=new Int32Array(g);for(let N=0;N<a;N+=1){if(z[N]<0)continue;const R=S[N],D=T[N],X=R+F[N],J=D+Y[N],nt=R+L[N],Z=D+G[N],ct=Math.min(R,X,nt),at=Math.max(R,X,nt),st=Math.min(D,J,Z),ht=Math.max(D,J,Z),dt=k(ct),bt=k(at),zt=U(st),wt=U(ht);for(let mt=zt;mt<=wt;mt+=1){const Nt=mt*b;for(let yt=dt;yt<=bt;yt+=1){const Bt=Nt+yt;m[w[Bt]++]=N}}}return{xMin:r,xMax:l,zMin:d,zMax:f,cellSize:P,nx:b,nz:M,offsets:g,indices:m,ia:z,ib:C,ic:v,ax:S,az:T,v0x:F,v0z:Y,v1x:L,v1z:G,invDenom:V,avgEdgeLength:x}}function ti(t,e,n,o){if(e.length===0||t.ia.length===0)return 0;const i=Vn(n,t.xMin,t.xMax),c=Vn(o,t.zMin,t.zMax),a=Ce(Math.floor((i-t.xMin)/t.cellSize),0,t.nx-1),l=Ce(Math.floor((c-t.zMin)/t.cellSize),0,t.nz-1)*t.nx+a,d=t.offsets[l],f=t.offsets[l+1];for(let p=d;p<f;p+=1){const h=t.indices[p],x=t.invDenom[h];if(x===0)continue;const I=i-t.ax[h],P=c-t.az[h],b=(I*t.v1z[h]-P*t.v1x[h])*x,M=(t.v0x[h]*P-t.v0z[h]*I)*x,B=1-b-M;if(B>=-1e-9&&b>=-1e-9&&M>=-1e-9){const z=t.ia[h],C=t.ib[h],v=t.ic[h];return e[z]*B+e[C]*b+e[v]*M}}for(let p=0;p<t.ia.length;p+=1){const h=t.invDenom[p];if(h===0)continue;const x=i-t.ax[p],I=c-t.az[p],P=(x*t.v1z[p]-I*t.v1x[p])*h,b=(t.v0x[p]*I-t.v0z[p]*x)*h,M=1-P-b;if(M>=-1e-9&&P>=-1e-9&&b>=-1e-9){const B=t.ia[p],z=t.ib[p],C=t.ic[p];return e[B]*M+e[z]*P+e[C]*b}}return 0}const Pe=document.querySelector("#gfx"),Ke=document.querySelector("#message"),re={target:[12.308137893676758,-2.078213691711426,-.03483019769191742],yaw:2.59007353266014,pitch:.3322148625050682,distance:34.27910453694887,orthoScale:14.198870005209317,mode:"perspective"};function Dn(t){Ke&&(Ke.textContent=t,Ke.classList.add("visible"))}function ei(t){t.mode=re.mode,t.orthoScale=re.orthoScale,t.distance=re.distance,t.setAngles(re.yaw,re.pitch),ce(t.target,...re.target)}async function ni(t){try{const e=await fetch(t);if(!e.ok)return null;const n=await e.json();return!n||n.version!==2?null:n}catch{return null}}async function oi(){if(!Pe)throw new Error("Canvas element not found.");if(!navigator.gpu){Dn("WebGPU is not supported in this browser.");return}const{device:t,context:e,format:n}=await Vo(Pe),o=new is(Pe,t,e,n),i=new es;new ns(Pe,i);const a=await rs("./scene.json"),r=await ni("./solids_model_v2.json");Ws(a),r&&($s(r),a.solidsModel=r);const l=Xs.sections??[],d=qs(l);if(d.length>0){const x=new Map(d.map(b=>[b.id,b])),I=[],P=new Set;if(a.sections)for(const b of a.sections){const M=x.get(b.id),B=b.path.length>0?b.path:(M==null?void 0:M.worldPath)??[];I.push({...b,path:B,vector:M}),P.add(b.id)}for(const b of d)P.has(b.id)||I.push({id:b.id,name:b.name,path:b.worldPath,vector:b});a.sections=I}const f=As(t,o,a);o.setObjects(f.objects);const p=()=>{o.resize();const{width:x,height:I}=o.getSize();i.setAspect(x/I)};p(),ei(i),si(t,a,f.objects,o,i,f.bounds),document.body.classList.add("ready"),window.addEventListener("resize",p);const h=()=>{o.render(i),requestAnimationFrame(h)};requestAnimationFrame(h)}function si(t,e,n,o,i,c){const a=document.querySelector("#panel");if(!a)return;const r=document.querySelector("#panel-toggle"),l=document.querySelector("#panel-body"),d=Array.from(document.querySelectorAll("input[name='theme']")),f=document.querySelector("#toggle-terrain"),p=document.querySelector("#toggle-grid"),h=document.querySelector("#toggle-sections"),x=document.querySelector("#toggle-profiles"),I=document.querySelector("#toggle-solids"),P=Array.from(document.querySelectorAll("input[name='solids-visibility']")),b=document.querySelector("#toggle-solids-edges"),M=document.querySelector("#fit-view"),B=document.querySelector("#toggle-projection"),z=Array.from(document.querySelectorAll("input[name='mode']")),C=Array.from(document.querySelectorAll(".panel-views button")),v=document.querySelector("#section-list"),S=document.querySelector("#profile-list"),T=document.querySelector("#solid-list"),F=document.querySelector("#solids-spacing"),Y=document.querySelector("#solids-spacing-value"),L=document.querySelector("#solids-clip-x"),G=document.querySelector("#solids-clip-x-value"),V=document.querySelector("#solids-clip-y"),A=document.querySelector("#solids-clip-y-value"),k=document.querySelector("#solids-clip-z"),U=document.querySelector("#solids-clip-z-value"),g=document.querySelector("#sections-controls"),y=document.querySelector("#profiles-controls"),m=document.querySelector("#solids-controls"),w=document.querySelector("#gfx"),N=document.querySelector("#section-detail"),R=document.querySelector("#section-title"),D=document.querySelector("#section-canvas"),X=document.querySelector("#section-close"),J=f==null?void 0:f.closest("label"),nt=p==null?void 0:p.closest("label");if(!f||!p||!h||!x||!I||P.length===0||!b||!M||!B||!r||!l||d.length===0||z.length===0||!v||!S||!T||!F||!Y||!L||!G||!V||!A||!k||!U||!g||!y||!m||!N||!R||!D||!X||!J||!nt)return;const Z=s=>{a.classList.toggle("panel--collapsed",s),r.setAttribute("aria-expanded",s?"false":"true")},ct=()=>{window.matchMedia("(max-width: 720px)").matches||Z(!1)};r.addEventListener("click",()=>{Z(!a.classList.contains("panel--collapsed"))}),window.addEventListener("resize",ct),ct(),document.addEventListener("pointerdown",s=>{if(!window.matchMedia("(max-width: 720px)").matches||a.classList.contains("panel--collapsed"))return;const u=s.target;u instanceof Node&&a.contains(u)||Z(!0)}),T.style.visibility="hidden";const at={dark:{clearColor:{r:21/255,g:21/255,b:21/255,a:1},sectionCanvasBg:"#111",sectionAxis:"rgba(255, 255, 255, 0.35)",sectionAxisTick:"rgba(255, 255, 255, 0.08)",sectionText:"rgba(230, 230, 230, 0.7)",sectionEmptyText:"#ccc",sectionHatch:"rgba(0, 0, 0, 0.85)",sectionPatchStroke:"rgba(0, 0, 0, 0.55)"},light:{clearColor:{r:1,g:1,b:1,a:1},sectionCanvasBg:"#fff",sectionAxis:"rgba(0, 0, 0, 0.35)",sectionAxisTick:"rgba(0, 0, 0, 0.08)",sectionText:"rgba(20, 20, 20, 0.7)",sectionEmptyText:"#333",sectionHatch:"rgba(0, 0, 0, 0.7)",sectionPatchStroke:"rgba(0, 0, 0, 0.35)"}};let st=at.dark,ht="dark";const dt=()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return"dark";try{return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}catch{return"dark"}},bt=()=>{var u;return((u=d.find(E=>E.checked))==null?void 0:u.value)==="light"?"light":"dark"},zt=s=>{document.documentElement.dataset.theme=s,ht=s,st=at[s],o.setClearColor(st.clearColor),Oe()},wt=()=>{var u;return((u=z.find(E=>E.checked))==null?void 0:u.value)==="solids"?"solids":"sections"},mt=()=>{var u;const s=(u=P.find(E=>E.checked))==null?void 0:u.value;return s==="wireframe"||s==="transparent"||s==="classic"?s:"classic"},Nt=s=>{const u=Number.parseFloat(F.max);return Number.isFinite(u)?Math.min(Math.max(0,s),u):Math.max(0,s)},yt=()=>{const s=Number.parseFloat(F.value);return Number.isFinite(s)?Nt(s):0},Bt=s=>{const u=Nt(s);F.value=u.toString(),_.solids.verticalSpacing=u,dn()},Mt=N,Lt=R,Et=D,Rt=X,Dt=new Map(e.soils.map(s=>[s.id,s])),Vt=new Map((e.sections??[]).map(s=>[s.id,s])),tt=e.solidsModel??null,Zt=new Set(((tt==null?void 0:tt.solids)??[]).map(s=>s.soilId)),ae=new Map;for(const s of n)s.objectType!=="solid"||!s.soilId||ae.set(s.soilId,s.layerIndex);let le=0;for(const s of ae.values())le=Math.max(le,s);const vt=tt?{xMin:tt.extent.xMin,xMax:tt.extent.xMax,yMin:c.min[1],yMax:c.max[1],zMin:tt.extent.zMin,zMax:tt.extent.zMax}:{xMin:c.min[0],xMax:c.max[0],yMin:c.min[1],yMax:c.max[1],zMin:c.min[2],zMax:c.max[2]},kt={xMin:vt.xMin,yMax:vt.yMax,zMax:vt.zMax},_={mode:wt(),visibility:{terrain:!0,grid:!0,sections:!0,profiles:!0,solids:!0},solids:{enabled:Zt,verticalSpacing:yt(),displayMode:mt(),highlightEdges:b.checked,crop:{...kt}},selectedSectionId:null,selectedProfileId:null};document.body.dataset.mode=_.mode;const ye=s=>`${s.toFixed(2)} m`,qn=(s,u)=>{const E=Math.abs(u-s),j=.01;return!Number.isFinite(E)||E<=0?j:Math.max(j,E/400)},Ee=(s,u,E,j,O)=>{s.min=E.toString(),s.max=j.toString(),s.step=qn(E,j).toString(),s.value=O.toString(),u.textContent=ye(O)};Ee(L,G,vt.xMin,vt.xMax,kt.xMin),Ee(V,A,vt.yMin,vt.yMax,kt.yMax),Ee(k,U,vt.zMin,vt.zMax,kt.zMax);const Ze=s=>Math.min(Math.max(vt.xMin,s),vt.xMax),tn=s=>Math.min(Math.max(vt.yMin,s),vt.yMax),en=s=>Math.min(Math.max(vt.zMin,s),vt.zMax),Wn=()=>{const s=Number.parseFloat(L.value);return Number.isFinite(s)?Ze(s):kt.xMin},$n=()=>{const s=Number.parseFloat(V.value);return Number.isFinite(s)?tn(s):kt.yMax},Hn=()=>{const s=Number.parseFloat(k.value);return Number.isFinite(s)?en(s):kt.zMax},Xn=s=>{const u=Ze(s);L.value=u.toString(),_.solids.crop.xMin=u,be()},Kn=s=>{const u=tn(s);V.value=u.toString(),_.solids.crop.yMax=u,be()},Qn=s=>{const u=en(s);k.value=u.toString(),_.solids.crop.zMax=u,be()},fe=new Map,Me=new Map;for(const s of n){if(s.objectType!=="solid"&&s.objectType!=="solidWireframe"&&s.objectType!=="solidEdge"||(fe.set(s.id,s.mesh),!s.soilId))continue;const u=Me.get(s.soilId)??{};s.objectType==="solid"?u.solid=s:s.objectType==="solidEdge"?u.edges=s:u.wireframe=s,Me.set(s.soilId,u)}const ee=(s,u)=>{const E=fe.get(s.id);E&&s.mesh!==E&&s.mesh.vertexBuffer.destroy(),s.mesh=u},Jn=()=>{for(const s of Me.values()){if(s.solid){const u=fe.get(s.solid.id);u&&ee(s.solid,u)}if(s.wireframe){const u=fe.get(s.wireframe.id);u&&ee(s.wireframe,u)}if(s.edges){const u=fe.get(s.edges.id);u&&ee(s.edges,u)}}};let nn="";const ke=()=>{if(!tt)return;const s=_.solids.crop.xMin,u=_.solids.crop.yMax,E=_.solids.crop.zMax,j=`${s.toFixed(5)}|${u.toFixed(5)}|${E.toFixed(5)}`;if(j===nn)return;nn=j;const O=s>kt.xMin+1e-4,q=E<kt.zMax-1e-4,$=O||q,K=u<kt.yMax-1e-4;if(!$&&!K){Jn();return}const{verticesXZ:Q,triangles:lt}=tt.mesh,ft=Math.floor(Q.length/2);for(const it of tt.solids){const ot=Me.get(it.soilId);if(!(ot!=null&&ot.solid)&&!(ot!=null&&ot.wireframe)&&!(ot!=null&&ot.edges))continue;const pt=tt.surfaces[it.top],W=tt.surfaces[it.bottom];if(!pt||!W||pt.length!==ft||W.length!==ft)continue;let et=Q,rt=lt,gt=pt,It=W,Ut,jt,At;if($){if(O){const xt=Rs(et,rt,gt,It,s);et=xt.verticesXZ,rt=xt.triangles,gt=xt.top,It=xt.bottom}if(q){const xt=Ys(et,rt,gt,It,Number.POSITIVE_INFINITY,E);et=xt.verticesXZ,rt=xt.triangles,gt=xt.top,It=xt.bottom}}if(K){const xt=Ds(et,rt,gt,It,u);et=xt.verticesXZ,rt=xt.triangles,At=xt.boundaryTriangles,gt=xt.top,It=xt.bottom,Ut=xt.topNormals,jt=xt.bottomNormals}const Pt=Un(t,et,rt,gt,It,Ut,jt,At);ot.solid&&ee(ot.solid,Pt.solid),ot.wireframe&&ee(ot.wireframe,Pt.wireframe),ot.edges&&ee(ot.edges,Pt.edges)}},Ae=(s,u,E)=>[s[0]+(u[0]-s[0])*E,s[1]+(u[1]-s[1])*E,s[2]+(u[2]-s[2])*E,s[3]+(u[3]-s[3])*E],Zn=3,to=.35,eo=.4,no=.6,oo=.35,so=.2,io=s=>{const u=Ae(s,[1,1,1,s[3]],to);return[u[0],u[1],u[2],eo]},ro=(s,u)=>{u==="transparent"?(s.color=io(s.baseColor),s.material=[0,Zn,s.baseMaterial[2],s.baseMaterial[3]]):(s.color=[...s.baseColor],s.material=[...s.baseMaterial])},co=(s,u)=>{if(u==="transparent"){const E=ht==="light"?[0,0,0,s.baseColor[3]]:[1,1,1,s.baseColor[3]],j=ht==="light"?oo:so,O=Ae(s.baseColor,E,j);s.color=[O[0],O[1],O[2],no]}else s.color=s.baseColor},Be=()=>({min:[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],max:[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]}),ne=(s,u)=>{s.min[0]=Math.min(s.min[0],u.min[0]),s.min[1]=Math.min(s.min[1],u.min[1]),s.min[2]=Math.min(s.min[2],u.min[2]),s.max[0]=Math.max(s.max[0],u.max[0]),s.max[1]=Math.max(s.max[1],u.max[1]),s.max[2]=Math.max(s.max[2],u.max[2])},ao=s=>Number.isFinite(s.min[0])&&Number.isFinite(s.min[1])&&Number.isFinite(s.min[2])&&Number.isFinite(s.max[0])&&Number.isFinite(s.max[1])&&Number.isFinite(s.max[2]),lo=()=>{if(tt){const $=ve.get("terrain");if($)return{min:[tt.extent.xMin,$.min,tt.extent.zMin],max:[tt.extent.xMax,$.max,tt.extent.zMax]}}const s=e.objects.find($=>$.type==="terrain");if(!s)return null;const u=s.position??[0,0,0],E=s.scale??[1,1,1],j=s.mesh.size??[1,1,1],O=[E[0]*j[0],E[1]*j[1],E[2]*j[2]],q=[Math.abs(O[0])*.5,Math.abs(O[1])*.5,Math.abs(O[2])*.5];return{min:[u[0]-q[0],u[1]-q[1],u[2]-q[2]],max:[u[0]+q[0],u[1]+q[1],u[2]+q[2]]}},fo=()=>{const s=e.sections??[];if(s.length===0)return null;let u=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,j=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,q=!1;for(const $ of s)for(const K of $.path??[])u=Math.min(u,K[0]),E=Math.max(E,K[0]),j=Math.min(j,K[1]),O=Math.max(O,K[1]),q=!0;return q?{min:[u,c.min[1],j],max:[E,c.max[1],O]}:null},ho=()=>{const s=e.profiles??[];if(s.length===0)return null;const E=.35*.5,j=.08,O=Be();let q=!1;for(const $ of s){const K=$.position.x,Q=$.position.y,lt=$.position.zGround,ft=Math.max($.depth,.01),it=Math.max(E,j),ot={min:[K-it,lt-ft,Q-it],max:[K+it,lt+E,Q+it]};ne(O,ot),q=!0}return q?O:null},uo=s=>{if(s.length===0)return null;let u=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY;for(const j of s)Number.isFinite(j)&&(u=Math.min(u,j),E=Math.max(E,j));return!Number.isFinite(u)||!Number.isFinite(E)?null:{min:u,max:E}},ve=new Map;if(tt)for(const[s,u]of Object.entries(tt.surfaces)){const E=uo(u);E&&ve.set(s,E)}const on=new Map;if(tt){const{extent:s}=tt;for(const u of tt.solids){const E=ve.get(u.top),j=ve.get(u.bottom),O=(j==null?void 0:j.min)??s.yBase,q=(E==null?void 0:E.max)??c.max[1];on.set(u.soilId,{min:[s.xMin,O,s.zMin],max:[s.xMax,q,s.zMax]})}}const sn=lo(),rn=fo(),cn=ho(),an=(s,u)=>{if(!Number.isFinite(u)||u===0)return 0;const E=le*.5;return-(s-E)*u},po=s=>{if(!tt)return null;const u=Be();let E=!1;for(const j of tt.solids){if(!_.solids.enabled.has(j.soilId))continue;const O=on.get(j.soilId);if(!O)continue;const q=ae.get(j.soilId)??0,$=an(q,s),K=Math.max(O.min[0],_.solids.crop.xMin),Q=O.min[1],lt=O.min[2],ft=O.max[0],it=Math.min(O.max[1],_.solids.crop.yMax),ot=Math.min(O.max[2],_.solids.crop.zMax);ft<K||it<Q||ot<lt||(ne(u,{min:[K,Q+$,lt],max:[ft,it+$,ot]}),E=!0)}return E?u:null},mo=()=>{if(!w)return{fracX:1,fracY:1,centerNdcX:0,centerNdcY:0};const s=Math.max(1,w.clientWidth),u=Math.max(1,w.clientHeight),E=16;if(window.matchMedia("(max-width: 720px)").matches)return{fracX:1,fracY:1,centerNdcX:0,centerNdcY:0};const O=w.getBoundingClientRect(),q=a.getBoundingClientRect(),$=q.left-O.left,K=q.right-O.left,Q=q.top-O.top,lt=q.bottom-O.top,ft=q.width>0&&q.height>0&&K>=0&&$<=s&&lt>=0&&Q<=u,it=E,ot=s-E,pt=E,W=u-E;let et=ot,rt=pt;ft&&(et=Math.min(ot,Math.max(it+1,$-E))),rt>=W&&(rt=pt);const gt=Math.max(1,et-it),It=Math.max(1,W-rt),Ut=it+gt*.5,jt=rt+It*.5;return{fracX:gt/s,fracY:It/u,centerNdcX:2*Ut/s-1,centerNdcY:1-2*jt/u}},Fe=()=>{const s=Be();if(_.visibility.terrain&&sn&&ne(s,sn),_.mode==="sections")_.visibility.sections&&rn&&ne(s,rn),_.visibility.profiles&&cn&&ne(s,cn);else if(_.visibility.solids){const u=po(_.solids.verticalSpacing);u&&ne(s,u)}return ao(s)?s:c},Le=s=>{const u=mo(),E=Math.max(.05,Math.min(1,u.fracX)),j=Math.max(.05,Math.min(1,u.fracY)),O=1.1,q=(s.min[0]+s.max[0])*.5,$=(s.min[1]+s.max[1])*.5,K=(s.min[2]+s.max[2])*.5,Q=s.max[0]-s.min[0],lt=s.max[1]-s.min[1],ft=s.max[2]-s.min[2],it=.5*Math.hypot(Q,lt,ft)*O;if(!Number.isFinite(it)||it<=0){ce(i.target,q,$,K);return}ce(i.target,q,$,K);const ot=i.fov*.5,pt=Math.tan(ot),W=Tt(-Math.cos(i.pitch)*Math.cos(i.yaw),-Math.sin(i.pitch),-Math.cos(i.pitch)*Math.sin(i.yaw));Ot(W,W);const et=St();Kt(et,W,Tt(0,1,0)),jn(et)<1e-6?ce(et,1,0,0):Ot(et,et);const rt=St();Kt(rt,et,W),Ot(rt,rt);const gt=[[s.min[0],s.min[1],s.min[2]],[s.min[0],s.min[1],s.max[2]],[s.min[0],s.max[1],s.min[2]],[s.min[0],s.max[1],s.max[2]],[s.max[0],s.min[1],s.min[2]],[s.max[0],s.min[1],s.max[2]],[s.max[0],s.max[1],s.min[2]],[s.max[0],s.max[1],s.max[2]]];if(i.mode==="perspective"){const qt=Math.max(1e-4,pt*i.aspect*E),Wt=Math.max(1e-4,pt*j);let Qt=.2;const $t=St();for(const _t of gt){ce($t,_t[0]-q,_t[1]-$,_t[2]-K);const se=Ht($t,et),ie=Ht($t,rt),Ie=Ht($t,W),_e=Math.abs(se)*O/qt-Ie,Bo=Math.abs(ie)*O/Wt-Ie;Qt=Math.max(Qt,_e,Bo)}i.distance=Math.min(200,Math.max(.2,Qt))}else{let qt=.2;const Wt=St(),Qt=Math.max(1e-4,E*i.aspect),$t=Math.max(1e-4,j);for(const _t of gt){ce(Wt,_t[0]-q,_t[1]-$,_t[2]-K);const se=Ht(Wt,et),ie=Ht(Wt,rt),Ie=Math.abs(se)*O/Qt,_e=Math.abs(ie)*O/$t;qt=Math.max(qt,Ie,_e)}i.orthoScale=Math.min(200,Math.max(.2,qt)),i.distance=i.orthoScale/Math.max(1e-4,pt)}let It=Number.POSITIVE_INFINITY,Ut=Number.NEGATIVE_INFINITY,jt=Number.POSITIVE_INFINITY,At=Number.NEGATIVE_INFINITY;const Pt=St();pe(Pt,i.target,W,-i.distance);for(const qt of gt){const Wt=Tt(qt[0]-Pt[0],qt[1]-Pt[1],qt[2]-Pt[2]),Qt=Ht(Wt,et),$t=Ht(Wt,rt),_t=Math.max(1e-4,Ht(Wt,W)),se=i.mode==="perspective"?Qt/(_t*pt*i.aspect):Qt/(i.orthoScale*i.aspect),ie=i.mode==="perspective"?$t/(_t*pt):$t/i.orthoScale;It=Math.min(It,se),Ut=Math.max(Ut,se),jt=Math.min(jt,ie),At=Math.max(At,ie)}const xt=(It+Ut)*.5,zo=(jt+At)*.5,No=u.centerNdcX-xt,Co=u.centerNdcY-zo,xn=i.mode==="perspective"?i.distance*pt:i.orthoScale,Eo=xn*i.aspect,gn=-No*Eo,yn=-Co*xn;if(Math.abs(gn)<1e-4&&Math.abs(yn)<1e-4)return;const ko=i.getPosition(),he=St();Je(he,i.target,ko),Ot(he,he);const Ao=Tt(0,1,0),ue=St();Kt(ue,he,Ao),Ot(ue,ue);const we=St();Kt(we,ue,he),Ot(we,we),pe(i.target,i.target,ue,gn),pe(i.target,i.target,we,yn)},Ve=new Map,xo=new Map,go=new Map;let yo=1;const ln=(s,u)=>{const E=s==="section"?xo:go,j=E.get(u);if(j)return j;const O=yo++;return E.set(u,O),Ve.set(O,{type:s,id:u}),O},fn=()=>{B.textContent=i.mode==="perspective"?"Perspective":"Orthographic"},dn=()=>{Y.textContent=`${_.solids.verticalSpacing.toFixed(2)} m`},be=()=>{G.textContent=ye(_.solids.crop.xMin),A.textContent=ye(_.solids.crop.yMax),U.textContent=ye(_.solids.crop.zMax)},oe={terrain:f.checked,grid:p.checked,sections:h.checked},hn=s=>{s?(oe.terrain=f.checked,oe.grid=p.checked,oe.sections=h.checked,f.checked=!1,p.checked=!1,h.checked=!1,_.visibility.terrain=!1,_.visibility.grid=!1,_.visibility.sections=!1,f.disabled=!0,p.disabled=!0,h.disabled=!0):(f.disabled=!1,p.disabled=!1,h.disabled=!1,f.checked=oe.terrain,p.checked=oe.grid,h.checked=oe.sections,_.visibility.terrain=f.checked,_.visibility.grid=p.checked,_.visibility.sections=h.checked)},ut=()=>{const s=_.mode==="sections",u=_.mode==="solids",E=s&&_.visibility.sections,j=_.visibility.sections,O=s&&_.visibility.profiles,q=u&&_.visibility.solids,$=_.solids.displayMode,K=q&&$==="wireframe",Q=q&&_.solids.highlightEdges,lt=u?_.solids.verticalSpacing:0;J.style.display=u?"none":"",nt.style.display=u?"none":"",g.style.display=u?"none":"",y.style.display=s?"":"none",m.style.display=u?"":"none";const ft=s?E:!!tt;v.style.opacity=ft?"1":"0.6",v.querySelectorAll("input[type='radio']").forEach(W=>{W.disabled=!ft}),S.style.opacity=O?"1":"0.6",S.querySelectorAll("input[type='radio']").forEach(W=>{W.disabled=!O}),T.style.opacity=q?"1":"0.6",T.querySelectorAll("input[type='checkbox']").forEach(W=>{W.disabled=!q});const it=[.678,1,.184,1],ot=[.43,.91,1,1],pt=[.678,1,.184,1];for(const W of n)if(W.objectType==="terrain"){const et=_.visibility.terrain,rt=_.visibility.grid;W.visible=et||rt,W.material[2]=rt?W.baseMaterial[2]:0,W.material[3]=et?0:rt?1:0}else if(W.objectType==="curve")W.visible=j;else if(W.objectType==="section"){W.visible=E;const et=_.selectedSectionId&&W.sectionId===_.selectedSectionId;W.color=et?Ae(W.baseColor,it,.45):W.baseColor}else if(W.objectType==="profile"){W.visible=O;const et=_.selectedProfileId&&W.profileId===_.selectedProfileId;W.color=et?pt:ot}else if(W.objectType==="solid"||W.objectType==="solidWireframe"||W.objectType==="solidEdge"){const et=W.soilId?_.solids.enabled.has(W.soilId):!0;W.objectType==="solid"?ro(W,$):W.objectType==="solidEdge"&&co(W,$);const rt=q&&$!=="wireframe";W.visible=(W.objectType==="solidWireframe"?K:W.objectType==="solidEdge"?Q:rt)&&et,W.objectType==="solidEdge"&&(W.edgeXray=K),Uo(W.modelMatrix,W.baseMatrix),W.modelMatrix[13]+=an(W.layerIndex,lt)}else W.visible=!0;Oe()},Mo={front:()=>({yaw:Math.PI/2,pitch:0}),back:()=>({yaw:-Math.PI/2,pitch:0}),left:()=>({yaw:Math.PI,pitch:0}),right:()=>({yaw:0,pitch:0}),top:()=>({yaw:i.yaw,pitch:Math.PI/2}),bottom:()=>({yaw:i.yaw,pitch:-Math.PI/2})};for(const s of C)s.addEventListener("click",()=>{const u=s.dataset.view??"",E=Mo[u];if(!E)return;const{yaw:j,pitch:O}=E();i.setAngles(j,O),Le(Fe())});const vo=()=>{_.mode=wt(),document.body.dataset.mode=_.mode,hn(_.mode==="solids"),_.mode==="sections"&&Bt(0),ut()};for(const s of z)s.addEventListener("change",vo);f.addEventListener("change",()=>{_.visibility.terrain=f.checked,ut()}),p.addEventListener("change",()=>{_.visibility.grid=p.checked,ut()}),h.addEventListener("change",()=>{_.visibility.sections=h.checked,ut()}),x.addEventListener("change",()=>{_.visibility.profiles=x.checked,ut()}),I.addEventListener("change",()=>{_.visibility.solids=I.checked,ut()});for(const s of P)s.addEventListener("change",()=>{s.checked&&(_.solids.displayMode=mt(),ut())});b.addEventListener("change",()=>{_.solids.highlightEdges=b.checked,ut()}),F.addEventListener("input",()=>{Bt(yt()),ut()}),L.addEventListener("input",()=>{Xn(Wn()),ke(),ut()}),V.addEventListener("input",()=>{Kn($n()),ke(),ut()}),k.addEventListener("input",()=>{Qn(Hn()),ke(),ut()}),M.addEventListener("click",()=>{Le(Fe())}),B.addEventListener("click",()=>{i.toggleProjection(),fn()}),v.innerHTML="";const un=new Map;if(e.sections&&e.sections.length>0)for(const s of e.sections){const u=document.createElement("label");u.className="panel-option";const E=document.createElement("input");E.type="radio",E.name="section-select",un.set(s.id,E),E.addEventListener("change",()=>{E.checked&&(_.selectedSectionId=s.id,ut())}),u.appendChild(E),u.appendChild(document.createTextNode(s.name)),v.appendChild(u)}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No sections loaded",v.appendChild(s)}S.innerHTML="";const pn=new Map;let de=null;if(e.profiles&&e.profiles.length>0){const s=document.createElement("label");s.className="panel-option";const u=document.createElement("input");u.type="radio",u.name="profile-select",u.checked=!0,u.addEventListener("change",()=>{u.checked&&(_.selectedProfileId=null,ut())}),s.appendChild(u),s.appendChild(document.createTextNode("None")),S.appendChild(s),de=u;for(const E of e.profiles){const j=document.createElement("label");j.className="panel-option";const O=document.createElement("input");O.type="radio",O.name="profile-select",pn.set(E.id,O),O.addEventListener("change",()=>{O.checked&&(_.selectedProfileId=E.id,ut())}),j.appendChild(O),j.appendChild(document.createTextNode(E.name)),S.appendChild(j)}}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No profiles loaded",S.appendChild(s)}const je=new Map;if(T.querySelectorAll("input[type='checkbox'][data-soil-id]").forEach(s=>{const u=s.dataset.soilId;u&&je.set(u,s)}),tt&&tt.solids.length>0){_.solids.enabled.clear();for(const s of tt.solids){let u=je.get(s.soilId);if(!u){const E=document.createElement("label");E.className="panel-option",u=document.createElement("input"),u.type="checkbox",u.checked=!0,u.dataset.soilId=s.soilId,je.set(s.soilId,u),E.appendChild(u),E.appendChild(document.createTextNode(s.name)),T.appendChild(E)}u.checked&&_.solids.enabled.add(s.soilId),u.addEventListener("change",()=>{u.checked?_.solids.enabled.add(s.soilId):_.solids.enabled.delete(s.soilId),ut()})}T.style.visibility="",I.disabled=!1,P.forEach(s=>{s.disabled=!1}),b.disabled=!1,F.disabled=!1,L.disabled=!1,V.disabled=!1,k.disabled=!1}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No solids model loaded",T.appendChild(s),T.querySelectorAll("input[type='checkbox']").forEach(u=>{u.disabled=!0}),T.style.visibility="",I.checked=!1,I.disabled=!0,P.forEach(u=>{u.disabled=!0,u.value==="classic"&&(u.checked=!0)}),b.checked=!1,b.disabled=!0,F.disabled=!0,L.disabled=!0,V.disabled=!0,k.disabled=!0,_.visibility.solids=!1}dn(),be();const bo=dt(),mn=d.find(s=>s.value===bo);mn&&(mn.checked=!0),zt(bt());for(const s of d)s.addEventListener("change",()=>{s.checked&&(zt(bt()),ut())});fn(),hn(_.mode==="solids"),ut(),Le(Fe());for(const s of n)s.objectType==="section"&&s.sectionId?s.pickId=ln("section",s.sectionId):s.objectType==="profile"&&s.profileId?s.pickId=ln("profile",s.profileId):s.pickId=0;w&&w.addEventListener("click",async s=>{if(s.button!==0||_.mode==="solids")return;const u=w.getBoundingClientRect(),E=s.clientX-u.left,j=s.clientY-u.top,O=await o.pick(E,j);if(!O||!Ve.has(O)){de&&(de.checked=!0),_.selectedSectionId=null,_.selectedProfileId=null,ut();return}const q=Ve.get(O);if(q){if(q.type==="section"){_.selectedSectionId=q.id,_.selectedProfileId=null;const $=un.get(q.id);$&&($.checked=!0),de&&(de.checked=!0),h.checked||(h.checked=!0,_.visibility.sections=!0)}else if(q.type==="profile"){_.selectedProfileId=q.id,_.selectedSectionId=null;const $=pn.get(q.id);$&&($.checked=!0),x.checked||(x.checked=!0,_.visibility.profiles=!0)}ut()}}),Rt.addEventListener("click",()=>{_.selectedSectionId=null,ut()}),window.addEventListener("resize",()=>{Oe()});function Oe(){const s=_.selectedSectionId,u=!!(s&&(_.mode==="sections"&&_.visibility.sections||_.mode==="solids"&&tt));if(Mt.classList.toggle("visible",!!u),!u||!s)return;const E=Vt.get(s);if(!E)return;Lt.textContent=E.name;const j=Et.getContext("2d");if(!j)return;const O=window.devicePixelRatio||1,q=Math.max(1,Et.clientWidth),$=Math.max(1,Et.clientHeight);Et.width=Math.floor(q*O),Et.height=Math.floor($*O),j.setTransform(O,0,0,O,0,0),j.clearRect(0,0,q,$),j.fillStyle=st.sectionCanvasBg,j.fillRect(0,0,q,$);const K=_.mode==="solids"?tt?Ks(E,tt):null:E.vector?wo(E.vector):null;if(!K||K.patches.length===0){j.fillStyle=st.sectionEmptyText,j.font="12px IBM Plex Sans, sans-serif",j.fillText("No polygons available for this section.",16,24);return}const Q={left:50,right:20,top:24,bottom:28},lt=Math.max(1,q-Q.left-Q.right),ft=Math.max(1,$-Q.top-Q.bottom),it=lt/Math.max(K.maxS-K.minS,.01),ot=ft/Math.max(K.maxD-K.minD,.01),pt=et=>Q.left+(et-K.minS)*it,W=et=>Q.top+(et-K.minD)*ot;j.strokeStyle=st.sectionAxis,j.lineWidth=1,j.beginPath(),j.moveTo(Q.left,Q.top),j.lineTo(Q.left,Q.top+ft),j.lineTo(Q.left+lt,Q.top+ft),j.stroke(),Io(j,Q.left,Q.top,ft,K.minD,K.maxD,st);for(const et of K.patches){const rt=Dt.get(et.soilId),gt=(rt==null?void 0:rt.color)??[.6,.6,.6],It=(rt==null?void 0:rt.patternId)??0,Ut=`rgb(${Math.round(gt[0]*255)}, ${Math.round(gt[1]*255)}, ${Math.round(gt[2]*255)})`;for(const jt of et.rings){if(jt.length===0)continue;const At=jt.map(Pt=>({x:pt(Pt.s),y:W(Pt.d)}));j.beginPath(),j.moveTo(At[0].x,At[0].y);for(let Pt=1;Pt<At.length;Pt+=1)j.lineTo(At[Pt].x,At[Pt].y);j.closePath(),j.fillStyle=Ut,j.fill(),Po(j,At,It),j.strokeStyle=st.sectionPatchStroke,j.lineWidth=.75,j.stroke()}}}function wo(s){const u=[];let E=Number.POSITIVE_INFINITY,j=Number.NEGATIVE_INFINITY,O=Number.POSITIVE_INFINITY,q=Number.NEGATIVE_INFINITY;for(const[$,K]of Object.entries(s.patches)){const Q=[];for(const lt of K.rings){const ft=lt.map(([it,ot])=>{const pt=it*s.sScale,W=s.zRef-ot;return E=Math.min(E,pt),j=Math.max(j,pt),O=Math.min(O,W),q=Math.max(q,W),{s:pt,d:W}});Q.push(ft)}u.push({soilId:$,rings:Q})}return!Number.isFinite(E)||!Number.isFinite(O)?null:{minS:E,maxS:j,minD:O,maxD:q,patches:u}}function Io(s,u,E,j,O,q,$){const K=Math.max(.1,q-O),Q=K/5,lt=[.5,1,2,5,10];let ft=lt[0];for(const it of lt)Q>it&&(ft=it);s.font="11px IBM Plex Sans, sans-serif",s.fillStyle=$.sectionText,s.textAlign="right",s.textBaseline="middle";for(let it=O;it<=q+.001;it+=ft){const ot=E+(it-O)/K*j;s.strokeStyle=$.sectionAxisTick,s.beginPath(),s.moveTo(u,ot),s.lineTo(u-6,ot),s.stroke(),s.fillText(it.toFixed(1),u-8,ot)}}function Po(s,u,E){if(E===0||u.length===0)return;let j=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,q=Number.POSITIVE_INFINITY,$=Number.NEGATIVE_INFINITY;for(const Q of u)j=Math.min(j,Q.x),O=Math.max(O,Q.x),q=Math.min(q,Q.y),$=Math.max($,Q.y);const K={x:j,y:q,width:Math.max(1,O-j),height:Math.max(1,$-q)};s.save(),s.beginPath(),s.moveTo(u[0].x,u[0].y);for(let Q=1;Q<u.length;Q+=1)s.lineTo(u[Q].x,u[Q].y);s.closePath(),s.clip(),s.strokeStyle=st.sectionHatch,s.lineWidth=1,E===1?(s.lineWidth=.25,Ue(s,K,Math.PI/4,12),Ue(s,K,-Math.PI/4,12)):E===2?(s.lineWidth=.25,So(s,K,Math.PI/4,9,8,2)):E===3&&(s.lineWidth=.25,To(s,K)),s.restore()}function Ue(s,u,E,j){const O=u.x+u.width*.5,q=u.y+u.height*.5,$=Math.hypot(u.width,u.height);s.save(),s.translate(O,q),s.rotate(E),s.translate(-O,-q);const K=O-$,Q=O+$;for(let lt=K;lt<=Q;lt+=j)s.beginPath(),s.moveTo(lt,q-$),s.lineTo(lt,q+$),s.stroke();s.restore()}function So(s,u,E,j,O,q){s.save(),s.setLineDash([O,q]),Ue(s,u,E,j),s.restore()}function To(s,u){const $=Math.ceil(u.height/9)+1;for(let K=0;K<$;K+=1){const Q=u.y+K*9,lt=K%3*12;for(let ft=u.x-36;ft<=u.x+u.width+36;ft+=36)s.beginPath(),s.moveTo(ft+lt,Q),s.lineTo(ft+lt+12.5,Q),s.stroke()}}}oi().catch(t=>{console.error(t),Dn(t instanceof Error?t.message:String(t))});
