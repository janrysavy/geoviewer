var ts=Object.defineProperty;var ns=(e,t,n)=>t in e?ts(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var H=(e,t,n)=>ns(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();async function os(e,t){var c,r,l,f;if(!navigator.gpu){const d=new Error("WebGPU is not supported by this browser.");throw(c=t==null?void 0:t.fail)==null||c.call(t,"navigator.gpu",d),d}const n=(t==null?void 0:t.call("canvas.getContext('webgpu')",()=>e.getContext("webgpu")))??e.getContext("webgpu");if(!n){const d=new Error("Failed to acquire WebGPU context.");throw(r=t==null?void 0:t.fail)==null||r.call(t,"canvas.getContext('webgpu')",d),d}const o=(t?await t.callAsync("navigator.gpu.requestAdapter",()=>navigator.gpu.requestAdapter({powerPreference:"high-performance"})):await navigator.gpu.requestAdapter({powerPreference:"high-performance"}))??null;if(!o){const d=new Error("No suitable GPU adapter found.");throw(l=t==null?void 0:t.fail)==null||l.call(t,"navigator.gpu.requestAdapter",d),d}const i=t?await t.callAsync("GPUAdapter.requestDevice",()=>o.requestDevice()):await o.requestDevice();(f=t==null?void 0:t.attachDevice)==null||f.call(t,i);const a=t?t.call("navigator.gpu.getPreferredCanvasFormat",()=>navigator.gpu.getPreferredCanvasFormat()):navigator.gpu.getPreferredCanvasFormat();return{adapter:o,device:i,context:n,format:a}}class ss{constructor(t){H(this,"failed",!1);H(this,"attached",!1);this.reportFailure=t}hasFailed(){return this.failed}fail(t,n,o){this.failed||(this.failed=!0,this.reportFailure({operation:t,error:n,hint:o}))}call(t,n){if(this.failed)throw new Error("WebGPU is in a failed state.");try{return n()}catch(o){throw this.fail(t,o),o}}async callAsync(t,n){if(this.failed)throw new Error("WebGPU is in a failed state.");try{return await n()}catch(o){throw this.fail(t,o),o}}attachDevice(t){this.attached||(this.attached=!0,t.addEventListener("uncapturederror",n=>{this.fail("GPUDevice.uncapturederror",n.error)}),t.lost.then(n=>{this.fail("GPUDevice.lost",new Error(n.message||"The GPU device was lost."),`reason=${n.reason}`)}))}}var Bt=1e-6,Oe=typeof Float32Array<"u"?Float32Array:Array,is="zyx";function rs(){var e=new Oe(9);return Oe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function it(){var e=new Oe(16);return Oe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function $n(e){var t=new Oe(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function cs(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function as(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ls(e,t,n){var o=t[0],i=t[1],a=t[2],c=t[3],r=t[4],l=t[5],f=t[6],d=t[7],u=t[8],h=t[9],m=t[10],I=t[11],w=t[12],P=t[13],g=t[14],L=t[15],C=n[0],N=n[1],v=n[2],S=n[3];return e[0]=C*o+N*r+v*u+S*w,e[1]=C*i+N*l+v*h+S*P,e[2]=C*a+N*f+v*m+S*g,e[3]=C*c+N*d+v*I+S*L,C=n[4],N=n[5],v=n[6],S=n[7],e[4]=C*o+N*r+v*u+S*w,e[5]=C*i+N*l+v*h+S*P,e[6]=C*a+N*f+v*m+S*g,e[7]=C*c+N*d+v*I+S*L,C=n[8],N=n[9],v=n[10],S=n[11],e[8]=C*o+N*r+v*u+S*w,e[9]=C*i+N*l+v*h+S*P,e[10]=C*a+N*f+v*m+S*g,e[11]=C*c+N*d+v*I+S*L,C=n[12],N=n[13],v=n[14],S=n[15],e[12]=C*o+N*r+v*u+S*w,e[13]=C*i+N*l+v*h+S*P,e[14]=C*a+N*f+v*m+S*g,e[15]=C*c+N*d+v*I+S*L,e}function fn(e,t,n,o){var i=t[0],a=t[1],c=t[2],r=t[3],l=i+i,f=a+a,d=c+c,u=i*l,h=i*f,m=i*d,I=a*f,w=a*d,P=c*d,g=r*l,L=r*f,C=r*d,N=o[0],v=o[1],S=o[2];return e[0]=(1-(I+P))*N,e[1]=(h+C)*N,e[2]=(m-L)*N,e[3]=0,e[4]=(h-C)*v,e[5]=(1-(u+P))*v,e[6]=(w+g)*v,e[7]=0,e[8]=(m+L)*S,e[9]=(w-g)*S,e[10]=(1-(u+I))*S,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function ds(e,t,n,o,i){var a=1/Math.tan(t/2);if(e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0){var c=1/(o-i);e[10]=i*c,e[14]=i*o*c}else e[10]=-1,e[14]=-o;return e}function fs(e,t,n,o,i,a,c){var r=1/(t-n),l=1/(o-i),f=1/(a-c);return e[0]=-2*r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=f,e[11]=0,e[12]=(t+n)*r,e[13]=(i+o)*l,e[14]=a*f,e[15]=1,e}function hs(e,t,n,o){var i,a,c,r,l,f,d,u,h,m,I=t[0],w=t[1],P=t[2],g=o[0],L=o[1],C=o[2],N=n[0],v=n[1],S=n[2];return Math.abs(I-N)<Bt&&Math.abs(w-v)<Bt&&Math.abs(P-S)<Bt?as(e):(d=I-N,u=w-v,h=P-S,m=1/Math.sqrt(d*d+u*u+h*h),d*=m,u*=m,h*=m,i=L*h-C*u,a=C*d-g*h,c=g*u-L*d,m=Math.sqrt(i*i+a*a+c*c),m?(m=1/m,i*=m,a*=m,c*=m):(i=0,a=0,c=0),r=u*c-h*a,l=h*i-d*c,f=d*a-u*i,m=Math.sqrt(r*r+l*l+f*f),m?(m=1/m,r*=m,l*=m,f*=m):(r=0,l=0,f=0),e[0]=i,e[1]=r,e[2]=d,e[3]=0,e[4]=a,e[5]=l,e[6]=u,e[7]=0,e[8]=c,e[9]=f,e[10]=h,e[11]=0,e[12]=-(i*I+a*w+c*P),e[13]=-(r*I+l*w+f*P),e[14]=-(d*I+u*w+h*P),e[15]=1,e)}function ke(){var e=new Oe(3);return Oe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function ao(e){var t=e[0],n=e[1],o=e[2];return Math.sqrt(t*t+n*n+o*o)}function Ee(e,t,n){var o=new Oe(3);return o[0]=e,o[1]=t,o[2]=n,o}function ps(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function st(e,t,n,o){return e[0]=t,e[1]=n,e[2]=o,e}function us(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function un(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function ms(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function vt(e,t,n,o){return e[0]=t[0]+n[0]*o,e[1]=t[1]+n[1]*o,e[2]=t[2]+n[2]*o,e}function gs(e,t){var n=t[0]-e[0],o=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+o*o+i*i)}function _e(e,t){var n=t[0],o=t[1],i=t[2],a=n*n+o*o+i*i;return a>0&&(a=1/Math.sqrt(a)),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e}function Xe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Qe(e,t,n){var o=t[0],i=t[1],a=t[2],c=n[0],r=n[1],l=n[2];return e[0]=i*l-a*r,e[1]=a*c-o*l,e[2]=o*r-i*c,e}var xs=ao;(function(){var e=ke();return function(t,n,o,i,a,c){var r,l;for(n||(n=3),o||(o=0),i?l=Math.min(i*n+o,t.length):l=t.length,r=o;r<l;r+=n)e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2],a(e,e,c),t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2];return t}})();function ys(){var e=new Oe(4);return Oe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function vs(e,t){var n=t[0],o=t[1],i=t[2],a=t[3],c=n*n+o*o+i*i+a*a;return c>0&&(c=1/Math.sqrt(c)),e[0]=n*c,e[1]=o*c,e[2]=i*c,e[3]=a*c,e}(function(){var e=ys();return function(t,n,o,i,a,c){var r,l;for(n||(n=4),o||(o=0),i?l=Math.min(i*n+o,t.length):l=t.length,r=o;r<l;r+=n)e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2],e[3]=t[r+3],a(e,e,c),t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=e[3];return t}})();function Ft(){var e=new Oe(4);return Oe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function Ms(e,t,n){n=n*.5;var o=Math.sin(n);return e[0]=o*t[0],e[1]=o*t[1],e[2]=o*t[2],e[3]=Math.cos(n),e}function en(e,t,n,o){var i=t[0],a=t[1],c=t[2],r=t[3],l=n[0],f=n[1],d=n[2],u=n[3],h,m,I,w,P;return m=i*l+a*f+c*d+r*u,m<0&&(m=-m,l=-l,f=-f,d=-d,u=-u),1-m>Bt?(h=Math.acos(m),I=Math.sin(h),w=Math.sin((1-o)*h)/I,P=Math.sin(o*h)/I):(w=1-o,P=o),e[0]=w*i+P*l,e[1]=w*a+P*f,e[2]=w*c+P*d,e[3]=w*r+P*u,e}function bs(e,t){var n=t[0]+t[4]+t[8],o;if(n>0)o=Math.sqrt(n+1),e[3]=.5*o,o=.5/o,e[0]=(t[5]-t[7])*o,e[1]=(t[6]-t[2])*o,e[2]=(t[1]-t[3])*o;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var a=(i+1)%3,c=(i+2)%3;o=Math.sqrt(t[i*3+i]-t[a*3+a]-t[c*3+c]+1),e[i]=.5*o,o=.5/o,e[3]=(t[a*3+c]-t[c*3+a])*o,e[a]=(t[a*3+i]+t[i*3+a])*o,e[c]=(t[c*3+i]+t[i*3+c])*o}return e}function ws(e,t,n,o){var i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:is,a=Math.PI/360;t*=a,o*=a,n*=a;var c=Math.sin(t),r=Math.cos(t),l=Math.sin(n),f=Math.cos(n),d=Math.sin(o),u=Math.cos(o);switch(i){case"xyz":e[0]=c*f*u+r*l*d,e[1]=r*l*u-c*f*d,e[2]=r*f*d+c*l*u,e[3]=r*f*u-c*l*d;break;case"xzy":e[0]=c*f*u-r*l*d,e[1]=r*l*u-c*f*d,e[2]=r*f*d+c*l*u,e[3]=r*f*u+c*l*d;break;case"yxz":e[0]=c*f*u+r*l*d,e[1]=r*l*u-c*f*d,e[2]=r*f*d-c*l*u,e[3]=r*f*u+c*l*d;break;case"yzx":e[0]=c*f*u+r*l*d,e[1]=r*l*u+c*f*d,e[2]=r*f*d-c*l*u,e[3]=r*f*u-c*l*d;break;case"zxy":e[0]=c*f*u-r*l*d,e[1]=r*l*u+c*f*d,e[2]=r*f*d+c*l*u,e[3]=r*f*u-c*l*d;break;case"zyx":e[0]=c*f*u-r*l*d,e[1]=r*l*u+c*f*d,e[2]=r*f*d-c*l*u,e[3]=r*f*u+c*l*d;break;default:throw new Error("Unknown angle order "+i)}return e}var lo=vs;(function(){var e=ke(),t=Ee(1,0,0),n=Ee(0,1,0);return function(o,i,a){var c=Xe(i,a);return c<-.999999?(Qe(e,t,i),xs(e)<1e-6&&Qe(e,n,i),_e(e,e),Ms(o,e,Math.PI),o):c>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(Qe(e,i,a),o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=1+c,lo(o,o))}})();(function(){var e=Ft(),t=Ft();return function(n,o,i,a,c,r){return en(e,o,c,r),en(t,i,a,r),en(n,e,t,2*r*(1-r)),n}})();(function(){var e=rs();return function(t,n,o,i){return e[0]=o[0],e[3]=o[1],e[6]=o[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-n[0],e[5]=-n[1],e[8]=-n[2],lo(t,bs(t,e))}})();const Hn=-Math.PI/2+.001,Xn=Math.PI/2-.001;class Ps{constructor(){H(this,"target",Ee(0,0,0));H(this,"position",ke());H(this,"yaw",Math.PI*.25);H(this,"pitch",Math.PI*.2);H(this,"distance",6);H(this,"aspect",1);H(this,"fov",45*Math.PI/180);H(this,"near",.1);H(this,"far",1e3);H(this,"orthoScale",4);H(this,"mode","perspective");H(this,"view",it());H(this,"proj",it());H(this,"viewProj",it());H(this,"worldUp",Ee(0,1,0));H(this,"tmpForward",ke());H(this,"tmpRight",ke());H(this,"tmpUp",ke())}setAspect(t){this.aspect=Math.max(1e-4,t)}toggleProjection(){this.mode==="perspective"?(this.orthoScale=this.distance*Math.tan(this.fov*.5),this.mode="axonometric"):(this.distance=this.orthoScale/Math.tan(this.fov*.5),this.mode="perspective")}setAngles(t,n){this.yaw=t,this.pitch=Math.max(Hn,Math.min(Xn,n))}orbit(t,n,o=.005){this.yaw-=t*o,this.pitch-=n*o,this.pitch=Math.max(Hn,Math.min(Xn,this.pitch))}zoom(t,n=.001){const o=Math.exp(t*n);this.mode==="perspective"?this.distance=Math.min(200,Math.max(.2,this.distance*o)):this.orthoScale=Math.min(200,Math.max(.2,this.orthoScale*o))}pan(t,n,o){const i=Math.max(1,o),a=this.getPanScale(i);this.updatePosition(),un(this.tmpForward,this.target,this.position),_e(this.tmpForward,this.tmpForward),Qe(this.tmpRight,this.tmpForward,this.worldUp),_e(this.tmpRight,this.tmpRight),Qe(this.tmpUp,this.tmpRight,this.tmpForward),_e(this.tmpUp,this.tmpUp),vt(this.target,this.target,this.tmpRight,-t*a),vt(this.target,this.target,this.tmpUp,n*a)}getViewMatrix(){return this.updatePosition(),hs(this.view,this.position,this.target,this.worldUp),this.view}getProjectionMatrix(){if(this.mode==="perspective")ds(this.proj,this.fov,this.aspect,this.near,this.far);else{const t=this.orthoScale,n=t*this.aspect;fs(this.proj,-n,n,-t,t,this.near,this.far)}return this.proj}getViewProjMatrix(){return ls(this.viewProj,this.getProjectionMatrix(),this.getViewMatrix()),this.viewProj}getPosition(){return this.updatePosition(),this.position}fitToBounds(t,n,o=1.2){const i=Ee(t[0],t[1],t[2]),a=Ee(n[0],n[1],n[2]),c=ke();us(c,i,a),ms(c,c,.5),ps(this.target,c);const r=.5*gs(i,a)*o;if(this.mode==="perspective"){const l=this.fov*.5,f=r/Math.sin(l),d=r/Math.sin(Math.atan(Math.tan(l)*this.aspect));this.distance=Math.max(f,d)}else this.orthoScale=Math.max(.1,r)}updatePosition(){const t=Math.cos(this.pitch),n=Math.sin(this.pitch),o=Math.cos(this.yaw),i=Math.sin(this.yaw);this.position[0]=this.target[0]+this.distance*t*o,this.position[1]=this.target[1]+this.distance*n,this.position[2]=this.target[2]+this.distance*t*i}getPanScale(t){return this.mode==="perspective"?2*this.distance*Math.tan(this.fov*.5)/t:this.orthoScale*2/t}}class Is{constructor(t,n){H(this,"pointerId",null);H(this,"dragMode",null);H(this,"lastX",0);H(this,"lastY",0);H(this,"pointers",new Map);H(this,"lastMidpoint",null);H(this,"lastDistance",null);H(this,"onPointerDown",t=>{if(this.canvas.setPointerCapture(t.pointerId),t.pointerType==="touch"){this.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),this.updateTouchGestureState();return}this.pointerId=t.pointerId,this.lastX=t.clientX,this.lastY=t.clientY,this.dragMode=this.getDragMode(t)});H(this,"onPointerMove",t=>{if(t.pointerType==="touch"){const i=this.pointers.get(t.pointerId);if(!i)return;const a={x:t.clientX,y:t.clientY};if(this.pointers.set(t.pointerId,a),this.pointers.size===1){const f=a.x-i.x,d=a.y-i.y;this.camera.orbit(-f,-d);return}const c=this.getTwoTouchPoints();if(!c)return;const r=this.getMidpoint(c[0],c[1]),l=this.getDistance(c[0],c[1]);if(this.lastMidpoint&&this.lastDistance!==null){const f=r.x-this.lastMidpoint.x,d=r.y-this.lastMidpoint.y;this.camera.pan(f,d,this.canvas.clientHeight);const u=l-this.lastDistance;Math.abs(u)>0&&this.camera.zoom(-u)}this.lastMidpoint=r,this.lastDistance=l;return}if(this.pointerId!==t.pointerId||!this.dragMode)return;const n=t.clientX-this.lastX,o=t.clientY-this.lastY;this.dragMode==="orbit"?this.camera.orbit(-n,-o):this.camera.pan(n,o,this.canvas.clientHeight),this.lastX=t.clientX,this.lastY=t.clientY});H(this,"onPointerUp",t=>{if(t.pointerType==="touch"){this.pointers.delete(t.pointerId),this.updateTouchGestureState(),this.canvas.releasePointerCapture(t.pointerId);return}this.pointerId===t.pointerId&&(this.canvas.releasePointerCapture(t.pointerId),this.pointerId=null,this.dragMode=null)});H(this,"onWheel",t=>{t.preventDefault();const n=t.deltaY*3.3;this.camera.zoom(n)});H(this,"onKeyDown",t=>{t.code==="KeyP"&&this.camera.toggleProjection()});this.canvas=t,this.camera=n,this.attach()}attach(){this.canvas.addEventListener("pointerdown",this.onPointerDown),this.canvas.addEventListener("pointermove",this.onPointerMove),this.canvas.addEventListener("pointerup",this.onPointerUp),this.canvas.addEventListener("pointercancel",this.onPointerUp),this.canvas.addEventListener("wheel",this.onWheel,{passive:!1}),this.canvas.addEventListener("contextmenu",t=>{t.preventDefault()}),window.addEventListener("keydown",this.onKeyDown)}updateTouchGestureState(){const t=this.getTwoTouchPoints();if(!t){this.lastMidpoint=null,this.lastDistance=null;return}this.lastMidpoint=this.getMidpoint(t[0],t[1]),this.lastDistance=this.getDistance(t[0],t[1])}getTwoTouchPoints(){if(this.pointers.size<2)return null;const t=this.pointers.values(),n=t.next().value,o=t.next().value;return!n||!o?null:[n,o]}getMidpoint(t,n){return{x:(t.x+n.x)*.5,y:(t.y+n.y)*.5}}getDistance(t,n){return Math.hypot(n.x-t.x,n.y-t.y)}getDragMode(t){return t.shiftKey||t.button===1?"pan":t.button===0?"orbit":null}}const Ss=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
  @location(1) normal: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
  @location(0) normal: vec3<f32>,
  @location(1) worldPos: vec3<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  out.normal = normalize((object.model * vec4<f32>(input.normal, 0.0)).xyz);
  out.worldPos = worldPos.xyz;
  return out;
}

// Fade to the average coverage when the pattern is sub-pixel to avoid moire.
fn resolvePattern(value: f32, duty: f32, fw: f32) -> f32 {
  let safeFw = max(fw, 1e-5);
  let fade = clamp(0.5 / safeFw, 0.0, 1.0);
  let clampedDuty = clamp(duty, 0.0, 1.0);
  return mix(clampedDuty, value, fade);
}

// Derivative-based antialiasing for periodic line patterns in screen space.
fn aaLine(u: f32, spacing: f32, thickness: f32) -> f32 {
  let safeSpacing = max(spacing, 1e-5);
  let coord = u / safeSpacing;
  let dist = abs(fract(coord) - 0.5);
  let fw = fwidth(coord);
  let width = clamp(thickness / safeSpacing, 0.0, 1.0);
  let halfWidth = 0.5 * width;
  let line = 1.0 - smoothstep(halfWidth - fw, halfWidth + fw, dist);
  return resolvePattern(line, width, fw);
}

// Antialiased on/off pulse along a period (used for dash segments).
fn aaPulse(u: f32, period: f32, length: f32) -> f32 {
  let safePeriod = max(period, 1e-5);
  let coord = u / safePeriod;
  let phase = fract(coord);
  let fw = fwidth(coord);
  let duty = clamp(length / safePeriod, 0.0, 1.0);
  let head = smoothstep(0.0, fw, phase);
  let tail = 1.0 - smoothstep(duty - fw, duty + fw, phase);
  let pulse = head * tail;
  return resolvePattern(pulse, duty, fw);
}

fn lineMask(
  screenPx: vec2<f32>,
  normal: vec2<f32>,
  spacing: f32,
  thickness: f32
) -> f32 {
  let u = dot(screenPx, normal);
  return aaLine(u, spacing, thickness);
}

fn dashMask(screenPx: vec2<f32>) -> f32 {
  let rowSpacing = 9.0;
  let dashLength = 12.5;
  let dashPeriod = 36.0;
  let thickness = 0.25;
  let rowIndex = floor(screenPx.y / rowSpacing);
  let phase = f32(i32(rowIndex) % 3) * (dashPeriod / 3.0);
  let row = aaLine(screenPx.y, rowSpacing, thickness);
  let dash = aaPulse(screenPx.x + phase, dashPeriod, dashLength);
  return row * dash;
}

fn dashedLineMask(
  screenPx: vec2<f32>,
  normal: vec2<f32>,
  spacing: f32,
  thickness: f32,
  dashLength: f32,
  dashPeriod: f32,
  phase: f32
) -> f32 {
  let line = lineMask(screenPx, normal, spacing, thickness);
  let tangent = vec2<f32>(-normal.y, normal.x);
  let v = dot(screenPx, tangent) + phase;
  let dash = aaPulse(v, dashPeriod, dashLength);
  return line * dash;
}

fn gridMask(worldPos: vec3<f32>, spacing: f32) -> f32 {
  if (spacing <= 0.0) {
    return 0.0;
  }
  let s = max(1e-4, spacing);
  let thickness = 0.0075;
  let lineX = gridLineMask(worldPos.x, s, thickness);
  let lineZ = gridLineMask(worldPos.z, s, thickness);
  return max(lineX, lineZ);
}

fn gridLineMask(u: f32, spacing: f32, thickness: f32) -> f32 {
  let coord = u / spacing;
  let dist = abs(fract(coord) - 0.5);
  let fw = max(fwidth(coord), 1e-4);
  let halfWidth = 0.5 * (thickness / spacing);
  return 1.0 - smoothstep(halfWidth - fw, halfWidth + fw, dist);
}

@fragment
fn fsMain(input: VertexOut, @builtin(front_facing) isFront: bool) -> @location(0) vec4<f32> {
  let light = normalize(-frame.cameraDir);
  let n = normalize(input.normal);
  let shadeNormal = select(-n, n, isFront);
  var ndotl = 0.0;
  let fill = 0.4;
  let materialType = i32(round(object.material.y));
  let patternId = i32(round(object.material.x));
  let gridOnly = object.material.w;

  if (materialType == 1) {
    ndotl = abs(dot(n, light));
  } else {
    ndotl = max(dot(shadeNormal, light), 0.0);
  }

  let lightFactor = min(1.0, ndotl + fill);
  let base = object.color.rgb * lightFactor;

  if (materialType == 1) {
    let grid = gridMask(input.worldPos, object.material.z);
    let gridColor = vec3<f32>(0.55, 0.55, 0.55);
    if (gridOnly > 0.5) {
      if (grid <= 0.0) {
        discard;
      }
      let color = mix(base, gridColor, grid);
      return vec4<f32>(color, 1.0);
    }
    let color = mix(base, gridColor, grid);
    return vec4<f32>(color, object.color.a);
  }

  if (materialType == 3) {
    let viewDir = normalize(frame.cameraPos - input.worldPos);
    let fresnel = pow(1.0 - max(dot(shadeNormal, viewDir), 0.0), 3.0);
    let glassLight = mix(0.65, 1.0, ndotl);
    let glassBase = object.color.rgb * glassLight;
    let rim = mix(glassBase, vec3<f32>(1.0, 1.0, 1.0), 0.6);
    let keyLight = normalize(vec3<f32>(0.35, 0.85, 0.25));
    let halfVec = normalize(keyLight + viewDir);
    let spec = pow(max(dot(shadeNormal, halfVec), 0.0), 64.0);
    // Key lights are positioned from the default camera view to hit front/top faces on load.
    let keyLight1 = normalize(vec3<f32>(-0.805159, 0.326138, 0.495332));
    let keyLight2 = normalize(vec3<f32>(0.805159, 0.326138, -0.495332));
    let halfVec1 = normalize(keyLight1 + viewDir);
    let halfVec2 = normalize(keyLight2 + viewDir);
    let spec1 = pow(max(dot(shadeNormal, halfVec1), 0.0), 64.0);
    let spec2 = pow(max(dot(shadeNormal, halfVec2), 0.0), 64.0);
    let extraSpec = (spec1 + spec2) * 0.18;
    let color = mix(glassBase, rim, fresnel) + spec * 0.25 + extraSpec;
    let alpha = clamp(object.color.a * (0.7 + 0.7 * fresnel), 0.0, 1.0);
    return vec4<f32>(color, alpha);
  }

  if (patternId == 0) {
    return vec4<f32>(base, object.color.a);
  }

  var u = 0.0;
  var v = 0.0;
  let an = abs(n);
  if (an.y >= an.x && an.y >= an.z) {
    u = input.worldPos.x;
    v = input.worldPos.z;
  } else if (an.x >= an.z) {
    u = input.worldPos.z;
    v = input.worldPos.y;
  } else {
    u = input.worldPos.x;
    v = input.worldPos.y;
  }
  let surfaceScale = max(object.material.w, 1e-4);
  let surfacePx = vec2(u, v) * surfaceScale;
  let normalA = vec2<f32>(-0.70710678, 0.70710678);
  let normalB = vec2<f32>(0.70710678, 0.70710678);

  var hatch = 0.0;
  if (patternId == 1) {
    let a = lineMask(surfacePx, normalA, 12.0, 0.25);
    let b = lineMask(surfacePx, normalB, 12.0, 0.25);
    hatch = max(a, b);
  } else if (patternId == 2) {
    hatch = dashedLineMask(surfacePx, normalA, 9.0, 0.25, 8.0, 10.0, 0.0);
  } else if (patternId == 3) {
    hatch = dashMask(surfacePx);
  }

  let ink = vec3<f32>(0.0, 0.0, 0.0);
  let color = mix(base, ink, hatch);
  return vec4<f32>(color, object.color.a);
}
`,Ts=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
  @location(1) normal: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  return out;
}

fn encodeId(id: u32) -> vec4<f32> {
  let r = f32((id >> 0u) & 0xFFu) / 255.0;
  let g = f32((id >> 8u) & 0xFFu) / 255.0;
  let b = f32((id >> 16u) & 0xFFu) / 255.0;
  let a = f32((id >> 24u) & 0xFFu) / 255.0;
  return vec4<f32>(r, g, b, a);
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  let id = u32(object.pick.x);
  return encodeId(id);
}
`,zs=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) start: vec3<f32>,
  @location(1) end: vec3<f32>,
  @location(2) side: f32,
  @location(3) along: f32,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

fn ndcToScreen(ndc: vec2<f32>, viewport: vec2<f32>) -> vec2<f32> {
  let x = (ndc.x * 0.5 + 0.5) * viewport.x;
  let y = (1.0 - (ndc.y * 0.5 + 0.5)) * viewport.y;
  return vec2<f32>(x, y);
}

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  let startClip = frame.viewProj * vec4<f32>(input.start, 1.0);
  let endClip = frame.viewProj * vec4<f32>(input.end, 1.0);
  let startNdc = startClip.xy / startClip.w;
  let endNdc = endClip.xy / endClip.w;

  let viewport = frame.viewport.xy;
  let startScreen = ndcToScreen(startNdc, viewport);
  let endScreen = ndcToScreen(endNdc, viewport);
  var dirScreen = endScreen - startScreen;
  let len = length(dirScreen);
  if (len < 1e-4) {
    dirScreen = vec2<f32>(1.0, 0.0);
  } else {
    dirScreen = dirScreen / len;
  }
  let perp = vec2<f32>(-dirScreen.y, dirScreen.x);
  let halfWidth = 3.0;
  let offsetScreen = perp * (halfWidth * input.side);
  let offsetNdc = vec2<f32>(
    offsetScreen.x * frame.viewport.z * 2.0,
    -offsetScreen.y * frame.viewport.w * 2.0
  );

  let baseClip = mix(startClip, endClip, input.along);
  let baseNdc = baseClip.xy / baseClip.w;
  let finalNdc = baseNdc + offsetNdc;

  var out: VertexOut;
  out.position = vec4<f32>(finalNdc * baseClip.w, baseClip.z, baseClip.w);
  return out;
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  return object.color;
}
`,Cs=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  return out;
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  return object.color;
}

`,Ns=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) aPos: vec3<f32>,
  @location(1) bPos: vec3<f32>,
  @location(2) n0: vec3<f32>,
  @location(3) n1: vec3<f32>,
  @location(4) side: f32,
  @location(5) along: f32,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
  @location(0) @interpolate(flat) lineA: vec2<f32>,
  @location(1) @interpolate(flat) lineB: vec2<f32>,
  @location(2) @interpolate(flat) visibility: f32,
};

fn ndcToScreen(ndc: vec2<f32>) -> vec2<f32> {
  let uv = ndc * 0.5 + vec2<f32>(0.5, 0.5);
  return vec2<f32>(uv.x * frame.viewport.x, (1.0 - uv.y) * frame.viewport.y);
}

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;

  let worldA = object.model * vec4<f32>(input.aPos, 1.0);
  let worldB = object.model * vec4<f32>(input.bPos, 1.0);
  let clipA = frame.viewProj * worldA;
  let clipB = frame.viewProj * worldB;

  let ndcA = clipA.xy / clipA.w;
  let ndcB = clipB.xy / clipB.w;
  let screenA = ndcToScreen(ndcA);
  let screenB = ndcToScreen(ndcB);
  out.lineA = screenA;
  out.lineB = screenB;

  let dir = screenB - screenA;
  let len = max(1e-4, length(dir));
  let tangent = dir / len;
  let normal = vec2<f32>(-tangent.y, tangent.x);

  let halfWidth = 1.0;
  let offsetPx = normal * (input.side * halfWidth);
  let offsetNdc = vec2<f32>(
    offsetPx.x * frame.viewport.z * 2.0,
    -offsetPx.y * frame.viewport.w * 2.0
  );

  let base = mix(clipA, clipB, input.along);
  let biasedZ = max(0.0, base.z);
  let shifted = vec4<f32>(
    base.xy + offsetNdc * base.w,
    biasedZ,
    base.w
  );
  out.position = shifted;

  out.visibility = 1.0;
  return out;
}

@fragment
fn fsMain(input: VertexOut) -> @location(0) vec4<f32> {
  if (input.visibility <= 0.0) {
    discard;
  }
  let a = input.lineA;
  let b = input.lineB;
  let ab = b - a;
  let len2 = max(1e-4, dot(ab, ab));

  let p = input.position.xy / frame.devicePixelRatio;
  let t = clamp(dot(p - a, ab) / len2, 0.0, 1.0);
  let proj = a + ab * t;
  let dist = length(p - proj);

  let halfWidth = 1.0;
  let aa = max(0.5, fwidth(dist));
  let mask = 1.0 - smoothstep(halfWidth - aa, halfWidth + aa, dist);
  return vec4<f32>(object.color.rgb, object.color.a * mask);
}
`,ks={r:21/255,g:21/255,b:21/255,a:1},Es=3;class As{constructor(t,n,o,i,a){H(this,"pipeline");H(this,"terrainPipeline");H(this,"glassBackPipeline");H(this,"glassFrontPipeline");H(this,"curvePipeline");H(this,"wireframePipeline");H(this,"edgePipeline");H(this,"edgeOccludedPipeline");H(this,"pickPipeline");H(this,"frameBindGroupLayout");H(this,"objectBindGroupLayout");H(this,"pipelineLayout");H(this,"frameUniformBuffer");H(this,"frameUniformData");H(this,"frameBindGroup");H(this,"depthTexture",null);H(this,"depthView",null);H(this,"pickTexture",null);H(this,"pickView",null);H(this,"pickDepthTexture",null);H(this,"pickDepthView",null);H(this,"pickBuffer",null);H(this,"objects",[]);H(this,"size",{width:0,height:0,dpr:1});H(this,"cameraDir",ke());H(this,"clearColor",{...ks});this.canvas=t,this.device=n,this.context=o,this.format=i,this.gpuGuard=a,this.frameUniformData=new Float32Array(28),this.frameUniformBuffer=this.gpuCall("GPUDevice.createBuffer(frameUniformBuffer)",()=>this.device.createBuffer({size:this.frameUniformData.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})),this.frameBindGroupLayout=this.gpuCall("GPUDevice.createBindGroupLayout(frame)",()=>this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]})),this.objectBindGroupLayout=this.gpuCall("GPUDevice.createBindGroupLayout(object)",()=>this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]})),this.pipelineLayout=this.gpuCall("GPUDevice.createPipelineLayout",()=>this.device.createPipelineLayout({bindGroupLayouts:[this.frameBindGroupLayout,this.objectBindGroupLayout]})),this.pipeline=this.createPipeline("back"),this.terrainPipeline=this.createPipeline("none",!0),this.glassBackPipeline=this.createPipeline("front",!0,!1,"less-equal"),this.glassFrontPipeline=this.createPipeline("back",!0,!1,"less-equal"),this.curvePipeline=this.createCurvePipeline(),this.wireframePipeline=this.createWireframePipeline(),this.edgePipeline=this.createEdgeHighlightPipeline("always"),this.edgeOccludedPipeline=this.createEdgeHighlightPipeline("less-equal"),this.pickPipeline=this.createPickPipeline(),this.frameBindGroup=this.gpuCall("GPUDevice.createBindGroup(frame)",()=>this.device.createBindGroup({layout:this.frameBindGroupLayout,entries:[{binding:0,resource:{buffer:this.frameUniformBuffer}}]}))}gpuCall(t,n){return this.gpuGuard?this.gpuGuard.call(t,n):n()}gpuCallAsync(t,n){return this.gpuGuard?this.gpuGuard.callAsync(t,n):n()}setObjects(t){this.objects=t}setClearColor(t){this.clearColor={...t}}createRenderObject(t,n,o,i,a,c){const r=$n(o),l=$n(r),f=[...i],d=[...a],u=[...a],h=new Float32Array(28);h.set(r,0),h.set(i,16),h.set(d,20),h.set([0,0,0,0],24);const m=this.gpuCall("GPUDevice.createBuffer(objectUniform)",()=>this.device.createBuffer({size:h.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})),I=this.gpuCall("GPUDevice.createBindGroup(object)",()=>this.device.createBindGroup({layout:this.objectBindGroupLayout,entries:[{binding:0,resource:{buffer:m}}]}));return this.gpuCall("GPUQueue.writeBuffer(objectUniform)",()=>this.device.queue.writeBuffer(m,0,h)),{id:t,mesh:n,modelMatrix:r,baseMatrix:l,color:i,baseColor:f,material:d,baseMaterial:u,objectType:c.objectType,layerIndex:c.layerIndex??0,visible:!0,soilId:c.soilId,sectionId:c.sectionId,profileId:c.profileId,pickId:0,edgeXray:!1,uniformBuffer:m,uniformData:h,bindGroup:I}}resize(){var r,l,f;const t=window.devicePixelRatio||1,n=Math.max(1,Math.floor(this.canvas.clientWidth*t)),o=Math.max(1,Math.floor(this.canvas.clientHeight*t));if(n===this.size.width&&o===this.size.height&&t===this.size.dpr)return;this.size={width:n,height:o,dpr:t},this.canvas.width=n,this.canvas.height=o,this.gpuCall("GPUCanvasContext.configure",()=>this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})),(r=this.depthTexture)==null||r.destroy();const i=this.gpuCall("GPUDevice.createTexture(depth)",()=>this.device.createTexture({size:{width:n,height:o},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}));this.depthTexture=i,this.depthView=this.gpuCall("GPUTexture.createView(depth)",()=>i.createView()),(l=this.pickTexture)==null||l.destroy();const a=this.gpuCall("GPUDevice.createTexture(pick)",()=>this.device.createTexture({size:{width:n,height:o},format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}));this.pickTexture=a,this.pickView=this.gpuCall("GPUTexture.createView(pick)",()=>a.createView()),(f=this.pickDepthTexture)==null||f.destroy();const c=this.gpuCall("GPUDevice.createTexture(pickDepth)",()=>this.device.createTexture({size:{width:n,height:o},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}));this.pickDepthTexture=c,this.pickDepthView=this.gpuCall("GPUTexture.createView(pickDepth)",()=>c.createView()),this.pickBuffer||(this.pickBuffer=this.gpuCall("GPUDevice.createBuffer(pickReadback)",()=>this.device.createBuffer({size:256,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})))}getSize(){return this.size}render(t){this.objects.length!==0&&this.gpuCall("Renderer.render",()=>{this.resize();const n=t.getViewProjMatrix(),o=t.getPosition();un(this.cameraDir,t.target,o),_e(this.cameraDir,this.cameraDir);const i=this.size.width/this.size.dpr,a=this.size.height/this.size.dpr;this.frameUniformData.set(n,0),this.frameUniformData.set([o[0],o[1],o[2],this.size.dpr],16),this.frameUniformData.set([this.cameraDir[0],this.cameraDir[1],this.cameraDir[2],0],20),this.frameUniformData.set([i,a,i>0?1/i:0,a>0?1/a:0],24),this.gpuCall("GPUQueue.writeBuffer(frameUniformBuffer)",()=>this.device.queue.writeBuffer(this.frameUniformBuffer,0,this.frameUniformData.buffer,this.frameUniformData.byteOffset,this.frameUniformData.byteLength));const c=t.mode==="perspective",r=c?a/(2*Math.tan(t.fov*.5)):a/(2*t.orthoScale),l=this.gpuCall("GPUCanvasContext.getCurrentTexture().createView",()=>this.context.getCurrentTexture().createView()),f=this.gpuCall("GPUDevice.createCommandEncoder",()=>this.device.createCommandEncoder()),d=this.gpuCall("GPUCommandEncoder.beginRenderPass",()=>f.beginRenderPass({colorAttachments:[{view:l,loadOp:"clear",storeOp:"store",clearValue:this.clearColor}],depthStencilAttachment:{view:this.depthView,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}}));d.setBindGroup(0,this.frameBindGroup);let u=null;for(const h of this.objects){if(!h.visible)continue;if(h.material[1]===0&&h.material[0]>0){const w=c?r/Math.max(t.distance,.01):r;h.material[3]=w}else h.material[1]!==1&&(h.material[3]=1);if(h.uniformData.set(h.modelMatrix,0),h.uniformData.set(h.color,16),h.uniformData.set(h.material,20),h.uniformData.set([h.pickId??0,0,0,0],24),this.device.queue.writeBuffer(h.uniformBuffer,0,h.uniformData.buffer,h.uniformData.byteOffset,h.uniformData.byteLength),h.objectType==="solid"&&Math.round(h.material[1])===Es){u!==this.glassBackPipeline&&(d.setPipeline(this.glassBackPipeline),u=this.glassBackPipeline),d.setBindGroup(1,h.bindGroup),d.setVertexBuffer(0,h.mesh.vertexBuffer),d.draw(h.mesh.vertexCount,1,0,0),u!==this.glassFrontPipeline&&(d.setPipeline(this.glassFrontPipeline),u=this.glassFrontPipeline),d.setBindGroup(1,h.bindGroup),d.setVertexBuffer(0,h.mesh.vertexBuffer),d.draw(h.mesh.vertexCount,1,0,0);continue}const I=h.objectType==="curve"?this.curvePipeline:h.objectType==="solidWireframe"?this.wireframePipeline:h.objectType==="solidEdge"?h.edgeXray?this.edgePipeline:this.edgeOccludedPipeline:h.objectType==="terrain"||h.objectType==="solid"?this.terrainPipeline:this.pipeline;u!==I&&(d.setPipeline(I),u=I),d.setBindGroup(1,h.bindGroup),d.setVertexBuffer(0,h.mesh.vertexBuffer),d.draw(h.mesh.vertexCount,1,0,0)}d.end(),this.gpuCall("GPUQueue.submit",()=>this.device.queue.submit([f.finish()]))})}async pick(t,n){return this.gpuCallAsync("Renderer.pick",async()=>{const o=this.pickTexture,i=this.pickView,a=this.pickDepthView,c=this.pickBuffer;if(!o||!i||!a||!c)return null;const r=Math.floor(t*this.size.dpr),l=Math.floor(n*this.size.dpr);if(r<0||l<0||r>=this.size.width||l>=this.size.height)return null;const f=this.gpuCall("GPUDevice.createCommandEncoder(pick)",()=>this.device.createCommandEncoder()),d=this.gpuCall("GPUCommandEncoder.beginRenderPass(pick)",()=>f.beginRenderPass({colorAttachments:[{view:i,loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:0}}],depthStencilAttachment:{view:a,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}}));d.setPipeline(this.pickPipeline),d.setBindGroup(0,this.frameBindGroup);for(const m of this.objects)!m.visible||!m.pickId||(d.setBindGroup(1,m.bindGroup),d.setVertexBuffer(0,m.mesh.vertexBuffer),d.draw(m.mesh.vertexCount,1,0,0));d.end(),this.gpuCall("GPUCommandEncoder.copyTextureToBuffer(pick)",()=>f.copyTextureToBuffer({texture:o,origin:{x:r,y:l}},{buffer:c,bytesPerRow:256},{width:1,height:1,depthOrArrayLayers:1})),this.gpuCall("GPUQueue.submit(pick)",()=>this.device.queue.submit([f.finish()])),await this.gpuCallAsync("GPUBuffer.mapAsync(pickReadback)",()=>c.mapAsync(GPUMapMode.READ));const u=new Uint8Array(this.gpuCall("GPUBuffer.getMappedRange(pickReadback)",()=>c.getMappedRange())),h=u[0]|u[1]<<8|u[2]<<16|u[3]<<24;return this.gpuCall("GPUBuffer.unmap(pickReadback)",()=>c.unmap()),h===0?null:h})}createPipeline(t,n=!1,o=!0,i="less"){const a=[{format:this.format}];n&&(a[0].blend={color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}});const c=this.gpuCall("GPUDevice.createShaderModule(mesh)",()=>this.device.createShaderModule({code:Ss}));return this.gpuCall("GPUDevice.createRenderPipeline(mesh)",()=>this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:c,entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{module:c,entryPoint:"fsMain",targets:a},primitive:{topology:"triangle-list",cullMode:t},depthStencil:{format:"depth24plus",depthWriteEnabled:o,depthCompare:i}}))}createCurvePipeline(){const t=this.gpuCall("GPUDevice.createShaderModule(curve)",()=>this.device.createShaderModule({code:zs}));return this.gpuCall("GPUDevice.createRenderPipeline(curve)",()=>this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:t,entryPoint:"vsMain",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32"},{shaderLocation:3,offset:28,format:"float32"}]}]},fragment:{module:t,entryPoint:"fsMain",targets:[{format:this.format,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less-equal",format:"depth24plus"}}))}createWireframePipeline(t="less-equal"){const n=this.gpuCall("GPUDevice.createShaderModule(wireframe)",()=>this.device.createShaderModule({code:Cs}));return this.gpuCall("GPUDevice.createRenderPipeline(wireframe)",()=>this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:n,entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]}]},fragment:{module:n,entryPoint:"fsMain",targets:[{format:this.format}]},primitive:{topology:"line-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:t}}))}createEdgeHighlightPipeline(t){const n=this.gpuCall("GPUDevice.createShaderModule(edgeHighlight)",()=>this.device.createShaderModule({code:Ns}));return this.gpuCall("GPUDevice.createRenderPipeline(edgeHighlight)",()=>this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:n,entryPoint:"vsMain",buffers:[{arrayStride:14*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:6*4,format:"float32x3"},{shaderLocation:3,offset:9*4,format:"float32x3"},{shaderLocation:4,offset:12*4,format:"float32"},{shaderLocation:5,offset:13*4,format:"float32"}]}]},fragment:{module:n,entryPoint:"fsMain",targets:[{format:this.format,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:t}}))}createPickPipeline(){const t=this.gpuCall("GPUDevice.createShaderModule(pick)",()=>this.device.createShaderModule({code:Ts}));return this.gpuCall("GPUDevice.createRenderPipeline(pick)",()=>this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:t,entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{module:t,entryPoint:"fsMain",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}}))}}async function Bs(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load scene: ${t.status}`);return await t.json()}function Fs(e){const t=new Float32Array([.5,-.5,-.5,1,0,0,.5,.5,-.5,1,0,0,.5,.5,.5,1,0,0,.5,-.5,-.5,1,0,0,.5,.5,.5,1,0,0,.5,-.5,.5,1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0,-.5,-.5,-.5,-1,0,0,-.5,.5,-.5,0,1,0,-.5,.5,.5,0,1,0,.5,.5,.5,0,1,0,-.5,.5,-.5,0,1,0,.5,.5,.5,0,1,0,.5,.5,-.5,0,1,0,-.5,-.5,.5,0,-1,0,-.5,-.5,-.5,0,-1,0,.5,-.5,-.5,0,-1,0,-.5,-.5,.5,0,-1,0,.5,-.5,-.5,0,-1,0,.5,-.5,.5,0,-1,0,-.5,-.5,.5,0,0,1,.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,.5,.5,0,0,1,.5,-.5,-.5,0,0,-1,-.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,.5,-.5,0,0,-1]),n=e.createBuffer({size:t.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(n,0,t),{vertexBuffer:n,vertexCount:t.length/6}}const Ls=1e-6;function Us(e,t){if(t.length<2)return Kn(e);const n=[],o=(c,r,l,f)=>{n.push(c[0],c[1],c[2],r[0],r[1],r[2],l,f)};for(let c=0;c<t.length-1;c+=1){const r=t[c],l=t[c+1],f=l[0]-r[0],d=l[1]-r[1],u=l[2]-r[2];f*f+d*d+u*u<=Ls||(o(r,l,-1,0),o(r,l,1,0),o(r,l,1,1),o(r,l,-1,0),o(r,l,1,1),o(r,l,-1,1))}const i=new Float32Array(n);if(i.length===0)return Kn(e);const a=e.createBuffer({size:i.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(a,0,i),{vertexBuffer:a,vertexCount:i.length/8}}function Kn(e){return{vertexBuffer:e.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}function Qn(e,t,n,o,i=.02){const a=[],c=(f,d,u,h,m,I)=>{a.push(f,d,u,h,m,I)};for(let f=0;f<t.length-1;f+=1){const[d,u]=t[f],[h,m]=t[f+1],I=h-d,w=m-u,P=Math.hypot(I,w);if(P<1e-4)continue;const g=w/P,L=-I/P,C=g*i,N=L*i,v=d+C,S=u+N,k=h+C,U=m+N,M=n,A=n,E=o,j=o;c(v,M,S,g,0,L),c(k,E,U,g,0,L),c(k,A,U,g,0,L),c(v,M,S,g,0,L),c(v,j,S,g,0,L),c(k,E,U,g,0,L),c(v,M,S,-g,0,-L),c(k,A,U,-g,0,-L),c(k,E,U,-g,0,-L),c(v,M,S,-g,0,-L),c(k,E,U,-g,0,-L),c(v,j,S,-g,0,-L)}const r=new Float32Array(a),l=e.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(l,0,r),{vertexBuffer:l,vertexCount:r.length/6}}const Gs=1e-6;function Vs(e,t,n,o){const i=Math.floor(t.length/2),a=Math.floor(o.length/3);if(i<3||n.length!==i||a<1||o.length!==a*3)return Jn(e);const c=new Float32Array(i),r=new Float32Array(i),l=new Float32Array(i),f=g=>t[g*2],d=g=>t[g*2+1],u=g=>n[g];for(let g=0;g<o.length;g+=3){let L=o[g]|0,C=o[g+1]|0,N=o[g+2]|0;if(L<0||C<0||N<0||L>=i||C>=i||N>=i)continue;const v=f(L),S=d(L),k=f(C),U=d(C),M=f(N),A=d(N);if((k-v)*(A-S)-(U-S)*(M-v)<0){const Z=C;C=N,N=Z}const j=u(L),O=u(C),X=u(N),D=k-v,x=O-j,T=U-S,y=M-v,F=X-j,z=A-S,W=x*z-T*F,R=T*y-D*z,J=D*F-x*y;c[L]+=W,r[L]+=R,l[L]+=J,c[C]+=W,r[C]+=R,l[C]+=J,c[N]+=W,r[N]+=R,l[N]+=J}const h=new Float32Array(i*3);for(let g=0;g<i;g+=1){const L=c[g],C=r[g],N=l[g],v=Math.hypot(L,C,N);if(v<=Gs){h[g*3]=0,h[g*3+1]=1,h[g*3+2]=0;continue}h[g*3]=L/v,h[g*3+1]=C/v,h[g*3+2]=N/v}const m=[],I=g=>{m.push(f(g),u(g),d(g),h[g*3],h[g*3+1],h[g*3+2])};for(let g=0;g<o.length;g+=3){let L=o[g]|0,C=o[g+1]|0,N=o[g+2]|0;if(L<0||C<0||N<0||L>=i||C>=i||N>=i)continue;const v=f(L),S=d(L),k=f(C),U=d(C),M=f(N),A=d(N);if((k-v)*(A-S)-(U-S)*(M-v)<0){const j=C;C=N,N=j}I(L),I(C),I(N)}const w=new Float32Array(m);if(w.length===0)return Jn(e);const P=e.createBuffer({size:w.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(P,0,w),{vertexBuffer:P,vertexCount:w.length/6}}function Jn(e){return{vertexBuffer:e.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}const js=1e-6,et=6,Os=(e,t,n)=>Math.min(Math.max(e,t),n),Ds=(e,t,n)=>{const o=Math.hypot(e,t,n);return o<=js?null:[e/o,t/o,n/o]},tn=1e-5,Zn=(e,t,n)=>{const o=Math.round(e/tn),i=Math.round(t/tn),a=Math.round(n/tn);return`${o},${i},${a}`};function _s(e,t){if(e.length===0)return e;const n=new Map,o=[],i=(r,l,f,d,u,h)=>{o.push(r[0],r[1],r[2],l[0],l[1],l[2],f[0],f[1],f[2],d[0],d[1],d[2],u,h)},a=(r,l,f,d)=>{i(r,l,f,d,-1,0),i(r,l,f,d,1,0),i(r,l,f,d,1,1),i(r,l,f,d,-1,0),i(r,l,f,d,1,1),i(r,l,f,d,-1,1)},c=(r,l,f)=>{const d=Zn(r[0],r[1],r[2]),u=Zn(l[0],l[1],l[2]),h=d<u?`${d}|${u}`:`${u}|${d}`,m=n.get(h);if(!m){n.set(h,{a:r,b:l,normals:[f]});return}m.normals.push(f)};for(let r=0;r+et*3-1<e.length;r+=et*3){const l=e[r],f=e[r+1],d=e[r+2],u=e[r+et],h=e[r+et+1],m=e[r+et+2],I=e[r+et*2],w=e[r+et*2+1],P=e[r+et*2+2],g=u-l,L=h-f,C=m-d,N=I-l,v=w-f,S=P-d,k=L*S-C*v,U=C*N-g*S,M=g*v-L*N,A=Ds(k,U,M);if(!A)continue;const E=[l,f,d],j=[u,h,m],O=[I,w,P];c(E,j,A),c(j,O,A),c(O,E,A)}for(const r of n.values()){const l=r.normals;if(l.length===1){a(r.a,r.b,l[0],l[0]);continue}let f=1,d=null,u=null;for(let h=0;h<l.length;h+=1){const m=l[h];for(let I=h+1;I<l.length;I+=1){const w=l[I],P=Os(m[0]*w[0]+m[1]*w[1]+m[2]*w[2],-1,1);P<f&&(f=P,d=m,u=w)}}d&&u&&f<t&&a(r.a,r.b,d,u)}return o.length>0?new Float32Array(o):new Float32Array}const qe=1e-6,Rs=Math.cos(40*Math.PI/180);function nn(e,t,n=6){if(t.length===0)return fo(e);const o=e.createBuffer({size:t.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(o,0,t),{vertexBuffer:o,vertexCount:t.length/n}}function Ys(e){if(e.length===0)return e;const t=new Float32Array(e.length*2);let n=0;for(let o=0;o+17<e.length;o+=18){const i=o,a=o+6,c=o+12;for(let r=0;r<6;r+=1)t[n++]=e[i+r];for(let r=0;r<6;r+=1)t[n++]=e[a+r];for(let r=0;r<6;r+=1)t[n++]=e[a+r];for(let r=0;r<6;r+=1)t[n++]=e[c+r];for(let r=0;r<6;r+=1)t[n++]=e[c+r];for(let r=0;r<6;r+=1)t[n++]=e[i+r]}return t}function qs(e,t){const n=Math.floor(t.length/3),o=new Int32Array(n*3);for(let i=0;i<n;i+=1){const a=i*3,c=t[a]|0;let r=t[a+1]|0,l=t[a+2]|0;const f=e[c*2],d=e[c*2+1],u=e[r*2],h=e[r*2+1],m=e[l*2],I=e[l*2+1];if((u-f)*(I-d)-(h-d)*(m-f)<0){const P=r;r=l,l=P}o[a]=c,o[a+1]=r,o[a+2]=l}return o}function eo(e,t,n,o){const i=Math.floor(e.length/2),a=new Float32Array(i*3);for(let c=0;c<n.length;c+=3){const r=n[c],l=n[c+1],f=n[c+2];if(r<0||l<0||f<0||r>=i||l>=i||f>=i)continue;const d=e[r*2],u=e[r*2+1],h=t[r],m=e[l*2],I=e[l*2+1],w=t[l],P=e[f*2],g=e[f*2+1],L=t[f],C=m-d,N=w-h,v=I-u,S=P-d,k=L-h,U=g-u;let M,A,E;o==="up"?(M=N*U-v*k,A=v*S-C*U,E=C*k-N*S):(M=k*v-U*N,A=U*C-S*v,E=S*N-k*C),a[r*3]+=M,a[r*3+1]+=A,a[r*3+2]+=E,a[l*3]+=M,a[l*3+1]+=A,a[l*3+2]+=E,a[f*3]+=M,a[f*3+1]+=A,a[f*3+2]+=E}for(let c=0;c<i;c+=1){const r=a[c*3],l=a[c*3+1],f=a[c*3+2],d=Math.hypot(r,l,f);if(d<=qe){a[c*3]=0,a[c*3+1]=o==="up"?1:-1,a[c*3+2]=0;continue}a[c*3]=r/d,a[c*3+1]=l/d,a[c*3+2]=f/d}return a}function Ws(e,t,n,o,i,a,c){const r=Math.floor(e.length/2),l=Math.floor(t.length/3);if(r<3||n.length!==r||o.length!==r||l<1||t.length!==l*3)return new Float32Array(0);const f=qs(e,t),d=i&&i.length===r*3?i:eo(e,n,f,"up"),u=a&&a.length===r*3?a:eo(e,o,f,"down"),h=[],m=(x,T)=>{h.push(x[0],x[1],x[2],T[0],T[1],T[2])},I=(x,T,y)=>{const F=x[0]+(T[0]-x[0])*y,z=x[1]+(T[1]-x[1])*y,W=x[2]+(T[2]-x[2])*y,R=Math.hypot(F,z,W);return R<=qe?[0,1,0]:[F/R,z/R,W/R]},w=qe,P=x=>{const T=[];for(let y=0;y<x.length;y+=1){const F=x[y],z=x[(y+1)%x.length],W=F.thickness>w,R=z.thickness>w;if(W&&R){T.push(z);continue}if(W===R)continue;const J=z.thickness-F.thickness;if(Math.abs(J)<=qe){R&&T.push(z);continue}const Z=(w-F.thickness)/J,oe=F.x+(z.x-F.x)*Z,ie=F.z+(z.z-F.z)*Z,le=F.yTop+(z.yTop-F.yTop)*Z,fe=F.yBottom+(z.yBottom-F.yBottom)*Z,ge=.5*(le+fe);T.push({x:oe,z:ie,yTop:ge,yBottom:ge,thickness:0,nTop:I(F.nTop,z.nTop,Z),nBottom:I(F.nBottom,z.nBottom,Z)}),R&&T.push(z)}return T},g=x=>{if(!(x.length<3)){for(let T=1;T+1<x.length;T+=1){const y=x[0],F=x[T],z=x[T+1];m([y.x,y.yTop,y.z],y.nTop),m([F.x,F.yTop,F.z],F.nTop),m([z.x,z.yTop,z.z],z.nTop)}for(let T=1;T+1<x.length;T+=1){const y=x[0],F=x[T],z=x[T+1];m([y.x,y.yBottom,y.z],y.nBottom),m([z.x,z.yBottom,z.z],z.nBottom),m([F.x,F.yBottom,F.z],F.nBottom)}}},L=(x,T,y)=>{x.thickness<=w&&T.thickness<=w&&y.thickness<=w||g(P([x,T,y]))},C=1e-5,N=new Int32Array(r),v=[],S=new Map;for(let x=0;x<r;x+=1){const T=e[x*2],y=e[x*2+1],F=Math.round(T/C),z=Math.round(y/C),W=`${F},${z}`;let R=S.get(W);R===void 0&&(R=v.length,S.set(W,R),v.push(x)),N[x]=R}const k=c&&c.length>=3?c:t,U=new Map,M=(x,T)=>{const y=x<T?x:T,F=x<T?T:x;return BigInt(y)<<32n|BigInt(F)},A=(x,T,y)=>{const F=M(x,T),z=U.get(F);if(!z){U.set(F,{a:x,b:T,c:y,count:1});return}z.count+=1};for(let x=0;x+2<k.length;x+=3){const T=k[x]|0,y=k[x+1]|0,F=k[x+2]|0;if(T<0||y<0||F<0||T>=r||y>=r||F>=r)continue;const z=N[T],W=N[y],R=N[F],J=[],Z=(oe,ie,le)=>{if(oe===ie)return;const fe=M(oe,ie);for(const ge of J)if(ge===fe)return;J.push(fe),A(oe,ie,le)};Z(z,W,R),Z(W,R,z),Z(R,z,W)}for(let x=0;x<f.length;x+=3){const T=f[x],y=f[x+1],F=f[x+2];if(T<0||y<0||F<0||T>=r||y>=r||F>=r)continue;const z=e[T*2],W=e[T*2+1],R=e[y*2],J=e[y*2+1],Z=e[F*2],oe=e[F*2+1],ie={x:z,z:W,yTop:n[T],yBottom:o[T],thickness:n[T]-o[T],nTop:[d[T*3],d[T*3+1],d[T*3+2]],nBottom:[u[T*3],u[T*3+1],u[T*3+2]]},le={x:R,z:J,yTop:n[y],yBottom:o[y],thickness:n[y]-o[y],nTop:[d[y*3],d[y*3+1],d[y*3+2]],nBottom:[u[y*3],u[y*3+1],u[y*3+2]]},fe={x:Z,z:oe,yTop:n[F],yBottom:o[F],thickness:n[F]-o[F],nTop:[d[F*3],d[F*3+1],d[F*3+2]],nBottom:[u[F*3],u[F*3+1],u[F*3+2]]};L(ie,le,fe)}const E=(x,T)=>{const y=x.thickness>w,F=T.thickness>w;if(y&&F)return[x,T];if(!y&&!F)return[];const z=T.thickness-x.thickness;if(Math.abs(z)<=qe)return y?[x]:[];const W=(w-x.thickness)/z,R=x.x+(T.x-x.x)*W,J=x.z+(T.z-x.z)*W,Z=x.yTop+(T.yTop-x.yTop)*W,oe=x.yBottom+(T.yBottom-x.yBottom)*W,ie={x:R,z:J,yTop:Z,yBottom:oe,thickness:w};return y?[x,ie]:[ie,T]},j=(x,T,y)=>{const F=[x.x,x.yTop,x.z],z=[T.x,T.yTop,T.z],W=[x.x,x.yBottom,x.z],R=[T.x,T.yBottom,T.z],J=z[0]-F[0],Z=z[1]-F[1],oe=z[2]-F[2],ie=R[0]-F[0],le=R[1]-F[1],fe=R[2]-F[2],ge=Z*fe-oe*le,de=oe*ie-J*fe,he=J*le-Z*ie;if(ge*y[0]+de*y[1]+he*y[2]>=0){m(F,y),m(z,y),m(R,y),m(F,y),m(R,y),m(W,y);return}m(F,y),m(R,y),m(z,y),m(F,y),m(W,y),m(R,y)},O=.001,X=1e-4,D=(x,T)=>{for(let y=0;y<f.length;y+=3){const F=f[y],z=f[y+1],W=f[y+2];if(F<0||z<0||W<0||F>=r||z>=r||W>=r)continue;const R=e[F*2],J=e[F*2+1],Z=e[z*2],oe=e[z*2+1],ie=e[W*2],le=e[W*2+1],fe=Z-R,ge=oe-J,de=ie-R,he=le-J,Pe=x-R,Te=T-J,ze=fe*he-ge*de;if(Math.abs(ze)<=qe)continue;const Se=(Pe*he-Te*de)/ze,je=(fe*Te-ge*Pe)/ze,Ae=1-Se-je;if(Ae>=-qe&&Se>=-qe&&je>=-qe){const $=n[F]*Ae+n[z]*Se+n[W]*je,Re=o[F]*Ae+o[z]*Se+o[W]*je;return $-Re}}return null};for(const x of U.values()){if(x.count!==1)continue;const T=v[x.a],y=v[x.b],F=v[x.c];if(T===void 0||y===void 0||F===void 0)continue;const z=e[T*2],W=e[T*2+1],R=e[y*2],J=e[y*2+1],Z=.5*(z+R),oe=.5*(W+J),ie=R-z;let fe=J-W,ge=-ie;const de=Math.hypot(fe,ge);if(de<=qe)continue;const he=[fe/de,0,ge/de],Pe=D(Z+he[0]*O,oe+he[2]*O),Te=D(Z-he[0]*O,oe-he[2]*O),ze=Pe!==null&&Pe>X,Se=Te!==null&&Te>X;if(ze&&Se)continue;const je=ze?[-he[0],0,-he[2]]:he,Ae={x:z,z:W,yTop:n[T],yBottom:o[T],thickness:n[T]-o[T]},$={x:R,z:J,yTop:n[y],yBottom:o[y],thickness:n[y]-o[y]},Re=E(Ae,$);Re.length===2&&j(Re[0],Re[1],je)}return new Float32Array(h)}function hn(e,t,n,o,i,a,c,r){const l=Math.floor(t.length/2),f=Math.floor(n.length/3);if(l<3||f<1||t.length!==l*2||n.length!==f*3||o.length!==l||i.length!==l){const I=fo(e);return{solid:I,wireframe:I,edges:I}}const d=Ws(t,n,o,i,a,c,r),u=nn(e,d),h=nn(e,Ys(d)),m=nn(e,_s(d,Rs),14);return{solid:u,wireframe:h,edges:m}}function fo(e){return{vertexBuffer:e.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}const We=1e-6;function $s(e){const t=e.worldPath,n=t[0],o=t[t.length-1],i=o[0]-n[0],a=o[1]-n[1],c=Math.hypot(i,a),r=c>We?i/c:1,l=c>We?a/c:0,f=Number.isFinite(e.sScale)&&e.sScale>0?e.sScale:e.LWorld&&e.sMaxCad?e.LWorld/e.sMaxCad:1,d=-l,u=r,h=Math.hypot(d,u),m=h>We?[d/h,0,u/h]:[0,0,1];return{origin:[n[0],n[1]],direction:[r,l],normal:m,sScale:f}}function ho(e,t){const n=e[0]*t.sScale,o=t.origin[0]+t.direction[0]*n,i=t.origin[1]+t.direction[1]*n;return[o,e[1],i]}function Hs(e,t,n){const o=[],i=(f,d)=>{o.push(f[0],f[1],f[2],d[0],d[1],d[2])},a=t.normal,c=[-a[0],-a[1],-a[2]];for(const f of n){const d=Xs(f);if(d.length<3)continue;const u=Qs(d);if(u.length===0)continue;const h=d.map(m=>ho(m,t));for(let m=0;m<u.length;m+=3){const I=u[m],w=u[m+1],P=u[m+2],g=h[I],L=h[w],C=h[P];i(g,a),i(L,a),i(C,a),i(g,c),i(C,c),i(L,c)}}const r=new Float32Array(o),l=e.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(l,0,r),{vertexBuffer:l,vertexCount:r.length/6}}function Xs(e){if(e.length<3)return[];const t=[];for(const a of e){const c=t[t.length-1];(!c||Math.hypot(a[0]-c[0],a[1]-c[1])>We)&&t.push([a[0],a[1]])}if(t.length<3)return[];const n=t[0],o=t[t.length-1];if(Math.hypot(n[0]-o[0],n[1]-o[1])<=We&&t.pop(),t.length<3)return[];const i=Ks(t);return i.length<3?[]:(Js(i)<0&&i.reverse(),i)}function Ks(e){const t=[],n=e.length;for(let o=0;o<n;o+=1){const i=e[(o-1+n)%n],a=e[o],c=e[(o+1)%n],r=Mt(i,a,c),l=a[0]-i[0],f=a[1]-i[1],d=c[0]-a[0],u=c[1]-a[1],h=l*d+f*u;Math.abs(r)<We&&h>0||t.push(a)}return t}function Qs(e){const t=[],n=e.length;if(n<3)return t;const o=Array.from({length:n},(c,r)=>r);let i=0;const a=n*n;for(;o.length>=3&&i<a;){i+=1;let c=!1;for(let r=0;r<o.length;r+=1){const l=o[(r-1+o.length)%o.length],f=o[r],d=o[(r+1)%o.length],u=e[l],h=e[f],m=e[d];if(!Zs(u,h,m))continue;let I=!1;for(let w=0;w<o.length;w+=1){const P=o[w];if(!(P===l||P===f||P===d)&&ei(e[P],u,h,m)){I=!0;break}}if(!I){t.push(l,f,d),o.splice(r,1),c=!0;break}}if(!c){for(let r=1;r<o.length-1;r+=1)t.push(o[0],o[r],o[r+1]);break}}return t}function Mt(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])}function Js(e){let t=0;for(let n=0;n<e.length;n+=1){const o=e[n],i=e[(n+1)%e.length];t+=o[0]*i[1]-i[0]*o[1]}return t*.5}function Zs(e,t,n){return Mt(e,t,n)>We}function ei(e,t,n,o){const i=Mt(t,n,e),a=Mt(n,o,e),c=Mt(o,t,e);return i>=-We&&a>=-We&&c>=-We}function ti(e){const t=new Float32Array([-.5,0,-.5,0,1,0,.5,0,.5,0,1,0,.5,0,-.5,0,1,0,-.5,0,-.5,0,1,0,-.5,0,.5,0,1,0,.5,0,.5,0,1,0]),n=e.createBuffer({size:t.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(n,0,t),{vertexBuffer:n,vertexCount:t.length/6}}const on=[.7,.7,.7],ni=[.12,.5,.18],sn=[.18,.9,.2],rn={landfill:1,silt:2,clay:3},oi=.25,cn=(e,t,n)=>{let o=n;return o<0?o+=1:o>1&&(o-=1),o<1/6?e+(t-e)*6*o:o<1/2?t:o<2/3?e+(t-e)*(2/3-o)*6:e},si=(e,t)=>{const n=e[0],o=e[1],i=e[2],a=Math.max(n,o,i),c=Math.min(n,o,i);let r=0,l=0,f=(a+c)*.5;if(a!==c){const h=a-c;l=f>.5?h/(2-a-c):h/(a+c),a===n?r=(o-i)/h+(o<i?6:0):a===o?r=(i-n)/h+2:r=(n-o)/h+4,r/=6}if(f=Math.min(1,Math.max(0,f+t)),l===0)return[f,f,f];const d=f<.5?f*(1+l):f+l-f*l,u=2*f-d;return[cn(u,d,r+1/3),cn(u,d,r),cn(u,d,r-1/3)]};function ii(e,t,n){var u;const o=new Map,i=[],a=it(),c=Ft(),r={min:[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],max:[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]},l=new Map(n.soils.map(h=>[h.id,h])),f=n.objects.find(h=>h.type==="terrain")??null;let d=!1;if(n.solidsModel){const h=n.solidsModel,m=h.surfaces.terrain;if(m&&Array.isArray(m)){const I=h.mesh,w=Math.floor(I.verticesXZ.length/2);if(w>2&&m.length===w){const P=Vs(e,I.verticesXZ,m,I.triangles);if(P.vertexCount>0){const g=(f==null?void 0:f.color)??ni,C=[0,1,(f==null?void 0:f.gridScale)??1,0],N=t.createRenderObject((f==null?void 0:f.id)??"terrain",P,a,[g[0],g[1],g[2],1],C,{objectType:"terrain"});i.push(N),d=!0}}}}if((u=n.solidsModel)!=null&&u.sectionCurves)for(const h of n.solidsModel.sectionCurves){if(!h.points||h.points.length<2)continue;const m=Us(e,h.points);if(m.vertexCount===0)continue;const I=[0,0,0,0],w=t.createRenderObject(`curve_${h.id}`,m,a,[sn[0],sn[1],sn[2],1],I,{objectType:"curve"});i.push(w)}for(const h of n.objects){if(h.type!=="terrain"&&h.type!=="marker"||h.type==="terrain"&&d)continue;const m=ri(e,h,o),I=ci(h),w=h.soilId?l.get(h.soilId):void 0,P=h.color??(w==null?void 0:w.color)??on,g=h.type==="terrain"?1:h.type==="marker"?2:0,L=h.patternId??(w==null?void 0:w.patternId)??(h.soilId?rn[h.soilId]:0)??0,C=g===0?L:0,N=h.gridScale??1,v=[C,g,N,0],S=t.createRenderObject(h.id,m,I,[P[0],P[1],P[2],1],v,{objectType:h.type,soilId:h.soilId});i.push(S),ai(r,h)}if(n.solidsModel){const h=n.solidsModel,{extent:m,surfaces:I,solids:w}=h,{verticesXZ:P,triangles:g}=h.mesh,L=Math.floor(P.length/2);let C=0;if(L>2)for(const S of w){const k=I[S.top],U=I[S.bottom];if(!k||!U||k.length!==L||U.length!==L){C+=1;continue}const{solid:M,wireframe:A,edges:E}=hn(e,P,g,k,U);if(M.vertexCount===0){C+=1;continue}const j=l.get(S.soilId),O=(j==null?void 0:j.color)??on,D=[(j==null?void 0:j.patternId)??rn[S.soilId]??0,0,0,0],x=t.createRenderObject(`solid_${S.id}`,M,a,[O[0],O[1],O[2],1],D,{objectType:"solid",soilId:S.soilId,layerIndex:C});if(i.push(x),A.vertexCount>0){const T=[0,2,0,0],y=t.createRenderObject(`solid_${S.id}_wireframe`,A,a,[O[0],O[1],O[2],1],T,{objectType:"solidWireframe",soilId:S.soilId,layerIndex:C});i.push(y)}if(E.vertexCount>0){const T=si(O,oi),y=[0,2,0,0],F=t.createRenderObject(`solid_${S.id}_edge`,E,a,[T[0],T[1],T[2],1],y,{objectType:"solidEdge",soilId:S.soilId,layerIndex:C});i.push(F)}C+=1}const N=I.terrain,v=N&&Array.isArray(N)&&N.length>0?fi(N,m.yBase):m.yBase;r.min[0]=Math.min(r.min[0],m.xMin),r.max[0]=Math.max(r.max[0],m.xMax),r.min[2]=Math.min(r.min[2],m.zMin),r.max[2]=Math.max(r.max[2],m.zMax),r.min[1]=Math.min(r.min[1],m.yBase),r.max[1]=Math.max(r.max[1],v)}if(n.sections&&n.sections.length>0){const h=r.min[1],m=r.max[1];for(const I of n.sections)if(I.vector){const w=$s(I.vector);let P=!1;for(const[g,L]of Object.entries(I.vector.patches)){if(!L.rings||L.rings.length===0)continue;const C=Hs(e,w,L.rings);if(C.vertexCount===0)continue;const N=l.get(g),v=(N==null?void 0:N.color)??on,k=[(N==null?void 0:N.patternId)??rn[g]??0,0,0,0],U=t.createRenderObject(`section_${I.id}_${g}`,C,a,[v[0],v[1],v[2],1],k,{objectType:"section",sectionId:I.id,soilId:g});i.push(U),P=!0}if(P)li(r,w,I.vector);else{const g=Qn(e,I.path,h,m),L=[.788,.392,.788],C=[0,2,0,0],N=t.createRenderObject(`section_${I.id}`,g,a,[L[0],L[1],L[2],1],C,{objectType:"section",sectionId:I.id});i.push(N),to(r,I,h,m)}}else{const w=Qn(e,I.path,h,m),P=[.788,.392,.788],g=[0,2,0,0],L=t.createRenderObject(`section_${I.id}`,w,a,[P[0],P[1],P[2],1],g,{objectType:"section",sectionId:I.id});i.push(L),to(r,I,h,m)}}if(n.profiles&&n.profiles.length>0){const h=po(e,o,"box"),m=.35,I=.08,w=[.43,.91,1];for(const P of n.profiles){const g=P.position.x,L=P.position.y,C=P.position.zGround,N=Math.max(P.depth,.01),v=it();fn(v,c,Ee(g,C,L),Ee(m,m,m));const S=it();fn(S,c,Ee(g,C-N*.5,L),Ee(I*2,N,I*2));const k=[0,2,0,0],U=t.createRenderObject(`profile_${P.id}_marker`,h,v,[w[0],w[1],w[2],1],k,{objectType:"profile",profileId:P.id}),M=t.createRenderObject(`profile_${P.id}_shaft`,h,S,[w[0],w[1],w[2],1],k,{objectType:"profile",profileId:P.id});i.push(U,M),di(r,P,m,I)}}return{objects:i,bounds:r,data:n}}function ri(e,t,n){const o=t.mesh.primitive;return po(e,n,o)}function po(e,t,n){const o=t.get(n);if(o)return o;let i;return n==="plane"?i=ti(e):i=Fs(e),t.set(n,i),i}function ci(e){const t=e.position??[0,0,0],n=e.rotation??[0,0,0],o=e.scale??[1,1,1],i=e.mesh.size??[1,1,1],a=[o[0]*i[0],o[1]*i[1],o[2]*i[2]],c=Ft();ws(c,n[0],n[1],n[2]);const r=it();return fn(r,c,Ee(t[0],t[1],t[2]),Ee(a[0],a[1],a[2])),r}function ai(e,t){const n=t.position??[0,0,0],o=t.mesh.size??[1,1,1],i=t.scale??[1,1,1],a=[o[0]*i[0]*.5,o[1]*i[1]*.5,o[2]*i[2]*.5],c=[n[0]-a[0],n[1]-a[1],n[2]-a[2]],r=[n[0]+a[0],n[1]+a[1],n[2]+a[2]];e.min[0]=Math.min(e.min[0],c[0]),e.min[1]=Math.min(e.min[1],c[1]),e.min[2]=Math.min(e.min[2],c[2]),e.max[0]=Math.max(e.max[0],r[0]),e.max[1]=Math.max(e.max[1],r[1]),e.max[2]=Math.max(e.max[2],r[2])}function to(e,t,n,o){for(const[i,a]of t.path)e.min[0]=Math.min(e.min[0],i),e.min[2]=Math.min(e.min[2],a),e.max[0]=Math.max(e.max[0],i),e.max[2]=Math.max(e.max[2],a);e.min[1]=Math.min(e.min[1],n),e.max[1]=Math.max(e.max[1],o)}function li(e,t,n){for(const o of Object.values(n.patches))for(const i of o.rings)for(const a of i){const c=ho([a[0],a[1]],t);e.min[0]=Math.min(e.min[0],c[0]),e.min[1]=Math.min(e.min[1],c[1]),e.min[2]=Math.min(e.min[2],c[2]),e.max[0]=Math.max(e.max[0],c[0]),e.max[1]=Math.max(e.max[1],c[1]),e.max[2]=Math.max(e.max[2],c[2])}}function di(e,t,n,o){const i=t.position.x,a=t.position.y,c=t.position.zGround,r=Math.max(t.depth,.01),l=n*.5,d=Math.max(l,o);e.min[0]=Math.min(e.min[0],i-d),e.max[0]=Math.max(e.max[0],i+d),e.min[2]=Math.min(e.min[2],a-d),e.max[2]=Math.max(e.max[2],a+d),e.max[1]=Math.max(e.max[1],c+l),e.min[1]=Math.min(e.min[1],c-r)}function fi(e,t){let n=Number.NEGATIVE_INFINITY;for(const o of e)Number.isFinite(o)&&(n=Math.max(n,o));return Number.isFinite(n)?n:t}const Le=1e-6,pn=.001,hi=pn+1e-4,an=.001;function uo(e,t,n){return Math.min(Math.max(e,t),n)}function dt(e,t,n,o,i,a){return(n-e)*(a-t)-(o-t)*(i-e)}function pi(e,t){const n=Math.floor(t.length/3),o=new Int32Array(n*3);for(let i=0;i<n;i+=1){const a=i*3,c=t[a]|0;let r=t[a+1]|0,l=t[a+2]|0;const f=e[c*2],d=e[c*2+1],u=e[r*2],h=e[r*2+1],m=e[l*2],I=e[l*2+1];if(dt(f,d,u,h,m,I)<0){const P=r;r=l,l=P}o[a]=c,o[a+1]=r,o[a+2]=l}return o}function no(e,t,n,o){const i=Math.floor(e.length/2),a=new Float32Array(i*3);for(let c=0;c<n.length;c+=3){const r=n[c],l=n[c+1],f=n[c+2];if(r<0||l<0||f<0||r>=i||l>=i||f>=i)continue;const d=e[r*2],u=e[r*2+1],h=t[r],m=e[l*2],I=e[l*2+1],w=t[l],P=e[f*2],g=e[f*2+1],L=t[f],C=m-d,N=w-h,v=I-u,S=P-d,k=L-h,U=g-u;let M,A,E;o==="up"?(M=N*U-v*k,A=v*S-C*U,E=C*k-N*S):(M=k*v-U*N,A=U*C-S*v,E=S*N-k*C),a[r*3]+=M,a[r*3+1]+=A,a[r*3+2]+=E,a[l*3]+=M,a[l*3+1]+=A,a[l*3+2]+=E,a[f*3]+=M,a[f*3+1]+=A,a[f*3+2]+=E}for(let c=0;c<i;c+=1){const r=a[c*3],l=a[c*3+1],f=a[c*3+2],d=Math.hypot(r,l,f);if(d<=Le){a[c*3]=0,a[c*3+1]=o==="up"?1:-1,a[c*3+2]=0;continue}a[c*3]=r/d,a[c*3+1]=l/d,a[c*3+2]=f/d}return a}const ui=e=>{const t=Math.hypot(e[0],e[1],e[2]);return t<=Le?[0,1,0]:[e[0]/t,e[1]/t,e[2]/t]},oo=(e,t,n)=>ui([e[0]+(t[0]-e[0])*n,e[1]+(t[1]-e[1])*n,e[2]+(t[2]-e[2])*n]);function mi(e,t,n,o,i,a){const c=n.length;if(c===0)return{verticesXZ:[],triangles:[],top:[],bottom:[]};const r=new Int32Array(c),l=[],f=[],d=[],u=[],h=[],m=new Map,I=(v,S)=>i==="x"?Math.abs(v-a)<=pn:Math.abs(S-a)<=pn,w=(v,S)=>`${v},${S}`,P=v=>Math.floor(v/an);for(let v=0;v<c;v+=1){const S=e[v*2],k=e[v*2+1];if(!I(S,k)){const j=d.length;l.push(S),f.push(k),d.push(n[v]),u.push(o[v]),h.push(1),r[v]=j;continue}const U=P(S),M=P(k);let A=-1;const E=an*an;for(let j=-1;j<=1&&A===-1;j+=1)for(let O=-1;O<=1&&A===-1;O+=1){const X=m.get(w(U+j,M+O));if(X)for(const D of X){const x=l[D]/h[D],T=f[D]/h[D];if((S-x)*(S-x)+(k-T)*(k-T)<=E){A=D;break}}}if(A===-1){A=d.length,l.push(S),f.push(k),d.push(n[v]),u.push(o[v]),h.push(1);const j=w(U,M),O=m.get(j);O?O.push(A):m.set(j,[A])}else l[A]+=S,f[A]+=k,d[A]+=n[v],u[A]+=o[v],h[A]+=1;r[v]=A}const g=new Array(l.length*2),L=new Array(d.length),C=new Array(u.length);for(let v=0;v<d.length;v+=1){const S=1/h[v];g[v*2]=l[v]*S,g[v*2+1]=f[v]*S,L[v]=d[v]*S,C[v]=u[v]*S}const N=[];for(let v=0;v+2<t.length;v+=3){const S=r[t[v]],k=r[t[v+1]],U=r[t[v+2]];if(S===k||k===U||U===S)continue;const M=g[S*2],A=g[S*2+1],E=g[k*2],j=g[k*2+1],O=g[U*2],X=g[U*2+1],D=dt(M,A,E,j,O,X);Math.abs(D)<=Le||N.push(S,k,U)}return{verticesXZ:g,triangles:N,top:L,bottom:C}}function Lt(e,t,n,o,i,a,c){const r=Math.floor(e.length/2),l=Math.floor(t.length/3);if(r<3||l<1||e.length!==r*2||t.length!==l*3||n.length!==r||o.length!==r)return{verticesXZ:[],triangles:[],top:[],bottom:[]};const f=[],d=[],u=[],h=[],m=new Int32Array(r);m.fill(-1);const I=new Map,w=k=>Math.abs(k-a)<=hi?a:k,P=k=>w(i==="x"?e[k*2]:e[k*2+1]),g=k=>{const U=P(k);return c==="max"?U<=a+Le:U>=a-Le},L=(k,U)=>{const M=k<U?k:U,A=k<U?U:k;return BigInt(M)<<32n|BigInt(A)},C=k=>{const U=m[k];if(U!==-1)return U;const M=d.length;m[k]=M;let A=e[k*2],E=e[k*2+1];return i==="x"?A=w(A):E=w(E),f.push(A,E),d.push(n[k]),u.push(o[k]),M},N=(k,U)=>{const M=P(k),A=P(U);if(Math.abs(M-a)<=Le)return C(k);if(Math.abs(A-a)<=Le)return C(U);const E=L(k,U),j=I.get(E);if(j!==void 0)return j;const O=e[k*2],X=e[k*2+1],D=e[U*2],x=e[U*2+1],T=n[k],y=o[k],F=n[U],z=o[U],W=A-M,R=Math.abs(W)<=Le?0:uo((a-M)/W,0,1);let J=O+(D-O)*R,Z=X+(x-X)*R;i==="x"?J=a:Z=a;const oe=T+(F-T)*R,ie=y+(z-y)*R,le=d.length;return I.set(E,le),f.push(J,Z),d.push(oe),u.push(ie),le},v=(k,U,M)=>{if(k===U||U===M||M===k)return;const A=f[k*2],E=f[k*2+1],j=f[U*2],O=f[U*2+1],X=f[M*2],D=f[M*2+1],x=dt(A,E,j,O,X,D);Math.abs(x)<=Le||h.push(k,U,M)},S=(k,U,M)=>{const A=[g(k),g(U),g(M)];if(!A[0]&&!A[1]&&!A[2])return;if(A[0]&&A[1]&&A[2]){v(C(k),C(U),C(M));return}const E=[],j=D=>{(E.length===0||E[E.length-1]!==D)&&E.push(D)},O=[k,U,M];for(let D=0;D<3;D+=1){const x=O[D],T=O[(D+1)%3],y=A[D],F=A[(D+1)%3];y&&F?j(C(T)):y&&!F?j(N(x,T)):!y&&F&&(j(N(x,T)),j(C(T)))}if(E.length>1&&E[0]===E[E.length-1]&&E.pop(),E.length<3)return;const X=E[0];for(let D=1;D+1<E.length;D+=1)v(X,E[D],E[D+1])};for(let k=0;k<l;k+=1){const U=k*3,M=t[U]|0,A=t[U+1]|0,E=t[U+2]|0;M<0||A<0||E<0||M>=r||A>=r||E>=r||S(M,A,E)}return mi(f,h,d,u,i,a)}function gi(e,t,n,o,i,a){const c=Math.floor(e.length/2),r=Math.floor(t.length/3);if(c<3||r<1||e.length!==c*2||t.length!==r*3||n.length!==c||o.length!==c)return{verticesXZ:[],triangles:[],top:[],bottom:[]};let l={verticesXZ:e,triangles:t,top:n,bottom:o};return i<Number.POSITIVE_INFINITY&&(l=Lt(l.verticesXZ,l.triangles,l.top,l.bottom,"x",i,"max")),a<Number.POSITIVE_INFINITY&&(l=Lt(l.verticesXZ,l.triangles,l.top,l.bottom,"z",a,"max")),l}function xi(e,t,n,o,i,a=Number.NEGATIVE_INFINITY){const c=Math.floor(e.length/2),r=Math.floor(t.length/3);if(c<3||r<1||e.length!==c*2||t.length!==r*3||n.length!==c||o.length!==c)return{verticesXZ:[],triangles:[],top:[],bottom:[]};let l={verticesXZ:e,triangles:t,top:n,bottom:o};return i>Number.NEGATIVE_INFINITY&&(l=Lt(l.verticesXZ,l.triangles,l.top,l.bottom,"x",i,"min")),a>Number.NEGATIVE_INFINITY&&(l=Lt(l.verticesXZ,l.triangles,l.top,l.bottom,"z",a,"min")),l}function yi(e,t,n,o,i){const a=Math.floor(e.length/2),c=Math.floor(t.length/3);if(a<3||c<1||e.length!==a*2||t.length!==c*3||n.length!==a||o.length!==a)return{verticesXZ:[],triangles:[],boundaryTriangles:[],top:[],bottom:[],topNormals:[],bottomNormals:[]};const r=pi(e,t),l=no(e,n,r,"up"),f=no(e,o,r,"down"),d=1e-5,u=1e-4,h=(M,A)=>{const E=Math.round(M.x/d),j=Math.round(M.z/d),O=Math.round(M.top/d),X=Math.round(M.bottom/d),D=Math.round(M.nTop[0]/u),x=Math.round(M.nTop[1]/u),T=Math.round(M.nTop[2]/u),y=Math.round(M.nBottom[0]/u),F=Math.round(M.nBottom[1]/u),z=Math.round(M.nBottom[2]/u);return`${E},${j},${O},${X},${D},${x},${T},${y},${F},${z}${A?"|cap":""}`},m=[],I=[],w=[],P=[],g=[],L=[],C=[],N=new Map,v=(M,A)=>{const E=h(M,A),j=N.get(E);if(j!==void 0)return j;const O=I.length;return N.set(E,O),m.push(M.x,M.z),I.push(M.top),w.push(M.bottom),P.push(M.nTop[0],M.nTop[1],M.nTop[2]),g.push(M.nBottom[0],M.nBottom[1],M.nBottom[2]),O},S=(M,A,E,j,O)=>{if(j){let y=dt(M.x,M.z,A.x,A.z,E.x,E.z);if(y<0){const J=A;A=E,E=J,y=-y}const F=[0,-1,0];M={...M,nTop:F},A={...A,nTop:F},E={...E,nTop:F};const z=v(M,j),W=v(A,j),R=v(E,j);if(C.push(z,W,R),z===W||W===R||R===z||Math.abs(y)<=Le)return;L.push(z,W,R);return}let X=dt(M.x,M.z,A.x,A.z,E.x,E.z);if(O!==0&&X*O<0){const y=A;A=E,E=y,X=-X}const D=v(M,j),x=v(A,j),T=v(E,j);C.push(D,x,T),!(D===x||x===T||T===D)&&(Math.abs(X)<=Le||L.push(D,x,T))},k=M=>M.top>i?{...M,top:i}:M,U=(M,A)=>{const E=A.top-M.top;if(Math.abs(E)<=Le)return{...M,top:i};const j=uo((i-M.top)/E,0,1);return{x:M.x+(A.x-M.x)*j,z:M.z+(A.z-M.z)*j,top:i,bottom:M.bottom+(A.bottom-M.bottom)*j,nTop:oo(M.nTop,A.nTop,j),nBottom:oo(M.nBottom,A.nBottom,j)}};for(let M=0;M<c;M+=1){const A=M*3,E=t[A]|0,j=t[A+1]|0,O=t[A+2]|0;if(E<0||j<0||O<0||E>=a||j>=a||O>=a)continue;const X={x:e[E*2],z:e[E*2+1],top:n[E],bottom:o[E],nTop:[l[E*3],l[E*3+1],l[E*3+2]],nBottom:[f[E*3],f[E*3+1],f[E*3+2]]},D={x:e[j*2],z:e[j*2+1],top:n[j],bottom:o[j],nTop:[l[j*3],l[j*3+1],l[j*3+2]],nBottom:[f[j*3],f[j*3+1],f[j*3+2]]},x={x:e[O*2],z:e[O*2+1],top:n[O],bottom:o[O],nTop:[l[O*3],l[O*3+1],l[O*3+2]],nBottom:[f[O*3],f[O*3+1],f[O*3+2]]},T=dt(X.x,X.z,D.x,D.z,x.x,x.z),y=T===0?0:Math.sign(T),F=X.top>i+Le,z=D.top>i+Le,W=x.top>i+Le,R=(F?1:0)+(z?1:0)+(W?1:0);if(R===0){S(X,D,x,!1,y);continue}if(R===3){S(k(X),k(D),k(x),!0,y);continue}if(R===1){let de=X,he=D,Pe=x;z?(de=D,he=x,Pe=X):W&&(de=x,he=X,Pe=D);const Te=U(de,he),ze=U(de,Pe),Se=k(de);S(he,Pe,Te,!1,y),S(Pe,ze,Te,!1,y),S(Se,Te,ze,!0,y);continue}let J=X,Z=D,oe=x;z?W||(J=x,Z=X,oe=D):(J=D,Z=x,oe=X);const ie=U(Z,J),le=U(oe,J),fe=k(Z),ge=k(oe);S(J,ie,le,!1,y),S(fe,ge,le,!0,y),S(fe,le,ie,!0,y)}return{verticesXZ:m,triangles:L,boundaryTriangles:C,top:I,bottom:w,topNormals:P,bottomNormals:g}}const Ke=e=>-e;function vi(e){return e.map(t=>({...t,worldPath:t.worldPath.map(([n,o])=>[n,Ke(o)])}))}function Mi(e){if(e.objects)for(const t of e.objects)t.position&&(t.position=[t.position[0],t.position[1],Ke(t.position[2])]);if(e.sections&&(e.sections=e.sections.map(t=>({...t,path:t.path.map(([n,o])=>[n,Ke(o)])}))),e.profiles)for(const t of e.profiles)t.position.y=Ke(t.position.y)}function bi(e){const t=e.extent.zMin,n=e.extent.zMax;if(e.extent.zMin=Ke(n),e.extent.zMax=Ke(t),e.sectionCurves)for(const a of e.sectionCurves)for(const c of a.points)c[2]=Ke(c[2]);if(e.solidOutlines)for(const a of Object.values(e.solidOutlines.bySolid))for(const c of a)for(let r=2;r<c.length;r+=3)c[r]=Ke(c[r]);const{verticesXZ:o,triangles:i}=e.mesh;for(let a=1;a<o.length;a+=2)o[a]=Ke(o[a]);for(let a=0;a+2<i.length;a+=3){const c=i[a+1];i[a+1]=i[a+2],i[a+2]=c}}const wi=[{id:"s1",name:"Geological Section No. 1",sourceDxf:"sections/section_1.dxf",worldPath:[[.01,4.25],[19.99,2.13]],LWorld:20.09215767407771,sMaxCad:20.09,sScale:1.0001074004020762,zRef:5,zBase:-5.55,interfaces:{terrain:[[0,0],[.98,.47],[2.07,.99],[2.97,1.41],[4.32,2],[4.5,2.07],[5.74,2.55],[7.03,3],[8.1,3.26],[9.18,3.49],[10.32,3.73],[11.32,3.91],[12.18,4.06],[13.06,4.19],[13.55,4.25],[13.93,4.3],[15.06,4.44],[16.02,4.54],[18.34,4.79],[19.22,4.89],[20.09,5]],base:[[0,-5.55],[20.09,-5.55]],landfillBase:[[0,-1.19],[1.01,-.91],[2.01,-.54],[3.01,-.16],[4.02,.22],[5.04,.57],[6.07,.9],[7.1,1.2],[8.09,1.48],[9.12,1.78],[10.06,2.04],[11.06,2.26],[12.09,2.42],[13.13,2.53],[14.17,2.6],[15.22,2.67],[16.26,2.74],[17.54,2.83],[18.81,2.9],[20.09,2.95]],siltClay:[[0,-2.23],[1.01,-1.87],[2.01,-1.44],[3.05,-1.09],[5.18,-.49],[6.13,-.15],[7.03,.28],[8.04,.98],[9.03,1.72],[9.12,1.78]]},patches:{landfill:{rings:[[[1.01,-.91],[2.01,-.54],[3.01,-.16],[4.02,.22],[5.04,.57],[6.07,.9],[7.1,1.2],[8.09,1.48],[9.12,1.78],[10.06,2.04],[11.06,2.26],[12.09,2.42],[13.13,2.53],[14.17,2.6],[15.22,2.67],[16.26,2.74],[17.54,2.83],[18.81,2.9],[20.09,2.95],[20.09,5],[19.22,4.89],[18.34,4.79],[16.02,4.54],[15.06,4.44],[13.93,4.3],[13.55,4.25],[13.06,4.19],[12.18,4.06],[11.32,3.91],[10.32,3.73],[9.18,3.49],[8.1,3.26],[7.03,3],[5.74,2.55],[4.5,2.07],[4.32,2],[2.97,1.41],[2.07,.99],[.98,.47],[0,0],[0,-1.19]]]},clay:{rings:[[[20.09,-5.55],[20.09,2.95],[18.81,2.9],[17.54,2.83],[16.26,2.74],[15.22,2.67],[14.17,2.6],[13.13,2.53],[12.09,2.42],[11.06,2.26],[10.06,2.04],[9.12,1.78],[9.03,1.72],[8.04,.98],[7.03,.28],[6.13,-.15],[5.18,-.49],[3.05,-1.09],[2.01,-1.44],[1.01,-1.87],[0,-2.23],[0,-5.55]]]},silt:{rings:[[[1.01,-1.87],[2.01,-1.44],[3.05,-1.09],[5.18,-.49],[6.13,-.15],[7.03,.28],[8.04,.98],[9.03,1.72],[9.12,1.78],[8.09,1.48],[7.1,1.2],[6.07,.9],[5.04,.57],[4.02,.22],[3.01,-.16],[2.01,-.54],[1.01,-.91],[0,-1.19],[0,-2.23]]]}}},{id:"s2",name:"Section 2",sourceDxf:"sections/section_2.dxf",worldPath:[[2.11,9.68],[1.91,.43]],LWorld:9.25216190952147,sMaxCad:9.25,sScale:1.0002337199482672,zRef:.97,zBase:-5.55,interfaces:{terrain:[[0,.97],[.59,.95],[1.27,.94],[1.5,.94],[2.41,.94],[2.64,.94],[3.3,.95],[4.56,.95],[5.59,.95],[6.63,.94],[7.65,.92],[8.64,.9],[9.25,.88]],base:[[0,-5.55],[9.25,-5.55]],landfillBase:[[0,-.3],[.03,-.25],[.12,-.29],[.17,-.32],[1.26,-.36],[1.65,-.37],[2.35,-.4],[2.76,-.43],[3.45,-.46],[4.04,-.47],[4.55,-.52],[5.59,-.55],[5.68,-.54],[6.56,-.54],[7.68,-.55],[8.06,-.56],[8.68,-.58],[9.25,-.61]],siltClay:[[0,-1.7],[.03,-1.64],[.12,-1.68],[.17,-1.7],[.33,-1.7],[1.26,-1.67],[1.65,-1.64],[2.36,-1.6],[2.76,-1.59],[3.45,-1.55],[4.03,-1.5],[4.55,-1.5],[5.59,-1.45],[5.64,-1.45],[5.68,-1.45],[5.71,-1.45],[6.41,-1.47],[6.81,-1.49],[7.17,-1.52],[7.77,-1.56],[9.25,-1.67]]},patches:{landfill:{rings:[[[.03,-.25],[.12,-.29],[.17,-.32],[1.26,-.36],[1.65,-.37],[2.35,-.4],[2.76,-.43],[3.45,-.46],[4.04,-.47],[4.55,-.52],[5.59,-.55],[5.68,-.54],[6.56,-.54],[7.68,-.55],[8.06,-.56],[8.68,-.58],[9.25,-.61],[9.25,.88],[8.64,.9],[7.65,.92],[6.63,.94],[5.59,.95],[4.56,.95],[3.3,.95],[2.64,.94],[2.41,.94],[1.5,.94],[1.27,.94],[.59,.95],[0,.97],[0,-.3]]]},clay:{rings:[[[9.25,-5.55],[9.25,-1.67],[7.77,-1.56],[7.17,-1.52],[6.81,-1.49],[6.41,-1.47],[5.71,-1.45],[5.68,-1.45],[5.64,-1.45],[5.59,-1.45],[4.55,-1.5],[4.03,-1.5],[3.45,-1.55],[2.76,-1.59],[2.36,-1.6],[1.65,-1.64],[1.26,-1.67],[.33,-1.7],[.17,-1.7],[.12,-1.68],[.03,-1.64],[0,-1.7],[0,-5.55]]]},silt:{rings:[[[.03,-1.64],[.12,-1.68],[.17,-1.7],[.33,-1.7],[1.26,-1.67],[1.65,-1.64],[2.36,-1.6],[2.76,-1.59],[3.45,-1.55],[4.03,-1.5],[4.55,-1.5],[5.59,-1.45],[5.64,-1.45],[5.68,-1.45],[5.71,-1.45],[6.41,-1.47],[6.81,-1.49],[7.17,-1.52],[7.77,-1.56],[9.25,-1.67],[9.25,-.61],[8.68,-.58],[8.06,-.56],[7.68,-.55],[6.56,-.54],[5.68,-.54],[5.59,-.55],[4.55,-.52],[4.04,-.47],[3.45,-.46],[2.76,-.43],[2.35,-.4],[1.65,-.37],[1.26,-.36],[.17,-.32],[.12,-.29],[.03,-.25],[0,-.3],[0,-1.7]]]}}},{id:"s3",name:"Section 3",sourceDxf:"sections/section_3.dxf",worldPath:[[15.29,.45],[15.63,9.53]],LWorld:9.086363408977213,sMaxCad:9.09,sScale:.9995999349809915,zRef:4.48,zBase:-5.55,interfaces:{terrain:[[0,4.43],[.69,4.45],[1.83,4.48],[2.64,4.48],[2.95,4.48],[3.82,4.48],[4.98,4.47],[6.25,4.44],[6.46,4.43],[7.32,4.42],[7.96,4.42],[8.44,4.42],[9.09,4.44]],base:[[0,-5.55],[9.09,-5.55]],landfillClay:[[0,2.58],[.39,2.6],[1.86,2.65],[2.17,2.68],[3.71,2.75],[3.78,2.75],[4.96,2.76],[6.13,2.73],[7.3,2.58],[7.63,2.54],[8.38,2.43],[8.58,2.4],[9.09,2.31]]},patches:{landfill:{rings:[[[.39,2.6],[1.86,2.65],[2.17,2.68],[3.71,2.75],[3.78,2.75],[4.96,2.76],[6.13,2.73],[7.3,2.58],[7.63,2.54],[8.38,2.43],[8.58,2.4],[9.09,2.31],[9.09,4.44],[8.44,4.42],[7.96,4.42],[7.32,4.42],[6.46,4.43],[6.25,4.44],[4.98,4.47],[3.82,4.48],[2.95,4.48],[2.64,4.48],[1.83,4.48],[.69,4.45],[0,4.43],[0,2.58]]]},clay:{rings:[[[9.09,-5.55],[9.09,2.31],[8.58,2.4],[8.38,2.43],[7.63,2.54],[7.3,2.58],[6.13,2.73],[4.96,2.76],[3.78,2.75],[3.71,2.75],[2.17,2.68],[1.86,2.65],[.39,2.6],[0,2.58],[0,-5.55]]]}}},{id:"s4",name:"Section 4",sourceDxf:"sections/section_4.dxf",worldPath:[[.2,9.81],[19.72,9.72]],LWorld:19.52020747840555,sMaxCad:19.52,sScale:1.0000106290166777,zRef:4.96,zBase:-5.55,interfaces:{terrain:[[0,.09],[.72,.41],[.94,.51],[1.95,.99],[2.72,1.35],[3.72,1.82],[3.97,1.93],[4.73,2.26],[4.98,2.36],[5.76,2.66],[6.54,2.91],[6.8,3],[7.64,3.22],[7.87,3.28],[8.71,3.47],[8.94,3.52],[9.79,3.68],[10.03,3.73],[10.88,3.87],[11.13,3.9],[11.98,4.03],[12.23,4.06],[13.34,4.2],[14.46,4.33],[15.3,4.43],[15.57,4.46],[16.41,4.56],[16.69,4.59],[17.52,4.69],[17.71,4.71],[18.16,4.77],[18.8,4.86],[19.52,4.96]],base:[[0,-5.55],[19.52,-5.55]],landfillBase:[[0,-1.27],[.83,-.86],[.9,-.81],[1.45,-.6],[1.93,-.49],[2.4,-.37],[3.09,-.22],[3.55,-.03],[4.05,.08],[4.71,.19],[4.9,.23],[5.12,.24],[5.78,.2],[6.8,.25],[6.93,.28],[7.76,.44],[8.03,.49],[9.12,.73],[9.94,.92],[10.21,.99],[10.39,1.03],[11.03,1.19],[11.3,1.26],[12.11,1.47],[12.39,1.54],[13.2,1.74],[13.49,1.81],[14.28,2.01],[14.58,2.07],[15.37,2.26],[15.67,2.32],[16.46,2.49],[16.67,2.52],[17.51,2.68],[17.69,2.7],[18.13,2.76],[18.78,2.86],[19.44,2.93],[19.52,2.94]],siltClay:[[0,-2.65],[.82,-2.24],[.88,-2.2],[1.45,-2],[1.94,-1.92],[2.42,-1.83],[3.12,-1.72],[3.58,-1.54],[4.1,-1.44],[4.74,-1.37],[5.02,-1.3],[5.45,-1.28],[5.82,-1.31],[5.87,-1.3],[6.72,-1.17],[6.79,-1.15],[6.86,-1.11],[7.62,-.75],[7.85,-.62],[8.58,-.21],[8.81,-.06],[9.51,.4],[9.74,.56],[10.39,1.03]]},patches:{landfill:{rings:[[[.83,-.86],[.9,-.81],[1.45,-.6],[1.93,-.49],[2.4,-.37],[3.09,-.22],[3.55,-.03],[4.05,.08],[4.71,.19],[4.9,.23],[5.12,.24],[5.78,.2],[6.8,.25],[6.93,.28],[7.76,.44],[8.03,.49],[9.12,.73],[9.94,.92],[10.21,.99],[10.39,1.03],[11.03,1.19],[11.3,1.26],[12.11,1.47],[12.39,1.54],[13.2,1.74],[13.49,1.81],[14.28,2.01],[14.58,2.07],[15.37,2.26],[15.67,2.32],[16.46,2.49],[16.67,2.52],[17.51,2.68],[17.69,2.7],[18.13,2.76],[18.78,2.86],[19.44,2.93],[19.52,2.94],[19.52,4.96],[18.8,4.86],[18.16,4.77],[17.71,4.71],[17.52,4.69],[16.69,4.59],[16.41,4.56],[15.57,4.46],[15.3,4.43],[14.46,4.33],[13.34,4.2],[12.23,4.06],[11.98,4.03],[11.13,3.9],[10.88,3.87],[10.03,3.73],[9.79,3.68],[8.94,3.52],[8.71,3.47],[7.87,3.28],[7.64,3.22],[6.8,3],[6.54,2.91],[5.76,2.66],[4.98,2.36],[4.73,2.26],[3.97,1.93],[3.72,1.82],[2.72,1.35],[1.95,.99],[.94,.51],[.72,.41],[0,.09],[0,-1.27]]]},clay:{rings:[[[19.52,-5.55],[19.52,2.94],[19.44,2.93],[18.78,2.86],[18.13,2.76],[17.69,2.7],[17.51,2.68],[16.67,2.52],[16.46,2.49],[15.67,2.32],[15.37,2.26],[14.58,2.07],[14.28,2.01],[13.49,1.81],[13.2,1.74],[12.39,1.54],[12.11,1.47],[11.3,1.26],[11.03,1.19],[10.39,1.03],[9.74,.56],[9.51,.4],[8.81,-.06],[8.58,-.21],[7.85,-.62],[7.62,-.75],[6.86,-1.11],[6.79,-1.15],[6.72,-1.17],[5.87,-1.3],[5.82,-1.31],[5.45,-1.28],[5.02,-1.3],[4.74,-1.37],[4.1,-1.44],[3.58,-1.54],[3.12,-1.72],[2.42,-1.83],[1.94,-1.92],[1.45,-2],[.88,-2.2],[.82,-2.24],[0,-2.65],[0,-5.55]]]},silt:{rings:[[[.82,-2.24],[.88,-2.2],[1.45,-2],[1.94,-1.92],[2.42,-1.83],[3.12,-1.72],[3.58,-1.54],[4.1,-1.44],[4.74,-1.37],[5.02,-1.3],[5.45,-1.28],[5.82,-1.31],[5.87,-1.3],[6.72,-1.17],[6.79,-1.15],[6.86,-1.11],[7.62,-.75],[7.85,-.62],[8.58,-.21],[8.81,-.06],[9.51,.4],[9.74,.56],[10.39,1.03],[10.21,.99],[9.94,.92],[9.12,.73],[8.03,.49],[7.76,.44],[6.93,.28],[6.8,.25],[5.78,.2],[5.12,.24],[4.9,.23],[4.71,.19],[4.05,.08],[3.55,-.03],[3.09,-.22],[2.4,-.37],[1.93,-.49],[1.45,-.6],[.9,-.81],[.83,-.86],[0,-1.27],[0,-2.65]]]}}}],Pi={sections:wi},Ut=1e-6,so=new WeakMap;function Ii(e,t,n){const o=e.path;if(o.length<2)return null;const[i,a]=o[0],[c,r]=o[o.length-1],l=c-i,f=r-a,d=Math.hypot(l,f);if(!Number.isFinite(d)||d<=Ut)return null;const u=l/d,h=f/d,m=t.surfaces,I=Ti(t),w=I.avgEdgeLength,P=Math.max(.01,w),g=Math.max(2,Math.floor(d/P)+1),L=new Map,C=(O,X,D)=>{const x=L.get(O)??m[O];return x?(L.set(O,x),Ci(I,x,X,D)):0},N=[],v=[],S=Object.create(null),k=new Set;for(const O of t.solids)k.add(O.top),k.add(O.bottom);const U=Array.from(k);for(const O of U)S[O]=[];for(let O=0;O<g;O+=1){const X=O/(g-1)*d,D=i+u*X,x=a+h*X;N.push(X);const T=C("terrain",D,x);v.push(T);for(const y of U)S[y].push(C(y,D,x))}const M=Math.max(...v),A=[];let E=Number.POSITIVE_INFINITY,j=Number.NEGATIVE_INFINITY;for(const O of t.solids){const X=S[O.top],D=S[O.bottom];if(!X||!D)continue;let x=0;for(let y=0;y<X.length;y+=1)x=Math.max(x,X[y]-D[y]);if(x<=Ut)continue;const T=[];for(let y=0;y<g;y+=1){const F=M-X[y];E=Math.min(E,F),j=Math.max(j,F),T.push({s:N[y],d:F})}for(let y=g-1;y>=0;y-=1){const F=M-D[y];E=Math.min(E,F),j=Math.max(j,F),T.push({s:N[y],d:F})}A.push({soilId:O.soilId,rings:[T]})}return!Number.isFinite(E)||A.length===0?null:{minS:0,maxS:d,minD:E,maxD:j,zRef:M,patches:A}}function Si(e,t){const n=Math.floor(e.length/2),o=Math.floor(t.length/3);if(n<3||o<1)return .25;const i=Math.min(o,200),a=Math.max(1,Math.floor(o/i));let c=0,r=0;for(let f=0;f<o;f+=a){const d=f*3,u=t[d]|0,h=t[d+1]|0,m=t[d+2]|0;u<0||h<0||m<0||u>=n||h>=n||m>=n||(c+=ln(e,u,h),c+=ln(e,h,m),c+=ln(e,m,u),r+=3)}const l=r>0?c/r:.25;return Number.isFinite(l)&&l>0?l:.25}function ln(e,t,n){const o=e[t*2],i=e[t*2+1],a=e[n*2],c=e[n*2+1];return Math.hypot(a-o,c-i)}function io(e,t,n){return Math.max(t,Math.min(n,e))}function Gt(e,t,n){return Math.max(t,Math.min(n,e))}function Ti(e){const t=so.get(e);if(t)return t;const n=zi(e);return so.set(e,n),n}function zi(e){const{extent:t,mesh:n}=e,{verticesXZ:o,triangles:i}=n,a=Math.floor(o.length/2),c=Math.floor(i.length/3);if(a<3||c<1||o.length!==a*2||i.length!==c*3){const z=new Int32Array(2);return{xMin:t.xMin,xMax:t.xMax,zMin:t.zMin,zMax:t.zMax,cellSize:Math.max(.01,t.xMax-t.xMin,t.zMax-t.zMin),nx:1,nz:1,offsets:z,indices:new Int32Array(0),ia:new Int32Array(0),ib:new Int32Array(0),ic:new Int32Array(0),ax:new Float32Array(0),az:new Float32Array(0),v0x:new Float32Array(0),v0z:new Float32Array(0),v1x:new Float32Array(0),v1z:new Float32Array(0),invDenom:new Float32Array(0),avgEdgeLength:.25}}const r=t.xMin,l=t.xMax,f=t.zMin,d=t.zMax,u=Math.max(Ut,l-r),h=Math.max(Ut,d-f),m=Si(o,i),I=Math.max(u,h)/128,w=Math.max(.05,I,m),P=Math.max(1,Math.ceil(u/w)),g=Math.max(1,Math.ceil(h/w)),L=P*g,C=new Int32Array(c),N=new Int32Array(c),v=new Int32Array(c),S=new Float32Array(c),k=new Float32Array(c),U=new Float32Array(c),M=new Float32Array(c),A=new Float32Array(c),E=new Float32Array(c),j=new Float32Array(c),O=new Int32Array(L),X=z=>Gt(Math.floor((z-r)/w),0,P-1),D=z=>Gt(Math.floor((z-f)/w),0,g-1);for(let z=0;z<c;z+=1){const W=z*3,R=i[W]|0,J=i[W+1]|0,Z=i[W+2]|0;if(R<0||J<0||Z<0||R>=a||J>=a||Z>=a){C[z]=-1,N[z]=-1,v[z]=-1,j[z]=0;continue}C[z]=R,N[z]=J,v[z]=Z;const oe=o[R*2],ie=o[R*2+1],le=o[J*2],fe=o[J*2+1],ge=o[Z*2],de=o[Z*2+1];S[z]=oe,k[z]=ie;const he=le-oe,Pe=fe-ie,Te=ge-oe,ze=de-ie;U[z]=he,M[z]=Pe,A[z]=Te,E[z]=ze;const Se=he*ze-Pe*Te;j[z]=Math.abs(Se)<=1e-12?0:1/Se;const je=Math.min(oe,le,ge),Ae=Math.max(oe,le,ge),$=Math.min(ie,fe,de),Re=Math.max(ie,fe,de),bt=X(je),Vt=X(Ae),jt=D($),tt=D(Re);for(let ft=jt;ft<=tt;ft+=1){const Ot=ft*P;for(let ht=bt;ht<=Vt;ht+=1)O[Ot+ht]+=1}}const x=new Int32Array(L+1);for(let z=0;z<L;z+=1)x[z+1]=x[z]+O[z];const T=x[L],y=new Int32Array(T),F=new Int32Array(x);for(let z=0;z<c;z+=1){if(C[z]<0)continue;const W=S[z],R=k[z],J=W+U[z],Z=R+M[z],oe=W+A[z],ie=R+E[z],le=Math.min(W,J,oe),fe=Math.max(W,J,oe),ge=Math.min(R,Z,ie),de=Math.max(R,Z,ie),he=X(le),Pe=X(fe),Te=D(ge),ze=D(de);for(let Se=Te;Se<=ze;Se+=1){const je=Se*P;for(let Ae=he;Ae<=Pe;Ae+=1){const $=je+Ae;y[F[$]++]=z}}}return{xMin:r,xMax:l,zMin:f,zMax:d,cellSize:w,nx:P,nz:g,offsets:x,indices:y,ia:C,ib:N,ic:v,ax:S,az:k,v0x:U,v0z:M,v1x:A,v1z:E,invDenom:j,avgEdgeLength:m}}function Ci(e,t,n,o){if(t.length===0||e.ia.length===0)return 0;const i=io(n,e.xMin,e.xMax),a=io(o,e.zMin,e.zMax),c=Gt(Math.floor((i-e.xMin)/e.cellSize),0,e.nx-1),l=Gt(Math.floor((a-e.zMin)/e.cellSize),0,e.nz-1)*e.nx+c,f=e.offsets[l],d=e.offsets[l+1];for(let u=f;u<d;u+=1){const h=e.indices[u],m=e.invDenom[h];if(m===0)continue;const I=i-e.ax[h],w=a-e.az[h],P=(I*e.v1z[h]-w*e.v1x[h])*m,g=(e.v0x[h]*w-e.v0z[h]*I)*m,L=1-P-g;if(L>=-1e-9&&P>=-1e-9&&g>=-1e-9){const C=e.ia[h],N=e.ib[h],v=e.ic[h];return t[C]*L+t[N]*P+t[v]*g}}for(let u=0;u<e.ia.length;u+=1){const h=e.invDenom[u];if(h===0)continue;const m=i-e.ax[u],I=a-e.az[u],w=(m*e.v1z[u]-I*e.v1x[u])*h,P=(e.v0x[u]*I-e.v0z[u]*m)*h,g=1-w-P;if(g>=-1e-9&&w>=-1e-9&&P>=-1e-9){const L=e.ia[u],C=e.ib[u],N=e.ic[u];return t[L]*g+t[C]*w+t[N]*P}}return 0}const ro="webgpu-failure-banner",co=e=>{if(e instanceof Error){const t=e.message||e.name;return t?`${e.name}: ${t}`:e.name}try{return typeof e=="string"?e:JSON.stringify(e)}catch{return String(e)}};function Ni(e){console.error("[webgpu] failure",e.operation,e.error);const t=document.getElementById(ro);if(t){const l=t.querySelector(".webgpu-banner__details");if(l){const f=["WebGPU call failed.",`Operation: ${e.operation}`,e.hint?`Hint: ${e.hint}`:null,`Error: ${co(e.error)}`].filter(Boolean);l.textContent=f.join(`
`)}t.classList.add("visible");return}const n=document.createElement("div");n.id=ro,n.className="webgpu-banner visible",n.setAttribute("role","alert");const o=document.createElement("div");o.className="webgpu-banner__body";const i=document.createElement("div");i.className="webgpu-banner__title",i.textContent="WebGPU call failed";const a=document.createElement("pre");a.className="webgpu-banner__details";const c=["WebGPU call failed.",`Operation: ${e.operation}`,e.hint?`Hint: ${e.hint}`:null,`Error: ${co(e.error)}`,"This device/browser may not fully support WebGPU."].filter(Boolean);a.textContent=c.join(`
`),o.append(i,a);const r=document.createElement("button");r.className="webgpu-banner__close",r.type="button",r.textContent="Dismiss",r.addEventListener("click",()=>{n.classList.remove("visible")}),n.append(o,r),document.body.appendChild(n)}const At=document.querySelector("#gfx"),dn=document.querySelector("#message"),Ve=new ss(Ni),lt={target:[12.308137893676758,-2.078213691711426,-.03483019769191742],yaw:2.59007353266014,pitch:.3322148625050682,distance:34.27910453694887,orthoScale:14.198870005209317,mode:"perspective"};function ki(e){dn&&(dn.textContent=e,dn.classList.add("visible"))}function Ei(e){e.mode=lt.mode,e.orthoScale=lt.orthoScale,e.distance=lt.distance,e.setAngles(lt.yaw,lt.pitch),st(e.target,...lt.target)}async function Ai(e){try{const t=await fetch(e);if(!t.ok)return null;const n=await t.json();return!n||n.version!==2?null:n}catch{return null}}async function Bi(){if(!At)throw new Error("Canvas element not found.");let e,t,n;try{({device:e,context:t,format:n}=await os(At,Ve))}catch(m){Ve.hasFailed()||Ve.fail("initWebGPU",m);return}let o;try{o=Ve.call("Renderer.constructor",()=>new As(At,e,t,n,Ve))}catch{return}const i=new Ps;new Is(At,i);const c=await Bs("./scene.json"),r=await Ai("./solids_model_v2.json");Mi(c),r&&(bi(r),c.solidsModel=r);const l=Pi.sections??[],f=vi(l);if(f.length>0){const m=new Map(f.map(P=>[P.id,P])),I=[],w=new Set;if(c.sections)for(const P of c.sections){const g=m.get(P.id),L=P.path.length>0?P.path:(g==null?void 0:g.worldPath)??[];I.push({...P,path:L,vector:g}),w.add(P.id)}for(const P of f)w.has(P.id)||I.push({id:P.id,name:P.name,path:P.worldPath,vector:P});c.sections=I}let d;try{d=Ve.call("buildScene",()=>ii(e,o,c))}catch{return}o.setObjects(d.objects);const u=()=>{if(Ve.hasFailed())return;try{o.resize()}catch(w){Ve.hasFailed()||Ve.fail("Renderer.resize",w);return}const{width:m,height:I}=o.getSize();i.setAspect(m/I)};u(),Ei(i),Fi(e,c,d.objects,o,i,d.bounds,Ve),document.body.classList.add("ready"),window.addEventListener("resize",u);const h=()=>{if(!Ve.hasFailed()){try{o.render(i)}catch(m){Ve.hasFailed()||Ve.fail("Renderer.render",m);return}requestAnimationFrame(h)}};requestAnimationFrame(h)}function Fi(e,t,n,o,i,a,c){var Nn,kn,En,An,Bn,Fn,Ln,Un,Gn,Vn,jn,On,Dn,_n,Rn,Yn,qn,Wn;const r=document.querySelector("#panel");if(!r)return;const l=document.querySelector("#panel-toggle"),f=document.querySelector("#panel-body"),d=Array.from(document.querySelectorAll("input[name='theme']")),u=document.querySelector("#toggle-terrain"),h=document.querySelector("#toggle-grid"),m=document.querySelector("#toggle-sections"),I=document.querySelector("#toggle-profiles"),w=document.querySelector("#toggle-solids"),P=Array.from(document.querySelectorAll("input[name='solids-visibility']")),g=document.querySelector("#toggle-solids-edges"),L=document.querySelector("#fit-view"),C=document.querySelector("#toggle-projection"),N=Array.from(document.querySelectorAll("input[name='mode']")),v=Array.from(document.querySelectorAll(".panel-views button")),S=document.querySelector("#section-list"),k=document.querySelector("#profile-list"),U=document.querySelector("#solid-list"),M=document.querySelector("#solids-spacing"),A=document.querySelector("#solids-spacing-value"),E=document.querySelector("#solids-clip-x"),j=document.querySelector("#solids-clip-x-value"),O=document.querySelector("#solids-clip-y"),X=document.querySelector("#solids-clip-y-value"),D=document.querySelector("#solids-clip-z"),x=document.querySelector("#solids-clip-z-value"),T=document.querySelector("#sections-controls"),y=document.querySelector("#profiles-controls"),F=document.querySelector("#solids-controls"),z=document.querySelector("#gfx"),W=document.querySelector("#section-detail"),R=document.querySelector("#section-title"),J=document.querySelector("#section-canvas"),Z=document.querySelector("#section-close"),oe=u==null?void 0:u.closest("label"),ie=h==null?void 0:h.closest("label");if(!u||!h||!m||!I||!w||P.length===0||!g||!L||!C||!l||!f||d.length===0||N.length===0||!S||!k||!U||!M||!A||!E||!j||!O||!X||!D||!x||!T||!y||!F||!W||!R||!J||!Z||!oe||!ie)return;const le=s=>{r.classList.toggle("panel--collapsed",s),l.setAttribute("aria-expanded",s?"false":"true")},fe=()=>{window.matchMedia("(max-width: 720px)").matches||le(!1)};l.addEventListener("click",()=>{le(!r.classList.contains("panel--collapsed"))}),window.addEventListener("resize",fe),fe(),document.addEventListener("pointerdown",s=>{if(!window.matchMedia("(max-width: 720px)").matches||r.classList.contains("panel--collapsed"))return;const p=s.target;p instanceof Node&&r.contains(p)||le(!0)}),U.style.visibility="hidden";const ge={dark:{clearColor:{r:21/255,g:21/255,b:21/255,a:1},sectionCanvasBg:"#111",sectionAxis:"rgba(255, 255, 255, 0.35)",sectionAxisTick:"rgba(255, 255, 255, 0.08)",sectionText:"rgba(230, 230, 230, 0.7)",sectionEmptyText:"#ccc",sectionHatch:"rgba(0, 0, 0, 0.85)",sectionPatchStroke:"rgba(0, 0, 0, 0.55)"},light:{clearColor:{r:1,g:1,b:1,a:1},sectionCanvasBg:"#fff",sectionAxis:"rgba(0, 0, 0, 0.35)",sectionAxisTick:"rgba(0, 0, 0, 0.08)",sectionText:"rgba(20, 20, 20, 0.7)",sectionEmptyText:"#333",sectionHatch:"rgba(0, 0, 0, 0.7)",sectionPatchStroke:"rgba(0, 0, 0, 0.35)"}};let de=ge.dark,he="dark";const Pe=()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return"dark";try{return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}catch{return"dark"}},Te=()=>{var p;return((p=d.find(b=>b.checked))==null?void 0:p.value)==="light"?"light":"dark"},ze=s=>{document.documentElement.dataset.theme=s,he=s,de=ge[s],o.setClearColor(de.clearColor),Qt()},Se=()=>{var p;return((p=N.find(b=>b.checked))==null?void 0:p.value)==="solids"?"solids":"sections"},je=()=>{var p;const s=(p=P.find(b=>b.checked))==null?void 0:p.value;return s==="wireframe"||s==="transparent"||s==="classic"?s:"classic"},Ae=s=>{const p=Number.parseFloat(M.max);return Number.isFinite(p)?Math.min(Math.max(0,s),p):Math.max(0,s)},$=(()=>{if(typeof window>"u")return{};const s=new URLSearchParams(window.location.search),p={},b=we=>{const ye=s.get(we);return ye===null?void 0:ye},B=we=>{const ye=s.get(we);if(ye===null)return;const Ie=Number.parseFloat(ye);return Number.isFinite(Ie)?Ie:void 0},G=we=>{const ye=s.get(we);if(ye===null)return;const Ie=ye.trim().toLowerCase();if(Ie==="1"||Ie==="true"||Ie==="yes"||Ie==="on")return!0;if(Ie==="0"||Ie==="false"||Ie==="no"||Ie==="off")return!1},_=we=>{const ye=b(we);if(ye===void 0)return;const Ie=ye.split(",").map(He=>He.trim()).filter(He=>He.length>0);return Ie.length>0?Ie:[]},q=b("theme");(q==="light"||q==="dark")&&(p.theme=q);const K=b("mode");(K==="sections"||K==="solids")&&(p.mode=K);const Q=G("panelCollapsed");Q!==void 0&&(p.panelCollapsed=Q);const re=b("proj");re==="perspective"?p.projection="perspective":(re==="orthographic"||re==="ortho"||re==="axonometric")&&(p.projection="axonometric");const ae={};for(const[we,ye]of[["terrain","terrain"],["grid","grid"],["sections","sections"],["profiles","profiles"],["solids","solids"]]){const Ie=G(we);Ie!==void 0&&(ae[ye]=Ie)}Object.keys(ae).length>0&&(p.visibility=ae);const ee={},ne=_("solidsEnabled");ne!==void 0&&(ee.enabled=ne);const ue=B("solidsSpacing");ue!==void 0&&(ee.verticalSpacing=ue);const Y=b("solidsVis");(Y==="classic"||Y==="wireframe"||Y==="transparent")&&(ee.displayMode=Y);const te=G("solidsEdges");te!==void 0&&(ee.highlightEdges=te);const se=B("cropX");se!==void 0&&(ee.cropX=se);const xe=B("cropY");xe!==void 0&&(ee.cropY=xe);const be=B("cropZ");be!==void 0&&(ee.cropZ=be),Object.keys(ee).length>0&&(p.solids=ee);const Ne={},Be=b("section");Be!==void 0&&(Ne.sectionId=Be);const Ce=b("profile");Ce!==void 0&&(Ne.profileId=Ce),Object.keys(Ne).length>0&&(p.selection=Ne);const pe={},me=b("camMode");me==="perspective"?pe.mode="perspective":(me==="orthographic"||me==="ortho"||me==="axonometric")&&(pe.mode="axonometric");const ut=B("camYawDeg"),mt=B("camYaw");ut!==void 0?pe.yaw=ut*Math.PI/180:mt!==void 0&&(pe.yaw=mt);const ot=B("camPitchDeg"),Ct=B("camPitch");ot!==void 0?pe.pitch=ot*Math.PI/180:Ct!==void 0&&(pe.pitch=Ct);const Nt=B("camDist");Nt!==void 0&&(pe.distance=Nt);const gt=B("camOrtho");gt!==void 0&&(pe.orthoScale=gt);const xt=b("camTarget");if(xt!==void 0){const we=xt.split(",").map(ye=>Number.parseFloat(ye.trim()));we.length>=3&&we.every(ye=>Number.isFinite(ye))&&(pe.target=[we[0],we[1],we[2]])}return Object.keys(pe).length>0&&(p.camera=pe),p})(),Re=()=>{const s=Number.parseFloat(M.value);return Number.isFinite(s)?Ae(s):0},bt=s=>{const p=Ae(s);M.value=p.toString(),V.solids.verticalSpacing=p,Tn()};$.panelCollapsed!==void 0&&le($.panelCollapsed),$.mode&&N.forEach(s=>{s.checked=s.value===$.mode}),$.visibility&&($.visibility.terrain!==void 0&&(u.checked=$.visibility.terrain),$.visibility.grid!==void 0&&(h.checked=$.visibility.grid),$.visibility.sections!==void 0&&(m.checked=$.visibility.sections),$.visibility.profiles!==void 0&&(I.checked=$.visibility.profiles),$.visibility.solids!==void 0&&(w.checked=$.visibility.solids)),(Nn=$.solids)!=null&&Nn.displayMode&&P.forEach(s=>{var p;s.checked=s.value===((p=$.solids)==null?void 0:p.displayMode)}),((kn=$.solids)==null?void 0:kn.highlightEdges)!==void 0&&(g.checked=$.solids.highlightEdges),((En=$.solids)==null?void 0:En.verticalSpacing)!==void 0&&(M.value=Ae($.solids.verticalSpacing).toString());const Vt=W,jt=R,tt=J,ft=Z,Ot=new Map(t.soils.map(s=>[s.id,s])),ht=new Map((t.sections??[]).map(s=>[s.id,s])),ce=t.solidsModel??null,mo=new Set(((ce==null?void 0:ce.solids)??[]).map(s=>s.soilId)),Dt=new Map;for(const s of n)s.objectType!=="solid"||!s.soilId||Dt.set(s.soilId,s.layerIndex);let _t=0;for(const s of Dt.values())_t=Math.max(_t,s);const ve=ce?{xMin:ce.extent.xMin,xMax:ce.extent.xMax,yMin:a.min[1],yMax:a.max[1],zMin:ce.extent.zMin,zMax:ce.extent.zMax}:{xMin:a.min[0],xMax:a.max[0],yMin:a.min[1],yMax:a.max[1],zMin:a.min[2],zMax:a.max[2]},$e={xMin:ve.xMin,yMax:ve.yMax,zMax:ve.zMax},go={xMin:((An=$.solids)==null?void 0:An.cropX)!==void 0?Math.min(Math.max(ve.xMin,$.solids.cropX),ve.xMax):$e.xMin,yMax:((Bn=$.solids)==null?void 0:Bn.cropY)!==void 0?Math.min(Math.max(ve.yMin,$.solids.cropY),ve.yMax):$e.yMax,zMax:((Fn=$.solids)==null?void 0:Fn.cropZ)!==void 0?Math.min(Math.max(ve.zMin,$.solids.cropZ),ve.zMax):$e.zMax},V={mode:Se(),visibility:{terrain:u.checked,grid:h.checked,sections:m.checked,profiles:I.checked,solids:w.checked},solids:{enabled:mo,verticalSpacing:Re(),displayMode:je(),highlightEdges:g.checked,crop:{...go}},selectedSectionId:null,selectedProfileId:null};document.body.dataset.mode=V.mode;const wt=s=>`${s.toFixed(2)} m`,xo=(s,p)=>{const b=Math.abs(p-s),B=.01;return!Number.isFinite(b)||b<=0?B:Math.max(B,b/400)},Rt=(s,p,b,B,G)=>{s.min=b.toString(),s.max=B.toString(),s.step=xo(b,B).toString(),s.value=G.toString(),p.textContent=wt(G)};Rt(E,j,ve.xMin,ve.xMax,V.solids.crop.xMin),Rt(O,X,ve.yMin,ve.yMax,V.solids.crop.yMax),Rt(D,x,ve.zMin,ve.zMax,V.solids.crop.zMax);const mn=s=>Math.min(Math.max(ve.xMin,s),ve.xMax),gn=s=>Math.min(Math.max(ve.yMin,s),ve.yMax),xn=s=>Math.min(Math.max(ve.zMin,s),ve.zMax),yo=()=>{const s=Number.parseFloat(E.value);return Number.isFinite(s)?mn(s):$e.xMin},vo=()=>{const s=Number.parseFloat(O.value);return Number.isFinite(s)?gn(s):$e.yMax},Mo=()=>{const s=Number.parseFloat(D.value);return Number.isFinite(s)?xn(s):$e.zMax},bo=s=>{const p=mn(s);E.value=p.toString(),V.solids.crop.xMin=p,Tt()},wo=s=>{const p=gn(s);O.value=p.toString(),V.solids.crop.yMax=p,Tt()},Po=s=>{const p=xn(s);D.value=p.toString(),V.solids.crop.zMax=p,Tt()},pt=new Map,Pt=new Map;for(const s of n){if(s.objectType!=="solid"&&s.objectType!=="solidWireframe"&&s.objectType!=="solidEdge"||(pt.set(s.id,s.mesh),!s.soilId))continue;const p=Pt.get(s.soilId)??{};s.objectType==="solid"?p.solid=s:s.objectType==="solidEdge"?p.edges=s:p.wireframe=s,Pt.set(s.soilId,p)}const rt=(s,p)=>{const b=pt.get(s.id);b&&s.mesh!==b&&s.mesh.vertexBuffer.destroy(),s.mesh=p},Io=()=>{for(const s of Pt.values()){if(s.solid){const p=pt.get(s.solid.id);p&&rt(s.solid,p)}if(s.wireframe){const p=pt.get(s.wireframe.id);p&&rt(s.wireframe,p)}if(s.edges){const p=pt.get(s.edges.id);p&&rt(s.edges,p)}}};let yn="";const It=()=>{if(!(!ce||c!=null&&c.hasFailed()))try{const s=V.solids.crop.xMin,p=V.solids.crop.yMax,b=V.solids.crop.zMax,B=`${s.toFixed(5)}|${p.toFixed(5)}|${b.toFixed(5)}`;if(B===yn)return;yn=B;const G=s>$e.xMin+1e-4,_=b<$e.zMax-1e-4,q=G||_,K=p<$e.yMax-1e-4;if(!q&&!K){Io();return}const{verticesXZ:Q,triangles:re}=ce.mesh,ae=Math.floor(Q.length/2);for(const ee of ce.solids){const ne=Pt.get(ee.soilId);if(!(ne!=null&&ne.solid)&&!(ne!=null&&ne.wireframe)&&!(ne!=null&&ne.edges))continue;const ue=ce.surfaces[ee.top],Y=ce.surfaces[ee.bottom];if(!ue||!Y||ue.length!==ae||Y.length!==ae)continue;let te=Q,se=re,xe=ue,be=Y,Ne,Be,Ce;if(q){if(G){const me=xi(te,se,xe,be,s);te=me.verticesXZ,se=me.triangles,xe=me.top,be=me.bottom}if(_){const me=gi(te,se,xe,be,Number.POSITIVE_INFINITY,b);te=me.verticesXZ,se=me.triangles,xe=me.top,be=me.bottom}}if(K){const me=yi(te,se,xe,be,p);te=me.verticesXZ,se=me.triangles,Ce=me.boundaryTriangles,xe=me.top,be=me.bottom,Ne=me.topNormals,Be=me.bottomNormals}const pe=c?c.call("createTinVolumeMeshes",()=>hn(e,te,se,xe,be,Ne,Be,Ce)):hn(e,te,se,xe,be,Ne,Be,Ce);ne.solid&&rt(ne.solid,pe.solid),ne.wireframe&&rt(ne.wireframe,pe.wireframe),ne.edges&&rt(ne.edges,pe.edges)}}catch(s){c&&!c.hasFailed()&&c.fail("rebuildSolidsMeshes",s)}},Yt=(s,p,b)=>[s[0]+(p[0]-s[0])*b,s[1]+(p[1]-s[1])*b,s[2]+(p[2]-s[2])*b,s[3]+(p[3]-s[3])*b],So=3,To=.35,zo=.4,Co=.6,No=.35,ko=.2,Eo=s=>{const p=Yt(s,[1,1,1,s[3]],To);return[p[0],p[1],p[2],zo]},Ao=(s,p)=>{p==="transparent"?(s.color=Eo(s.baseColor),s.material=[0,So,s.baseMaterial[2],s.baseMaterial[3]]):(s.color=[...s.baseColor],s.material=[...s.baseMaterial])},Bo=(s,p)=>{if(p==="transparent"){const b=he==="light"?[0,0,0,s.baseColor[3]]:[1,1,1,s.baseColor[3]],B=he==="light"?No:ko,G=Yt(s.baseColor,b,B);s.color=[G[0],G[1],G[2],Co]}else s.color=s.baseColor},qt=()=>({min:[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],max:[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]}),ct=(s,p)=>{s.min[0]=Math.min(s.min[0],p.min[0]),s.min[1]=Math.min(s.min[1],p.min[1]),s.min[2]=Math.min(s.min[2],p.min[2]),s.max[0]=Math.max(s.max[0],p.max[0]),s.max[1]=Math.max(s.max[1],p.max[1]),s.max[2]=Math.max(s.max[2],p.max[2])},Fo=s=>Number.isFinite(s.min[0])&&Number.isFinite(s.min[1])&&Number.isFinite(s.min[2])&&Number.isFinite(s.max[0])&&Number.isFinite(s.max[1])&&Number.isFinite(s.max[2]),Lo=()=>{if(ce){const q=St.get("terrain");if(q)return{min:[ce.extent.xMin,q.min,ce.extent.zMin],max:[ce.extent.xMax,q.max,ce.extent.zMax]}}const s=t.objects.find(q=>q.type==="terrain");if(!s)return null;const p=s.position??[0,0,0],b=s.scale??[1,1,1],B=s.mesh.size??[1,1,1],G=[b[0]*B[0],b[1]*B[1],b[2]*B[2]],_=[Math.abs(G[0])*.5,Math.abs(G[1])*.5,Math.abs(G[2])*.5];return{min:[p[0]-_[0],p[1]-_[1],p[2]-_[2]],max:[p[0]+_[0],p[1]+_[1],p[2]+_[2]]}},Uo=()=>{const s=t.sections??[];if(s.length===0)return null;let p=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY,B=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,_=!1;for(const q of s)for(const K of q.path??[])p=Math.min(p,K[0]),b=Math.max(b,K[0]),B=Math.min(B,K[1]),G=Math.max(G,K[1]),_=!0;return _?{min:[p,a.min[1],B],max:[b,a.max[1],G]}:null},Go=()=>{const s=t.profiles??[];if(s.length===0)return null;const b=.35*.5,B=.08,G=qt();let _=!1;for(const q of s){const K=q.position.x,Q=q.position.y,re=q.position.zGround,ae=Math.max(q.depth,.01),ee=Math.max(b,B),ne={min:[K-ee,re-ae,Q-ee],max:[K+ee,re+b,Q+ee]};ct(G,ne),_=!0}return _?G:null},Vo=s=>{if(s.length===0)return null;let p=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY;for(const B of s)Number.isFinite(B)&&(p=Math.min(p,B),b=Math.max(b,B));return!Number.isFinite(p)||!Number.isFinite(b)?null:{min:p,max:b}},St=new Map;if(ce)for(const[s,p]of Object.entries(ce.surfaces)){const b=Vo(p);b&&St.set(s,b)}const vn=new Map;if(ce){const{extent:s}=ce;for(const p of ce.solids){const b=St.get(p.top),B=St.get(p.bottom),G=(B==null?void 0:B.min)??s.yBase,_=(b==null?void 0:b.max)??a.max[1];vn.set(p.soilId,{min:[s.xMin,G,s.zMin],max:[s.xMax,_,s.zMax]})}}const Mn=Lo(),bn=Uo(),wn=Go(),Pn=(s,p)=>{if(!Number.isFinite(p)||p===0)return 0;const b=_t*.5;return-(s-b)*p},jo=s=>{if(!ce)return null;const p=qt();let b=!1;for(const B of ce.solids){if(!V.solids.enabled.has(B.soilId))continue;const G=vn.get(B.soilId);if(!G)continue;const _=Dt.get(B.soilId)??0,q=Pn(_,s),K=Math.max(G.min[0],V.solids.crop.xMin),Q=G.min[1],re=G.min[2],ae=G.max[0],ee=Math.min(G.max[1],V.solids.crop.yMax),ne=Math.min(G.max[2],V.solids.crop.zMax);ae<K||ee<Q||ne<re||(ct(p,{min:[K,Q+q,re],max:[ae,ee+q,ne]}),b=!0)}return b?p:null},Oo=()=>{if(!z)return{fracX:1,fracY:1,centerNdcX:0,centerNdcY:0};const s=Math.max(1,z.clientWidth),p=Math.max(1,z.clientHeight),b=16;if(window.matchMedia("(max-width: 720px)").matches)return{fracX:1,fracY:1,centerNdcX:0,centerNdcY:0};const G=z.getBoundingClientRect(),_=r.getBoundingClientRect(),q=_.left-G.left,K=_.right-G.left,Q=_.top-G.top,re=_.bottom-G.top,ae=_.width>0&&_.height>0&&K>=0&&q<=s&&re>=0&&Q<=p,ee=b,ne=s-b,ue=b,Y=p-b;let te=ne,se=ue;ae&&(te=Math.min(ne,Math.max(ee+1,q-b))),se>=Y&&(se=ue);const xe=Math.max(1,te-ee),be=Math.max(1,Y-se),Ne=ee+xe*.5,Be=se+be*.5;return{fracX:xe/s,fracY:be/p,centerNdcX:2*Ne/s-1,centerNdcY:1-2*Be/p}},Wt=()=>{const s=qt();if(V.visibility.terrain&&Mn&&ct(s,Mn),V.mode==="sections")V.visibility.sections&&bn&&ct(s,bn),V.visibility.profiles&&wn&&ct(s,wn);else if(V.visibility.solids){const p=jo(V.solids.verticalSpacing);p&&ct(s,p)}return Fo(s)?s:a},$t=s=>{const p=Oo(),b=Math.max(.05,Math.min(1,p.fracX)),B=Math.max(.05,Math.min(1,p.fracY)),G=1.1,_=(s.min[0]+s.max[0])*.5,q=(s.min[1]+s.max[1])*.5,K=(s.min[2]+s.max[2])*.5,Q=s.max[0]-s.min[0],re=s.max[1]-s.min[1],ae=s.max[2]-s.min[2],ee=.5*Math.hypot(Q,re,ae)*G;if(!Number.isFinite(ee)||ee<=0){st(i.target,_,q,K);return}st(i.target,_,q,K);const ne=i.fov*.5,ue=Math.tan(ne),Y=Ee(-Math.cos(i.pitch)*Math.cos(i.yaw),-Math.sin(i.pitch),-Math.cos(i.pitch)*Math.sin(i.yaw));_e(Y,Y);const te=ke();Qe(te,Y,Ee(0,1,0)),ao(te)<1e-6?st(te,1,0,0):_e(te,te);const se=ke();Qe(se,te,Y),_e(se,se);const xe=[[s.min[0],s.min[1],s.min[2]],[s.min[0],s.min[1],s.max[2]],[s.min[0],s.max[1],s.min[2]],[s.min[0],s.max[1],s.max[2]],[s.max[0],s.min[1],s.min[2]],[s.max[0],s.min[1],s.max[2]],[s.max[0],s.max[1],s.min[2]],[s.max[0],s.max[1],s.max[2]]];if(i.mode==="perspective"){const Fe=Math.max(1e-4,ue*i.aspect*b),Ue=Math.max(1e-4,ue*B);let Ye=.2;const De=ke();for(const Ge of xe){st(De,Ge[0]-_,Ge[1]-q,Ge[2]-K);const Je=Xe(De,te),Ze=Xe(De,se),Et=Xe(De,Y),Zt=Math.abs(Je)*G/Fe-Et,es=Math.abs(Ze)*G/Ue-Et;Ye=Math.max(Ye,Zt,es)}i.distance=Math.min(200,Math.max(.2,Ye))}else{let Fe=.2;const Ue=ke(),Ye=Math.max(1e-4,b*i.aspect),De=Math.max(1e-4,B);for(const Ge of xe){st(Ue,Ge[0]-_,Ge[1]-q,Ge[2]-K);const Je=Xe(Ue,te),Ze=Xe(Ue,se),Et=Math.abs(Je)*G/Ye,Zt=Math.abs(Ze)*G/De;Fe=Math.max(Fe,Et,Zt)}i.orthoScale=Math.min(200,Math.max(.2,Fe)),i.distance=i.orthoScale/Math.max(1e-4,ue)}let be=Number.POSITIVE_INFINITY,Ne=Number.NEGATIVE_INFINITY,Be=Number.POSITIVE_INFINITY,Ce=Number.NEGATIVE_INFINITY,pe=0,me=0,ut=0,mt=0;const ot=ke();vt(ot,i.target,Y,-i.distance);for(const Fe of xe){const Ue=Ee(Fe[0]-ot[0],Fe[1]-ot[1],Fe[2]-ot[2]),Ye=Xe(Ue,te),De=Xe(Ue,se),Ge=Math.max(1e-4,Xe(Ue,Y)),Je=i.mode==="perspective"?Ye/(Ge*ue*i.aspect):Ye/(i.orthoScale*i.aspect),Ze=i.mode==="perspective"?De/(Ge*ue):De/i.orthoScale;Je<be&&(be=Je,pe=Ge),Je>Ne&&(Ne=Je,me=Ge),Ze<Be&&(Be=Ze,ut=Ge),Ze>Ce&&(Ce=Ze,mt=Ge)}const Ct=(be+Ne)*.5,Nt=(Be+Ce)*.5,gt=p.centerNdcX-Ct,xt=p.centerNdcY-Nt;let we=0,ye=0;if(i.mode==="perspective"){const Fe=1/Math.max(1e-4,pe)+1/Math.max(1e-4,me),Ue=1/Math.max(1e-4,ut)+1/Math.max(1e-4,mt),Ye=Fe>1e-6?2/Fe:i.distance,De=Ue>1e-6?2/Ue:i.distance;we=-gt*(ue*i.aspect)*Ye,ye=-xt*ue*De}else{const Fe=i.orthoScale,Ue=Fe*i.aspect;we=-gt*Ue,ye=-xt*Fe}if(Math.abs(we)<1e-4&&Math.abs(ye)<1e-4)return;const Ie=i.getPosition(),He=ke();un(He,i.target,Ie),_e(He,He);const Zo=Ee(0,1,0),yt=ke();Qe(yt,He,Zo),_e(yt,yt);const kt=ke();Qe(kt,yt,He),_e(kt,kt),vt(i.target,i.target,yt,we),vt(i.target,i.target,kt,ye)},Ht=new Map,Do=new Map,_o=new Map;let Ro=1;const In=(s,p)=>{const b=s==="section"?Do:_o,B=b.get(p);if(B)return B;const G=Ro++;return b.set(p,G),Ht.set(G,{type:s,id:p}),G},Sn=()=>{C.textContent=i.mode==="perspective"?"Perspective":"Orthographic"},Tn=()=>{A.textContent=`${V.solids.verticalSpacing.toFixed(2)} m`},Tt=()=>{j.textContent=wt(V.solids.crop.xMin),X.textContent=wt(V.solids.crop.yMax),x.textContent=wt(V.solids.crop.zMax)},at={terrain:u.checked,grid:h.checked,sections:m.checked},zn=s=>{s?(at.terrain=u.checked,at.grid=h.checked,at.sections=m.checked,u.checked=!1,h.checked=!1,m.checked=!1,V.visibility.terrain=!1,V.visibility.grid=!1,V.visibility.sections=!1,u.disabled=!0,h.disabled=!0,m.disabled=!0):(u.disabled=!1,h.disabled=!1,m.disabled=!1,u.checked=at.terrain,h.checked=at.grid,m.checked=at.sections,V.visibility.terrain=u.checked,V.visibility.grid=h.checked,V.visibility.sections=m.checked)},Me=()=>{const s=V.mode==="sections",p=V.mode==="solids",b=s&&V.visibility.sections,B=V.visibility.sections,G=s&&V.visibility.profiles,_=p&&V.visibility.solids,q=V.solids.displayMode,K=_&&q==="wireframe",Q=_&&V.solids.highlightEdges,re=p?V.solids.verticalSpacing:0;oe.style.display=p?"none":"",ie.style.display=p?"none":"",T.style.display=p?"none":"",y.style.display=s?"":"none",F.style.display=p?"":"none";const ae=s?b:!!ce;S.style.opacity=ae?"1":"0.6",S.querySelectorAll("input[type='radio']").forEach(Y=>{Y.disabled=!ae}),k.style.opacity=G?"1":"0.6",k.querySelectorAll("input[type='radio']").forEach(Y=>{Y.disabled=!G}),U.style.opacity=_?"1":"0.6",U.querySelectorAll("input[type='checkbox']").forEach(Y=>{Y.disabled=!_});const ee=[.678,1,.184,1],ne=[.43,.91,1,1],ue=[.678,1,.184,1];for(const Y of n)if(Y.objectType==="terrain"){const te=V.visibility.terrain,se=V.visibility.grid;Y.visible=te||se,Y.material[2]=se?Y.baseMaterial[2]:0,Y.material[3]=te?0:se?1:0}else if(Y.objectType==="curve")Y.visible=B;else if(Y.objectType==="section"){Y.visible=b;const te=V.selectedSectionId&&Y.sectionId===V.selectedSectionId;Y.color=te?Yt(Y.baseColor,ee,.45):Y.baseColor}else if(Y.objectType==="profile"){Y.visible=G;const te=V.selectedProfileId&&Y.profileId===V.selectedProfileId;Y.color=te?ue:ne}else if(Y.objectType==="solid"||Y.objectType==="solidWireframe"||Y.objectType==="solidEdge"){const te=Y.soilId?V.solids.enabled.has(Y.soilId):!0;Y.objectType==="solid"?Ao(Y,q):Y.objectType==="solidEdge"&&Bo(Y,q);const se=_&&q!=="wireframe";Y.visible=(Y.objectType==="solidWireframe"?K:Y.objectType==="solidEdge"?Q:se)&&te,Y.objectType==="solidEdge"&&(Y.edgeXray=K),cs(Y.modelMatrix,Y.baseMatrix),Y.modelMatrix[13]+=Pn(Y.layerIndex,re)}else Y.visible=!0;Qt()},Yo={front:()=>({yaw:Math.PI/2,pitch:0}),back:()=>({yaw:-Math.PI/2,pitch:0}),left:()=>({yaw:Math.PI,pitch:0}),right:()=>({yaw:0,pitch:0}),top:()=>({yaw:i.yaw,pitch:Math.PI/2}),bottom:()=>({yaw:i.yaw,pitch:-Math.PI/2})};for(const s of v)s.addEventListener("click",()=>{const p=s.dataset.view??"",b=Yo[p];if(!b)return;const{yaw:B,pitch:G}=b();i.setAngles(B,G),$t(Wt())});const qo=()=>{V.mode=Se(),document.body.dataset.mode=V.mode,zn(V.mode==="solids"),V.mode==="sections"&&bt(0),Me()};for(const s of N)s.addEventListener("change",qo);u.addEventListener("change",()=>{V.visibility.terrain=u.checked,Me()}),h.addEventListener("change",()=>{V.visibility.grid=h.checked,Me()}),m.addEventListener("change",()=>{V.visibility.sections=m.checked,Me()}),I.addEventListener("change",()=>{V.visibility.profiles=I.checked,Me()}),w.addEventListener("change",()=>{V.visibility.solids=w.checked,Me()});for(const s of P)s.addEventListener("change",()=>{s.checked&&(V.solids.displayMode=je(),Me())});g.addEventListener("change",()=>{V.solids.highlightEdges=g.checked,Me()}),M.addEventListener("input",()=>{bt(Re()),Me()}),E.addEventListener("input",()=>{bo(yo()),It(),Me()}),O.addEventListener("input",()=>{wo(vo()),It(),Me()}),D.addEventListener("input",()=>{Po(Mo()),It(),Me()}),L.addEventListener("click",()=>{$t(Wt())}),C.addEventListener("click",()=>{i.toggleProjection(),Sn()}),S.innerHTML="";const Xt=new Map;if(t.sections&&t.sections.length>0)for(const s of t.sections){const p=document.createElement("label");p.className="panel-option";const b=document.createElement("input");b.type="radio",b.name="section-select",Xt.set(s.id,b),b.addEventListener("change",()=>{b.checked&&(V.selectedSectionId=s.id,Me())}),p.appendChild(b),p.appendChild(document.createTextNode(s.name)),S.appendChild(p)}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No sections loaded",S.appendChild(s)}k.innerHTML="";const Kt=new Map;let nt=null;if(t.profiles&&t.profiles.length>0){const s=document.createElement("label");s.className="panel-option";const p=document.createElement("input");p.type="radio",p.name="profile-select",p.checked=!0,p.addEventListener("change",()=>{p.checked&&(V.selectedProfileId=null,Me())}),s.appendChild(p),s.appendChild(document.createTextNode("None")),k.appendChild(s),nt=p;for(const b of t.profiles){const B=document.createElement("label");B.className="panel-option";const G=document.createElement("input");G.type="radio",G.name="profile-select",Kt.set(b.id,G),G.addEventListener("change",()=>{G.checked&&(V.selectedProfileId=b.id,Me())}),B.appendChild(G),B.appendChild(document.createTextNode(b.name)),k.appendChild(B)}}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No profiles loaded",k.appendChild(s)}if(((Ln=$.selection)==null?void 0:Ln.sectionId)!==void 0){const s=$.selection.sectionId,p=Xt.get(s);p&&(p.checked=!0,V.selectedSectionId=s)}if(((Un=$.selection)==null?void 0:Un.profileId)!==void 0){const s=$.selection.profileId;if(s===""||s==="none")nt&&(nt.checked=!0),V.selectedProfileId=null;else{const p=Kt.get(s);p&&(p.checked=!0,V.selectedProfileId=s)}}const zt=new Map;if(U.querySelectorAll("input[type='checkbox'][data-soil-id]").forEach(s=>{const p=s.dataset.soilId;p&&zt.set(p,s)}),ce&&ce.solids.length>0){V.solids.enabled.clear();for(const s of ce.solids){let p=zt.get(s.soilId);if(!p){const b=document.createElement("label");b.className="panel-option",p=document.createElement("input"),p.type="checkbox",p.checked=!0,p.dataset.soilId=s.soilId,zt.set(s.soilId,p),b.appendChild(p),b.appendChild(document.createTextNode(s.name)),U.appendChild(b)}p.checked&&V.solids.enabled.add(s.soilId),p.addEventListener("change",()=>{p.checked?V.solids.enabled.add(s.soilId):V.solids.enabled.delete(s.soilId),Me()})}if(((Gn=$.solids)==null?void 0:Gn.enabled)!==void 0){const s=new Set($.solids.enabled),p=s.has("*")||s.has("all");V.solids.enabled.clear();for(const b of ce.solids){const B=zt.get(b.soilId);if(!B)continue;const G=p||s.has(b.soilId);B.checked=G,G&&V.solids.enabled.add(b.soilId)}}U.style.visibility="",w.disabled=!1,P.forEach(s=>{s.disabled=!1}),g.disabled=!1,M.disabled=!1,E.disabled=!1,O.disabled=!1,D.disabled=!1}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No solids model loaded",U.appendChild(s),U.querySelectorAll("input[type='checkbox']").forEach(p=>{p.disabled=!0}),U.style.visibility="",w.checked=!1,w.disabled=!0,P.forEach(p=>{p.disabled=!0,p.value==="classic"&&(p.checked=!0)}),g.checked=!1,g.disabled=!0,M.disabled=!0,E.disabled=!0,O.disabled=!0,D.disabled=!0,V.visibility.solids=!1}Tn(),Tt();const Wo=Pe(),$o=$.theme??Wo,Cn=d.find(s=>s.value===$o);Cn&&(Cn.checked=!0),ze(Te());for(const s of d)s.addEventListener("change",()=>{s.checked&&(ze(Te()),Me())});$.projection&&(i.mode=$.projection),(Vn=$.camera)!=null&&Vn.mode&&(i.mode=$.camera.mode),(((jn=$.camera)==null?void 0:jn.yaw)!==void 0||((On=$.camera)==null?void 0:On.pitch)!==void 0)&&i.setAngles($.camera.yaw??i.yaw,$.camera.pitch??i.pitch),Sn(),zn(V.mode==="solids"),It(),Me(),((Dn=$.camera)==null?void 0:Dn.target)!==void 0||((_n=$.camera)==null?void 0:_n.distance)!==void 0||((Rn=$.camera)==null?void 0:Rn.orthoScale)!==void 0||$t(Wt()),(Yn=$.camera)!=null&&Yn.target&&st(i.target,$.camera.target[0],$.camera.target[1],$.camera.target[2]),((qn=$.camera)==null?void 0:qn.distance)!==void 0&&(i.distance=$.camera.distance),((Wn=$.camera)==null?void 0:Wn.orthoScale)!==void 0&&(i.orthoScale=$.camera.orthoScale);for(const s of n)s.objectType==="section"&&s.sectionId?s.pickId=In("section",s.sectionId):s.objectType==="profile"&&s.profileId?s.pickId=In("profile",s.profileId):s.pickId=0;z&&z.addEventListener("click",async s=>{if(s.button!==0||c!=null&&c.hasFailed()||V.mode==="solids")return;const p=z.getBoundingClientRect(),b=s.clientX-p.left,B=s.clientY-p.top;let G=null;try{G=c?await c.callAsync("Renderer.pick",()=>o.pick(b,B)):await o.pick(b,B)}catch{return}if(!G||!Ht.has(G)){nt&&(nt.checked=!0),V.selectedSectionId=null,V.selectedProfileId=null,Me();return}const _=Ht.get(G);if(_){if(_.type==="section"){V.selectedSectionId=_.id,V.selectedProfileId=null;const q=Xt.get(_.id);q&&(q.checked=!0),nt&&(nt.checked=!0),m.checked||(m.checked=!0,V.visibility.sections=!0)}else if(_.type==="profile"){V.selectedProfileId=_.id,V.selectedSectionId=null;const q=Kt.get(_.id);q&&(q.checked=!0),I.checked||(I.checked=!0,V.visibility.profiles=!0)}Me()}}),ft.addEventListener("click",()=>{V.selectedSectionId=null,Me()}),window.addEventListener("resize",()=>{Qt()});function Qt(){const s=V.selectedSectionId,p=!!(s&&(V.mode==="sections"&&V.visibility.sections||V.mode==="solids"&&ce));if(Vt.classList.toggle("visible",!!p),!p||!s)return;const b=ht.get(s);if(!b)return;jt.textContent=b.name;const B=tt.getContext("2d");if(!B)return;const G=window.devicePixelRatio||1,_=Math.max(1,tt.clientWidth),q=Math.max(1,tt.clientHeight);tt.width=Math.floor(_*G),tt.height=Math.floor(q*G),B.setTransform(G,0,0,G,0,0),B.clearRect(0,0,_,q),B.fillStyle=de.sectionCanvasBg,B.fillRect(0,0,_,q);const K=V.mode==="solids"?ce?Ii(b,ce):null:b.vector?Ho(b.vector):null;if(!K||K.patches.length===0){B.fillStyle=de.sectionEmptyText,B.font="12px IBM Plex Sans, sans-serif",B.fillText("No polygons available for this section.",16,24);return}const Q={left:50,right:20,top:24,bottom:28},re=Math.max(1,_-Q.left-Q.right),ae=Math.max(1,q-Q.top-Q.bottom),ee=re/Math.max(K.maxS-K.minS,.01),ne=ae/Math.max(K.maxD-K.minD,.01),ue=te=>Q.left+(te-K.minS)*ee,Y=te=>Q.top+(te-K.minD)*ne;B.strokeStyle=de.sectionAxis,B.lineWidth=1,B.beginPath(),B.moveTo(Q.left,Q.top),B.lineTo(Q.left,Q.top+ae),B.lineTo(Q.left+re,Q.top+ae),B.stroke(),Xo(B,Q.left,Q.top,ae,K.minD,K.maxD,de);for(const te of K.patches){const se=Ot.get(te.soilId),xe=(se==null?void 0:se.color)??[.6,.6,.6],be=(se==null?void 0:se.patternId)??0,Ne=`rgb(${Math.round(xe[0]*255)}, ${Math.round(xe[1]*255)}, ${Math.round(xe[2]*255)})`;for(const Be of te.rings){if(Be.length===0)continue;const Ce=Be.map(pe=>({x:ue(pe.s),y:Y(pe.d)}));B.beginPath(),B.moveTo(Ce[0].x,Ce[0].y);for(let pe=1;pe<Ce.length;pe+=1)B.lineTo(Ce[pe].x,Ce[pe].y);B.closePath(),B.fillStyle=Ne,B.fill(),Ko(B,Ce,be),B.strokeStyle=de.sectionPatchStroke,B.lineWidth=.75,B.stroke()}}}function Ho(s){const p=[];let b=Number.POSITIVE_INFINITY,B=Number.NEGATIVE_INFINITY,G=Number.POSITIVE_INFINITY,_=Number.NEGATIVE_INFINITY;for(const[q,K]of Object.entries(s.patches)){const Q=[];for(const re of K.rings){const ae=re.map(([ee,ne])=>{const ue=ee*s.sScale,Y=s.zRef-ne;return b=Math.min(b,ue),B=Math.max(B,ue),G=Math.min(G,Y),_=Math.max(_,Y),{s:ue,d:Y}});Q.push(ae)}p.push({soilId:q,rings:Q})}return!Number.isFinite(b)||!Number.isFinite(G)?null:{minS:b,maxS:B,minD:G,maxD:_,patches:p}}function Xo(s,p,b,B,G,_,q){const K=Math.max(.1,_-G),Q=K/5,re=[.5,1,2,5,10];let ae=re[0];for(const ee of re)Q>ee&&(ae=ee);s.font="11px IBM Plex Sans, sans-serif",s.fillStyle=q.sectionText,s.textAlign="right",s.textBaseline="middle";for(let ee=G;ee<=_+.001;ee+=ae){const ne=b+(ee-G)/K*B;s.strokeStyle=q.sectionAxisTick,s.beginPath(),s.moveTo(p,ne),s.lineTo(p-6,ne),s.stroke(),s.fillText(ee.toFixed(1),p-8,ne)}}function Ko(s,p,b){if(b===0||p.length===0)return;let B=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,_=Number.POSITIVE_INFINITY,q=Number.NEGATIVE_INFINITY;for(const Q of p)B=Math.min(B,Q.x),G=Math.max(G,Q.x),_=Math.min(_,Q.y),q=Math.max(q,Q.y);const K={x:B,y:_,width:Math.max(1,G-B),height:Math.max(1,q-_)};s.save(),s.beginPath(),s.moveTo(p[0].x,p[0].y);for(let Q=1;Q<p.length;Q+=1)s.lineTo(p[Q].x,p[Q].y);s.closePath(),s.clip(),s.strokeStyle=de.sectionHatch,s.lineWidth=1,b===1?(s.lineWidth=.25,Jt(s,K,Math.PI/4,12),Jt(s,K,-Math.PI/4,12)):b===2?(s.lineWidth=.25,Qo(s,K,Math.PI/4,9,8,2)):b===3&&(s.lineWidth=.25,Jo(s,K)),s.restore()}function Jt(s,p,b,B){const G=p.x+p.width*.5,_=p.y+p.height*.5,q=Math.hypot(p.width,p.height);s.save(),s.translate(G,_),s.rotate(b),s.translate(-G,-_);const K=G-q,Q=G+q;for(let re=K;re<=Q;re+=B)s.beginPath(),s.moveTo(re,_-q),s.lineTo(re,_+q),s.stroke();s.restore()}function Qo(s,p,b,B,G,_){s.save(),s.setLineDash([G,_]),Jt(s,p,b,B),s.restore()}function Jo(s,p){const q=Math.ceil(p.height/9)+1;for(let K=0;K<q;K+=1){const Q=p.y+K*9,re=K%3*12;for(let ae=p.x-36;ae<=p.x+p.width+36;ae+=36)s.beginPath(),s.moveTo(ae+re,Q),s.lineTo(ae+re+12.5,Q),s.stroke()}}}Bi().catch(e=>{console.error(e),Ve.hasFailed()||ki(e instanceof Error?e.message:String(e))});
