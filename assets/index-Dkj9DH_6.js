var Vo=Object.defineProperty;var jo=(t,e,n)=>e in t?Vo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var H=(t,e,n)=>jo(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const c of i)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const c={};return i.integrity&&(c.integrity=i.integrity),i.referrerPolicy&&(c.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?c.credentials="include":i.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(i){if(i.ep)return;i.ep=!0;const c=n(i);fetch(i.href,c)}})();async function Oo(t){if(!navigator.gpu)throw new Error("WebGPU is not supported by this browser.");const e=t.getContext("webgpu");if(!e)throw new Error("Failed to acquire WebGPU context.");const n=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(!n)throw new Error("No suitable GPU adapter found.");const o=await n.requestDevice(),i=navigator.gpu.getPreferredCanvasFormat();return{adapter:n,device:o,context:e,format:i}}var we=1e-6,Bt=typeof Float32Array<"u"?Float32Array:Array,Uo="zyx";function Go(){var t=new Bt(9);return Bt!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function Qt(){var t=new Bt(16);return Bt!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function In(t){var e=new Bt(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Yo(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function _o(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ro(t,e,n){var o=e[0],i=e[1],c=e[2],a=e[3],r=e[4],l=e[5],f=e[6],d=e[7],p=e[8],h=e[9],m=e[10],w=e[11],P=e[12],v=e[13],M=e[14],B=e[15],T=n[0],C=n[1],g=n[2],b=n[3];return t[0]=T*o+C*r+g*p+b*P,t[1]=T*i+C*l+g*h+b*v,t[2]=T*c+C*f+g*m+b*M,t[3]=T*a+C*d+g*w+b*B,T=n[4],C=n[5],g=n[6],b=n[7],t[4]=T*o+C*r+g*p+b*P,t[5]=T*i+C*l+g*h+b*v,t[6]=T*c+C*f+g*m+b*M,t[7]=T*a+C*d+g*w+b*B,T=n[8],C=n[9],g=n[10],b=n[11],t[8]=T*o+C*r+g*p+b*P,t[9]=T*i+C*l+g*h+b*v,t[10]=T*c+C*f+g*m+b*M,t[11]=T*a+C*d+g*w+b*B,T=n[12],C=n[13],g=n[14],b=n[15],t[12]=T*o+C*r+g*p+b*P,t[13]=T*i+C*l+g*h+b*v,t[14]=T*c+C*f+g*m+b*M,t[15]=T*a+C*d+g*w+b*B,t}function Ze(t,e,n,o){var i=e[0],c=e[1],a=e[2],r=e[3],l=i+i,f=c+c,d=a+a,p=i*l,h=i*f,m=i*d,w=c*f,P=c*d,v=a*d,M=r*l,B=r*f,T=r*d,C=o[0],g=o[1],b=o[2];return t[0]=(1-(w+v))*C,t[1]=(h+T)*C,t[2]=(m-B)*C,t[3]=0,t[4]=(h-T)*g,t[5]=(1-(p+v))*g,t[6]=(P+M)*g,t[7]=0,t[8]=(m+B)*b,t[9]=(P-M)*b,t[10]=(1-(p+w))*b,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Do(t,e,n,o,i){var c=1/Math.tan(e/2);if(t[0]=c/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,i!=null&&i!==1/0){var a=1/(o-i);t[10]=i*a,t[14]=i*o*a}else t[10]=-1,t[14]=-o;return t}function qo(t,e,n,o,i,c,a){var r=1/(e-n),l=1/(o-i),f=1/(c-a);return t[0]=-2*r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=f,t[11]=0,t[12]=(e+n)*r,t[13]=(i+o)*l,t[14]=c*f,t[15]=1,t}function Wo(t,e,n,o){var i,c,a,r,l,f,d,p,h,m,w=e[0],P=e[1],v=e[2],M=o[0],B=o[1],T=o[2],C=n[0],g=n[1],b=n[2];return Math.abs(w-C)<we&&Math.abs(P-g)<we&&Math.abs(v-b)<we?_o(t):(d=w-C,p=P-g,h=v-b,m=1/Math.sqrt(d*d+p*p+h*h),d*=m,p*=m,h*=m,i=B*h-T*p,c=T*d-M*h,a=M*p-B*d,m=Math.sqrt(i*i+c*c+a*a),m?(m=1/m,i*=m,c*=m,a*=m):(i=0,c=0,a=0),r=p*a-h*c,l=h*i-d*a,f=d*c-p*i,m=Math.sqrt(r*r+l*l+f*f),m?(m=1/m,r*=m,l*=m,f*=m):(r=0,l=0,f=0),t[0]=i,t[1]=r,t[2]=d,t[3]=0,t[4]=c,t[5]=l,t[6]=p,t[7]=0,t[8]=a,t[9]=f,t[10]=h,t[11]=0,t[12]=-(i*w+c*P+a*v),t[13]=-(r*w+l*P+f*v),t[14]=-(d*w+p*P+h*v),t[15]=1,t)}function wt(){var t=new Bt(3);return Bt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Yn(t){var e=t[0],n=t[1],o=t[2];return Math.sqrt(e*e+n*n+o*o)}function It(t,e,n){var o=new Bt(3);return o[0]=t,o[1]=e,o[2]=n,o}function $o(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ne(t,e,n,o){return t[0]=e,t[1]=n,t[2]=o,t}function Ho(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function en(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Xo(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function fe(t,e,n,o){return t[0]=e[0]+n[0]*o,t[1]=e[1]+n[1]*o,t[2]=e[2]+n[2]*o,t}function Ko(t,e){var n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}function Vt(t,e){var n=e[0],o=e[1],i=e[2],c=n*n+o*o+i*i;return c>0&&(c=1/Math.sqrt(c)),t[0]=e[0]*c,t[1]=e[1]*c,t[2]=e[2]*c,t}function Dt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Wt(t,e,n){var o=e[0],i=e[1],c=e[2],a=n[0],r=n[1],l=n[2];return t[0]=i*l-c*r,t[1]=c*a-o*l,t[2]=o*r-i*a,t}var Qo=Yn;(function(){var t=wt();return function(e,n,o,i,c,a){var r,l;for(n||(n=3),o||(o=0),i?l=Math.min(i*n+o,e.length):l=e.length,r=o;r<l;r+=n)t[0]=e[r],t[1]=e[r+1],t[2]=e[r+2],c(t,t,a),e[r]=t[0],e[r+1]=t[1],e[r+2]=t[2];return e}})();function Jo(){var t=new Bt(4);return Bt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Zo(t,e){var n=e[0],o=e[1],i=e[2],c=e[3],a=n*n+o*o+i*i+c*c;return a>0&&(a=1/Math.sqrt(a)),t[0]=n*a,t[1]=o*a,t[2]=i*a,t[3]=c*a,t}(function(){var t=Jo();return function(e,n,o,i,c,a){var r,l;for(n||(n=4),o||(o=0),i?l=Math.min(i*n+o,e.length):l=e.length,r=o;r<l;r+=n)t[0]=e[r],t[1]=e[r+1],t[2]=e[r+2],t[3]=e[r+3],c(t,t,a),e[r]=t[0],e[r+1]=t[1],e[r+2]=t[2],e[r+3]=t[3];return e}})();function Ie(){var t=new Bt(4);return Bt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function ts(t,e,n){n=n*.5;var o=Math.sin(n);return t[0]=o*e[0],t[1]=o*e[1],t[2]=o*e[2],t[3]=Math.cos(n),t}function Re(t,e,n,o){var i=e[0],c=e[1],a=e[2],r=e[3],l=n[0],f=n[1],d=n[2],p=n[3],h,m,w,P,v;return m=i*l+c*f+a*d+r*p,m<0&&(m=-m,l=-l,f=-f,d=-d,p=-p),1-m>we?(h=Math.acos(m),w=Math.sin(h),P=Math.sin((1-o)*h)/w,v=Math.sin(o*h)/w):(P=1-o,v=o),t[0]=P*i+v*l,t[1]=P*c+v*f,t[2]=P*a+v*d,t[3]=P*r+v*p,t}function es(t,e){var n=e[0]+e[4]+e[8],o;if(n>0)o=Math.sqrt(n+1),t[3]=.5*o,o=.5/o,t[0]=(e[5]-e[7])*o,t[1]=(e[6]-e[2])*o,t[2]=(e[1]-e[3])*o;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var c=(i+1)%3,a=(i+2)%3;o=Math.sqrt(e[i*3+i]-e[c*3+c]-e[a*3+a]+1),t[i]=.5*o,o=.5/o,t[3]=(e[c*3+a]-e[a*3+c])*o,t[c]=(e[c*3+i]+e[i*3+c])*o,t[a]=(e[a*3+i]+e[i*3+a])*o}return t}function ns(t,e,n,o){var i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Uo,c=Math.PI/360;e*=c,o*=c,n*=c;var a=Math.sin(e),r=Math.cos(e),l=Math.sin(n),f=Math.cos(n),d=Math.sin(o),p=Math.cos(o);switch(i){case"xyz":t[0]=a*f*p+r*l*d,t[1]=r*l*p-a*f*d,t[2]=r*f*d+a*l*p,t[3]=r*f*p-a*l*d;break;case"xzy":t[0]=a*f*p-r*l*d,t[1]=r*l*p-a*f*d,t[2]=r*f*d+a*l*p,t[3]=r*f*p+a*l*d;break;case"yxz":t[0]=a*f*p+r*l*d,t[1]=r*l*p-a*f*d,t[2]=r*f*d-a*l*p,t[3]=r*f*p+a*l*d;break;case"yzx":t[0]=a*f*p+r*l*d,t[1]=r*l*p+a*f*d,t[2]=r*f*d-a*l*p,t[3]=r*f*p-a*l*d;break;case"zxy":t[0]=a*f*p-r*l*d,t[1]=r*l*p+a*f*d,t[2]=r*f*d+a*l*p,t[3]=r*f*p-a*l*d;break;case"zyx":t[0]=a*f*p-r*l*d,t[1]=r*l*p+a*f*d,t[2]=r*f*d-a*l*p,t[3]=r*f*p+a*l*d;break;default:throw new Error("Unknown angle order "+i)}return t}var _n=Zo;(function(){var t=wt(),e=It(1,0,0),n=It(0,1,0);return function(o,i,c){var a=Dt(i,c);return a<-.999999?(Wt(t,e,i),Qo(t)<1e-6&&Wt(t,n,i),Vt(t,t),ts(o,t,Math.PI),o):a>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(Wt(t,i,c),o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=1+a,_n(o,o))}})();(function(){var t=Ie(),e=Ie();return function(n,o,i,c,a,r){return Re(t,o,a,r),Re(e,i,c,r),Re(n,t,e,2*r*(1-r)),n}})();(function(){var t=Go();return function(e,n,o,i){return t[0]=o[0],t[3]=o[1],t[6]=o[2],t[1]=i[0],t[4]=i[1],t[7]=i[2],t[2]=-n[0],t[5]=-n[1],t[8]=-n[2],_n(e,es(e,t))}})();const Pn=-Math.PI/2+.001,Sn=Math.PI/2-.001;class os{constructor(){H(this,"target",It(0,0,0));H(this,"position",wt());H(this,"yaw",Math.PI*.25);H(this,"pitch",Math.PI*.2);H(this,"distance",6);H(this,"aspect",1);H(this,"fov",45*Math.PI/180);H(this,"near",.1);H(this,"far",1e3);H(this,"orthoScale",4);H(this,"mode","perspective");H(this,"view",Qt());H(this,"proj",Qt());H(this,"viewProj",Qt());H(this,"worldUp",It(0,1,0));H(this,"tmpForward",wt());H(this,"tmpRight",wt());H(this,"tmpUp",wt())}setAspect(e){this.aspect=Math.max(1e-4,e)}toggleProjection(){this.mode==="perspective"?(this.orthoScale=this.distance*Math.tan(this.fov*.5),this.mode="axonometric"):(this.distance=this.orthoScale/Math.tan(this.fov*.5),this.mode="perspective")}setAngles(e,n){this.yaw=e,this.pitch=Math.max(Pn,Math.min(Sn,n))}orbit(e,n,o=.005){this.yaw-=e*o,this.pitch-=n*o,this.pitch=Math.max(Pn,Math.min(Sn,this.pitch))}zoom(e,n=.001){const o=Math.exp(e*n);this.mode==="perspective"?this.distance=Math.min(200,Math.max(.2,this.distance*o)):this.orthoScale=Math.min(200,Math.max(.2,this.orthoScale*o))}pan(e,n,o){const i=Math.max(1,o),c=this.getPanScale(i);this.updatePosition(),en(this.tmpForward,this.target,this.position),Vt(this.tmpForward,this.tmpForward),Wt(this.tmpRight,this.tmpForward,this.worldUp),Vt(this.tmpRight,this.tmpRight),Wt(this.tmpUp,this.tmpRight,this.tmpForward),Vt(this.tmpUp,this.tmpUp),fe(this.target,this.target,this.tmpRight,-e*c),fe(this.target,this.target,this.tmpUp,n*c)}getViewMatrix(){return this.updatePosition(),Wo(this.view,this.position,this.target,this.worldUp),this.view}getProjectionMatrix(){if(this.mode==="perspective")Do(this.proj,this.fov,this.aspect,this.near,this.far);else{const e=this.orthoScale,n=e*this.aspect;qo(this.proj,-n,n,-e,e,this.near,this.far)}return this.proj}getViewProjMatrix(){return Ro(this.viewProj,this.getProjectionMatrix(),this.getViewMatrix()),this.viewProj}getPosition(){return this.updatePosition(),this.position}fitToBounds(e,n,o=1.2){const i=It(e[0],e[1],e[2]),c=It(n[0],n[1],n[2]),a=wt();Ho(a,i,c),Xo(a,a,.5),$o(this.target,a);const r=.5*Ko(i,c)*o;if(this.mode==="perspective"){const l=this.fov*.5,f=r/Math.sin(l),d=r/Math.sin(Math.atan(Math.tan(l)*this.aspect));this.distance=Math.max(f,d)}else this.orthoScale=Math.max(.1,r)}updatePosition(){const e=Math.cos(this.pitch),n=Math.sin(this.pitch),o=Math.cos(this.yaw),i=Math.sin(this.yaw);this.position[0]=this.target[0]+this.distance*e*o,this.position[1]=this.target[1]+this.distance*n,this.position[2]=this.target[2]+this.distance*e*i}getPanScale(e){return this.mode==="perspective"?2*this.distance*Math.tan(this.fov*.5)/e:this.orthoScale*2/e}}class ss{constructor(e,n){H(this,"pointerId",null);H(this,"dragMode",null);H(this,"lastX",0);H(this,"lastY",0);H(this,"pointers",new Map);H(this,"lastMidpoint",null);H(this,"lastDistance",null);H(this,"onPointerDown",e=>{if(this.canvas.setPointerCapture(e.pointerId),e.pointerType==="touch"){this.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),this.updateTouchGestureState();return}this.pointerId=e.pointerId,this.lastX=e.clientX,this.lastY=e.clientY,this.dragMode=this.getDragMode(e)});H(this,"onPointerMove",e=>{if(e.pointerType==="touch"){const i=this.pointers.get(e.pointerId);if(!i)return;const c={x:e.clientX,y:e.clientY};if(this.pointers.set(e.pointerId,c),this.pointers.size===1){const f=c.x-i.x,d=c.y-i.y;this.camera.orbit(-f,-d);return}const a=this.getTwoTouchPoints();if(!a)return;const r=this.getMidpoint(a[0],a[1]),l=this.getDistance(a[0],a[1]);if(this.lastMidpoint&&this.lastDistance!==null){const f=r.x-this.lastMidpoint.x,d=r.y-this.lastMidpoint.y;this.camera.pan(f,d,this.canvas.clientHeight);const p=l-this.lastDistance;Math.abs(p)>0&&this.camera.zoom(-p)}this.lastMidpoint=r,this.lastDistance=l;return}if(this.pointerId!==e.pointerId||!this.dragMode)return;const n=e.clientX-this.lastX,o=e.clientY-this.lastY;this.dragMode==="orbit"?this.camera.orbit(-n,-o):this.camera.pan(n,o,this.canvas.clientHeight),this.lastX=e.clientX,this.lastY=e.clientY});H(this,"onPointerUp",e=>{if(e.pointerType==="touch"){this.pointers.delete(e.pointerId),this.updateTouchGestureState(),this.canvas.releasePointerCapture(e.pointerId);return}this.pointerId===e.pointerId&&(this.canvas.releasePointerCapture(e.pointerId),this.pointerId=null,this.dragMode=null)});H(this,"onWheel",e=>{e.preventDefault();const n=e.deltaY*3.3;this.camera.zoom(n)});H(this,"onKeyDown",e=>{e.code==="KeyP"&&this.camera.toggleProjection()});this.canvas=e,this.camera=n,this.attach()}attach(){this.canvas.addEventListener("pointerdown",this.onPointerDown),this.canvas.addEventListener("pointermove",this.onPointerMove),this.canvas.addEventListener("pointerup",this.onPointerUp),this.canvas.addEventListener("pointercancel",this.onPointerUp),this.canvas.addEventListener("wheel",this.onWheel,{passive:!1}),this.canvas.addEventListener("contextmenu",e=>{e.preventDefault()}),window.addEventListener("keydown",this.onKeyDown)}updateTouchGestureState(){const e=this.getTwoTouchPoints();if(!e){this.lastMidpoint=null,this.lastDistance=null;return}this.lastMidpoint=this.getMidpoint(e[0],e[1]),this.lastDistance=this.getDistance(e[0],e[1])}getTwoTouchPoints(){if(this.pointers.size<2)return null;const e=this.pointers.values(),n=e.next().value,o=e.next().value;return!n||!o?null:[n,o]}getMidpoint(e,n){return{x:(e.x+n.x)*.5,y:(e.y+n.y)*.5}}getDistance(e,n){return Math.hypot(n.x-e.x,n.y-e.y)}getDragMode(e){return e.shiftKey||e.button===1?"pan":e.button===0?"orbit":null}}const Tn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
  @location(1) normal: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
  @location(0) normal: vec3<f32>,
  @location(1) worldPos: vec3<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  out.normal = normalize((object.model * vec4<f32>(input.normal, 0.0)).xyz);
  out.worldPos = worldPos.xyz;
  return out;
}

// Fade to the average coverage when the pattern is sub-pixel to avoid moire.
fn resolvePattern(value: f32, duty: f32, fw: f32) -> f32 {
  let safeFw = max(fw, 1e-5);
  let fade = clamp(0.5 / safeFw, 0.0, 1.0);
  let clampedDuty = clamp(duty, 0.0, 1.0);
  return mix(clampedDuty, value, fade);
}

// Derivative-based antialiasing for periodic line patterns in screen space.
fn aaLine(u: f32, spacing: f32, thickness: f32) -> f32 {
  let safeSpacing = max(spacing, 1e-5);
  let coord = u / safeSpacing;
  let dist = abs(fract(coord) - 0.5);
  let fw = fwidth(coord);
  let width = clamp(thickness / safeSpacing, 0.0, 1.0);
  let halfWidth = 0.5 * width;
  let line = 1.0 - smoothstep(halfWidth - fw, halfWidth + fw, dist);
  return resolvePattern(line, width, fw);
}

// Antialiased on/off pulse along a period (used for dash segments).
fn aaPulse(u: f32, period: f32, length: f32) -> f32 {
  let safePeriod = max(period, 1e-5);
  let coord = u / safePeriod;
  let phase = fract(coord);
  let fw = fwidth(coord);
  let duty = clamp(length / safePeriod, 0.0, 1.0);
  let head = smoothstep(0.0, fw, phase);
  let tail = 1.0 - smoothstep(duty - fw, duty + fw, phase);
  let pulse = head * tail;
  return resolvePattern(pulse, duty, fw);
}

fn lineMask(
  screenPx: vec2<f32>,
  normal: vec2<f32>,
  spacing: f32,
  thickness: f32
) -> f32 {
  let u = dot(screenPx, normal);
  return aaLine(u, spacing, thickness);
}

fn dashMask(screenPx: vec2<f32>) -> f32 {
  let rowSpacing = 9.0;
  let dashLength = 12.5;
  let dashPeriod = 36.0;
  let thickness = 0.25;
  let rowIndex = floor(screenPx.y / rowSpacing);
  let phase = f32(i32(rowIndex) % 3) * (dashPeriod / 3.0);
  let row = aaLine(screenPx.y, rowSpacing, thickness);
  let dash = aaPulse(screenPx.x + phase, dashPeriod, dashLength);
  return row * dash;
}

fn dashedLineMask(
  screenPx: vec2<f32>,
  normal: vec2<f32>,
  spacing: f32,
  thickness: f32,
  dashLength: f32,
  dashPeriod: f32,
  phase: f32
) -> f32 {
  let line = lineMask(screenPx, normal, spacing, thickness);
  let tangent = vec2<f32>(-normal.y, normal.x);
  let v = dot(screenPx, tangent) + phase;
  let dash = aaPulse(v, dashPeriod, dashLength);
  return line * dash;
}

fn gridMask(worldPos: vec3<f32>, spacing: f32) -> f32 {
  if (spacing <= 0.0) {
    return 0.0;
  }
  let s = max(1e-4, spacing);
  let thickness = 0.0075;
  let lineX = gridLineMask(worldPos.x, s, thickness);
  let lineZ = gridLineMask(worldPos.z, s, thickness);
  return max(lineX, lineZ);
}

fn gridLineMask(u: f32, spacing: f32, thickness: f32) -> f32 {
  let coord = u / spacing;
  let dist = abs(fract(coord) - 0.5);
  let fw = max(fwidth(coord), 1e-4);
  let halfWidth = 0.5 * (thickness / spacing);
  return 1.0 - smoothstep(halfWidth - fw, halfWidth + fw, dist);
}

@fragment
fn fsMain(input: VertexOut, @builtin(front_facing) isFront: bool) -> @location(0) vec4<f32> {
  let light = normalize(-frame.cameraDir);
  let n = normalize(input.normal);
  let shadeNormal = select(-n, n, isFront);
  var ndotl = 0.0;
  let fill = 0.4;
  let materialType = i32(round(object.material.y));
  let patternId = i32(round(object.material.x));
  let gridOnly = object.material.w;

  if (materialType == 1) {
    ndotl = abs(dot(n, light));
  } else {
    ndotl = max(dot(shadeNormal, light), 0.0);
  }

  let lightFactor = min(1.0, ndotl + fill);
  let base = object.color.rgb * lightFactor;

  if (materialType == 1) {
    let grid = gridMask(input.worldPos, object.material.z);
    let gridColor = vec3<f32>(0.55, 0.55, 0.55);
    if (gridOnly > 0.5) {
      if (grid <= 0.0) {
        discard;
      }
      let color = mix(base, gridColor, grid);
      return vec4<f32>(color, 1.0);
    }
    let color = mix(base, gridColor, grid);
    return vec4<f32>(color, object.color.a);
  }

  if (materialType == 3) {
    let viewDir = normalize(frame.cameraPos - input.worldPos);
    let fresnel = pow(1.0 - max(dot(shadeNormal, viewDir), 0.0), 3.0);
    let glassLight = mix(0.65, 1.0, ndotl);
    let glassBase = object.color.rgb * glassLight;
    let rim = mix(glassBase, vec3<f32>(1.0, 1.0, 1.0), 0.6);
    let keyLight = normalize(vec3<f32>(0.35, 0.85, 0.25));
    let halfVec = normalize(keyLight + viewDir);
    let spec = pow(max(dot(shadeNormal, halfVec), 0.0), 64.0);
    // Key lights are positioned from the default camera view to hit front/top faces on load.
    let keyLight1 = normalize(vec3<f32>(-0.805159, 0.326138, 0.495332));
    let keyLight2 = normalize(vec3<f32>(0.805159, 0.326138, -0.495332));
    let halfVec1 = normalize(keyLight1 + viewDir);
    let halfVec2 = normalize(keyLight2 + viewDir);
    let spec1 = pow(max(dot(shadeNormal, halfVec1), 0.0), 64.0);
    let spec2 = pow(max(dot(shadeNormal, halfVec2), 0.0), 64.0);
    let extraSpec = (spec1 + spec2) * 0.18;
    let color = mix(glassBase, rim, fresnel) + spec * 0.25 + extraSpec;
    let alpha = clamp(object.color.a * (0.7 + 0.7 * fresnel), 0.0, 1.0);
    return vec4<f32>(color, alpha);
  }

  if (patternId == 0) {
    return vec4<f32>(base, object.color.a);
  }

  var u = 0.0;
  var v = 0.0;
  let an = abs(n);
  if (an.y >= an.x && an.y >= an.z) {
    u = input.worldPos.x;
    v = input.worldPos.z;
  } else if (an.x >= an.z) {
    u = input.worldPos.z;
    v = input.worldPos.y;
  } else {
    u = input.worldPos.x;
    v = input.worldPos.y;
  }
  let surfaceScale = max(object.material.w, 1e-4);
  let surfacePx = vec2(u, v) * surfaceScale;
  let normalA = vec2<f32>(-0.70710678, 0.70710678);
  let normalB = vec2<f32>(0.70710678, 0.70710678);

  var hatch = 0.0;
  if (patternId == 1) {
    let a = lineMask(surfacePx, normalA, 12.0, 0.25);
    let b = lineMask(surfacePx, normalB, 12.0, 0.25);
    hatch = max(a, b);
  } else if (patternId == 2) {
    hatch = dashedLineMask(surfacePx, normalA, 9.0, 0.25, 8.0, 10.0, 0.0);
  } else if (patternId == 3) {
    hatch = dashMask(surfacePx);
  }

  let ink = vec3<f32>(0.0, 0.0, 0.0);
  let color = mix(base, ink, hatch);
  return vec4<f32>(color, object.color.a);
}
`,zn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
  @location(1) normal: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  return out;
}

fn encodeId(id: u32) -> vec4<f32> {
  let r = f32((id >> 0u) & 0xFFu) / 255.0;
  let g = f32((id >> 8u) & 0xFFu) / 255.0;
  let b = f32((id >> 16u) & 0xFFu) / 255.0;
  let a = f32((id >> 24u) & 0xFFu) / 255.0;
  return vec4<f32>(r, g, b, a);
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  let id = u32(object.pick.x);
  return encodeId(id);
}
`,Nn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) start: vec3<f32>,
  @location(1) end: vec3<f32>,
  @location(2) side: f32,
  @location(3) along: f32,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

fn ndcToScreen(ndc: vec2<f32>, viewport: vec2<f32>) -> vec2<f32> {
  let x = (ndc.x * 0.5 + 0.5) * viewport.x;
  let y = (1.0 - (ndc.y * 0.5 + 0.5)) * viewport.y;
  return vec2<f32>(x, y);
}

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  let startClip = frame.viewProj * vec4<f32>(input.start, 1.0);
  let endClip = frame.viewProj * vec4<f32>(input.end, 1.0);
  let startNdc = startClip.xy / startClip.w;
  let endNdc = endClip.xy / endClip.w;

  let viewport = frame.viewport.xy;
  let startScreen = ndcToScreen(startNdc, viewport);
  let endScreen = ndcToScreen(endNdc, viewport);
  var dirScreen = endScreen - startScreen;
  let len = length(dirScreen);
  if (len < 1e-4) {
    dirScreen = vec2<f32>(1.0, 0.0);
  } else {
    dirScreen = dirScreen / len;
  }
  let perp = vec2<f32>(-dirScreen.y, dirScreen.x);
  let halfWidth = 3.0;
  let offsetScreen = perp * (halfWidth * input.side);
  let offsetNdc = vec2<f32>(
    offsetScreen.x * frame.viewport.z * 2.0,
    -offsetScreen.y * frame.viewport.w * 2.0
  );

  let baseClip = mix(startClip, endClip, input.along);
  let baseNdc = baseClip.xy / baseClip.w;
  let finalNdc = baseNdc + offsetNdc;

  var out: VertexOut;
  out.position = vec4<f32>(finalNdc * baseClip.w, baseClip.z, baseClip.w);
  return out;
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  return object.color;
}
`,Cn=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) position: vec3<f32>,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
};

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;
  let worldPos = object.model * vec4<f32>(input.position, 1.0);
  out.position = frame.viewProj * worldPos;
  return out;
}

@fragment
fn fsMain() -> @location(0) vec4<f32> {
  return object.color;
}

`,En=`struct FrameUniforms {
  viewProj: mat4x4<f32>,
  cameraPos: vec3<f32>,
  devicePixelRatio: f32,
  cameraDir: vec3<f32>,
  _pad0: f32,
  viewport: vec4<f32>,
};

struct ObjectUniforms {
  model: mat4x4<f32>,
  color: vec4<f32>,
  material: vec4<f32>,
  pick: vec4<f32>,
};

@group(0) @binding(0)
var<uniform> frame: FrameUniforms;

@group(1) @binding(0)
var<uniform> object: ObjectUniforms;

struct VertexIn {
  @location(0) aPos: vec3<f32>,
  @location(1) bPos: vec3<f32>,
  @location(2) n0: vec3<f32>,
  @location(3) n1: vec3<f32>,
  @location(4) side: f32,
  @location(5) along: f32,
};

struct VertexOut {
  @builtin(position) position: vec4<f32>,
  @location(0) @interpolate(flat) lineA: vec2<f32>,
  @location(1) @interpolate(flat) lineB: vec2<f32>,
  @location(2) @interpolate(flat) visibility: f32,
};

fn ndcToScreen(ndc: vec2<f32>) -> vec2<f32> {
  let uv = ndc * 0.5 + vec2<f32>(0.5, 0.5);
  return vec2<f32>(uv.x * frame.viewport.x, (1.0 - uv.y) * frame.viewport.y);
}

@vertex
fn vsMain(input: VertexIn) -> VertexOut {
  var out: VertexOut;

  let worldA = object.model * vec4<f32>(input.aPos, 1.0);
  let worldB = object.model * vec4<f32>(input.bPos, 1.0);
  let clipA = frame.viewProj * worldA;
  let clipB = frame.viewProj * worldB;

  let ndcA = clipA.xy / clipA.w;
  let ndcB = clipB.xy / clipB.w;
  let screenA = ndcToScreen(ndcA);
  let screenB = ndcToScreen(ndcB);
  out.lineA = screenA;
  out.lineB = screenB;

  let dir = screenB - screenA;
  let len = max(1e-4, length(dir));
  let tangent = dir / len;
  let normal = vec2<f32>(-tangent.y, tangent.x);

  let halfWidth = 1.0;
  let offsetPx = normal * (input.side * halfWidth);
  let offsetNdc = vec2<f32>(
    offsetPx.x * frame.viewport.z * 2.0,
    -offsetPx.y * frame.viewport.w * 2.0
  );

  let base = mix(clipA, clipB, input.along);
  let biasedZ = max(0.0, base.z);
  let shifted = vec4<f32>(
    base.xy + offsetNdc * base.w,
    biasedZ,
    base.w
  );
  out.position = shifted;

  out.visibility = 1.0;
  return out;
}

@fragment
fn fsMain(input: VertexOut) -> @location(0) vec4<f32> {
  if (input.visibility <= 0.0) {
    discard;
  }
  let a = input.lineA;
  let b = input.lineB;
  let ab = b - a;
  let len2 = max(1e-4, dot(ab, ab));

  let p = input.position.xy / frame.devicePixelRatio;
  let t = clamp(dot(p - a, ab) / len2, 0.0, 1.0);
  let proj = a + ab * t;
  let dist = length(p - proj);

  let halfWidth = 1.0;
  let aa = max(0.5, fwidth(dist));
  let mask = 1.0 - smoothstep(halfWidth - aa, halfWidth + aa, dist);
  return vec4<f32>(object.color.rgb, object.color.a * mask);
}
`,is={r:21/255,g:21/255,b:21/255,a:1},rs=3;class cs{constructor(e,n,o,i){H(this,"pipeline");H(this,"terrainPipeline");H(this,"glassBackPipeline");H(this,"glassFrontPipeline");H(this,"curvePipeline");H(this,"wireframePipeline");H(this,"edgePipeline");H(this,"edgeOccludedPipeline");H(this,"pickPipeline");H(this,"frameBindGroupLayout");H(this,"objectBindGroupLayout");H(this,"pipelineLayout");H(this,"frameUniformBuffer");H(this,"frameUniformData");H(this,"frameBindGroup");H(this,"depthTexture",null);H(this,"depthView",null);H(this,"pickTexture",null);H(this,"pickView",null);H(this,"pickDepthTexture",null);H(this,"pickDepthView",null);H(this,"pickBuffer",null);H(this,"objects",[]);H(this,"size",{width:0,height:0,dpr:1});H(this,"cameraDir",wt());H(this,"clearColor",{...is});this.canvas=e,this.device=n,this.context=o,this.format=i,this.frameUniformData=new Float32Array(28),this.frameUniformBuffer=n.createBuffer({size:this.frameUniformData.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.frameBindGroupLayout=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.objectBindGroupLayout=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.pipelineLayout=n.createPipelineLayout({bindGroupLayouts:[this.frameBindGroupLayout,this.objectBindGroupLayout]}),this.pipeline=this.createPipeline("back"),this.terrainPipeline=this.createPipeline("none",!0),this.glassBackPipeline=this.createPipeline("front",!0,!1,"less-equal"),this.glassFrontPipeline=this.createPipeline("back",!0,!1,"less-equal"),this.curvePipeline=this.createCurvePipeline(),this.wireframePipeline=this.createWireframePipeline(),this.edgePipeline=this.createEdgeHighlightPipeline("always"),this.edgeOccludedPipeline=this.createEdgeHighlightPipeline("less-equal"),this.pickPipeline=this.createPickPipeline(),this.frameBindGroup=n.createBindGroup({layout:this.frameBindGroupLayout,entries:[{binding:0,resource:{buffer:this.frameUniformBuffer}}]})}setObjects(e){this.objects=e}setClearColor(e){this.clearColor={...e}}createRenderObject(e,n,o,i,c,a){const r=In(o),l=In(r),f=[...i],d=[...c],p=[...c],h=new Float32Array(28);h.set(r,0),h.set(i,16),h.set(d,20),h.set([0,0,0,0],24);const m=this.device.createBuffer({size:h.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),w=this.device.createBindGroup({layout:this.objectBindGroupLayout,entries:[{binding:0,resource:{buffer:m}}]});return this.device.queue.writeBuffer(m,0,h),{id:e,mesh:n,modelMatrix:r,baseMatrix:l,color:i,baseColor:f,material:d,baseMaterial:p,objectType:a.objectType,layerIndex:a.layerIndex??0,visible:!0,soilId:a.soilId,sectionId:a.sectionId,profileId:a.profileId,pickId:0,edgeXray:!1,uniformBuffer:m,uniformData:h,bindGroup:w}}resize(){var i,c,a;const e=window.devicePixelRatio||1,n=Math.max(1,Math.floor(this.canvas.clientWidth*e)),o=Math.max(1,Math.floor(this.canvas.clientHeight*e));n===this.size.width&&o===this.size.height&&e===this.size.dpr||(this.size={width:n,height:o,dpr:e},this.canvas.width=n,this.canvas.height=o,this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"}),(i=this.depthTexture)==null||i.destroy(),this.depthTexture=this.device.createTexture({size:{width:n,height:o},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.depthView=this.depthTexture.createView(),(c=this.pickTexture)==null||c.destroy(),this.pickTexture=this.device.createTexture({size:{width:n,height:o},format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.pickView=this.pickTexture.createView(),(a=this.pickDepthTexture)==null||a.destroy(),this.pickDepthTexture=this.device.createTexture({size:{width:n,height:o},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.pickDepthView=this.pickDepthTexture.createView(),this.pickBuffer||(this.pickBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})))}getSize(){return this.size}render(e){if(this.objects.length===0)return;this.resize();const n=e.getViewProjMatrix(),o=e.getPosition();en(this.cameraDir,e.target,o),Vt(this.cameraDir,this.cameraDir);const i=this.size.width/this.size.dpr,c=this.size.height/this.size.dpr;this.frameUniformData.set(n,0),this.frameUniformData.set([o[0],o[1],o[2],this.size.dpr],16),this.frameUniformData.set([this.cameraDir[0],this.cameraDir[1],this.cameraDir[2],0],20),this.frameUniformData.set([i,c,i>0?1/i:0,c>0?1/c:0],24),this.device.queue.writeBuffer(this.frameUniformBuffer,0,this.frameUniformData.buffer,this.frameUniformData.byteOffset,this.frameUniformData.byteLength);const a=e.mode==="perspective",r=a?c/(2*Math.tan(e.fov*.5)):c/(2*e.orthoScale),l=this.context.getCurrentTexture().createView(),f=this.device.createCommandEncoder(),d=f.beginRenderPass({colorAttachments:[{view:l,loadOp:"clear",storeOp:"store",clearValue:this.clearColor}],depthStencilAttachment:{view:this.depthView,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});d.setBindGroup(0,this.frameBindGroup);let p=null;for(const h of this.objects){if(!h.visible)continue;if(h.material[1]===0&&h.material[0]>0){const P=a?r/Math.max(e.distance,.01):r;h.material[3]=P}else h.material[1]!==1&&(h.material[3]=1);if(h.uniformData.set(h.modelMatrix,0),h.uniformData.set(h.color,16),h.uniformData.set(h.material,20),h.uniformData.set([h.pickId??0,0,0,0],24),this.device.queue.writeBuffer(h.uniformBuffer,0,h.uniformData.buffer,h.uniformData.byteOffset,h.uniformData.byteLength),h.objectType==="solid"&&Math.round(h.material[1])===rs){p!==this.glassBackPipeline&&(d.setPipeline(this.glassBackPipeline),p=this.glassBackPipeline),d.setBindGroup(1,h.bindGroup),d.setVertexBuffer(0,h.mesh.vertexBuffer),d.draw(h.mesh.vertexCount,1,0,0),p!==this.glassFrontPipeline&&(d.setPipeline(this.glassFrontPipeline),p=this.glassFrontPipeline),d.setBindGroup(1,h.bindGroup),d.setVertexBuffer(0,h.mesh.vertexBuffer),d.draw(h.mesh.vertexCount,1,0,0);continue}const w=h.objectType==="curve"?this.curvePipeline:h.objectType==="solidWireframe"?this.wireframePipeline:h.objectType==="solidEdge"?h.edgeXray?this.edgePipeline:this.edgeOccludedPipeline:h.objectType==="terrain"||h.objectType==="solid"?this.terrainPipeline:this.pipeline;p!==w&&(d.setPipeline(w),p=w),d.setBindGroup(1,h.bindGroup),d.setVertexBuffer(0,h.mesh.vertexBuffer),d.draw(h.mesh.vertexCount,1,0,0)}d.end(),this.device.queue.submit([f.finish()])}async pick(e,n){if(!this.pickTexture||!this.pickView||!this.pickDepthView||!this.pickBuffer)return null;const o=Math.floor(e*this.size.dpr),i=Math.floor(n*this.size.dpr);if(o<0||i<0||o>=this.size.width||i>=this.size.height)return null;const c=this.device.createCommandEncoder(),a=c.beginRenderPass({colorAttachments:[{view:this.pickView,loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:0}}],depthStencilAttachment:{view:this.pickDepthView,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});a.setPipeline(this.pickPipeline),a.setBindGroup(0,this.frameBindGroup);for(const f of this.objects)!f.visible||!f.pickId||(a.setBindGroup(1,f.bindGroup),a.setVertexBuffer(0,f.mesh.vertexBuffer),a.draw(f.mesh.vertexCount,1,0,0));a.end(),c.copyTextureToBuffer({texture:this.pickTexture,origin:{x:o,y:i}},{buffer:this.pickBuffer,bytesPerRow:256},{width:1,height:1,depthOrArrayLayers:1}),this.device.queue.submit([c.finish()]),await this.pickBuffer.mapAsync(GPUMapMode.READ);const r=new Uint8Array(this.pickBuffer.getMappedRange()),l=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;return this.pickBuffer.unmap(),l===0?null:l}createPipeline(e,n=!1,o=!0,i="less"){const c=[{format:this.format}];return n&&(c[0].blend={color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}),this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:Tn}),entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{module:this.device.createShaderModule({code:Tn}),entryPoint:"fsMain",targets:c},primitive:{topology:"triangle-list",cullMode:e},depthStencil:{format:"depth24plus",depthWriteEnabled:o,depthCompare:i}})}createCurvePipeline(){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:Nn}),entryPoint:"vsMain",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32"},{shaderLocation:3,offset:28,format:"float32"}]}]},fragment:{module:this.device.createShaderModule({code:Nn}),entryPoint:"fsMain",targets:[{format:this.format,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{depthWriteEnabled:!1,depthCompare:"less-equal",format:"depth24plus"}})}createWireframePipeline(e="less-equal"){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:Cn}),entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]}]},fragment:{module:this.device.createShaderModule({code:Cn}),entryPoint:"fsMain",targets:[{format:this.format}]},primitive:{topology:"line-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:e}})}createEdgeHighlightPipeline(e){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:En}),entryPoint:"vsMain",buffers:[{arrayStride:14*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:6*4,format:"float32x3"},{shaderLocation:3,offset:9*4,format:"float32x3"},{shaderLocation:4,offset:12*4,format:"float32"},{shaderLocation:5,offset:13*4,format:"float32"}]}]},fragment:{module:this.device.createShaderModule({code:En}),entryPoint:"fsMain",targets:[{format:this.format,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:e}})}createPickPipeline(){return this.device.createRenderPipeline({layout:this.pipelineLayout,vertex:{module:this.device.createShaderModule({code:zn}),entryPoint:"vsMain",buffers:[{arrayStride:6*4,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"}]}]},fragment:{module:this.device.createShaderModule({code:zn}),entryPoint:"fsMain",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}})}}async function as(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load scene: ${e.status}`);return await e.json()}function ls(t){const e=new Float32Array([.5,-.5,-.5,1,0,0,.5,.5,-.5,1,0,0,.5,.5,.5,1,0,0,.5,-.5,-.5,1,0,0,.5,.5,.5,1,0,0,.5,-.5,.5,1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0,-.5,-.5,-.5,-1,0,0,-.5,.5,-.5,0,1,0,-.5,.5,.5,0,1,0,.5,.5,.5,0,1,0,-.5,.5,-.5,0,1,0,.5,.5,.5,0,1,0,.5,.5,-.5,0,1,0,-.5,-.5,.5,0,-1,0,-.5,-.5,-.5,0,-1,0,.5,-.5,-.5,0,-1,0,-.5,-.5,.5,0,-1,0,.5,-.5,-.5,0,-1,0,.5,-.5,.5,0,-1,0,-.5,-.5,.5,0,0,1,.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,.5,.5,0,0,1,.5,-.5,-.5,0,0,-1,-.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,.5,-.5,0,0,-1]),n=t.createBuffer({size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(n,0,e),{vertexBuffer:n,vertexCount:e.length/6}}const fs=1e-6;function ds(t,e){if(e.length<2)return kn(t);const n=[],o=(a,r,l,f)=>{n.push(a[0],a[1],a[2],r[0],r[1],r[2],l,f)};for(let a=0;a<e.length-1;a+=1){const r=e[a],l=e[a+1],f=l[0]-r[0],d=l[1]-r[1],p=l[2]-r[2];f*f+d*d+p*p<=fs||(o(r,l,-1,0),o(r,l,1,0),o(r,l,1,1),o(r,l,-1,0),o(r,l,1,1),o(r,l,-1,1))}const i=new Float32Array(n);if(i.length===0)return kn(t);const c=t.createBuffer({size:i.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(c,0,i),{vertexBuffer:c,vertexCount:i.length/8}}function kn(t){return{vertexBuffer:t.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}function An(t,e,n,o,i=.02){const c=[],a=(f,d,p,h,m,w)=>{c.push(f,d,p,h,m,w)};for(let f=0;f<e.length-1;f+=1){const[d,p]=e[f],[h,m]=e[f+1],w=h-d,P=m-p,v=Math.hypot(w,P);if(v<1e-4)continue;const M=P/v,B=-w/v,T=M*i,C=B*i,g=d+T,b=p+C,z=h+T,L=m+C,I=n,E=n,F=o,j=o;a(g,I,b,M,0,B),a(z,F,L,M,0,B),a(z,E,L,M,0,B),a(g,I,b,M,0,B),a(g,j,b,M,0,B),a(z,F,L,M,0,B),a(g,I,b,-M,0,-B),a(z,E,L,-M,0,-B),a(z,F,L,-M,0,-B),a(g,I,b,-M,0,-B),a(z,F,L,-M,0,-B),a(g,j,b,-M,0,-B)}const r=new Float32Array(c),l=t.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(l,0,r),{vertexBuffer:l,vertexCount:r.length/6}}const hs=1e-6;function us(t,e,n,o){const i=Math.floor(e.length/2),c=Math.floor(o.length/3);if(i<3||n.length!==i||c<1||o.length!==c*3)return Bn(t);const a=new Float32Array(i),r=new Float32Array(i),l=new Float32Array(i),f=M=>e[M*2],d=M=>e[M*2+1],p=M=>n[M];for(let M=0;M<o.length;M+=3){let B=o[M]|0,T=o[M+1]|0,C=o[M+2]|0;if(B<0||T<0||C<0||B>=i||T>=i||C>=i)continue;const g=f(B),b=d(B),z=f(T),L=d(T),I=f(C),E=d(C);if((z-g)*(E-b)-(L-b)*(I-g)<0){const J=T;T=C,C=J}const j=p(B),G=p(T),Y=p(C),W=z-g,x=G-j,S=L-b,y=I-g,A=Y-j,N=E-b,q=x*N-S*A,_=S*y-W*N,Q=W*A-x*y;a[B]+=q,r[B]+=_,l[B]+=Q,a[T]+=q,r[T]+=_,l[T]+=Q,a[C]+=q,r[C]+=_,l[C]+=Q}const h=new Float32Array(i*3);for(let M=0;M<i;M+=1){const B=a[M],T=r[M],C=l[M],g=Math.hypot(B,T,C);if(g<=hs){h[M*3]=0,h[M*3+1]=1,h[M*3+2]=0;continue}h[M*3]=B/g,h[M*3+1]=T/g,h[M*3+2]=C/g}const m=[],w=M=>{m.push(f(M),p(M),d(M),h[M*3],h[M*3+1],h[M*3+2])};for(let M=0;M<o.length;M+=3){let B=o[M]|0,T=o[M+1]|0,C=o[M+2]|0;if(B<0||T<0||C<0||B>=i||T>=i||C>=i)continue;const g=f(B),b=d(B),z=f(T),L=d(T),I=f(C),E=d(C);if((z-g)*(E-b)-(L-b)*(I-g)<0){const j=T;T=C,C=j}w(B),w(T),w(C)}const P=new Float32Array(m);if(P.length===0)return Bn(t);const v=t.createBuffer({size:P.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(v,0,P),{vertexBuffer:v,vertexCount:P.length/6}}function Bn(t){return{vertexBuffer:t.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}const ps=1e-6,Xt=6,ms=(t,e,n)=>Math.min(Math.max(t,e),n),xs=(t,e,n)=>{const o=Math.hypot(t,e,n);return o<=ps?null:[t/o,e/o,n/o]},De=1e-5,Fn=(t,e,n)=>{const o=Math.round(t/De),i=Math.round(e/De),c=Math.round(n/De);return`${o},${i},${c}`};function gs(t,e){if(t.length===0)return t;const n=new Map,o=[],i=(r,l,f,d,p,h)=>{o.push(r[0],r[1],r[2],l[0],l[1],l[2],f[0],f[1],f[2],d[0],d[1],d[2],p,h)},c=(r,l,f,d)=>{i(r,l,f,d,-1,0),i(r,l,f,d,1,0),i(r,l,f,d,1,1),i(r,l,f,d,-1,0),i(r,l,f,d,1,1),i(r,l,f,d,-1,1)},a=(r,l,f)=>{const d=Fn(r[0],r[1],r[2]),p=Fn(l[0],l[1],l[2]),h=d<p?`${d}|${p}`:`${p}|${d}`,m=n.get(h);if(!m){n.set(h,{a:r,b:l,normals:[f]});return}m.normals.push(f)};for(let r=0;r+Xt*3-1<t.length;r+=Xt*3){const l=t[r],f=t[r+1],d=t[r+2],p=t[r+Xt],h=t[r+Xt+1],m=t[r+Xt+2],w=t[r+Xt*2],P=t[r+Xt*2+1],v=t[r+Xt*2+2],M=p-l,B=h-f,T=m-d,C=w-l,g=P-f,b=v-d,z=B*b-T*g,L=T*C-M*b,I=M*g-B*C,E=xs(z,L,I);if(!E)continue;const F=[l,f,d],j=[p,h,m],G=[w,P,v];a(F,j,E),a(j,G,E),a(G,F,E)}for(const r of n.values()){const l=r.normals;if(l.length===1){c(r.a,r.b,l[0],l[0]);continue}let f=1,d=null,p=null;for(let h=0;h<l.length;h+=1){const m=l[h];for(let w=h+1;w<l.length;w+=1){const P=l[w],v=ms(m[0]*P[0]+m[1]*P[1]+m[2]*P[2],-1,1);v<f&&(f=v,d=m,p=P)}}d&&p&&f<e&&c(r.a,r.b,d,p)}return o.length>0?new Float32Array(o):new Float32Array}const Yt=1e-6,ys=Math.cos(40*Math.PI/180);function qe(t,e,n=6){if(e.length===0)return Dn(t);const o=t.createBuffer({size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(o,0,e),{vertexBuffer:o,vertexCount:e.length/n}}function Ms(t){if(t.length===0)return t;const e=new Float32Array(t.length*2);let n=0;for(let o=0;o+17<t.length;o+=18){const i=o,c=o+6,a=o+12;for(let r=0;r<6;r+=1)e[n++]=t[i+r];for(let r=0;r<6;r+=1)e[n++]=t[c+r];for(let r=0;r<6;r+=1)e[n++]=t[c+r];for(let r=0;r<6;r+=1)e[n++]=t[a+r];for(let r=0;r<6;r+=1)e[n++]=t[a+r];for(let r=0;r<6;r+=1)e[n++]=t[i+r]}return e}function vs(t,e){const n=Math.floor(e.length/3),o=new Int32Array(n*3);for(let i=0;i<n;i+=1){const c=i*3,a=e[c]|0;let r=e[c+1]|0,l=e[c+2]|0;const f=t[a*2],d=t[a*2+1],p=t[r*2],h=t[r*2+1],m=t[l*2],w=t[l*2+1];if((p-f)*(w-d)-(h-d)*(m-f)<0){const v=r;r=l,l=v}o[c]=a,o[c+1]=r,o[c+2]=l}return o}function Ln(t,e,n,o){const i=Math.floor(t.length/2),c=new Float32Array(i*3);for(let a=0;a<n.length;a+=3){const r=n[a],l=n[a+1],f=n[a+2];if(r<0||l<0||f<0||r>=i||l>=i||f>=i)continue;const d=t[r*2],p=t[r*2+1],h=e[r],m=t[l*2],w=t[l*2+1],P=e[l],v=t[f*2],M=t[f*2+1],B=e[f],T=m-d,C=P-h,g=w-p,b=v-d,z=B-h,L=M-p;let I,E,F;o==="up"?(I=C*L-g*z,E=g*b-T*L,F=T*z-C*b):(I=z*g-L*C,E=L*T-b*g,F=b*C-z*T),c[r*3]+=I,c[r*3+1]+=E,c[r*3+2]+=F,c[l*3]+=I,c[l*3+1]+=E,c[l*3+2]+=F,c[f*3]+=I,c[f*3+1]+=E,c[f*3+2]+=F}for(let a=0;a<i;a+=1){const r=c[a*3],l=c[a*3+1],f=c[a*3+2],d=Math.hypot(r,l,f);if(d<=Yt){c[a*3]=0,c[a*3+1]=o==="up"?1:-1,c[a*3+2]=0;continue}c[a*3]=r/d,c[a*3+1]=l/d,c[a*3+2]=f/d}return c}function bs(t,e,n,o,i,c,a){const r=Math.floor(t.length/2),l=Math.floor(e.length/3);if(r<3||n.length!==r||o.length!==r||l<1||e.length!==l*3)return new Float32Array(0);const f=vs(t,e),d=i&&i.length===r*3?i:Ln(t,n,f,"up"),p=c&&c.length===r*3?c:Ln(t,o,f,"down"),h=[],m=(x,S)=>{h.push(x[0],x[1],x[2],S[0],S[1],S[2])},w=(x,S,y)=>{const A=x[0]+(S[0]-x[0])*y,N=x[1]+(S[1]-x[1])*y,q=x[2]+(S[2]-x[2])*y,_=Math.hypot(A,N,q);return _<=Yt?[0,1,0]:[A/_,N/_,q/_]},P=Yt,v=x=>{const S=[];for(let y=0;y<x.length;y+=1){const A=x[y],N=x[(y+1)%x.length],q=A.thickness>P,_=N.thickness>P;if(q&&_){S.push(N);continue}if(q===_)continue;const Q=N.thickness-A.thickness;if(Math.abs(Q)<=Yt){_&&S.push(N);continue}const J=(P-A.thickness)/Q,Z=A.x+(N.x-A.x)*J,et=A.z+(N.z-A.z)*J,lt=A.yTop+(N.yTop-A.yTop)*J,ft=A.yBottom+(N.yBottom-A.yBottom)*J,rt=.5*(lt+ft);S.push({x:Z,z:et,yTop:rt,yBottom:rt,thickness:0,nTop:w(A.nTop,N.nTop,J),nBottom:w(A.nBottom,N.nBottom,J)}),_&&S.push(N)}return S},M=x=>{if(!(x.length<3)){for(let S=1;S+1<x.length;S+=1){const y=x[0],A=x[S],N=x[S+1];m([y.x,y.yTop,y.z],y.nTop),m([A.x,A.yTop,A.z],A.nTop),m([N.x,N.yTop,N.z],N.nTop)}for(let S=1;S+1<x.length;S+=1){const y=x[0],A=x[S],N=x[S+1];m([y.x,y.yBottom,y.z],y.nBottom),m([N.x,N.yBottom,N.z],N.nBottom),m([A.x,A.yBottom,A.z],A.nBottom)}}},B=(x,S,y)=>{x.thickness<=P&&S.thickness<=P&&y.thickness<=P||M(v([x,S,y]))},T=1e-5,C=new Int32Array(r),g=[],b=new Map;for(let x=0;x<r;x+=1){const S=t[x*2],y=t[x*2+1],A=Math.round(S/T),N=Math.round(y/T),q=`${A},${N}`;let _=b.get(q);_===void 0&&(_=g.length,b.set(q,_),g.push(x)),C[x]=_}const z=a&&a.length>=3?a:e,L=new Map,I=(x,S)=>{const y=x<S?x:S,A=x<S?S:x;return BigInt(y)<<32n|BigInt(A)},E=(x,S,y)=>{const A=I(x,S),N=L.get(A);if(!N){L.set(A,{a:x,b:S,c:y,count:1});return}N.count+=1};for(let x=0;x+2<z.length;x+=3){const S=z[x]|0,y=z[x+1]|0,A=z[x+2]|0;if(S<0||y<0||A<0||S>=r||y>=r||A>=r)continue;const N=C[S],q=C[y],_=C[A],Q=[],J=(Z,et,lt)=>{if(Z===et)return;const ft=I(Z,et);for(const rt of Q)if(rt===ft)return;Q.push(ft),E(Z,et,lt)};J(N,q,_),J(q,_,N),J(_,N,q)}for(let x=0;x<f.length;x+=3){const S=f[x],y=f[x+1],A=f[x+2];if(S<0||y<0||A<0||S>=r||y>=r||A>=r)continue;const N=t[S*2],q=t[S*2+1],_=t[y*2],Q=t[y*2+1],J=t[A*2],Z=t[A*2+1],et={x:N,z:q,yTop:n[S],yBottom:o[S],thickness:n[S]-o[S],nTop:[d[S*3],d[S*3+1],d[S*3+2]],nBottom:[p[S*3],p[S*3+1],p[S*3+2]]},lt={x:_,z:Q,yTop:n[y],yBottom:o[y],thickness:n[y]-o[y],nTop:[d[y*3],d[y*3+1],d[y*3+2]],nBottom:[p[y*3],p[y*3+1],p[y*3+2]]},ft={x:J,z:Z,yTop:n[A],yBottom:o[A],thickness:n[A]-o[A],nTop:[d[A*3],d[A*3+1],d[A*3+2]],nBottom:[p[A*3],p[A*3+1],p[A*3+2]]};B(et,lt,ft)}const F=(x,S)=>{const y=x.thickness>P,A=S.thickness>P;if(y&&A)return[x,S];if(!y&&!A)return[];const N=S.thickness-x.thickness;if(Math.abs(N)<=Yt)return y?[x]:[];const q=(P-x.thickness)/N,_=x.x+(S.x-x.x)*q,Q=x.z+(S.z-x.z)*q,J=x.yTop+(S.yTop-x.yTop)*q,Z=x.yBottom+(S.yBottom-x.yBottom)*q,et={x:_,z:Q,yTop:J,yBottom:Z,thickness:P};return y?[x,et]:[et,S]},j=(x,S,y)=>{const A=[x.x,x.yTop,x.z],N=[S.x,S.yTop,S.z],q=[x.x,x.yBottom,x.z],_=[S.x,S.yBottom,S.z],Q=N[0]-A[0],J=N[1]-A[1],Z=N[2]-A[2],et=_[0]-A[0],lt=_[1]-A[1],ft=_[2]-A[2],rt=J*ft-Z*lt,dt=Z*et-Q*ft,ht=Q*lt-J*et;if(rt*y[0]+dt*y[1]+ht*y[2]>=0){m(A,y),m(N,y),m(_,y),m(A,y),m(_,y),m(q,y);return}m(A,y),m(_,y),m(N,y),m(A,y),m(q,y),m(_,y)},G=.001,Y=1e-4,W=(x,S)=>{for(let y=0;y<f.length;y+=3){const A=f[y],N=f[y+1],q=f[y+2];if(A<0||N<0||q<0||A>=r||N>=r||q>=r)continue;const _=t[A*2],Q=t[A*2+1],J=t[N*2],Z=t[N*2+1],et=t[q*2],lt=t[q*2+1],ft=J-_,rt=Z-Q,dt=et-_,ht=lt-Q,mt=x-_,Mt=S-Q,vt=ft*ht-rt*dt;if(Math.abs(vt)<=Yt)continue;const gt=(mt*ht-Mt*dt)/vt,kt=(ft*Mt-rt*mt)/vt,zt=1-gt-kt;if(zt>=-Yt&&gt>=-Yt&&kt>=-Yt){const jt=n[A]*zt+n[N]*gt+n[q]*kt,Rt=o[A]*zt+o[N]*gt+o[q]*kt;return jt-Rt}}return null};for(const x of L.values()){if(x.count!==1)continue;const S=g[x.a],y=g[x.b],A=g[x.c];if(S===void 0||y===void 0||A===void 0)continue;const N=t[S*2],q=t[S*2+1],_=t[y*2],Q=t[y*2+1],J=.5*(N+_),Z=.5*(q+Q),et=_-N;let ft=Q-q,rt=-et;const dt=Math.hypot(ft,rt);if(dt<=Yt)continue;const ht=[ft/dt,0,rt/dt],mt=W(J+ht[0]*G,Z+ht[2]*G),Mt=W(J-ht[0]*G,Z-ht[2]*G),vt=mt!==null&&mt>Y,gt=Mt!==null&&Mt>Y;if(vt&&gt)continue;const kt=vt?[-ht[0],0,-ht[2]]:ht,zt={x:N,z:q,yTop:n[S],yBottom:o[S],thickness:n[S]-o[S]},jt={x:_,z:Q,yTop:n[y],yBottom:o[y],thickness:n[y]-o[y]},Rt=F(zt,jt);Rt.length===2&&j(Rt[0],Rt[1],kt)}return new Float32Array(h)}function Rn(t,e,n,o,i,c,a,r){const l=Math.floor(e.length/2),f=Math.floor(n.length/3);if(l<3||f<1||e.length!==l*2||n.length!==f*3||o.length!==l||i.length!==l){const w=Dn(t);return{solid:w,wireframe:w,edges:w}}const d=bs(e,n,o,i,c,a,r),p=qe(t,d),h=qe(t,Ms(d)),m=qe(t,gs(d,ys),14);return{solid:p,wireframe:h,edges:m}}function Dn(t){return{vertexBuffer:t.createBuffer({size:4,usage:GPUBufferUsage.VERTEX}),vertexCount:0}}const _t=1e-6;function ws(t){const e=t.worldPath,n=e[0],o=e[e.length-1],i=o[0]-n[0],c=o[1]-n[1],a=Math.hypot(i,c),r=a>_t?i/a:1,l=a>_t?c/a:0,f=Number.isFinite(t.sScale)&&t.sScale>0?t.sScale:t.LWorld&&t.sMaxCad?t.LWorld/t.sMaxCad:1,d=-l,p=r,h=Math.hypot(d,p),m=h>_t?[d/h,0,p/h]:[0,0,1];return{origin:[n[0],n[1]],direction:[r,l],normal:m,sScale:f}}function qn(t,e){const n=t[0]*e.sScale,o=e.origin[0]+e.direction[0]*n,i=e.origin[1]+e.direction[1]*n;return[o,t[1],i]}function Is(t,e,n){const o=[],i=(f,d)=>{o.push(f[0],f[1],f[2],d[0],d[1],d[2])},c=e.normal,a=[-c[0],-c[1],-c[2]];for(const f of n){const d=Ps(f);if(d.length<3)continue;const p=Ts(d);if(p.length===0)continue;const h=d.map(m=>qn(m,e));for(let m=0;m<p.length;m+=3){const w=p[m],P=p[m+1],v=p[m+2],M=h[w],B=h[P],T=h[v];i(M,c),i(B,c),i(T,c),i(M,a),i(T,a),i(B,a)}}const r=new Float32Array(o),l=t.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(l,0,r),{vertexBuffer:l,vertexCount:r.length/6}}function Ps(t){if(t.length<3)return[];const e=[];for(const c of t){const a=e[e.length-1];(!a||Math.hypot(c[0]-a[0],c[1]-a[1])>_t)&&e.push([c[0],c[1]])}if(e.length<3)return[];const n=e[0],o=e[e.length-1];if(Math.hypot(n[0]-o[0],n[1]-o[1])<=_t&&e.pop(),e.length<3)return[];const i=Ss(e);return i.length<3?[]:(zs(i)<0&&i.reverse(),i)}function Ss(t){const e=[],n=t.length;for(let o=0;o<n;o+=1){const i=t[(o-1+n)%n],c=t[o],a=t[(o+1)%n],r=de(i,c,a),l=c[0]-i[0],f=c[1]-i[1],d=a[0]-c[0],p=a[1]-c[1],h=l*d+f*p;Math.abs(r)<_t&&h>0||e.push(c)}return e}function Ts(t){const e=[],n=t.length;if(n<3)return e;const o=Array.from({length:n},(a,r)=>r);let i=0;const c=n*n;for(;o.length>=3&&i<c;){i+=1;let a=!1;for(let r=0;r<o.length;r+=1){const l=o[(r-1+o.length)%o.length],f=o[r],d=o[(r+1)%o.length],p=t[l],h=t[f],m=t[d];if(!Ns(p,h,m))continue;let w=!1;for(let P=0;P<o.length;P+=1){const v=o[P];if(!(v===l||v===f||v===d)&&Cs(t[v],p,h,m)){w=!0;break}}if(!w){e.push(l,f,d),o.splice(r,1),a=!0;break}}if(!a){for(let r=1;r<o.length-1;r+=1)e.push(o[0],o[r],o[r+1]);break}}return e}function de(t,e,n){return(e[0]-t[0])*(n[1]-t[1])-(e[1]-t[1])*(n[0]-t[0])}function zs(t){let e=0;for(let n=0;n<t.length;n+=1){const o=t[n],i=t[(n+1)%t.length];e+=o[0]*i[1]-i[0]*o[1]}return e*.5}function Ns(t,e,n){return de(t,e,n)>_t}function Cs(t,e,n,o){const i=de(e,n,t),c=de(n,o,t),a=de(o,e,t);return i>=-_t&&c>=-_t&&a>=-_t}function Es(t){const e=new Float32Array([-.5,0,-.5,0,1,0,.5,0,.5,0,1,0,.5,0,-.5,0,1,0,-.5,0,-.5,0,1,0,-.5,0,.5,0,1,0,.5,0,.5,0,1,0]),n=t.createBuffer({size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return t.queue.writeBuffer(n,0,e),{vertexBuffer:n,vertexCount:e.length/6}}const We=[.7,.7,.7],ks=[.12,.5,.18],$e=[.18,.9,.2],He={landfill:1,silt:2,clay:3},As=.25,Xe=(t,e,n)=>{let o=n;return o<0?o+=1:o>1&&(o-=1),o<1/6?t+(e-t)*6*o:o<1/2?e:o<2/3?t+(e-t)*(2/3-o)*6:t},Bs=(t,e)=>{const n=t[0],o=t[1],i=t[2],c=Math.max(n,o,i),a=Math.min(n,o,i);let r=0,l=0,f=(c+a)*.5;if(c!==a){const h=c-a;l=f>.5?h/(2-c-a):h/(c+a),c===n?r=(o-i)/h+(o<i?6:0):c===o?r=(i-n)/h+2:r=(n-o)/h+4,r/=6}if(f=Math.min(1,Math.max(0,f+e)),l===0)return[f,f,f];const d=f<.5?f*(1+l):f+l-f*l,p=2*f-d;return[Xe(p,d,r+1/3),Xe(p,d,r),Xe(p,d,r-1/3)]};function Fs(t,e,n){var p;const o=new Map,i=[],c=Qt(),a=Ie(),r={min:[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],max:[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]},l=new Map(n.soils.map(h=>[h.id,h])),f=n.objects.find(h=>h.type==="terrain")??null;let d=!1;if(n.solidsModel){const h=n.solidsModel,m=h.surfaces.terrain;if(m&&Array.isArray(m)){const w=h.mesh,P=Math.floor(w.verticesXZ.length/2);if(P>2&&m.length===P){const v=us(t,w.verticesXZ,m,w.triangles);if(v.vertexCount>0){const M=(f==null?void 0:f.color)??ks,T=[0,1,(f==null?void 0:f.gridScale)??1,0],C=e.createRenderObject((f==null?void 0:f.id)??"terrain",v,c,[M[0],M[1],M[2],1],T,{objectType:"terrain"});i.push(C),d=!0}}}}if((p=n.solidsModel)!=null&&p.sectionCurves)for(const h of n.solidsModel.sectionCurves){if(!h.points||h.points.length<2)continue;const m=ds(t,h.points);if(m.vertexCount===0)continue;const w=[0,0,0,0],P=e.createRenderObject(`curve_${h.id}`,m,c,[$e[0],$e[1],$e[2],1],w,{objectType:"curve"});i.push(P)}for(const h of n.objects){if(h.type!=="terrain"&&h.type!=="marker"||h.type==="terrain"&&d)continue;const m=Ls(t,h,o),w=Vs(h),P=h.soilId?l.get(h.soilId):void 0,v=h.color??(P==null?void 0:P.color)??We,M=h.type==="terrain"?1:h.type==="marker"?2:0,B=h.patternId??(P==null?void 0:P.patternId)??(h.soilId?He[h.soilId]:0)??0,T=M===0?B:0,C=h.gridScale??1,g=[T,M,C,0],b=e.createRenderObject(h.id,m,w,[v[0],v[1],v[2],1],g,{objectType:h.type,soilId:h.soilId});i.push(b),js(r,h)}if(n.solidsModel){const h=n.solidsModel,{extent:m,surfaces:w,solids:P}=h,{verticesXZ:v,triangles:M}=h.mesh,B=Math.floor(v.length/2);let T=0;if(B>2)for(const b of P){const z=w[b.top],L=w[b.bottom];if(!z||!L||z.length!==B||L.length!==B){T+=1;continue}const{solid:I,wireframe:E,edges:F}=Rn(t,v,M,z,L);if(I.vertexCount===0){T+=1;continue}const j=l.get(b.soilId),G=(j==null?void 0:j.color)??We,W=[(j==null?void 0:j.patternId)??He[b.soilId]??0,0,0,0],x=e.createRenderObject(`solid_${b.id}`,I,c,[G[0],G[1],G[2],1],W,{objectType:"solid",soilId:b.soilId,layerIndex:T});if(i.push(x),E.vertexCount>0){const S=[0,2,0,0],y=e.createRenderObject(`solid_${b.id}_wireframe`,E,c,[G[0],G[1],G[2],1],S,{objectType:"solidWireframe",soilId:b.soilId,layerIndex:T});i.push(y)}if(F.vertexCount>0){const S=Bs(G,As),y=[0,2,0,0],A=e.createRenderObject(`solid_${b.id}_edge`,F,c,[S[0],S[1],S[2],1],y,{objectType:"solidEdge",soilId:b.soilId,layerIndex:T});i.push(A)}T+=1}const C=w.terrain,g=C&&Array.isArray(C)&&C.length>0?Gs(C,m.yBase):m.yBase;r.min[0]=Math.min(r.min[0],m.xMin),r.max[0]=Math.max(r.max[0],m.xMax),r.min[2]=Math.min(r.min[2],m.zMin),r.max[2]=Math.max(r.max[2],m.zMax),r.min[1]=Math.min(r.min[1],m.yBase),r.max[1]=Math.max(r.max[1],g)}if(n.sections&&n.sections.length>0){const h=r.min[1],m=r.max[1];for(const w of n.sections)if(w.vector){const P=ws(w.vector);let v=!1;for(const[M,B]of Object.entries(w.vector.patches)){if(!B.rings||B.rings.length===0)continue;const T=Is(t,P,B.rings);if(T.vertexCount===0)continue;const C=l.get(M),g=(C==null?void 0:C.color)??We,z=[(C==null?void 0:C.patternId)??He[M]??0,0,0,0],L=e.createRenderObject(`section_${w.id}_${M}`,T,c,[g[0],g[1],g[2],1],z,{objectType:"section",sectionId:w.id,soilId:M});i.push(L),v=!0}if(v)Os(r,P,w.vector);else{const M=An(t,w.path,h,m),B=[.788,.392,.788],T=[0,2,0,0],C=e.createRenderObject(`section_${w.id}`,M,c,[B[0],B[1],B[2],1],T,{objectType:"section",sectionId:w.id});i.push(C),Vn(r,w,h,m)}}else{const P=An(t,w.path,h,m),v=[.788,.392,.788],M=[0,2,0,0],B=e.createRenderObject(`section_${w.id}`,P,c,[v[0],v[1],v[2],1],M,{objectType:"section",sectionId:w.id});i.push(B),Vn(r,w,h,m)}}if(n.profiles&&n.profiles.length>0){const h=Wn(t,o,"box"),m=.35,w=.08,P=[.43,.91,1];for(const v of n.profiles){const M=v.position.x,B=v.position.y,T=v.position.zGround,C=Math.max(v.depth,.01),g=Qt();Ze(g,a,It(M,T,B),It(m,m,m));const b=Qt();Ze(b,a,It(M,T-C*.5,B),It(w*2,C,w*2));const z=[0,2,0,0],L=e.createRenderObject(`profile_${v.id}_marker`,h,g,[P[0],P[1],P[2],1],z,{objectType:"profile",profileId:v.id}),I=e.createRenderObject(`profile_${v.id}_shaft`,h,b,[P[0],P[1],P[2],1],z,{objectType:"profile",profileId:v.id});i.push(L,I),Us(r,v,m,w)}}return{objects:i,bounds:r,data:n}}function Ls(t,e,n){const o=e.mesh.primitive;return Wn(t,n,o)}function Wn(t,e,n){const o=e.get(n);if(o)return o;let i;return n==="plane"?i=Es(t):i=ls(t),e.set(n,i),i}function Vs(t){const e=t.position??[0,0,0],n=t.rotation??[0,0,0],o=t.scale??[1,1,1],i=t.mesh.size??[1,1,1],c=[o[0]*i[0],o[1]*i[1],o[2]*i[2]],a=Ie();ns(a,n[0],n[1],n[2]);const r=Qt();return Ze(r,a,It(e[0],e[1],e[2]),It(c[0],c[1],c[2])),r}function js(t,e){const n=e.position??[0,0,0],o=e.mesh.size??[1,1,1],i=e.scale??[1,1,1],c=[o[0]*i[0]*.5,o[1]*i[1]*.5,o[2]*i[2]*.5],a=[n[0]-c[0],n[1]-c[1],n[2]-c[2]],r=[n[0]+c[0],n[1]+c[1],n[2]+c[2]];t.min[0]=Math.min(t.min[0],a[0]),t.min[1]=Math.min(t.min[1],a[1]),t.min[2]=Math.min(t.min[2],a[2]),t.max[0]=Math.max(t.max[0],r[0]),t.max[1]=Math.max(t.max[1],r[1]),t.max[2]=Math.max(t.max[2],r[2])}function Vn(t,e,n,o){for(const[i,c]of e.path)t.min[0]=Math.min(t.min[0],i),t.min[2]=Math.min(t.min[2],c),t.max[0]=Math.max(t.max[0],i),t.max[2]=Math.max(t.max[2],c);t.min[1]=Math.min(t.min[1],n),t.max[1]=Math.max(t.max[1],o)}function Os(t,e,n){for(const o of Object.values(n.patches))for(const i of o.rings)for(const c of i){const a=qn([c[0],c[1]],e);t.min[0]=Math.min(t.min[0],a[0]),t.min[1]=Math.min(t.min[1],a[1]),t.min[2]=Math.min(t.min[2],a[2]),t.max[0]=Math.max(t.max[0],a[0]),t.max[1]=Math.max(t.max[1],a[1]),t.max[2]=Math.max(t.max[2],a[2])}}function Us(t,e,n,o){const i=e.position.x,c=e.position.y,a=e.position.zGround,r=Math.max(e.depth,.01),l=n*.5,d=Math.max(l,o);t.min[0]=Math.min(t.min[0],i-d),t.max[0]=Math.max(t.max[0],i+d),t.min[2]=Math.min(t.min[2],c-d),t.max[2]=Math.max(t.max[2],c+d),t.max[1]=Math.max(t.max[1],a+l),t.min[1]=Math.min(t.min[1],a-r)}function Gs(t,e){let n=Number.NEGATIVE_INFINITY;for(const o of t)Number.isFinite(o)&&(n=Math.max(n,o));return Number.isFinite(n)?n:e}const Tt=1e-6,tn=.001,Ke=.001;function $n(t,e,n){return Math.min(Math.max(t,e),n)}function oe(t,e,n,o,i,c){return(n-t)*(c-e)-(o-e)*(i-t)}function Ys(t,e){const n=Math.floor(e.length/3),o=new Int32Array(n*3);for(let i=0;i<n;i+=1){const c=i*3,a=e[c]|0;let r=e[c+1]|0,l=e[c+2]|0;const f=t[a*2],d=t[a*2+1],p=t[r*2],h=t[r*2+1],m=t[l*2],w=t[l*2+1];if(oe(f,d,p,h,m,w)<0){const v=r;r=l,l=v}o[c]=a,o[c+1]=r,o[c+2]=l}return o}function jn(t,e,n,o){const i=Math.floor(t.length/2),c=new Float32Array(i*3);for(let a=0;a<n.length;a+=3){const r=n[a],l=n[a+1],f=n[a+2];if(r<0||l<0||f<0||r>=i||l>=i||f>=i)continue;const d=t[r*2],p=t[r*2+1],h=e[r],m=t[l*2],w=t[l*2+1],P=e[l],v=t[f*2],M=t[f*2+1],B=e[f],T=m-d,C=P-h,g=w-p,b=v-d,z=B-h,L=M-p;let I,E,F;o==="up"?(I=C*L-g*z,E=g*b-T*L,F=T*z-C*b):(I=z*g-L*C,E=L*T-b*g,F=b*C-z*T),c[r*3]+=I,c[r*3+1]+=E,c[r*3+2]+=F,c[l*3]+=I,c[l*3+1]+=E,c[l*3+2]+=F,c[f*3]+=I,c[f*3+1]+=E,c[f*3+2]+=F}for(let a=0;a<i;a+=1){const r=c[a*3],l=c[a*3+1],f=c[a*3+2],d=Math.hypot(r,l,f);if(d<=Tt){c[a*3]=0,c[a*3+1]=o==="up"?1:-1,c[a*3+2]=0;continue}c[a*3]=r/d,c[a*3+1]=l/d,c[a*3+2]=f/d}return c}const _s=t=>{const e=Math.hypot(t[0],t[1],t[2]);return e<=Tt?[0,1,0]:[t[0]/e,t[1]/e,t[2]/e]},On=(t,e,n)=>_s([t[0]+(e[0]-t[0])*n,t[1]+(e[1]-t[1])*n,t[2]+(e[2]-t[2])*n]);function Rs(t,e,n,o,i,c){const a=n.length;if(a===0)return{verticesXZ:[],triangles:[],top:[],bottom:[]};const r=new Int32Array(a),l=[],f=[],d=[],p=[],h=[],m=new Map,w=(g,b)=>i==="x"?Math.abs(g-c)<=tn:Math.abs(b-c)<=tn,P=(g,b)=>`${g},${b}`,v=g=>Math.floor(g/Ke);for(let g=0;g<a;g+=1){const b=t[g*2],z=t[g*2+1];if(!w(b,z)){const j=d.length;l.push(b),f.push(z),d.push(n[g]),p.push(o[g]),h.push(1),r[g]=j;continue}const L=v(b),I=v(z);let E=-1;const F=Ke*Ke;for(let j=-1;j<=1&&E===-1;j+=1)for(let G=-1;G<=1&&E===-1;G+=1){const Y=m.get(P(L+j,I+G));if(Y)for(const W of Y){const x=l[W]/h[W],S=f[W]/h[W];if((b-x)*(b-x)+(z-S)*(z-S)<=F){E=W;break}}}if(E===-1){E=d.length,l.push(b),f.push(z),d.push(n[g]),p.push(o[g]),h.push(1);const j=P(L,I),G=m.get(j);G?G.push(E):m.set(j,[E])}else l[E]+=b,f[E]+=z,d[E]+=n[g],p[E]+=o[g],h[E]+=1;r[g]=E}const M=new Array(l.length*2),B=new Array(d.length),T=new Array(p.length);for(let g=0;g<d.length;g+=1){const b=1/h[g];M[g*2]=l[g]*b,M[g*2+1]=f[g]*b,B[g]=d[g]*b,T[g]=p[g]*b}const C=[];for(let g=0;g+2<e.length;g+=3){const b=r[e[g]],z=r[e[g+1]],L=r[e[g+2]];if(b===z||z===L||L===b)continue;const I=M[b*2],E=M[b*2+1],F=M[z*2],j=M[z*2+1],G=M[L*2],Y=M[L*2+1],W=oe(I,E,F,j,G,Y);Math.abs(W)<=Tt||C.push(b,z,L)}return{verticesXZ:M,triangles:C,top:B,bottom:T}}function Pe(t,e,n,o,i,c,a){const r=Math.floor(t.length/2),l=Math.floor(e.length/3);if(r<3||l<1||t.length!==r*2||e.length!==l*3||n.length!==r||o.length!==r)return{verticesXZ:[],triangles:[],top:[],bottom:[]};const f=[],d=[],p=[],h=[],m=new Int32Array(r);m.fill(-1);const w=new Map,P=z=>Math.abs(z-c)<=tn?c:z,v=z=>P(i==="x"?t[z*2]:t[z*2+1]),M=z=>{const L=v(z);return a==="max"?L<=c+Tt:L>=c-Tt},B=(z,L)=>{const I=z<L?z:L,E=z<L?L:z;return BigInt(I)<<32n|BigInt(E)},T=z=>{const L=m[z];if(L!==-1)return L;const I=d.length;m[z]=I;let E=t[z*2],F=t[z*2+1];return i==="x"?E=P(E):F=P(F),f.push(E,F),d.push(n[z]),p.push(o[z]),I},C=(z,L)=>{const I=v(z),E=v(L);if(Math.abs(I-c)<=Tt)return T(z);if(Math.abs(E-c)<=Tt)return T(L);const F=B(z,L),j=w.get(F);if(j!==void 0)return j;const G=t[z*2],Y=t[z*2+1],W=t[L*2],x=t[L*2+1],S=n[z],y=o[z],A=n[L],N=o[L],q=E-I,_=Math.abs(q)<=Tt?0:$n((c-I)/q,0,1);let Q=G+(W-G)*_,J=Y+(x-Y)*_;i==="x"?Q=c:J=c;const Z=S+(A-S)*_,et=y+(N-y)*_,lt=d.length;return w.set(F,lt),f.push(Q,J),d.push(Z),p.push(et),lt},g=(z,L,I)=>{if(z===L||L===I||I===z)return;const E=f[z*2],F=f[z*2+1],j=f[L*2],G=f[L*2+1],Y=f[I*2],W=f[I*2+1],x=oe(E,F,j,G,Y,W);Math.abs(x)<=Tt||h.push(z,L,I)},b=(z,L,I)=>{const E=[M(z),M(L),M(I)];if(!E[0]&&!E[1]&&!E[2])return;if(E[0]&&E[1]&&E[2]){g(T(z),T(L),T(I));return}const F=[],j=[z,L,I];for(let Y=0;Y<3;Y+=1){const W=j[Y],x=j[(Y+1)%3],S=E[Y],y=E[(Y+1)%3];S&&y?F.push(T(x)):S&&!y?F.push(C(W,x)):!S&&y&&(F.push(C(W,x)),F.push(T(x)))}if(F.length<3)return;const G=F[0];for(let Y=1;Y+1<F.length;Y+=1)g(G,F[Y],F[Y+1])};for(let z=0;z<l;z+=1){const L=z*3,I=e[L]|0,E=e[L+1]|0,F=e[L+2]|0;I<0||E<0||F<0||I>=r||E>=r||F>=r||b(I,E,F)}return Rs(f,h,d,p,i,c)}function Ds(t,e,n,o,i,c){const a=Math.floor(t.length/2),r=Math.floor(e.length/3);if(a<3||r<1||t.length!==a*2||e.length!==r*3||n.length!==a||o.length!==a)return{verticesXZ:[],triangles:[],top:[],bottom:[]};let l={verticesXZ:t,triangles:e,top:n,bottom:o};return i<Number.POSITIVE_INFINITY&&(l=Pe(l.verticesXZ,l.triangles,l.top,l.bottom,"x",i,"max")),c<Number.POSITIVE_INFINITY&&(l=Pe(l.verticesXZ,l.triangles,l.top,l.bottom,"z",c,"max")),l}function qs(t,e,n,o,i,c=Number.NEGATIVE_INFINITY){const a=Math.floor(t.length/2),r=Math.floor(e.length/3);if(a<3||r<1||t.length!==a*2||e.length!==r*3||n.length!==a||o.length!==a)return{verticesXZ:[],triangles:[],top:[],bottom:[]};let l={verticesXZ:t,triangles:e,top:n,bottom:o};return i>Number.NEGATIVE_INFINITY&&(l=Pe(l.verticesXZ,l.triangles,l.top,l.bottom,"x",i,"min")),c>Number.NEGATIVE_INFINITY&&(l=Pe(l.verticesXZ,l.triangles,l.top,l.bottom,"z",c,"min")),l}function Ws(t,e,n,o,i){const c=Math.floor(t.length/2),a=Math.floor(e.length/3);if(c<3||a<1||t.length!==c*2||e.length!==a*3||n.length!==c||o.length!==c)return{verticesXZ:[],triangles:[],boundaryTriangles:[],top:[],bottom:[],topNormals:[],bottomNormals:[]};const r=Ys(t,e),l=jn(t,n,r,"up"),f=jn(t,o,r,"down"),d=1e-5,p=1e-4,h=(I,E)=>{const F=Math.round(I.x/d),j=Math.round(I.z/d),G=Math.round(I.top/d),Y=Math.round(I.bottom/d),W=Math.round(I.nTop[0]/p),x=Math.round(I.nTop[1]/p),S=Math.round(I.nTop[2]/p),y=Math.round(I.nBottom[0]/p),A=Math.round(I.nBottom[1]/p),N=Math.round(I.nBottom[2]/p);return`${F},${j},${G},${Y},${W},${x},${S},${y},${A},${N}${E?"|cap":""}`},m=[],w=[],P=[],v=[],M=[],B=[],T=[],C=new Map,g=(I,E)=>{const F=h(I,E),j=C.get(F);if(j!==void 0)return j;const G=w.length;return C.set(F,G),m.push(I.x,I.z),w.push(I.top),P.push(I.bottom),v.push(I.nTop[0],I.nTop[1],I.nTop[2]),M.push(I.nBottom[0],I.nBottom[1],I.nBottom[2]),G},b=(I,E,F,j,G)=>{if(j){let y=oe(I.x,I.z,E.x,E.z,F.x,F.z);if(y<0){const Q=E;E=F,F=Q,y=-y}const A=[0,-1,0];if(I={...I,nTop:A},E={...E,nTop:A},F={...F,nTop:A},Math.abs(y)<=Tt)return;const N=g(I,j),q=g(E,j),_=g(F,j);if(T.push(N,q,_),N===q||q===_||_===N)return;B.push(N,q,_);return}let Y=oe(I.x,I.z,E.x,E.z,F.x,F.z);if(G!==0&&Y*G<0){const y=E;E=F,F=y,Y=-Y}const W=g(I,j),x=g(E,j),S=g(F,j);T.push(W,x,S),!(W===x||x===S||S===W)&&(Math.abs(Y)<=Tt||B.push(W,x,S))},z=I=>I.top>i?{...I,top:i}:I,L=(I,E)=>{const F=E.top-I.top;if(Math.abs(F)<=Tt)return{...I,top:i};const j=$n((i-I.top)/F,0,1);return{x:I.x+(E.x-I.x)*j,z:I.z+(E.z-I.z)*j,top:i,bottom:I.bottom+(E.bottom-I.bottom)*j,nTop:On(I.nTop,E.nTop,j),nBottom:On(I.nBottom,E.nBottom,j)}};for(let I=0;I<a;I+=1){const E=I*3,F=e[E]|0,j=e[E+1]|0,G=e[E+2]|0;if(F<0||j<0||G<0||F>=c||j>=c||G>=c)continue;const Y={x:t[F*2],z:t[F*2+1],top:n[F],bottom:o[F],nTop:[l[F*3],l[F*3+1],l[F*3+2]],nBottom:[f[F*3],f[F*3+1],f[F*3+2]]},W={x:t[j*2],z:t[j*2+1],top:n[j],bottom:o[j],nTop:[l[j*3],l[j*3+1],l[j*3+2]],nBottom:[f[j*3],f[j*3+1],f[j*3+2]]},x={x:t[G*2],z:t[G*2+1],top:n[G],bottom:o[G],nTop:[l[G*3],l[G*3+1],l[G*3+2]],nBottom:[f[G*3],f[G*3+1],f[G*3+2]]},S=oe(Y.x,Y.z,W.x,W.z,x.x,x.z),y=S===0?0:Math.sign(S),A=Y.top>i+Tt,N=W.top>i+Tt,q=x.top>i+Tt,_=(A?1:0)+(N?1:0)+(q?1:0);if(_===0){b(Y,W,x,!1,y);continue}if(_===3){b(z(Y),z(W),z(x),!0,y);continue}if(_===1){let dt=Y,ht=W,mt=x;N?(dt=W,ht=x,mt=Y):q&&(dt=x,ht=Y,mt=W);const Mt=L(dt,ht),vt=L(dt,mt),gt=z(dt);b(ht,mt,Mt,!1,y),b(mt,vt,Mt,!1,y),b(gt,Mt,vt,!0,y);continue}let Q=Y,J=W,Z=x;N?q||(Q=x,J=Y,Z=W):(Q=W,J=x,Z=Y);const et=L(J,Q),lt=L(Z,Q),ft=z(J),rt=z(Z);b(Q,et,lt,!1,y),b(ft,rt,lt,!0,y),b(ft,lt,et,!0,y)}return{verticesXZ:m,triangles:B,boundaryTriangles:T,top:w,bottom:P,topNormals:v,bottomNormals:M}}const qt=t=>-t;function $s(t){return t.map(e=>({...e,worldPath:e.worldPath.map(([n,o])=>[n,qt(o)])}))}function Hs(t){if(t.objects)for(const e of t.objects)e.position&&(e.position=[e.position[0],e.position[1],qt(e.position[2])]);if(t.sections&&(t.sections=t.sections.map(e=>({...e,path:e.path.map(([n,o])=>[n,qt(o)])}))),t.profiles)for(const e of t.profiles)e.position.y=qt(e.position.y)}function Xs(t){const e=t.extent.zMin,n=t.extent.zMax;if(t.extent.zMin=qt(n),t.extent.zMax=qt(e),t.sectionCurves)for(const c of t.sectionCurves)for(const a of c.points)a[2]=qt(a[2]);if(t.solidOutlines)for(const c of Object.values(t.solidOutlines.bySolid))for(const a of c)for(let r=2;r<a.length;r+=3)a[r]=qt(a[r]);const{verticesXZ:o,triangles:i}=t.mesh;for(let c=1;c<o.length;c+=2)o[c]=qt(o[c]);for(let c=0;c+2<i.length;c+=3){const a=i[c+1];i[c+1]=i[c+2],i[c+2]=a}}const Ks=[{id:"s1",name:"Geological Section No. 1",sourceDxf:"sections/section_1.dxf",worldPath:[[.01,4.25],[19.99,2.13]],LWorld:20.09215767407771,sMaxCad:20.09,sScale:1.0001074004020762,zRef:5,zBase:-5.55,interfaces:{terrain:[[0,0],[.98,.47],[2.07,.99],[2.97,1.41],[4.32,2],[4.5,2.07],[5.74,2.55],[7.03,3],[8.1,3.26],[9.18,3.49],[10.32,3.73],[11.32,3.91],[12.18,4.06],[13.06,4.19],[13.55,4.25],[13.93,4.3],[15.06,4.44],[16.02,4.54],[18.34,4.79],[19.22,4.89],[20.09,5]],base:[[0,-5.55],[20.09,-5.55]],landfillBase:[[0,-1.19],[1.01,-.91],[2.01,-.54],[3.01,-.16],[4.02,.22],[5.04,.57],[6.07,.9],[7.1,1.2],[8.09,1.48],[9.12,1.78],[10.06,2.04],[11.06,2.26],[12.09,2.42],[13.13,2.53],[14.17,2.6],[15.22,2.67],[16.26,2.74],[17.54,2.83],[18.81,2.9],[20.09,2.95]],siltClay:[[0,-2.23],[1.01,-1.87],[2.01,-1.44],[3.05,-1.09],[5.18,-.49],[6.13,-.15],[7.03,.28],[8.04,.98],[9.03,1.72],[9.12,1.78]]},patches:{landfill:{rings:[[[1.01,-.91],[2.01,-.54],[3.01,-.16],[4.02,.22],[5.04,.57],[6.07,.9],[7.1,1.2],[8.09,1.48],[9.12,1.78],[10.06,2.04],[11.06,2.26],[12.09,2.42],[13.13,2.53],[14.17,2.6],[15.22,2.67],[16.26,2.74],[17.54,2.83],[18.81,2.9],[20.09,2.95],[20.09,5],[19.22,4.89],[18.34,4.79],[16.02,4.54],[15.06,4.44],[13.93,4.3],[13.55,4.25],[13.06,4.19],[12.18,4.06],[11.32,3.91],[10.32,3.73],[9.18,3.49],[8.1,3.26],[7.03,3],[5.74,2.55],[4.5,2.07],[4.32,2],[2.97,1.41],[2.07,.99],[.98,.47],[0,0],[0,-1.19]]]},clay:{rings:[[[20.09,-5.55],[20.09,2.95],[18.81,2.9],[17.54,2.83],[16.26,2.74],[15.22,2.67],[14.17,2.6],[13.13,2.53],[12.09,2.42],[11.06,2.26],[10.06,2.04],[9.12,1.78],[9.03,1.72],[8.04,.98],[7.03,.28],[6.13,-.15],[5.18,-.49],[3.05,-1.09],[2.01,-1.44],[1.01,-1.87],[0,-2.23],[0,-5.55]]]},silt:{rings:[[[1.01,-1.87],[2.01,-1.44],[3.05,-1.09],[5.18,-.49],[6.13,-.15],[7.03,.28],[8.04,.98],[9.03,1.72],[9.12,1.78],[8.09,1.48],[7.1,1.2],[6.07,.9],[5.04,.57],[4.02,.22],[3.01,-.16],[2.01,-.54],[1.01,-.91],[0,-1.19],[0,-2.23]]]}}},{id:"s2",name:"Section 2",sourceDxf:"sections/section_2.dxf",worldPath:[[2.11,9.68],[1.91,.43]],LWorld:9.25216190952147,sMaxCad:9.25,sScale:1.0002337199482672,zRef:.97,zBase:-5.55,interfaces:{terrain:[[0,.97],[.59,.95],[1.27,.94],[1.5,.94],[2.41,.94],[2.64,.94],[3.3,.95],[4.56,.95],[5.59,.95],[6.63,.94],[7.65,.92],[8.64,.9],[9.25,.88]],base:[[0,-5.55],[9.25,-5.55]],landfillBase:[[0,-.3],[.03,-.25],[.12,-.29],[.17,-.32],[1.26,-.36],[1.65,-.37],[2.35,-.4],[2.76,-.43],[3.45,-.46],[4.04,-.47],[4.55,-.52],[5.59,-.55],[5.68,-.54],[6.56,-.54],[7.68,-.55],[8.06,-.56],[8.68,-.58],[9.25,-.61]],siltClay:[[0,-1.7],[.03,-1.64],[.12,-1.68],[.17,-1.7],[.33,-1.7],[1.26,-1.67],[1.65,-1.64],[2.36,-1.6],[2.76,-1.59],[3.45,-1.55],[4.03,-1.5],[4.55,-1.5],[5.59,-1.45],[5.64,-1.45],[5.68,-1.45],[5.71,-1.45],[6.41,-1.47],[6.81,-1.49],[7.17,-1.52],[7.77,-1.56],[9.25,-1.67]]},patches:{landfill:{rings:[[[.03,-.25],[.12,-.29],[.17,-.32],[1.26,-.36],[1.65,-.37],[2.35,-.4],[2.76,-.43],[3.45,-.46],[4.04,-.47],[4.55,-.52],[5.59,-.55],[5.68,-.54],[6.56,-.54],[7.68,-.55],[8.06,-.56],[8.68,-.58],[9.25,-.61],[9.25,.88],[8.64,.9],[7.65,.92],[6.63,.94],[5.59,.95],[4.56,.95],[3.3,.95],[2.64,.94],[2.41,.94],[1.5,.94],[1.27,.94],[.59,.95],[0,.97],[0,-.3]]]},clay:{rings:[[[9.25,-5.55],[9.25,-1.67],[7.77,-1.56],[7.17,-1.52],[6.81,-1.49],[6.41,-1.47],[5.71,-1.45],[5.68,-1.45],[5.64,-1.45],[5.59,-1.45],[4.55,-1.5],[4.03,-1.5],[3.45,-1.55],[2.76,-1.59],[2.36,-1.6],[1.65,-1.64],[1.26,-1.67],[.33,-1.7],[.17,-1.7],[.12,-1.68],[.03,-1.64],[0,-1.7],[0,-5.55]]]},silt:{rings:[[[.03,-1.64],[.12,-1.68],[.17,-1.7],[.33,-1.7],[1.26,-1.67],[1.65,-1.64],[2.36,-1.6],[2.76,-1.59],[3.45,-1.55],[4.03,-1.5],[4.55,-1.5],[5.59,-1.45],[5.64,-1.45],[5.68,-1.45],[5.71,-1.45],[6.41,-1.47],[6.81,-1.49],[7.17,-1.52],[7.77,-1.56],[9.25,-1.67],[9.25,-.61],[8.68,-.58],[8.06,-.56],[7.68,-.55],[6.56,-.54],[5.68,-.54],[5.59,-.55],[4.55,-.52],[4.04,-.47],[3.45,-.46],[2.76,-.43],[2.35,-.4],[1.65,-.37],[1.26,-.36],[.17,-.32],[.12,-.29],[.03,-.25],[0,-.3],[0,-1.7]]]}}},{id:"s3",name:"Section 3",sourceDxf:"sections/section_3.dxf",worldPath:[[15.29,.45],[15.63,9.53]],LWorld:9.086363408977213,sMaxCad:9.09,sScale:.9995999349809915,zRef:4.48,zBase:-5.55,interfaces:{terrain:[[0,4.43],[.69,4.45],[1.83,4.48],[2.64,4.48],[2.95,4.48],[3.82,4.48],[4.98,4.47],[6.25,4.44],[6.46,4.43],[7.32,4.42],[7.96,4.42],[8.44,4.42],[9.09,4.44]],base:[[0,-5.55],[9.09,-5.55]],landfillClay:[[0,2.58],[.39,2.6],[1.86,2.65],[2.17,2.68],[3.71,2.75],[3.78,2.75],[4.96,2.76],[6.13,2.73],[7.3,2.58],[7.63,2.54],[8.38,2.43],[8.58,2.4],[9.09,2.31]]},patches:{landfill:{rings:[[[.39,2.6],[1.86,2.65],[2.17,2.68],[3.71,2.75],[3.78,2.75],[4.96,2.76],[6.13,2.73],[7.3,2.58],[7.63,2.54],[8.38,2.43],[8.58,2.4],[9.09,2.31],[9.09,4.44],[8.44,4.42],[7.96,4.42],[7.32,4.42],[6.46,4.43],[6.25,4.44],[4.98,4.47],[3.82,4.48],[2.95,4.48],[2.64,4.48],[1.83,4.48],[.69,4.45],[0,4.43],[0,2.58]]]},clay:{rings:[[[9.09,-5.55],[9.09,2.31],[8.58,2.4],[8.38,2.43],[7.63,2.54],[7.3,2.58],[6.13,2.73],[4.96,2.76],[3.78,2.75],[3.71,2.75],[2.17,2.68],[1.86,2.65],[.39,2.6],[0,2.58],[0,-5.55]]]}}},{id:"s4",name:"Section 4",sourceDxf:"sections/section_4.dxf",worldPath:[[.2,9.81],[19.72,9.72]],LWorld:19.52020747840555,sMaxCad:19.52,sScale:1.0000106290166777,zRef:4.96,zBase:-5.55,interfaces:{terrain:[[0,.09],[.72,.41],[.94,.51],[1.95,.99],[2.72,1.35],[3.72,1.82],[3.97,1.93],[4.73,2.26],[4.98,2.36],[5.76,2.66],[6.54,2.91],[6.8,3],[7.64,3.22],[7.87,3.28],[8.71,3.47],[8.94,3.52],[9.79,3.68],[10.03,3.73],[10.88,3.87],[11.13,3.9],[11.98,4.03],[12.23,4.06],[13.34,4.2],[14.46,4.33],[15.3,4.43],[15.57,4.46],[16.41,4.56],[16.69,4.59],[17.52,4.69],[17.71,4.71],[18.16,4.77],[18.8,4.86],[19.52,4.96]],base:[[0,-5.55],[19.52,-5.55]],landfillBase:[[0,-1.27],[.83,-.86],[.9,-.81],[1.45,-.6],[1.93,-.49],[2.4,-.37],[3.09,-.22],[3.55,-.03],[4.05,.08],[4.71,.19],[4.9,.23],[5.12,.24],[5.78,.2],[6.8,.25],[6.93,.28],[7.76,.44],[8.03,.49],[9.12,.73],[9.94,.92],[10.21,.99],[10.39,1.03],[11.03,1.19],[11.3,1.26],[12.11,1.47],[12.39,1.54],[13.2,1.74],[13.49,1.81],[14.28,2.01],[14.58,2.07],[15.37,2.26],[15.67,2.32],[16.46,2.49],[16.67,2.52],[17.51,2.68],[17.69,2.7],[18.13,2.76],[18.78,2.86],[19.44,2.93],[19.52,2.94]],siltClay:[[0,-2.65],[.82,-2.24],[.88,-2.2],[1.45,-2],[1.94,-1.92],[2.42,-1.83],[3.12,-1.72],[3.58,-1.54],[4.1,-1.44],[4.74,-1.37],[5.02,-1.3],[5.45,-1.28],[5.82,-1.31],[5.87,-1.3],[6.72,-1.17],[6.79,-1.15],[6.86,-1.11],[7.62,-.75],[7.85,-.62],[8.58,-.21],[8.81,-.06],[9.51,.4],[9.74,.56],[10.39,1.03]]},patches:{landfill:{rings:[[[.83,-.86],[.9,-.81],[1.45,-.6],[1.93,-.49],[2.4,-.37],[3.09,-.22],[3.55,-.03],[4.05,.08],[4.71,.19],[4.9,.23],[5.12,.24],[5.78,.2],[6.8,.25],[6.93,.28],[7.76,.44],[8.03,.49],[9.12,.73],[9.94,.92],[10.21,.99],[10.39,1.03],[11.03,1.19],[11.3,1.26],[12.11,1.47],[12.39,1.54],[13.2,1.74],[13.49,1.81],[14.28,2.01],[14.58,2.07],[15.37,2.26],[15.67,2.32],[16.46,2.49],[16.67,2.52],[17.51,2.68],[17.69,2.7],[18.13,2.76],[18.78,2.86],[19.44,2.93],[19.52,2.94],[19.52,4.96],[18.8,4.86],[18.16,4.77],[17.71,4.71],[17.52,4.69],[16.69,4.59],[16.41,4.56],[15.57,4.46],[15.3,4.43],[14.46,4.33],[13.34,4.2],[12.23,4.06],[11.98,4.03],[11.13,3.9],[10.88,3.87],[10.03,3.73],[9.79,3.68],[8.94,3.52],[8.71,3.47],[7.87,3.28],[7.64,3.22],[6.8,3],[6.54,2.91],[5.76,2.66],[4.98,2.36],[4.73,2.26],[3.97,1.93],[3.72,1.82],[2.72,1.35],[1.95,.99],[.94,.51],[.72,.41],[0,.09],[0,-1.27]]]},clay:{rings:[[[19.52,-5.55],[19.52,2.94],[19.44,2.93],[18.78,2.86],[18.13,2.76],[17.69,2.7],[17.51,2.68],[16.67,2.52],[16.46,2.49],[15.67,2.32],[15.37,2.26],[14.58,2.07],[14.28,2.01],[13.49,1.81],[13.2,1.74],[12.39,1.54],[12.11,1.47],[11.3,1.26],[11.03,1.19],[10.39,1.03],[9.74,.56],[9.51,.4],[8.81,-.06],[8.58,-.21],[7.85,-.62],[7.62,-.75],[6.86,-1.11],[6.79,-1.15],[6.72,-1.17],[5.87,-1.3],[5.82,-1.31],[5.45,-1.28],[5.02,-1.3],[4.74,-1.37],[4.1,-1.44],[3.58,-1.54],[3.12,-1.72],[2.42,-1.83],[1.94,-1.92],[1.45,-2],[.88,-2.2],[.82,-2.24],[0,-2.65],[0,-5.55]]]},silt:{rings:[[[.82,-2.24],[.88,-2.2],[1.45,-2],[1.94,-1.92],[2.42,-1.83],[3.12,-1.72],[3.58,-1.54],[4.1,-1.44],[4.74,-1.37],[5.02,-1.3],[5.45,-1.28],[5.82,-1.31],[5.87,-1.3],[6.72,-1.17],[6.79,-1.15],[6.86,-1.11],[7.62,-.75],[7.85,-.62],[8.58,-.21],[8.81,-.06],[9.51,.4],[9.74,.56],[10.39,1.03],[10.21,.99],[9.94,.92],[9.12,.73],[8.03,.49],[7.76,.44],[6.93,.28],[6.8,.25],[5.78,.2],[5.12,.24],[4.9,.23],[4.71,.19],[4.05,.08],[3.55,-.03],[3.09,-.22],[2.4,-.37],[1.93,-.49],[1.45,-.6],[.9,-.81],[.83,-.86],[0,-1.27],[0,-2.65]]]}}}],Qs={sections:Ks},Se=1e-6,Un=new WeakMap;function Js(t,e,n){const o=t.path;if(o.length<2)return null;const[i,c]=o[0],[a,r]=o[o.length-1],l=a-i,f=r-c,d=Math.hypot(l,f);if(!Number.isFinite(d)||d<=Se)return null;const p=l/d,h=f/d,m=e.surfaces,w=ti(e),P=w.avgEdgeLength,v=Math.max(.01,P),M=Math.max(2,Math.floor(d/v)+1),B=new Map,T=(G,Y,W)=>{const x=B.get(G)??m[G];return x?(B.set(G,x),ni(w,x,Y,W)):0},C=[],g=[],b=Object.create(null),z=new Set;for(const G of e.solids)z.add(G.top),z.add(G.bottom);const L=Array.from(z);for(const G of L)b[G]=[];for(let G=0;G<M;G+=1){const Y=G/(M-1)*d,W=i+p*Y,x=c+h*Y;C.push(Y);const S=T("terrain",W,x);g.push(S);for(const y of L)b[y].push(T(y,W,x))}const I=Math.max(...g),E=[];let F=Number.POSITIVE_INFINITY,j=Number.NEGATIVE_INFINITY;for(const G of e.solids){const Y=b[G.top],W=b[G.bottom];if(!Y||!W)continue;let x=0;for(let y=0;y<Y.length;y+=1)x=Math.max(x,Y[y]-W[y]);if(x<=Se)continue;const S=[];for(let y=0;y<M;y+=1){const A=I-Y[y];F=Math.min(F,A),j=Math.max(j,A),S.push({s:C[y],d:A})}for(let y=M-1;y>=0;y-=1){const A=I-W[y];F=Math.min(F,A),j=Math.max(j,A),S.push({s:C[y],d:A})}E.push({soilId:G.soilId,rings:[S]})}return!Number.isFinite(F)||E.length===0?null:{minS:0,maxS:d,minD:F,maxD:j,zRef:I,patches:E}}function Zs(t,e){const n=Math.floor(t.length/2),o=Math.floor(e.length/3);if(n<3||o<1)return .25;const i=Math.min(o,200),c=Math.max(1,Math.floor(o/i));let a=0,r=0;for(let f=0;f<o;f+=c){const d=f*3,p=e[d]|0,h=e[d+1]|0,m=e[d+2]|0;p<0||h<0||m<0||p>=n||h>=n||m>=n||(a+=Qe(t,p,h),a+=Qe(t,h,m),a+=Qe(t,m,p),r+=3)}const l=r>0?a/r:.25;return Number.isFinite(l)&&l>0?l:.25}function Qe(t,e,n){const o=t[e*2],i=t[e*2+1],c=t[n*2],a=t[n*2+1];return Math.hypot(c-o,a-i)}function Gn(t,e,n){return Math.max(e,Math.min(n,t))}function Te(t,e,n){return Math.max(e,Math.min(n,t))}function ti(t){const e=Un.get(t);if(e)return e;const n=ei(t);return Un.set(t,n),n}function ei(t){const{extent:e,mesh:n}=t,{verticesXZ:o,triangles:i}=n,c=Math.floor(o.length/2),a=Math.floor(i.length/3);if(c<3||a<1||o.length!==c*2||i.length!==a*3){const N=new Int32Array(2);return{xMin:e.xMin,xMax:e.xMax,zMin:e.zMin,zMax:e.zMax,cellSize:Math.max(.01,e.xMax-e.xMin,e.zMax-e.zMin),nx:1,nz:1,offsets:N,indices:new Int32Array(0),ia:new Int32Array(0),ib:new Int32Array(0),ic:new Int32Array(0),ax:new Float32Array(0),az:new Float32Array(0),v0x:new Float32Array(0),v0z:new Float32Array(0),v1x:new Float32Array(0),v1z:new Float32Array(0),invDenom:new Float32Array(0),avgEdgeLength:.25}}const r=e.xMin,l=e.xMax,f=e.zMin,d=e.zMax,p=Math.max(Se,l-r),h=Math.max(Se,d-f),m=Zs(o,i),w=Math.max(p,h)/128,P=Math.max(.05,w,m),v=Math.max(1,Math.ceil(p/P)),M=Math.max(1,Math.ceil(h/P)),B=v*M,T=new Int32Array(a),C=new Int32Array(a),g=new Int32Array(a),b=new Float32Array(a),z=new Float32Array(a),L=new Float32Array(a),I=new Float32Array(a),E=new Float32Array(a),F=new Float32Array(a),j=new Float32Array(a),G=new Int32Array(B),Y=N=>Te(Math.floor((N-r)/P),0,v-1),W=N=>Te(Math.floor((N-f)/P),0,M-1);for(let N=0;N<a;N+=1){const q=N*3,_=i[q]|0,Q=i[q+1]|0,J=i[q+2]|0;if(_<0||Q<0||J<0||_>=c||Q>=c||J>=c){T[N]=-1,C[N]=-1,g[N]=-1,j[N]=0;continue}T[N]=_,C[N]=Q,g[N]=J;const Z=o[_*2],et=o[_*2+1],lt=o[Q*2],ft=o[Q*2+1],rt=o[J*2],dt=o[J*2+1];b[N]=Z,z[N]=et;const ht=lt-Z,mt=ft-et,Mt=rt-Z,vt=dt-et;L[N]=ht,I[N]=mt,E[N]=Mt,F[N]=vt;const gt=ht*vt-mt*Mt;j[N]=Math.abs(gt)<=1e-12?0:1/gt;const kt=Math.min(Z,lt,rt),zt=Math.max(Z,lt,rt),jt=Math.min(et,ft,dt),Rt=Math.max(et,ft,dt),ze=Y(kt),Kt=Y(zt),Ne=W(jt),Ce=W(Rt);for(let se=Ne;se<=Ce;se+=1){const ot=se*v;for(let ie=ze;ie<=Kt;ie+=1)G[ot+ie]+=1}}const x=new Int32Array(B+1);for(let N=0;N<B;N+=1)x[N+1]=x[N]+G[N];const S=x[B],y=new Int32Array(S),A=new Int32Array(x);for(let N=0;N<a;N+=1){if(T[N]<0)continue;const q=b[N],_=z[N],Q=q+L[N],J=_+I[N],Z=q+E[N],et=_+F[N],lt=Math.min(q,Q,Z),ft=Math.max(q,Q,Z),rt=Math.min(_,J,et),dt=Math.max(_,J,et),ht=Y(lt),mt=Y(ft),Mt=W(rt),vt=W(dt);for(let gt=Mt;gt<=vt;gt+=1){const kt=gt*v;for(let zt=ht;zt<=mt;zt+=1){const jt=kt+zt;y[A[jt]++]=N}}}return{xMin:r,xMax:l,zMin:f,zMax:d,cellSize:P,nx:v,nz:M,offsets:x,indices:y,ia:T,ib:C,ic:g,ax:b,az:z,v0x:L,v0z:I,v1x:E,v1z:F,invDenom:j,avgEdgeLength:m}}function ni(t,e,n,o){if(e.length===0||t.ia.length===0)return 0;const i=Gn(n,t.xMin,t.xMax),c=Gn(o,t.zMin,t.zMax),a=Te(Math.floor((i-t.xMin)/t.cellSize),0,t.nx-1),l=Te(Math.floor((c-t.zMin)/t.cellSize),0,t.nz-1)*t.nx+a,f=t.offsets[l],d=t.offsets[l+1];for(let p=f;p<d;p+=1){const h=t.indices[p],m=t.invDenom[h];if(m===0)continue;const w=i-t.ax[h],P=c-t.az[h],v=(w*t.v1z[h]-P*t.v1x[h])*m,M=(t.v0x[h]*P-t.v0z[h]*w)*m,B=1-v-M;if(B>=-1e-9&&v>=-1e-9&&M>=-1e-9){const T=t.ia[h],C=t.ib[h],g=t.ic[h];return e[T]*B+e[C]*v+e[g]*M}}for(let p=0;p<t.ia.length;p+=1){const h=t.invDenom[p];if(h===0)continue;const m=i-t.ax[p],w=c-t.az[p],P=(m*t.v1z[p]-w*t.v1x[p])*h,v=(t.v0x[p]*w-t.v0z[p]*m)*h,M=1-P-v;if(M>=-1e-9&&P>=-1e-9&&v>=-1e-9){const B=t.ia[p],T=t.ib[p],C=t.ic[p];return e[B]*M+e[T]*P+e[C]*v}}return 0}const be=document.querySelector("#gfx"),Je=document.querySelector("#message"),ee={target:[12.308137893676758,-2.078213691711426,-.03483019769191742],yaw:2.59007353266014,pitch:.3322148625050682,distance:34.27910453694887,orthoScale:14.198870005209317,mode:"perspective"};function Hn(t){Je&&(Je.textContent=t,Je.classList.add("visible"))}function oi(t){t.mode=ee.mode,t.orthoScale=ee.orthoScale,t.distance=ee.distance,t.setAngles(ee.yaw,ee.pitch),ne(t.target,...ee.target)}async function si(t){try{const e=await fetch(t);if(!e.ok)return null;const n=await e.json();return!n||n.version!==2?null:n}catch{return null}}async function ii(){if(!be)throw new Error("Canvas element not found.");if(!navigator.gpu){Hn("WebGPU is not supported in this browser.");return}const{device:t,context:e,format:n}=await Oo(be),o=new cs(be,t,e,n),i=new os;new ss(be,i);const a=await as("./scene.json"),r=await si("./solids_model_v2.json");Hs(a),r&&(Xs(r),a.solidsModel=r);const l=Qs.sections??[],f=$s(l);if(f.length>0){const m=new Map(f.map(v=>[v.id,v])),w=[],P=new Set;if(a.sections)for(const v of a.sections){const M=m.get(v.id),B=v.path.length>0?v.path:(M==null?void 0:M.worldPath)??[];w.push({...v,path:B,vector:M}),P.add(v.id)}for(const v of f)P.has(v.id)||w.push({id:v.id,name:v.name,path:v.worldPath,vector:v});a.sections=w}const d=Fs(t,o,a);o.setObjects(d.objects);const p=()=>{o.resize();const{width:m,height:w}=o.getSize();i.setAspect(m/w)};p(),oi(i),ri(t,a,d.objects,o,i,d.bounds),document.body.classList.add("ready"),window.addEventListener("resize",p);const h=()=>{o.render(i),requestAnimationFrame(h)};requestAnimationFrame(h)}function ri(t,e,n,o,i,c){const a=document.querySelector("#panel");if(!a)return;const r=document.querySelector("#panel-toggle"),l=document.querySelector("#panel-body"),f=Array.from(document.querySelectorAll("input[name='theme']")),d=document.querySelector("#toggle-terrain"),p=document.querySelector("#toggle-grid"),h=document.querySelector("#toggle-sections"),m=document.querySelector("#toggle-profiles"),w=document.querySelector("#toggle-solids"),P=Array.from(document.querySelectorAll("input[name='solids-visibility']")),v=document.querySelector("#toggle-solids-edges"),M=document.querySelector("#fit-view"),B=document.querySelector("#toggle-projection"),T=Array.from(document.querySelectorAll("input[name='mode']")),C=Array.from(document.querySelectorAll(".panel-views button")),g=document.querySelector("#section-list"),b=document.querySelector("#profile-list"),z=document.querySelector("#solid-list"),L=document.querySelector("#solids-spacing"),I=document.querySelector("#solids-spacing-value"),E=document.querySelector("#solids-clip-x"),F=document.querySelector("#solids-clip-x-value"),j=document.querySelector("#solids-clip-y"),G=document.querySelector("#solids-clip-y-value"),Y=document.querySelector("#solids-clip-z"),W=document.querySelector("#solids-clip-z-value"),x=document.querySelector("#sections-controls"),S=document.querySelector("#profiles-controls"),y=document.querySelector("#solids-controls"),A=document.querySelector("#gfx"),N=document.querySelector("#section-detail"),q=document.querySelector("#section-title"),_=document.querySelector("#section-canvas"),Q=document.querySelector("#section-close"),J=d==null?void 0:d.closest("label"),Z=p==null?void 0:p.closest("label");if(!d||!p||!h||!m||!w||P.length===0||!v||!M||!B||!r||!l||f.length===0||T.length===0||!g||!b||!z||!L||!I||!E||!F||!j||!G||!Y||!W||!x||!S||!y||!N||!q||!_||!Q||!J||!Z)return;const et=s=>{a.classList.toggle("panel--collapsed",s),r.setAttribute("aria-expanded",s?"false":"true")},lt=()=>{window.matchMedia("(max-width: 720px)").matches||et(!1)};r.addEventListener("click",()=>{et(!a.classList.contains("panel--collapsed"))}),window.addEventListener("resize",lt),lt(),document.addEventListener("pointerdown",s=>{if(!window.matchMedia("(max-width: 720px)").matches||a.classList.contains("panel--collapsed"))return;const u=s.target;u instanceof Node&&a.contains(u)||et(!0)}),z.style.visibility="hidden";const ft={dark:{clearColor:{r:21/255,g:21/255,b:21/255,a:1},sectionCanvasBg:"#111",sectionAxis:"rgba(255, 255, 255, 0.35)",sectionAxisTick:"rgba(255, 255, 255, 0.08)",sectionText:"rgba(230, 230, 230, 0.7)",sectionEmptyText:"#ccc",sectionHatch:"rgba(0, 0, 0, 0.85)",sectionPatchStroke:"rgba(0, 0, 0, 0.55)"},light:{clearColor:{r:1,g:1,b:1,a:1},sectionCanvasBg:"#fff",sectionAxis:"rgba(0, 0, 0, 0.35)",sectionAxisTick:"rgba(0, 0, 0, 0.08)",sectionText:"rgba(20, 20, 20, 0.7)",sectionEmptyText:"#333",sectionHatch:"rgba(0, 0, 0, 0.7)",sectionPatchStroke:"rgba(0, 0, 0, 0.35)"}};let rt=ft.dark,dt="dark";const ht=()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return"dark";try{return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}catch{return"dark"}},mt=()=>{var u;return((u=f.find(k=>k.checked))==null?void 0:u.value)==="light"?"light":"dark"},Mt=s=>{document.documentElement.dataset.theme=s,dt=s,rt=ft[s],o.setClearColor(rt.clearColor),Ge()},vt=()=>{var u;return((u=T.find(k=>k.checked))==null?void 0:u.value)==="solids"?"solids":"sections"},gt=()=>{var u;const s=(u=P.find(k=>k.checked))==null?void 0:u.value;return s==="wireframe"||s==="transparent"||s==="classic"?s:"classic"},kt=s=>{const u=Number.parseFloat(L.max);return Number.isFinite(u)?Math.min(Math.max(0,s),u):Math.max(0,s)},zt=()=>{const s=Number.parseFloat(L.value);return Number.isFinite(s)?kt(s):0},jt=s=>{const u=kt(s);L.value=u.toString(),U.solids.verticalSpacing=u,pn()},Rt=N,ze=q,Kt=_,Ne=Q,Ce=new Map(e.soils.map(s=>[s.id,s])),se=new Map((e.sections??[]).map(s=>[s.id,s])),ot=e.solidsModel??null,ie=new Set(((ot==null?void 0:ot.solids)??[]).map(s=>s.soilId)),Ee=new Map;for(const s of n)s.objectType!=="solid"||!s.soilId||Ee.set(s.soilId,s.layerIndex);let ke=0;for(const s of Ee.values())ke=Math.max(ke,s);const Pt=ot?{xMin:ot.extent.xMin,xMax:ot.extent.xMax,yMin:c.min[1],yMax:c.max[1],zMin:ot.extent.zMin,zMax:ot.extent.zMax}:{xMin:c.min[0],xMax:c.max[0],yMin:c.min[1],yMax:c.max[1],zMin:c.min[2],zMax:c.max[2]},Ot={xMin:Pt.xMin,yMax:Pt.yMax,zMax:Pt.zMax},U={mode:vt(),visibility:{terrain:!0,grid:!0,sections:!0,profiles:!0,solids:!0},solids:{enabled:ie,verticalSpacing:zt(),displayMode:gt(),highlightEdges:v.checked,crop:{...Ot}},selectedSectionId:null,selectedProfileId:null};document.body.dataset.mode=U.mode;const he=s=>`${s.toFixed(2)} m`,Xn=(s,u)=>{const k=Math.abs(u-s),V=.01;return!Number.isFinite(k)||k<=0?V:Math.max(V,k/400)},Ae=(s,u,k,V,O)=>{s.min=k.toString(),s.max=V.toString(),s.step=Xn(k,V).toString(),s.value=O.toString(),u.textContent=he(O)};Ae(E,F,Pt.xMin,Pt.xMax,Ot.xMin),Ae(j,G,Pt.yMin,Pt.yMax,Ot.yMax),Ae(Y,W,Pt.zMin,Pt.zMax,Ot.zMax);const nn=s=>Math.min(Math.max(Pt.xMin,s),Pt.xMax),on=s=>Math.min(Math.max(Pt.yMin,s),Pt.yMax),sn=s=>Math.min(Math.max(Pt.zMin,s),Pt.zMax),Kn=()=>{const s=Number.parseFloat(E.value);return Number.isFinite(s)?nn(s):Ot.xMin},Qn=()=>{const s=Number.parseFloat(j.value);return Number.isFinite(s)?on(s):Ot.yMax},Jn=()=>{const s=Number.parseFloat(Y.value);return Number.isFinite(s)?sn(s):Ot.zMax},Zn=s=>{const u=nn(s);E.value=u.toString(),U.solids.crop.xMin=u,me()},to=s=>{const u=on(s);j.value=u.toString(),U.solids.crop.yMax=u,me()},eo=s=>{const u=sn(s);Y.value=u.toString(),U.solids.crop.zMax=u,me()},re=new Map,ue=new Map;for(const s of n){if(s.objectType!=="solid"&&s.objectType!=="solidWireframe"&&s.objectType!=="solidEdge"||(re.set(s.id,s.mesh),!s.soilId))continue;const u=ue.get(s.soilId)??{};s.objectType==="solid"?u.solid=s:s.objectType==="solidEdge"?u.edges=s:u.wireframe=s,ue.set(s.soilId,u)}const Jt=(s,u)=>{const k=re.get(s.id);k&&s.mesh!==k&&s.mesh.vertexBuffer.destroy(),s.mesh=u},no=()=>{for(const s of ue.values()){if(s.solid){const u=re.get(s.solid.id);u&&Jt(s.solid,u)}if(s.wireframe){const u=re.get(s.wireframe.id);u&&Jt(s.wireframe,u)}if(s.edges){const u=re.get(s.edges.id);u&&Jt(s.edges,u)}}};let rn="";const Be=()=>{if(!ot)return;const s=U.solids.crop.xMin,u=U.solids.crop.yMax,k=U.solids.crop.zMax,V=`${s.toFixed(5)}|${u.toFixed(5)}|${k.toFixed(5)}`;if(V===rn)return;rn=V;const O=s>Ot.xMin+1e-4,R=k<Ot.zMax-1e-4,$=O||R,X=u<Ot.yMax-1e-4;if(!$&&!X){no();return}const{verticesXZ:K,triangles:ct}=ot.mesh,at=Math.floor(K.length/2);for(const st of ot.solids){const nt=ue.get(st.soilId);if(!(nt!=null&&nt.solid)&&!(nt!=null&&nt.wireframe)&&!(nt!=null&&nt.edges))continue;const ut=ot.surfaces[st.top],D=ot.surfaces[st.bottom];if(!ut||!D||ut.length!==at||D.length!==at)continue;let tt=K,it=ct,yt=ut,bt=D,Ut,Ft,At;if($){if(O){const xt=qs(tt,it,yt,bt,s);tt=xt.verticesXZ,it=xt.triangles,yt=xt.top,bt=xt.bottom}if(R){const xt=Ds(tt,it,yt,bt,Number.POSITIVE_INFINITY,k);tt=xt.verticesXZ,it=xt.triangles,yt=xt.top,bt=xt.bottom}}if(X){const xt=Ws(tt,it,yt,bt,u);tt=xt.verticesXZ,it=xt.triangles,At=xt.boundaryTriangles,yt=xt.top,bt=xt.bottom,Ut=xt.topNormals,Ft=xt.bottomNormals}const Nt=Rn(t,tt,it,yt,bt,Ut,Ft,At);nt.solid&&Jt(nt.solid,Nt.solid),nt.wireframe&&Jt(nt.wireframe,Nt.wireframe),nt.edges&&Jt(nt.edges,Nt.edges)}},Fe=(s,u,k)=>[s[0]+(u[0]-s[0])*k,s[1]+(u[1]-s[1])*k,s[2]+(u[2]-s[2])*k,s[3]+(u[3]-s[3])*k],oo=3,so=.35,io=.4,ro=.6,co=.35,ao=.2,lo=s=>{const u=Fe(s,[1,1,1,s[3]],so);return[u[0],u[1],u[2],io]},fo=(s,u)=>{u==="transparent"?(s.color=lo(s.baseColor),s.material=[0,oo,s.baseMaterial[2],s.baseMaterial[3]]):(s.color=[...s.baseColor],s.material=[...s.baseMaterial])},ho=(s,u)=>{if(u==="transparent"){const k=dt==="light"?[0,0,0,s.baseColor[3]]:[1,1,1,s.baseColor[3]],V=dt==="light"?co:ao,O=Fe(s.baseColor,k,V);s.color=[O[0],O[1],O[2],ro]}else s.color=s.baseColor},Le=()=>({min:[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],max:[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]}),Zt=(s,u)=>{s.min[0]=Math.min(s.min[0],u.min[0]),s.min[1]=Math.min(s.min[1],u.min[1]),s.min[2]=Math.min(s.min[2],u.min[2]),s.max[0]=Math.max(s.max[0],u.max[0]),s.max[1]=Math.max(s.max[1],u.max[1]),s.max[2]=Math.max(s.max[2],u.max[2])},uo=s=>Number.isFinite(s.min[0])&&Number.isFinite(s.min[1])&&Number.isFinite(s.min[2])&&Number.isFinite(s.max[0])&&Number.isFinite(s.max[1])&&Number.isFinite(s.max[2]),po=()=>{if(ot){const $=pe.get("terrain");if($)return{min:[ot.extent.xMin,$.min,ot.extent.zMin],max:[ot.extent.xMax,$.max,ot.extent.zMax]}}const s=e.objects.find($=>$.type==="terrain");if(!s)return null;const u=s.position??[0,0,0],k=s.scale??[1,1,1],V=s.mesh.size??[1,1,1],O=[k[0]*V[0],k[1]*V[1],k[2]*V[2]],R=[Math.abs(O[0])*.5,Math.abs(O[1])*.5,Math.abs(O[2])*.5];return{min:[u[0]-R[0],u[1]-R[1],u[2]-R[2]],max:[u[0]+R[0],u[1]+R[1],u[2]+R[2]]}},mo=()=>{const s=e.sections??[];if(s.length===0)return null;let u=Number.POSITIVE_INFINITY,k=Number.NEGATIVE_INFINITY,V=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,R=!1;for(const $ of s)for(const X of $.path??[])u=Math.min(u,X[0]),k=Math.max(k,X[0]),V=Math.min(V,X[1]),O=Math.max(O,X[1]),R=!0;return R?{min:[u,c.min[1],V],max:[k,c.max[1],O]}:null},xo=()=>{const s=e.profiles??[];if(s.length===0)return null;const k=.35*.5,V=.08,O=Le();let R=!1;for(const $ of s){const X=$.position.x,K=$.position.y,ct=$.position.zGround,at=Math.max($.depth,.01),st=Math.max(k,V),nt={min:[X-st,ct-at,K-st],max:[X+st,ct+k,K+st]};Zt(O,nt),R=!0}return R?O:null},go=s=>{if(s.length===0)return null;let u=Number.POSITIVE_INFINITY,k=Number.NEGATIVE_INFINITY;for(const V of s)Number.isFinite(V)&&(u=Math.min(u,V),k=Math.max(k,V));return!Number.isFinite(u)||!Number.isFinite(k)?null:{min:u,max:k}},pe=new Map;if(ot)for(const[s,u]of Object.entries(ot.surfaces)){const k=go(u);k&&pe.set(s,k)}const cn=new Map;if(ot){const{extent:s}=ot;for(const u of ot.solids){const k=pe.get(u.top),V=pe.get(u.bottom),O=(V==null?void 0:V.min)??s.yBase,R=(k==null?void 0:k.max)??c.max[1];cn.set(u.soilId,{min:[s.xMin,O,s.zMin],max:[s.xMax,R,s.zMax]})}}const an=po(),ln=mo(),fn=xo(),dn=(s,u)=>{if(!Number.isFinite(u)||u===0)return 0;const k=ke*.5;return-(s-k)*u},yo=s=>{if(!ot)return null;const u=Le();let k=!1;for(const V of ot.solids){if(!U.solids.enabled.has(V.soilId))continue;const O=cn.get(V.soilId);if(!O)continue;const R=Ee.get(V.soilId)??0,$=dn(R,s),X=Math.max(O.min[0],U.solids.crop.xMin),K=O.min[1],ct=O.min[2],at=O.max[0],st=Math.min(O.max[1],U.solids.crop.yMax),nt=Math.min(O.max[2],U.solids.crop.zMax);at<X||st<K||nt<ct||(Zt(u,{min:[X,K+$,ct],max:[at,st+$,nt]}),k=!0)}return k?u:null},Mo=()=>{if(!A)return{fracX:1,fracY:1,centerNdcX:0,centerNdcY:0};const s=Math.max(1,A.clientWidth),u=Math.max(1,A.clientHeight),k=16;if(window.matchMedia("(max-width: 720px)").matches)return{fracX:1,fracY:1,centerNdcX:0,centerNdcY:0};const O=A.getBoundingClientRect(),R=a.getBoundingClientRect(),$=R.left-O.left,X=R.right-O.left,K=R.top-O.top,ct=R.bottom-O.top,at=R.width>0&&R.height>0&&X>=0&&$<=s&&ct>=0&&K<=u,st=k,nt=s-k,ut=k,D=u-k;let tt=nt,it=ut;at&&(tt=Math.min(nt,Math.max(st+1,$-k))),it>=D&&(it=ut);const yt=Math.max(1,tt-st),bt=Math.max(1,D-it),Ut=st+yt*.5,Ft=it+bt*.5;return{fracX:yt/s,fracY:bt/u,centerNdcX:2*Ut/s-1,centerNdcY:1-2*Ft/u}},Ve=()=>{const s=Le();if(U.visibility.terrain&&an&&Zt(s,an),U.mode==="sections")U.visibility.sections&&ln&&Zt(s,ln),U.visibility.profiles&&fn&&Zt(s,fn);else if(U.visibility.solids){const u=yo(U.solids.verticalSpacing);u&&Zt(s,u)}return uo(s)?s:c},je=s=>{const u=Mo(),k=Math.max(.05,Math.min(1,u.fracX)),V=Math.max(.05,Math.min(1,u.fracY)),O=1.1,R=(s.min[0]+s.max[0])*.5,$=(s.min[1]+s.max[1])*.5,X=(s.min[2]+s.max[2])*.5,K=s.max[0]-s.min[0],ct=s.max[1]-s.min[1],at=s.max[2]-s.min[2],st=.5*Math.hypot(K,ct,at)*O;if(!Number.isFinite(st)||st<=0){ne(i.target,R,$,X);return}ne(i.target,R,$,X);const nt=i.fov*.5,ut=Math.tan(nt),D=It(-Math.cos(i.pitch)*Math.cos(i.yaw),-Math.sin(i.pitch),-Math.cos(i.pitch)*Math.sin(i.yaw));Vt(D,D);const tt=wt();Wt(tt,D,It(0,1,0)),Yn(tt)<1e-6?ne(tt,1,0,0):Vt(tt,tt);const it=wt();Wt(it,tt,D),Vt(it,it);const yt=[[s.min[0],s.min[1],s.min[2]],[s.min[0],s.min[1],s.max[2]],[s.min[0],s.max[1],s.min[2]],[s.min[0],s.max[1],s.max[2]],[s.max[0],s.min[1],s.min[2]],[s.max[0],s.min[1],s.max[2]],[s.max[0],s.max[1],s.min[2]],[s.max[0],s.max[1],s.max[2]]];if(i.mode==="perspective"){const St=Math.max(1e-4,ut*i.aspect*k),Ct=Math.max(1e-4,ut*V);let Gt=.2;const Lt=wt();for(const Et of yt){ne(Lt,Et[0]-R,Et[1]-$,Et[2]-X);const $t=Dt(Lt,tt),Ht=Dt(Lt,it),ve=Dt(Lt,D),_e=Math.abs($t)*O/St-ve,Lo=Math.abs(Ht)*O/Ct-ve;Gt=Math.max(Gt,_e,Lo)}i.distance=Math.min(200,Math.max(.2,Gt))}else{let St=.2;const Ct=wt(),Gt=Math.max(1e-4,k*i.aspect),Lt=Math.max(1e-4,V);for(const Et of yt){ne(Ct,Et[0]-R,Et[1]-$,Et[2]-X);const $t=Dt(Ct,tt),Ht=Dt(Ct,it),ve=Math.abs($t)*O/Gt,_e=Math.abs(Ht)*O/Lt;St=Math.max(St,ve,_e)}i.orthoScale=Math.min(200,Math.max(.2,St)),i.distance=i.orthoScale/Math.max(1e-4,ut)}let bt=Number.POSITIVE_INFINITY,Ut=Number.NEGATIVE_INFINITY,Ft=Number.POSITIVE_INFINITY,At=Number.NEGATIVE_INFINITY,Nt=0,xt=0,Mn=0,vn=0;const xe=wt();fe(xe,i.target,D,-i.distance);for(const St of yt){const Ct=It(St[0]-xe[0],St[1]-xe[1],St[2]-xe[2]),Gt=Dt(Ct,tt),Lt=Dt(Ct,it),Et=Math.max(1e-4,Dt(Ct,D)),$t=i.mode==="perspective"?Gt/(Et*ut*i.aspect):Gt/(i.orthoScale*i.aspect),Ht=i.mode==="perspective"?Lt/(Et*ut):Lt/i.orthoScale;$t<bt&&(bt=$t,Nt=Et),$t>Ut&&(Ut=$t,xt=Et),Ht<Ft&&(Ft=Ht,Mn=Et),Ht>At&&(At=Ht,vn=Et)}const ko=(bt+Ut)*.5,Ao=(Ft+At)*.5,bn=u.centerNdcX-ko,wn=u.centerNdcY-Ao;let ge=0,ye=0;if(i.mode==="perspective"){const St=1/Math.max(1e-4,Nt)+1/Math.max(1e-4,xt),Ct=1/Math.max(1e-4,Mn)+1/Math.max(1e-4,vn),Gt=St>1e-6?2/St:i.distance,Lt=Ct>1e-6?2/Ct:i.distance;ge=-bn*(ut*i.aspect)*Gt,ye=-wn*ut*Lt}else{const St=i.orthoScale,Ct=St*i.aspect;ge=-bn*Ct,ye=-wn*St}if(Math.abs(ge)<1e-4&&Math.abs(ye)<1e-4)return;const Bo=i.getPosition(),ae=wt();en(ae,i.target,Bo),Vt(ae,ae);const Fo=It(0,1,0),le=wt();Wt(le,ae,Fo),Vt(le,le);const Me=wt();Wt(Me,le,ae),Vt(Me,Me),fe(i.target,i.target,le,ge),fe(i.target,i.target,Me,ye)},Oe=new Map,vo=new Map,bo=new Map;let wo=1;const hn=(s,u)=>{const k=s==="section"?vo:bo,V=k.get(u);if(V)return V;const O=wo++;return k.set(u,O),Oe.set(O,{type:s,id:u}),O},un=()=>{B.textContent=i.mode==="perspective"?"Perspective":"Orthographic"},pn=()=>{I.textContent=`${U.solids.verticalSpacing.toFixed(2)} m`},me=()=>{F.textContent=he(U.solids.crop.xMin),G.textContent=he(U.solids.crop.yMax),W.textContent=he(U.solids.crop.zMax)},te={terrain:d.checked,grid:p.checked,sections:h.checked},mn=s=>{s?(te.terrain=d.checked,te.grid=p.checked,te.sections=h.checked,d.checked=!1,p.checked=!1,h.checked=!1,U.visibility.terrain=!1,U.visibility.grid=!1,U.visibility.sections=!1,d.disabled=!0,p.disabled=!0,h.disabled=!0):(d.disabled=!1,p.disabled=!1,h.disabled=!1,d.checked=te.terrain,p.checked=te.grid,h.checked=te.sections,U.visibility.terrain=d.checked,U.visibility.grid=p.checked,U.visibility.sections=h.checked)},pt=()=>{const s=U.mode==="sections",u=U.mode==="solids",k=s&&U.visibility.sections,V=U.visibility.sections,O=s&&U.visibility.profiles,R=u&&U.visibility.solids,$=U.solids.displayMode,X=R&&$==="wireframe",K=R&&U.solids.highlightEdges,ct=u?U.solids.verticalSpacing:0;J.style.display=u?"none":"",Z.style.display=u?"none":"",x.style.display=u?"none":"",S.style.display=s?"":"none",y.style.display=u?"":"none";const at=s?k:!!ot;g.style.opacity=at?"1":"0.6",g.querySelectorAll("input[type='radio']").forEach(D=>{D.disabled=!at}),b.style.opacity=O?"1":"0.6",b.querySelectorAll("input[type='radio']").forEach(D=>{D.disabled=!O}),z.style.opacity=R?"1":"0.6",z.querySelectorAll("input[type='checkbox']").forEach(D=>{D.disabled=!R});const st=[.678,1,.184,1],nt=[.43,.91,1,1],ut=[.678,1,.184,1];for(const D of n)if(D.objectType==="terrain"){const tt=U.visibility.terrain,it=U.visibility.grid;D.visible=tt||it,D.material[2]=it?D.baseMaterial[2]:0,D.material[3]=tt?0:it?1:0}else if(D.objectType==="curve")D.visible=V;else if(D.objectType==="section"){D.visible=k;const tt=U.selectedSectionId&&D.sectionId===U.selectedSectionId;D.color=tt?Fe(D.baseColor,st,.45):D.baseColor}else if(D.objectType==="profile"){D.visible=O;const tt=U.selectedProfileId&&D.profileId===U.selectedProfileId;D.color=tt?ut:nt}else if(D.objectType==="solid"||D.objectType==="solidWireframe"||D.objectType==="solidEdge"){const tt=D.soilId?U.solids.enabled.has(D.soilId):!0;D.objectType==="solid"?fo(D,$):D.objectType==="solidEdge"&&ho(D,$);const it=R&&$!=="wireframe";D.visible=(D.objectType==="solidWireframe"?X:D.objectType==="solidEdge"?K:it)&&tt,D.objectType==="solidEdge"&&(D.edgeXray=X),Yo(D.modelMatrix,D.baseMatrix),D.modelMatrix[13]+=dn(D.layerIndex,ct)}else D.visible=!0;Ge()},Io={front:()=>({yaw:Math.PI/2,pitch:0}),back:()=>({yaw:-Math.PI/2,pitch:0}),left:()=>({yaw:Math.PI,pitch:0}),right:()=>({yaw:0,pitch:0}),top:()=>({yaw:i.yaw,pitch:Math.PI/2}),bottom:()=>({yaw:i.yaw,pitch:-Math.PI/2})};for(const s of C)s.addEventListener("click",()=>{const u=s.dataset.view??"",k=Io[u];if(!k)return;const{yaw:V,pitch:O}=k();i.setAngles(V,O),je(Ve())});const Po=()=>{U.mode=vt(),document.body.dataset.mode=U.mode,mn(U.mode==="solids"),U.mode==="sections"&&jt(0),pt()};for(const s of T)s.addEventListener("change",Po);d.addEventListener("change",()=>{U.visibility.terrain=d.checked,pt()}),p.addEventListener("change",()=>{U.visibility.grid=p.checked,pt()}),h.addEventListener("change",()=>{U.visibility.sections=h.checked,pt()}),m.addEventListener("change",()=>{U.visibility.profiles=m.checked,pt()}),w.addEventListener("change",()=>{U.visibility.solids=w.checked,pt()});for(const s of P)s.addEventListener("change",()=>{s.checked&&(U.solids.displayMode=gt(),pt())});v.addEventListener("change",()=>{U.solids.highlightEdges=v.checked,pt()}),L.addEventListener("input",()=>{jt(zt()),pt()}),E.addEventListener("input",()=>{Zn(Kn()),Be(),pt()}),j.addEventListener("input",()=>{to(Qn()),Be(),pt()}),Y.addEventListener("input",()=>{eo(Jn()),Be(),pt()}),M.addEventListener("click",()=>{je(Ve())}),B.addEventListener("click",()=>{i.toggleProjection(),un()}),g.innerHTML="";const xn=new Map;if(e.sections&&e.sections.length>0)for(const s of e.sections){const u=document.createElement("label");u.className="panel-option";const k=document.createElement("input");k.type="radio",k.name="section-select",xn.set(s.id,k),k.addEventListener("change",()=>{k.checked&&(U.selectedSectionId=s.id,pt())}),u.appendChild(k),u.appendChild(document.createTextNode(s.name)),g.appendChild(u)}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No sections loaded",g.appendChild(s)}b.innerHTML="";const gn=new Map;let ce=null;if(e.profiles&&e.profiles.length>0){const s=document.createElement("label");s.className="panel-option";const u=document.createElement("input");u.type="radio",u.name="profile-select",u.checked=!0,u.addEventListener("change",()=>{u.checked&&(U.selectedProfileId=null,pt())}),s.appendChild(u),s.appendChild(document.createTextNode("None")),b.appendChild(s),ce=u;for(const k of e.profiles){const V=document.createElement("label");V.className="panel-option";const O=document.createElement("input");O.type="radio",O.name="profile-select",gn.set(k.id,O),O.addEventListener("change",()=>{O.checked&&(U.selectedProfileId=k.id,pt())}),V.appendChild(O),V.appendChild(document.createTextNode(k.name)),b.appendChild(V)}}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No profiles loaded",b.appendChild(s)}const Ue=new Map;if(z.querySelectorAll("input[type='checkbox'][data-soil-id]").forEach(s=>{const u=s.dataset.soilId;u&&Ue.set(u,s)}),ot&&ot.solids.length>0){U.solids.enabled.clear();for(const s of ot.solids){let u=Ue.get(s.soilId);if(!u){const k=document.createElement("label");k.className="panel-option",u=document.createElement("input"),u.type="checkbox",u.checked=!0,u.dataset.soilId=s.soilId,Ue.set(s.soilId,u),k.appendChild(u),k.appendChild(document.createTextNode(s.name)),z.appendChild(k)}u.checked&&U.solids.enabled.add(s.soilId),u.addEventListener("change",()=>{u.checked?U.solids.enabled.add(s.soilId):U.solids.enabled.delete(s.soilId),pt()})}z.style.visibility="",w.disabled=!1,P.forEach(s=>{s.disabled=!1}),v.disabled=!1,L.disabled=!1,E.disabled=!1,j.disabled=!1,Y.disabled=!1}else{const s=document.createElement("div");s.className="panel-option",s.textContent="No solids model loaded",z.appendChild(s),z.querySelectorAll("input[type='checkbox']").forEach(u=>{u.disabled=!0}),z.style.visibility="",w.checked=!1,w.disabled=!0,P.forEach(u=>{u.disabled=!0,u.value==="classic"&&(u.checked=!0)}),v.checked=!1,v.disabled=!0,L.disabled=!0,E.disabled=!0,j.disabled=!0,Y.disabled=!0,U.visibility.solids=!1}pn(),me();const So=ht(),yn=f.find(s=>s.value===So);yn&&(yn.checked=!0),Mt(mt());for(const s of f)s.addEventListener("change",()=>{s.checked&&(Mt(mt()),pt())});un(),mn(U.mode==="solids"),pt(),je(Ve());for(const s of n)s.objectType==="section"&&s.sectionId?s.pickId=hn("section",s.sectionId):s.objectType==="profile"&&s.profileId?s.pickId=hn("profile",s.profileId):s.pickId=0;A&&A.addEventListener("click",async s=>{if(s.button!==0||U.mode==="solids")return;const u=A.getBoundingClientRect(),k=s.clientX-u.left,V=s.clientY-u.top,O=await o.pick(k,V);if(!O||!Oe.has(O)){ce&&(ce.checked=!0),U.selectedSectionId=null,U.selectedProfileId=null,pt();return}const R=Oe.get(O);if(R){if(R.type==="section"){U.selectedSectionId=R.id,U.selectedProfileId=null;const $=xn.get(R.id);$&&($.checked=!0),ce&&(ce.checked=!0),h.checked||(h.checked=!0,U.visibility.sections=!0)}else if(R.type==="profile"){U.selectedProfileId=R.id,U.selectedSectionId=null;const $=gn.get(R.id);$&&($.checked=!0),m.checked||(m.checked=!0,U.visibility.profiles=!0)}pt()}}),Ne.addEventListener("click",()=>{U.selectedSectionId=null,pt()}),window.addEventListener("resize",()=>{Ge()});function Ge(){const s=U.selectedSectionId,u=!!(s&&(U.mode==="sections"&&U.visibility.sections||U.mode==="solids"&&ot));if(Rt.classList.toggle("visible",!!u),!u||!s)return;const k=se.get(s);if(!k)return;ze.textContent=k.name;const V=Kt.getContext("2d");if(!V)return;const O=window.devicePixelRatio||1,R=Math.max(1,Kt.clientWidth),$=Math.max(1,Kt.clientHeight);Kt.width=Math.floor(R*O),Kt.height=Math.floor($*O),V.setTransform(O,0,0,O,0,0),V.clearRect(0,0,R,$),V.fillStyle=rt.sectionCanvasBg,V.fillRect(0,0,R,$);const X=U.mode==="solids"?ot?Js(k,ot):null:k.vector?To(k.vector):null;if(!X||X.patches.length===0){V.fillStyle=rt.sectionEmptyText,V.font="12px IBM Plex Sans, sans-serif",V.fillText("No polygons available for this section.",16,24);return}const K={left:50,right:20,top:24,bottom:28},ct=Math.max(1,R-K.left-K.right),at=Math.max(1,$-K.top-K.bottom),st=ct/Math.max(X.maxS-X.minS,.01),nt=at/Math.max(X.maxD-X.minD,.01),ut=tt=>K.left+(tt-X.minS)*st,D=tt=>K.top+(tt-X.minD)*nt;V.strokeStyle=rt.sectionAxis,V.lineWidth=1,V.beginPath(),V.moveTo(K.left,K.top),V.lineTo(K.left,K.top+at),V.lineTo(K.left+ct,K.top+at),V.stroke(),zo(V,K.left,K.top,at,X.minD,X.maxD,rt);for(const tt of X.patches){const it=Ce.get(tt.soilId),yt=(it==null?void 0:it.color)??[.6,.6,.6],bt=(it==null?void 0:it.patternId)??0,Ut=`rgb(${Math.round(yt[0]*255)}, ${Math.round(yt[1]*255)}, ${Math.round(yt[2]*255)})`;for(const Ft of tt.rings){if(Ft.length===0)continue;const At=Ft.map(Nt=>({x:ut(Nt.s),y:D(Nt.d)}));V.beginPath(),V.moveTo(At[0].x,At[0].y);for(let Nt=1;Nt<At.length;Nt+=1)V.lineTo(At[Nt].x,At[Nt].y);V.closePath(),V.fillStyle=Ut,V.fill(),No(V,At,bt),V.strokeStyle=rt.sectionPatchStroke,V.lineWidth=.75,V.stroke()}}}function To(s){const u=[];let k=Number.POSITIVE_INFINITY,V=Number.NEGATIVE_INFINITY,O=Number.POSITIVE_INFINITY,R=Number.NEGATIVE_INFINITY;for(const[$,X]of Object.entries(s.patches)){const K=[];for(const ct of X.rings){const at=ct.map(([st,nt])=>{const ut=st*s.sScale,D=s.zRef-nt;return k=Math.min(k,ut),V=Math.max(V,ut),O=Math.min(O,D),R=Math.max(R,D),{s:ut,d:D}});K.push(at)}u.push({soilId:$,rings:K})}return!Number.isFinite(k)||!Number.isFinite(O)?null:{minS:k,maxS:V,minD:O,maxD:R,patches:u}}function zo(s,u,k,V,O,R,$){const X=Math.max(.1,R-O),K=X/5,ct=[.5,1,2,5,10];let at=ct[0];for(const st of ct)K>st&&(at=st);s.font="11px IBM Plex Sans, sans-serif",s.fillStyle=$.sectionText,s.textAlign="right",s.textBaseline="middle";for(let st=O;st<=R+.001;st+=at){const nt=k+(st-O)/X*V;s.strokeStyle=$.sectionAxisTick,s.beginPath(),s.moveTo(u,nt),s.lineTo(u-6,nt),s.stroke(),s.fillText(st.toFixed(1),u-8,nt)}}function No(s,u,k){if(k===0||u.length===0)return;let V=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,R=Number.POSITIVE_INFINITY,$=Number.NEGATIVE_INFINITY;for(const K of u)V=Math.min(V,K.x),O=Math.max(O,K.x),R=Math.min(R,K.y),$=Math.max($,K.y);const X={x:V,y:R,width:Math.max(1,O-V),height:Math.max(1,$-R)};s.save(),s.beginPath(),s.moveTo(u[0].x,u[0].y);for(let K=1;K<u.length;K+=1)s.lineTo(u[K].x,u[K].y);s.closePath(),s.clip(),s.strokeStyle=rt.sectionHatch,s.lineWidth=1,k===1?(s.lineWidth=.25,Ye(s,X,Math.PI/4,12),Ye(s,X,-Math.PI/4,12)):k===2?(s.lineWidth=.25,Co(s,X,Math.PI/4,9,8,2)):k===3&&(s.lineWidth=.25,Eo(s,X)),s.restore()}function Ye(s,u,k,V){const O=u.x+u.width*.5,R=u.y+u.height*.5,$=Math.hypot(u.width,u.height);s.save(),s.translate(O,R),s.rotate(k),s.translate(-O,-R);const X=O-$,K=O+$;for(let ct=X;ct<=K;ct+=V)s.beginPath(),s.moveTo(ct,R-$),s.lineTo(ct,R+$),s.stroke();s.restore()}function Co(s,u,k,V,O,R){s.save(),s.setLineDash([O,R]),Ye(s,u,k,V),s.restore()}function Eo(s,u){const $=Math.ceil(u.height/9)+1;for(let X=0;X<$;X+=1){const K=u.y+X*9,ct=X%3*12;for(let at=u.x-36;at<=u.x+u.width+36;at+=36)s.beginPath(),s.moveTo(at+ct,K),s.lineTo(at+ct+12.5,K),s.stroke()}}}ii().catch(t=>{console.error(t),Hn(t instanceof Error?t.message:String(t))});
